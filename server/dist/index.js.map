{"version":3,"sources":["../src/utils/slip-extract.ts","../src/index.ts","../src/middleware/security.ts","../src/routes/projects.ts","../src/routes/tasks.ts","../src/routes/timelogs.ts","../src/routes/users.ts","../src/middleware/super-admin.ts","../src/utils/settings.ts","../src/routes/departments.ts","../src/routes/roles.ts","../src/routes/auth.ts","../src/utils/mailer.ts","../src/routes/approvals.ts","../src/routes/calendar.ts","../src/routes/gmail.ts","../src/routes/invoices.ts","../src/routes/receipts.ts","../src/routes/bank-credits.ts","../src/routes/documents.ts","../src/routes/admin.ts","../src/routes/settings.ts","../src/routes/speech.ts","../src/routes/chatbot.ts"],"sourcesContent":["// Slip amount extraction utilities\n// Uses pdf-parse for PDFs and tesseract.js for images\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport pdfParse from 'pdf-parse'\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport Tesseract from 'tesseract.js'\n\nfunction findAmountFromText(text: string): number | undefined {\n  const raw = String(text || '')\n  const lines = raw.split(/\\r?\\n/).map(l => l.trim()).filter(Boolean)\n  // Strict: find \"Amount\" followed by a number (optionally with currency)\n  const amountLineRe = /amount\\s*[:\\-]?\\s*(?:\\(\\s*(?:LKR|Rs\\.?|USD|GBP|EUR|AUD|CAD)\\s*\\)\\s*|(?:LKR|Rs\\.?|USD|GBP|EUR|AUD|CAD)\\s*)?([\\d,]+(?:\\.\\d{1,2})?)/i\n\n  // 1) Exact line match\n  for (let i = 0; i < lines.length; i++) {\n    const ln = lines[i]\n    const m = ln.match(amountLineRe)\n    if (m && m[1]) {\n      const val = Number(m[1].replace(/,/g, ''))\n      if (!Number.isNaN(val)) return val\n    }\n  }\n\n  // 2) Two-line context (currency/number might wrap)\n  for (let i = 0; i < lines.length; i++) {\n    const ctx = `${lines[i]} ${lines[i + 1] || ''}`\n    const m = ctx.match(amountLineRe)\n    if (m && m[1]) {\n      const val = Number(m[1].replace(/,/g, ''))\n      if (!Number.isNaN(val)) return val\n    }\n  }\n\n  // 3) Global fallback: first \"Amount:\" occurrence in the whole text\n  const g = raw.match(amountLineRe)\n  if (g && g[1]) {\n    const val = Number(g[1].replace(/,/g, ''))\n    if (!Number.isNaN(val)) return val\n  }\n\n  return undefined\n}\n\nexport async function extractAmountFromPdf(buffer: Buffer): Promise<number | undefined> {\n  try {\n    const parsed = await pdfParse(buffer)\n    return findAmountFromText(String(parsed?.text || ''))\n  } catch {\n    return undefined\n  }\n}\n\nexport async function extractAmountFromImage(buffer: Buffer): Promise<number | undefined> {\n  try {\n    const { data } = await Tesseract.recognize(buffer, 'eng', { logger: () => {} })\n    return findAmountFromText(String(data?.text || ''))\n  } catch {\n    return undefined\n  }\n}\n\nexport async function extractAmount(buffer: Buffer, mimeType: string): Promise<number | undefined> {\n  if (/^application\\/pdf/i.test(mimeType)) return extractAmountFromPdf(buffer)\n  if (/^image\\//i.test(mimeType)) return extractAmountFromImage(buffer)\n  return undefined\n}\n","import fs from 'fs'\nimport path from 'path'\nimport dotenv from 'dotenv'\n// Load env from the correct place whether running from repo root or server dir\n(() => {\n  const candidates = [\n    path.resolve(process.cwd(), 'server/.env'),\n    path.resolve(process.cwd(), '.env'),\n    path.resolve(__dirname, '../.env'),\n  ]\n  for (const p of candidates) {\n    try {\n      if (fs.existsSync(p)) { dotenv.config({ path: p }); break }\n    } catch {}\n  }\n})()\nimport express from 'express'\nimport cors from 'cors'\nimport morgan from 'morgan'\nimport { PrismaClient } from '@prisma/client'\nimport { helmetMiddleware, buildCorsOptions, loginRateLimiter } from './middleware/security.ts'\nimport projectsRouter from './routes/projects.ts'\nimport tasksRouter from './routes/tasks.ts'\nimport timelogsRouter from './routes/timelogs.ts'\nimport usersRouter from './routes/users.ts'\nimport departmentsRouter from './routes/departments.ts'\nimport rolesRouter from './routes/roles.ts'\nimport authRouter from './routes/auth.ts'\nimport approvalsRouter from './routes/approvals.ts'\nimport calendarRouter from './routes/calendar.ts'\nimport gmailRouter from './routes/gmail.ts'\nimport invoicesRouter from './routes/invoices.ts'\nimport receiptsRouter from './routes/receipts.ts'\nimport bankCreditsRouter from './routes/bank-credits.ts'\nimport documentsRouter from './routes/documents.ts'\nimport adminRouter from './routes/admin.ts'\nimport settingsRouter from './routes/settings.ts'\nimport speechRouter from './routes/speech.ts'\nimport chatbotRouter from './routes/chatbot.ts'\n\nconst app = express()\napp.disable('x-powered-by')\napp.set('trust proxy', 1)\napp.use(helmetMiddleware())\napp.use(cors(buildCorsOptions()))\nimport cookieParser from 'cookie-parser'\napp.use(cookieParser())\napp.use(express.json())\napp.use(morgan('dev'))\n// Serve uploaded files\napp.use('/uploads', express.static(path.resolve(process.cwd(), 'uploads')))\n\nconst prisma = new PrismaClient()\n\napp.get('/health', async (_req, res) => {\n  try {\n    await prisma.$queryRaw`SELECT 1`\n    res.json({ ok: true })\n  } catch (e) {\n    res.status(500).json({ ok: false, error: String(e) })\n  }\n})\n\n// Auth middleware: JWT first; dev-only fallbacks behind env flags\napp.use(async (req, _res, next) => {\n  const auth = req.header('authorization') || ''\n  let userId: string | null = null\n  let adminId: string | null = null\n  if (auth.toLowerCase().startsWith('bearer ')) {\n    const token = auth.slice(7)\n    try {\n      const secret = process.env.JWT_SECRET || 'dev-secret'\n      // eslint-disable-next-line @typescript-eslint/no-var-requires\n      const jwt = require('jsonwebtoken')\n      const payload = jwt.verify(token, secret) as any\n      userId = payload?.sub || null\n      adminId = userId\n    } catch {}\n  }\n  // Dev helper: allow x-user-id header or xuid cookie when explicitly enabled\n  const allowDevHeaders = (process.env.ALLOW_DEV_HEADERS || '').toLowerCase() === 'true'\n  if (!userId && allowDevHeaders) {\n    const fromHeader = req.header('x-user-id') || ''\n    const fromCookie = (req as any).cookies?.xuid || ''\n    userId = fromHeader || fromCookie || null\n  }\n\n  // Secure impersonation: if an active impersonation session cookie is present and admin JWT is valid, act as the target user\n  try {\n    const impSid = (req as any).cookies?.impSid || ''\n    if (impSid && adminId) {\n      const { PrismaClient } = await import('@prisma/client')\n      const prisma = new PrismaClient()\n      const db: any = prisma\n      const session = await db.impersonationSession.findUnique({ where: { id: String(impSid) } })\n      if (session && !session.endedAt && session.adminId === adminId) {\n        userId = session.userId\n        ;(req as any).adminId = adminId\n        ;(req as any).impersonationSessionId = session.id\n      }\n    }\n  } catch {}\n\n  ;(req as any).userId = userId\n  // Attach hydrated user for role checks when available\n  // Skip eager load in dev; routes look up user as needed\n  next()\n})\n\napp.use('/projects', projectsRouter)\napp.use('/tasks', tasksRouter)\napp.use('/timelogs', timelogsRouter)\n// New admin data APIs\napp.use('/api/users', usersRouter)\napp.use('/api/departments', departmentsRouter)\napp.use('/api/roles', rolesRouter)\napp.use('/auth', authRouter)\n// Provide /api/auth as an alias for auth endpoints to match other API prefixes\napp.use('/api/auth', authRouter)\n// Approvals\napp.use('/api/approvals', approvalsRouter)\n// Calendars (Google/Microsoft OAuth + events)\napp.use('/api/calendar', calendarRouter)\n// Gmail integration for Slips & Invoices\napp.use('/api/gmail', gmailRouter)\napp.use('/api/receipts', receiptsRouter)\napp.use('/api/bank-credits', bankCreditsRouter)\n// Invoices\napp.use('/invoices', invoicesRouter)\n// Documents\napp.use('/api/documents', documentsRouter)\n// Admin helper endpoints\napp.use('/api/admin', adminRouter)\n// System settings\napp.use('/api/settings', settingsRouter)\n// Speech-to-Text proxy\napp.use('/api/speech', speechRouter)\n// Chatbot proxy (RapidAPI)\napp.use('/api/chatbot', loginRateLimiter(), chatbotRouter)\n\nconst port = process.env.PORT || 4000\napp.listen(port, () => {\n  console.log(`API listening on :${port}`)\n})\n","import helmet from 'helmet'\nimport rateLimit from 'express-rate-limit'\nimport type { CorsOptions } from 'cors'\n\nexport function helmetMiddleware() {\n  return helmet({\n    contentSecurityPolicy: false, // can be tuned if you serve HTML\n    crossOriginEmbedderPolicy: false,\n  })\n}\n\nexport function loginRateLimiter() {\n  return rateLimit({\n    windowMs: 10 * 60 * 1000,\n    max: 100,\n    standardHeaders: true,\n    legacyHeaders: false,\n    message: 'Too many requests, please try again later.',\n  })\n}\n\nexport function buildCorsOptions(): CorsOptions {\n  const allowAll = (process.env.CORS_ALLOW_ALL || '').toLowerCase() === 'true'\n  const originEnv = process.env.FRONTEND_BASE_URL || process.env.APP_BASE_URL || ''\n  const origins = originEnv ? originEnv.split(',').map(s => s.trim()) : []\n  return allowAll || origins.length === 0\n    ? { origin: true, credentials: true }\n    : { origin: origins, credentials: true }\n}\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient, TaskStatus } from '@prisma/client'\nimport { z } from 'zod'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\nfunction calcTaskProgress(tasks: { status: TaskStatus }[]) {\n  const total = tasks.length\n  if (total === 0) return 0\n  const completed = tasks.filter(t => t.status === 'COMPLETED').length\n  return Math.round((completed / total) * 100)\n}\n\nasync function projectProgressAndHours(projectId: string) {\n  const phases = await prisma.phase.findMany({\n    where: { projectId },\n    include: { tasks: { select: { id: true, status: true } } },\n  })\n  const allTasks = phases.flatMap(p => p.tasks)\n  const progress = calcTaskProgress(allTasks)\n\n  const usedMinsAgg = await prisma.timeLog.aggregate({\n    _sum: { durationMins: true },\n    where: { task: { phase: { projectId } } },\n  })\n  const usedMins = usedMinsAgg._sum.durationMins || 0\n  const usedHours = Math.round((usedMins / 60) * 100) / 100\n\n  const project = await prisma.project.findUnique({\n    where: { id: projectId },\n    select: { allocatedHours: true },\n  })\n  const allocatedHours = project?.allocatedHours ?? 0\n  const leftHours = Math.max(allocatedHours - usedHours, 0)\n  return { progress, usedHours, leftHours, allocatedHours }\n}\n\nrouter.get('/', async (_req: Request, res: Response) => {\n  const projects = await prisma.project.findMany({\n    include: {\n      phases: { include: { tasks: { select: { status: true } } } },\n      memberships: { include: { user: true } },\n    },\n    orderBy: { createdAt: 'desc' },\n  })\n  const result = await Promise.all(\n    projects.map(async p => {\n      const allTasks = p.phases.flatMap(ph => ph.tasks)\n      const progress = calcTaskProgress(allTasks)\n      const agg = await prisma.timeLog.aggregate({\n        _sum: { durationMins: true },\n        where: { task: { phase: { projectId: p.id } } },\n      })\n      const usedHours = Math.round(((agg._sum.durationMins || 0) / 60) * 100) / 100\n      const leftHours = Math.max(p.allocatedHours - usedHours, 0)\n\n      // Determine duration dates: prefer project-level, fallback to phases' min/max\n      const phaseStart = p.phases\n        .map(ph => ph.startDate)\n        .filter(Boolean)\n        .sort((a: any, b: any) => new Date(a).getTime() - new Date(b).getTime())[0] as Date | undefined\n      const phaseEnd = p.phases\n        .map(ph => ph.endDate)\n        .filter(Boolean)\n        .sort((a: any, b: any) => new Date(b).getTime() - new Date(a).getTime())[0] as Date | undefined\n      const startDate = p.startDate ?? phaseStart ?? null\n      const endDate = p.endDate ?? phaseEnd ?? null\n      return {\n        ...p,\n        phases: undefined,\n        memberships: p.memberships,\n        progress,\n        usedHours,\n        leftHours,\n        startDate,\n        endDate,\n      }\n    })\n  )\n  res.json(result)\n})\n\n// Minimal list of projects with phases for invoicing UI\nrouter.get('/basic', async (_req: Request, res: Response) => {\n  const projects = await prisma.project.findMany({\n    orderBy: { createdAt: 'desc' },\n    select: {\n      id: true,\n      title: true,\n      phases: { select: { id: true, name: true } },\n    },\n  })\n  res.json(projects.map(p => ({ id: p.id, name: p.title, phases: p.phases.map(ph => ({ id: ph.id, name: ph.name })) })))\n})\n\nconst createProjectSchema = z.object({\n  code: z.string(),\n  title: z.string(),\n  description: z.string().default(''),\n  ownerId: z.string().optional(),\n  allocatedHours: z.number().int().nonnegative().default(0),\n  visibility: z.enum(['PRIVATE', 'TEAM', 'COMPANY']).default('TEAM'),\n  status: z.enum(['PLANNING', 'IN_PROGRESS', 'ON_HOLD', 'COMPLETED', 'CANCELLED']).default('PLANNING'),\n  startDate: z.string().datetime().optional(),\n  endDate: z.string().datetime().optional(),\n  memberUserIds: z.array(z.string()).optional().default([]),\n})\n\nrouter.post('/', async (req: Request, res: Response) => {\n  const parsed = createProjectSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const data = parsed.data as any\n  // Coerce dates and validate order if present\n  if (data.startDate) data.startDate = new Date(data.startDate)\n  if (data.endDate) data.endDate = new Date(data.endDate)\n  if (data.startDate && data.endDate && data.startDate > data.endDate) {\n    return res.status(400).json({ error: 'startDate must be before or equal to endDate' })\n  }\n  try {\n    const { memberUserIds, ...projectData } = data\n    const project = await prisma.project.create({ data: projectData })\n\n    if (memberUserIds && memberUserIds.length > 0) {\n      const roleMap = await inferProjectRoles(prisma, memberUserIds)\n      for (const userId of memberUserIds) {\n        const role = (roleMap[userId] || 'ENGINEER') as any\n        await prisma.projectMembership.upsert({\n          where: { projectId_userId: { projectId: project.id, userId } },\n          update: { role },\n          create: { projectId: project.id, userId, role },\n        })\n      }\n    }\n\n    res.status(201).json(project)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to create project' })\n  }\n})\n\nrouter.get('/:id', async (req: Request, res: Response) => {\n  const id = req.params.id\n  const project = await prisma.project.findUnique({\n    where: { id },\n    include: {\n      phases: { include: { tasks: { include: { assignees: { include: { user: true } } } } } },\n      memberships: { include: { user: true } },\n      owner: true,\n    },\n  })\n  if (!project) return res.status(404).json({ error: 'Not found' })\n  const meta = await projectProgressAndHours(id)\n  res.json({ ...project, ...meta })\n})\n\n// Get project members (users) for a given project\nrouter.get('/:id/members', async (req: Request, res: Response) => {\n  const id = req.params.id\n  const memberships = await prisma.projectMembership.findMany({\n    where: { projectId: id },\n    include: { user: true },\n    orderBy: { user: { name: 'asc' } },\n  })\n  const users = memberships.map(m => m.user)\n  res.json(users)\n})\n\nconst updateProjectSchema = createProjectSchema.partial()\nrouter.patch('/:id', async (req: Request, res: Response) => {\n  const id = req.params.id\n  const parsed = updateProjectSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const data: any = { ...parsed.data }\n  if (data.startDate !== undefined) data.startDate = data.startDate ? new Date(data.startDate) : null\n  if (data.endDate !== undefined) data.endDate = data.endDate ? new Date(data.endDate) : null\n  if (data.startDate && data.endDate && data.startDate > data.endDate) {\n    return res.status(400).json({ error: 'startDate must be before or equal to endDate' })\n  }\n  const project = await prisma.project.update({ where: { id }, data })\n  const meta = await projectProgressAndHours(id)\n  res.json({ ...project, ...meta })\n})\n\nrouter.post('/:id/phases', async (req: Request, res: Response) => {\n  const id = req.params.id\n  const schema = z.object({\n    name: z.string(),\n    description: z.string().optional(),\n    startDate: z.string().datetime().optional(),\n    endDate: z.string().datetime().optional(),\n  })\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { name, description, startDate, endDate } = parsed.data\n  const phase = await prisma.phase.create({\n    data: {\n      name,\n      description,\n      startDate: startDate ? new Date(startDate) : undefined,\n      endDate: endDate ? new Date(endDate) : undefined,\n      projectId: id,\n    },\n  })\n  res.status(201).json(phase)\n})\n\n// Update a phase's basic fields (name, description, dates)\nrouter.patch('/:id/phases/:phaseId', async (req: Request, res: Response) => {\n  const projectId = req.params.id\n  const phaseId = req.params.phaseId\n\n  const schema = z.object({\n    name: z.string().optional(),\n    description: z.string().nullable().optional(),\n    startDate: z.string().datetime().nullable().optional(),\n    endDate: z.string().datetime().nullable().optional(),\n  })\n\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n\n  // Ensure the phase belongs to this project\n  const phase = await prisma.phase.findFirst({ where: { id: phaseId, projectId } })\n  if (!phase) return res.status(404).json({ error: 'Phase not found for project' })\n\n  const data: any = { ...parsed.data }\n  if (data.startDate !== undefined) data.startDate = data.startDate ? new Date(data.startDate) : null\n  if (data.endDate !== undefined) data.endDate = data.endDate ? new Date(data.endDate) : null\n\n  try {\n    const updated = await prisma.phase.update({ where: { id: phaseId }, data })\n    res.json(updated)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to update phase' })\n  }\n})\n\n// Add members to a project by user IDs\nrouter.post('/:id/members', async (req: Request, res: Response) => {\n  const projectId = req.params.id\n  const schema = z.object({ userIds: z.array(z.string()).min(1), role: z.enum(['DIRECTOR','MANAGER','CONSULTANT','LEAD','ENGINEER','OPS']).optional() })\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { userIds, role } = parsed.data\n  try {\n    let roleMap: Record<string, string> = {}\n    if (!role) {\n      roleMap = await inferProjectRoles(prisma, userIds)\n    }\n    let count = 0\n    for (const userId of userIds) {\n      const r = (role || roleMap[userId] || 'ENGINEER') as any\n      await prisma.projectMembership.upsert({\n        where: { projectId_userId: { projectId, userId } },\n        update: { role: r },\n        create: { projectId, userId, role: r },\n      })\n      count++\n    }\n    res.status(201).json({ count })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to add members' })\n  }\n})\n\n// Remove members from a project\nrouter.delete('/:id/members', async (req: Request, res: Response) => {\n  const projectId = req.params.id\n  const schema = z.object({ userIds: z.array(z.string()).min(1) })\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { userIds } = parsed.data\n  try {\n    const result = await prisma.projectMembership.deleteMany({\n      where: { projectId, userId: { in: userIds } },\n    })\n    res.json({ count: result.count })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to remove members' })\n  }\n})\n\n// Create a task in a phase (supports optional assignees by userId)\nrouter.post('/:id/phases/:phaseId/tasks', async (req: Request, res: Response) => {\n  const projectId = req.params.id\n  const phaseId = req.params.phaseId\n\n  const schema = z.object({\n    title: z.string().min(1),\n    description: z.string().optional().default(''),\n    dueDate: z.string().optional(), // Accepts ISO strings or YYYY-MM-DD\n    status: z.enum(['NOT_STARTED', 'IN_PROGRESS', 'ON_HOLD', 'COMPLETED']).optional().default('NOT_STARTED'),\n    assigneeUserIds: z.array(z.string()).optional().default([]),\n    priority: z.enum(['LOW','MEDIUM','HIGH','CRITICAL']).optional(),\n  })\n\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { title, description, dueDate, status, assigneeUserIds, priority } = parsed.data as any\n\n  try {\n    // Ensure phase belongs to project\n    const phase = await prisma.phase.findFirst({ where: { id: phaseId, projectId } })\n    if (!phase) return res.status(404).json({ error: 'Phase not found for project' })\n\n    // Normalize date string (support date-only)\n    let due: Date | undefined\n    if (dueDate) {\n      const asDate = new Date(dueDate)\n      if (isNaN(asDate.getTime())) {\n        return res.status(400).json({ error: 'Invalid dueDate format' })\n      }\n      due = asDate\n    }\n\n    // Map provided userIds to membership ids for this project\n    // Find existing memberships and create missing ones\n    const existingMemberships = assigneeUserIds.length\n      ? await prisma.projectMembership.findMany({\n          where: { projectId, userId: { in: assigneeUserIds } },\n          select: { id: true, userId: true },\n        })\n      : []\n\n    const existingUserIds = new Set(existingMemberships.map(m => m.userId))\n    const missingUserIds = (assigneeUserIds || []).filter((uid: string) => !existingUserIds.has(uid))\n\n    let createdMemberships: { id: string }[] = []\n    if (missingUserIds.length > 0) {\n      // Create missing memberships with inferred roles\n      const roleMap = await inferProjectRoles(prisma, missingUserIds)\n      await prisma.projectMembership.createMany({\n        data: missingUserIds.map((uid: string) => ({ projectId, userId: uid, role: (roleMap[uid] || 'ENGINEER') as any })),\n        skipDuplicates: true,\n      })\n      createdMemberships = await prisma.projectMembership.findMany({\n        where: { projectId, userId: { in: missingUserIds } },\n        select: { id: true },\n      })\n    }\n\n    const created = await prisma.task.create({\n      data: ({\n        title,\n        description: description || '',\n        status: status as any,\n        dueDate: due,\n        priority: (priority || 'MEDIUM') as any,\n        phaseId,\n        assignees: (existingMemberships.length || createdMemberships.length)\n          ? { connect: [...existingMemberships, ...createdMemberships].map(m => ({ id: m.id })) }\n          : undefined,\n      } as any),\n      include: {\n        assignees: { include: { user: true } },\n      },\n    })\n\n    res.status(201).json(created)\n  } catch (e: any) {\n    console.error('Failed to create task', e)\n    res.status(400).json({ error: e?.message || 'Failed to create task' })\n  }\n})\n\nexport default router\n// Infer a ProjectRole from the user's app role/department\nasync function inferProjectRoles(prisma: PrismaClient, userIds: string[]): Promise<Record<string, string>> {\n  if (!userIds || userIds.length === 0) return {}\n  const users = await prisma.user.findMany({\n    where: { id: { in: userIds } },\n    include: { role: true, department: true },\n  })\n  const map: Record<string, string> = {}\n  for (const u of users) {\n    const appRole = (u.role?.name || '').toUpperCase()\n    const dept = (u.department?.name || '').toUpperCase()\n    let pr: string = 'ENGINEER'\n    if (['DIRECTOR', 'MANAGER', 'LEAD', 'CONSULTANT', 'ENGINEER', 'OPS'].includes(appRole)) {\n      pr = appRole\n    } else if (dept.includes('OPS')) {\n      pr = 'OPS'\n    } else if (appRole === 'CLIENT') {\n      // No CLIENT in ProjectRole; treat as CONSULTANT by default\n      pr = 'CONSULTANT'\n    }\n    map[u.id] = pr\n  }\n  return map\n}\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient, TaskStatus, HistoryType } from '@prisma/client'\nimport { z } from 'zod'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\nrouter.post('/phases/:phaseId/tasks', async (req: Request, res: Response) => {\n  const phaseId = req.params.phaseId\n  const schema = z.object({\n    title: z.string(),\n    description: z.string().default(''),\n    dueDate: z.string().datetime().optional(),\n    priority: z.enum(['LOW','MEDIUM','HIGH','CRITICAL']).optional(),\n  })\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { title, description, dueDate, priority } = parsed.data as any\n  const task = await prisma.task.create({ data: ({ title, description, priority: (priority || 'MEDIUM') as any, dueDate: dueDate ? new Date(dueDate) : null, phaseId } as any) })\n  res.status(201).json(task)\n})\n\nrouter.get('/:id', async (req: Request, res: Response) => {\n  const id = req.params.id\n  const task = await prisma.task.findUnique({\n    where: { id },\n    include: {\n      timeLogs: true,\n      comments: {\n        include: {\n          author: true,\n          replies: { include: { author: true } },\n          mentions: true,\n        },\n        orderBy: { createdAt: 'asc' },\n      },\n      documents: true,\n      phase: { include: { project: true } },\n      assignees: { include: { user: true } },\n      history: { orderBy: { createdAt: 'desc' } },\n    },\n  })\n  if (!task) return res.status(404).json({ error: 'Not found' })\n  res.json(task)\n})\n\nrouter.patch('/:id', async (req: Request, res: Response) => {\n  const id = req.params.id\n  const schema = z.object({\n    title: z.string().optional(),\n    description: z.string().optional(),\n    status: z.nativeEnum(TaskStatus).optional(),\n    dueDate: z.string().datetime().nullable().optional(),\n    priority: z.enum(['LOW','MEDIUM','HIGH','CRITICAL']).optional(),\n    assigneeUserIds: z.array(z.string()).optional(),\n  })\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { assigneeUserIds, ...rest } = parsed.data as any\n  const data: any = { ...rest }\n  if (data.dueDate !== undefined) {\n    data.dueDate = data.dueDate ? new Date(data.dueDate) : null\n  }\n  // Update basic fields first\n  await prisma.task.update({ where: { id }, data })\n\n  // If assigneeUserIds is provided, update the relation\n  if (assigneeUserIds !== undefined) {\n    // Determine projectId via task -> phase\n    const t = await prisma.task.findUnique({\n      where: { id },\n      select: { phase: { select: { projectId: true } } },\n    })\n    const projectId = t?.phase?.projectId\n    if (!projectId) return res.status(400).json({ error: 'Task phase/project not found' })\n\n    // Find existing memberships and create missing ones\n    const existing = assigneeUserIds.length\n      ? await prisma.projectMembership.findMany({ where: { projectId, userId: { in: assigneeUserIds } }, select: { id: true, userId: true } })\n      : []\n    const existingIds = new Set(existing.map(e => e.userId))\n    const missing = (assigneeUserIds || []).filter((uid: string) => !existingIds.has(uid))\n    if (missing.length > 0) {\n      await prisma.projectMembership.createMany({ data: missing.map((uid: string) => ({ projectId, userId: uid, role: 'ENGINEER' })), skipDuplicates: true })\n    }\n    const allMemberships = assigneeUserIds.length\n      ? await prisma.projectMembership.findMany({ where: { projectId, userId: { in: assigneeUserIds } }, select: { id: true } })\n      : []\n\n    // Set new assignees (clear if empty array)\n    await prisma.task.update({\n      where: { id },\n      data: {\n        assignees: { set: [], ...(allMemberships.length ? { connect: allMemberships.map(m => ({ id: m.id })) } : {}) },\n      },\n    })\n  }\n\n  const updated = await prisma.task.findUnique({\n    where: { id },\n    include: { assignees: { include: { user: true } } },\n  })\n  res.json(updated)\n})\n\n// Create a comment on a task (supports optional parent reply and mentions)\nrouter.post('/:taskId/comments', async (req: Request, res: Response) => {\n  const userId = (req as any).userId\n  if (!userId) return res.status(401).json({ error: 'x-user-id required' })\n  const taskId = req.params.taskId\n  const schema = z.object({\n    content: z.string().min(1),\n    parentId: z.string().optional(),\n    mentionUserIds: z.array(z.string()).optional(),\n  })\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { content, parentId, mentionUserIds } = parsed.data\n\n  try {\n    // Ensure task exists\n    const task = await prisma.task.findUnique({ where: { id: taskId } })\n    if (!task) return res.status(404).json({ error: 'Task not found' })\n\n    const comment = await prisma.comment.create({\n      data: {\n        taskId,\n        authorId: userId,\n        content,\n        parentId: parentId || undefined,\n        ...(mentionUserIds && mentionUserIds.length\n          ? { mentions: { connect: mentionUserIds.map(id => ({ id })) } }\n          : {}),\n      },\n      include: { author: true, replies: { include: { author: true } }, mentions: true },\n    })\n\n    // Record in task history as an update\n    const snippet = content.length > 180 ? `${content.slice(0, 180)}â€¦` : content\n    await prisma.historyEvent.create({\n      data: {\n        taskId,\n        type: HistoryType.COMMENT,\n        message: `Comment: ${snippet}`,\n        createdById: userId,\n      },\n    })\n\n    res.status(201).json(comment)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to create comment' })\n  }\n})\n\n// List comments for a task (top-level with nested replies)\nrouter.get('/:taskId/comments', async (req: Request, res: Response) => {\n  const taskId = req.params.taskId\n  try {\n    const comments = await prisma.comment.findMany({\n      where: { taskId, parentId: null },\n      include: { author: true, replies: { include: { author: true } }, mentions: true },\n      orderBy: { createdAt: 'asc' },\n    })\n    res.json(comments)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to load comments' })\n  }\n})\n\n// List task history events (comments, time logs, status changes, documents)\nrouter.get('/:taskId/history', async (req: Request, res: Response) => {\n  const taskId = req.params.taskId\n  try {\n    const history = await prisma.historyEvent.findMany({\n      where: { taskId },\n      orderBy: { createdAt: 'desc' },\n      include: { createdBy: true },\n    })\n    res.json(history)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to load history' })\n  }\n})\n\nexport default router\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\nimport multer from 'multer'\nimport fs from 'fs'\nimport path from 'path'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\n// Ensure uploads directory exists\nconst UPLOAD_DIR = path.resolve(process.cwd(), 'uploads')\ntry { fs.mkdirSync(UPLOAD_DIR, { recursive: true }) } catch (_) {}\n\nconst storage = multer.diskStorage({\n  destination: (_req: Request, _file: any, cb: (err: any, dest: string) => void) => cb(null, UPLOAD_DIR),\n  filename: (_req: Request, file: any, cb: (err: any, fileName: string) => void) => {\n    const unique = `${Date.now()}-${Math.round(Math.random() * 1e9)}`\n    const safe = file.originalname.replace(/[^a-zA-Z0-9_.-]/g, '_')\n    cb(null, `${unique}-${safe}`)\n  },\n})\nconst upload = multer({ storage })\n\nconst createSchema = z.object({\n  startedAt: z.string().datetime(),\n  endedAt: z.string().datetime(),\n  description: z.string(),\n})\n\n// Supports multipart/form-data (with optional `file`) or JSON body\nrouter.post('/tasks/:taskId/timelogs', upload.single('file'), async (req: Request, res: Response) => {\n  const userId = (req as any).userId\n  if (!userId) return res.status(401).json({ error: 'x-user-id required' })\n  const taskId = req.params.taskId\n  const parsed = createSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { startedAt, endedAt, description } = parsed.data\n  const start = new Date(startedAt)\n  const end = new Date(endedAt)\n  const durationMins = Math.max(0, Math.round((end.getTime() - start.getTime()) / 60000))\n  try {\n    let attachmentId: string | undefined\n    if ((req as any).file) {\n      // Attach uploaded file to this task's project if possible\n      const file = (req as any).file as any\n      // Resolve projectId via task -> phase\n      const task = await prisma.task.findUnique({ where: { id: taskId }, include: { phase: true } })\n      const projectId = task?.phase?.projectId\n      const attachment = await prisma.attachment.create({\n        data: {\n          filePath: path.relative(process.cwd(), path.join(UPLOAD_DIR, file.filename)),\n          fileType: file.mimetype || 'application/octet-stream',\n          projectId: projectId || undefined,\n        },\n      })\n      attachmentId = attachment.id\n    }\n\n    const log = await prisma.timeLog.create({\n      data: { taskId, userId, startedAt: start, endedAt: end, durationMins, description, attachmentId },\n    })\n    try {\n      // Record in task history for unified timeline\n      await prisma.historyEvent.create({\n        data: {\n          taskId,\n          type: 'TIME_LOG' as any,\n          message: `Logged ${Math.round((durationMins / 60) * 10) / 10}h: ${description}`,\n          createdById: String(userId),\n        },\n      })\n    } catch {}\n    res.status(201).json(log)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to create time log' })\n  }\n})\n\nrouter.get('/tasks/:taskId/timelogs', async (req: Request, res: Response) => {\n  const scope = (req.query.scope as string) || 'all'\n  const taskId = req.params.taskId\n  const where: any = { taskId }\n  if (scope === 'mine') {\n    const userId = (req as any).userId\n    if (!userId) return res.status(401).json({ error: 'x-user-id required' })\n    where.userId = userId\n  }\n  const logs = await prisma.timeLog.findMany({ where, orderBy: { startedAt: 'desc' }, include: { attachment: true } })\n  res.json(logs)\n})\n\nexport default router\n","import { Router } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\nimport { requireSuperAdmin } from '../middleware/super-admin.ts'\nimport { getSuperAdminEmail } from '../utils/settings.ts'\nimport { isSuperAdminByUserId } from '../middleware/super-admin.ts'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\nconst paginationSchema = z.object({\n  page: z.coerce.number().int().positive().default(1),\n  limit: z.coerce.number().int().positive().max(100).default(20),\n  search: z.string().optional(),\n  roleId: z.string().optional(),\n  departmentId: z.string().optional(),\n  isActive: z.coerce.boolean().optional(),\n})\n\nrouter.get('/', requireSuperAdmin, async (req, res) => {\n  const parsed = paginationSchema.safeParse(req.query)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { page, limit, search, roleId, departmentId, isActive } = parsed.data\n  const where: any = {}\n  if (search) {\n    where.OR = [\n      { name: { contains: search, mode: 'insensitive' } },\n      { email: { contains: search.toLowerCase(), mode: 'insensitive' } },\n    ]\n  }\n  if (roleId) where.roleId = roleId\n  if (departmentId) where.departmentId = departmentId\n  if (isActive !== undefined) where.isActive = isActive\n\n  const [total, rows] = await Promise.all([\n    prisma.user.count({ where }),\n    prisma.user.findMany({\n      where,\n      include: { role: { select: { name: true } }, department: { select: { name: true } } },\n      orderBy: [{ createdAt: 'desc' }],\n      skip: (page - 1) * limit,\n      take: limit,\n    }),\n  ])\n  const items = rows.map(u => ({\n    id: u.id,\n    name: u.name,\n    email: u.email,\n    isActive: u.isActive,\n    verified: !!(u as any).emailVerifiedAt,\n    roleId: (u as any).roleId,\n    departmentId: (u as any).departmentId,\n    createdAt: u.createdAt,\n    updatedAt: u.updatedAt,\n    role: (u as any).role?.name?.toLowerCase?.() || '',\n    department: (u as any).department?.name || '',\n  }))\n  res.json({ total, page, limit, items })\n})\n\nconst createUserSchema = z.object({\n  name: z.string().min(1),\n  email: z.string().email(),\n  roleId: z.string(),\n  departmentId: z.string(),\n  isActive: z.boolean().optional(),\n})\n\nrouter.post('/', requireSuperAdmin, async (req, res) => {\n  const parsed = createUserSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { name, email, roleId, departmentId, isActive } = parsed.data\n  try {\n    const user = await prisma.user.create({\n      data: { name, email: email.trim().toLowerCase(), roleId, departmentId, isActive: isActive ?? true },\n    })\n    res.status(201).json(user)\n  } catch (e: any) {\n    if (e.code === 'P2002' && e.meta?.target?.includes('email')) {\n      return res.status(409).json({ error: 'Email already exists' })\n    }\n    res.status(400).json({ error: e?.message || 'Failed to create user' })\n  }\n})\n\n// Current user profile based on x-user-id header\n// Current user profile with dev-friendly fallbacks\nrouter.get('/me', async (req, res) => {\n  const auth = String(req.header('authorization') || '')\n  const allowDevHeaders = (process.env.ALLOW_DEV_HEADERS || '').toLowerCase() === 'true'\n  let userId = (req as any).userId as string | null\n  let u: any = null\n\n  try {\n    // If a bearer token is present but invalid, attempt dev cookie fallback when allowed\n    const hasBearer = auth.toLowerCase().startsWith('bearer ')\n    if (hasBearer && !userId && allowDevHeaders) {\n      const fromCookie = (req as any).cookies?.xuid || ''\n      if (fromCookie) userId = String(fromCookie)\n    }\n    if (userId) {\n      u = await prisma.user.findUnique({ where: { id: userId }, include: { role: true, department: true } })\n    }\n    // Fallback by email header (dev convenience) only when dev headers are allowed and no bearer is present\n    if (!u && allowDevHeaders && !hasBearer) {\n      const email = String(req.header('x-email') || req.query.email || '').toLowerCase()\n      if (email) {\n        u = await prisma.user.findUnique({ where: { email }, include: { role: true, department: true } })\n      }\n    }\n    // Last resort: pick the first user in DB only in dev header mode and without bearer\n    if (!u && allowDevHeaders && !hasBearer) {\n      u = await prisma.user.findFirst({ include: { role: true, department: true }, orderBy: { createdAt: 'asc' } })\n    }\n    // Auto-provision a default admin if database is empty\n    if (!u) {\n      const role = await prisma.appRole.findFirst({}) || await prisma.appRole.create({ data: { name: 'Director' } })\n      const dept = await prisma.department.findFirst({}) || await prisma.department.create({ data: { name: 'Executive Department' } })\n      u = await prisma.user.create({ data: ({ name: 'Admin', email: 'admin@company.com', roleId: role.id, departmentId: dept.id, isActive: true, emailVerifiedAt: new Date() } as any), include: { role: true, department: true } })\n    }\n\n    // Resolve super-admin flag by id or email\n    const superById = await isSuperAdminByUserId(userId)\n    const adminEmail = (await getSuperAdminEmail()).toLowerCase()\n    const isSuper = superById || (!!adminEmail && String(u?.email || '').toLowerCase() === adminEmail)\n\n    const me = {\n      id: u.id,\n      name: u.name,\n      email: u.email,\n      isActive: u.isActive,\n      role: isSuper ? 'admin' : ((u as any).role?.name?.toLowerCase?.() || ''),\n      department: (u as any).department?.name || '',\n      lastActive: new Date().toISOString(),\n      isSuperAdmin: isSuper,\n    }\n    res.json(me)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to resolve current user' })\n  }\n})\n\nrouter.get('/:id', requireSuperAdmin, async (req, res) => {\n  const u = await prisma.user.findUnique({\n    where: { id: req.params.id },\n    include: { role: true, department: true },\n  })\n  if (!u) return res.status(404).json({ error: 'Not found' })\n  const user = {\n    id: u.id,\n    name: u.name,\n    email: u.email,\n    isActive: u.isActive,\n    verified: !!(u as any).emailVerifiedAt,\n    roleId: (u as any).roleId,\n    departmentId: (u as any).departmentId,\n    createdAt: u.createdAt,\n    updatedAt: u.updatedAt,\n    role: (u as any).role?.name?.toLowerCase?.() || '',\n    department: (u as any).department?.name || '',\n  }\n  res.json(user)\n})\n\nconst updateUserSchema = createUserSchema.partial()\nrouter.patch('/:id', requireSuperAdmin, async (req, res) => {\n  const parsed = updateUserSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const data = { ...parsed.data } as any\n  if (data.email) data.email = data.email.trim().toLowerCase()\n  try {\n    const user = await prisma.user.update({ where: { id: req.params.id }, data })\n    res.json(user)\n  } catch (e: any) {\n    if (e.code === 'P2002' && e.meta?.target?.includes('email')) {\n      return res.status(409).json({ error: 'Email already exists' })\n    }\n    if (e.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    res.status(400).json({ error: e?.message || 'Failed to update user' })\n  }\n})\n\nrouter.delete('/:id', requireSuperAdmin, async (req, res) => {\n  const id = String(req.params.id)\n  const hard = String(req.query.hard || req.query.force || '').toLowerCase() === 'true'\n  try {\n    const u = await prisma.user.findUnique({ where: { id } })\n    if (!u) return res.status(404).json({ error: 'Not found' })\n    const adminEmail = String(process.env.SUPERADMIN_EMAIL || '').trim().toLowerCase()\n    if (adminEmail && String(u.email).toLowerCase() === adminEmail) {\n      return res.status(403).json({ error: 'Cannot delete super admin user' })\n    }\n\n    if (hard) {\n      // Deep cleanup then delete\n      const adminUser = await prisma.user.findFirst({ where: { email: adminEmail } })\n      if (!adminUser) return res.status(500).json({ error: 'Super admin user not found' })\n      await prisma.$transaction(async (tx) => {\n        // Remove memberships (will also detach task assignees via join)\n        await tx.projectMembership.deleteMany({ where: { userId: id } })\n        // Delete logs and notifications\n        await tx.timeLog.deleteMany({ where: { userId: id } })\n        await tx.notification.deleteMany({ where: { userId: id } })\n        // Auth tokens\n        await tx.authToken.deleteMany({ where: { userId: id } })\n        // Calendar related\n        await tx.calendarOAuthState.deleteMany({ where: { userId: id } })\n        await tx.calendarSource.deleteMany({ where: { userId: id } })\n        await tx.calendarAccount.deleteMany({ where: { userId: id } })\n        // Documents: reassign creator to admin, clear reviewer\n        await tx.document.updateMany({ where: { reviewerId: id }, data: { reviewerId: null } })\n        await tx.document.updateMany({ where: { createdById: id }, data: { createdById: adminUser.id } })\n        // History events: reassign creator\n        await tx.historyEvent.updateMany({ where: { createdById: id }, data: { createdById: adminUser.id } })\n        // Comments: reassign author\n        await tx.comment.updateMany({ where: { authorId: id }, data: { authorId: adminUser.id } })\n        // Projects: clear owner if this user\n        await tx.project.updateMany({ where: { ownerId: id }, data: { ownerId: null } })\n        // Impersonation sessions involving this user\n        try {\n          const db: any = tx as any\n          await db.impersonationSession.deleteMany({ where: { OR: [{ userId: id }, { adminId: id }] } })\n        } catch {}\n        // Finally delete the user (AuthTokens cascade)\n        await tx.user.delete({ where: { id } })\n      })\n      return res.status(204).end()\n    }\n\n    // Try simple delete; on FK failure, scrub\n    try {\n      await prisma.user.delete({ where: { id } })\n      return res.status(204).end()\n    } catch (e: any) {\n      if (e?.code === 'P2003' || e?.code === 'P2014' || String(e?.message || '').toLowerCase().includes('foreign key')) {\n        const newEmail = `archived+${id}@example.com`\n        await prisma.user.update({ where: { id }, data: ({ isActive: false, email: newEmail, name: 'Archived User', passwordHash: null } as any) })\n        return res.status(200).json({ ok: true, scrubbed: true })\n      }\n      throw e\n    }\n  } catch (e: any) {\n    if (e?.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    return res.status(400).json({ error: e?.message || 'Failed to delete user' })\n  }\n})\n\nexport default router\n","import { Request, Response, NextFunction } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { getSuperAdminEmail } from '../utils/settings.ts'\n\nconst prisma = new PrismaClient()\n\nexport async function requireSuperAdmin(req: Request, res: Response, next: NextFunction) {\n  try {\n    const adminEmail = (await getSuperAdminEmail()).toLowerCase()\n    if (!adminEmail) {\n      return res.status(500).json({ error: 'SUPERADMIN_EMAIL is not configured' })\n    }\n    const impersonatingAdminId = (req as any).adminId as string | null\n    const userId = (req as any).userId as string | null\n    if (!userId && !impersonatingAdminId) return res.status(401).json({ error: 'Authentication required' })\n\n    // If impersonating, authorize based on the original admin identity\n    if (impersonatingAdminId) {\n      const adminUser = await prisma.user.findUnique({ where: { id: impersonatingAdminId } })\n      if (!adminUser) return res.status(401).json({ error: 'Invalid admin' })\n      const isSuperAdmin = adminUser.email.toLowerCase() === adminEmail\n      if (!isSuperAdmin) return res.status(403).json({ error: 'Admin only' })\n      ;(req as any).user = adminUser\n      return next()\n    }\n\n    // Normal case: use current user identity\n    const user = await prisma.user.findUnique({ where: { id: userId! } })\n    if (!user) return res.status(401).json({ error: 'Invalid user' })\n    const isSuper = user.email.toLowerCase() === adminEmail\n    if (!isSuper) return res.status(403).json({ error: 'Admin only' })\n    ;(req as any).user = user\n    return next()\n  } catch (e: any) {\n    return res.status(500).json({ error: e?.message || 'Authorization failed' })\n  }\n}\n\nexport async function isSuperAdminByUserId(userId: string | null) {\n  if (!userId) return false\n  const adminEmail = String(process.env.SUPERADMIN_EMAIL || '').trim().toLowerCase()\n  if (!adminEmail) return false\n  const user = await prisma.user.findUnique({ where: { id: userId } })\n  return !!user && user.email.toLowerCase() === adminEmail\n}\n","import { PrismaClient } from '@prisma/client'\n\nconst prisma = new PrismaClient()\n\nlet cachedEmail: string | null = null\nlet cachedAt = 0\n\nexport async function getSuperAdminEmail(): Promise<string> {\n  const now = Date.now()\n  if (cachedEmail && now - cachedAt < 30000) return cachedEmail\n  const rec = await prisma.systemSetting.findUnique({ where: { key: 'SUPERADMIN_EMAIL' } }).catch(() => null)\n  const envEmail = String(process.env.SUPERADMIN_EMAIL || '').trim()\n  const email = (rec?.value || envEmail || 'admin@company.com').trim()\n  cachedEmail = email\n  cachedAt = now\n  return email\n}\n\nexport async function setSuperAdminEmail(email: string) {\n  const value = email.trim()\n  await prisma.systemSetting.upsert({ where: { key: 'SUPERADMIN_EMAIL' }, update: { value }, create: { key: 'SUPERADMIN_EMAIL', value } })\n  cachedEmail = value\n  cachedAt = Date.now()\n  return value\n}\n\n","import { Router } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\nrouter.get('/', async (_req, res) => {\n  const items = await prisma.department.findMany({ orderBy: { name: 'asc' } })\n  res.json(items)\n})\n\nconst bodySchema = z.object({ name: z.string().min(1) })\n\nrouter.post('/', async (req, res) => {\n  const parsed = bodySchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  try {\n    const item = await prisma.department.create({ data: parsed.data })\n    res.status(201).json(item)\n  } catch (e: any) {\n    if (e.code === 'P2002') return res.status(409).json({ error: 'Department already exists' })\n    res.status(400).json({ error: e?.message || 'Failed to create department' })\n  }\n})\n\nrouter.patch('/:id', async (req, res) => {\n  const parsed = bodySchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  try {\n    const item = await prisma.department.update({ where: { id: req.params.id }, data: parsed.data })\n    res.json(item)\n  } catch (e: any) {\n    if (e.code === 'P2002') return res.status(409).json({ error: 'Department already exists' })\n    if (e.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    res.status(400).json({ error: e?.message || 'Failed to update department' })\n  }\n})\n\n// Set department lead\nrouter.patch('/:id/lead', async (req, res) => {\n  const body = z.object({ userId: z.string().min(1) }).parse(req.body || {})\n  try {\n    const dept = await prisma.department.update({ where: { id: req.params.id }, data: { leadId: body.userId } as any })\n    res.json(dept)\n  } catch (e: any) {\n    if (e.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    res.status(400).json({ error: e?.message || 'Failed to set lead' })\n  }\n})\n\n// Update department settings (disable/hide)\nrouter.patch('/:id/settings', async (req, res) => {\n  const body = z.object({ disabled: z.coerce.boolean().optional() }).parse(req.body || {})\n  try {\n    const dept = await prisma.department.update({ where: { id: req.params.id }, data: body as any })\n    res.json(dept)\n  } catch (e: any) {\n    if (e.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    res.status(400).json({ error: e?.message || 'Failed to update settings' })\n  }\n})\n\nrouter.delete('/:id', async (req, res) => {\n  const id = req.params.id\n  const force = String(req.query.force || '').toLowerCase() === 'true'\n  const toDeptId = (req.query.toDeptId as string) || ''\n  const count = await prisma.user.count({ where: { departmentId: id } })\n  if (count > 0 && !force) {\n    return res.status(409).json({ error: 'Users reference this department' })\n  }\n  try {\n    if (count > 0 && force) {\n      let targetId = toDeptId\n      if (!targetId) {\n        // Find or create a fallback department named \"Unassigned\"\n        const unassigned = await prisma.department.upsert({\n          where: { name: 'Unassigned' },\n          update: {},\n          create: { name: 'Unassigned' },\n        })\n        targetId = unassigned.id\n      } else {\n        const exists = await prisma.department.findUnique({ where: { id: targetId } })\n        if (!exists) return res.status(400).json({ error: 'toDeptId not found' })\n        if (targetId === id) return res.status(400).json({ error: 'toDeptId cannot equal the department being deleted' })\n      }\n      // Reassign users to target department\n      await prisma.user.updateMany({ where: { departmentId: id }, data: { departmentId: targetId } })\n    }\n    await prisma.department.delete({ where: { id } })\n    res.status(204).end()\n  } catch (e: any) {\n    if (e.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    res.status(400).json({ error: e?.message || 'Failed to delete department' })\n  }\n})\n\nexport default router\n","import { Router } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\nrouter.get('/', async (_req, res) => {\n  const items = await prisma.appRole.findMany({ orderBy: { name: 'asc' } })\n  res.json(items)\n})\n\nconst bodySchema = z.object({ name: z.string().min(1) })\n\nrouter.post('/', async (req, res) => {\n  const parsed = bodySchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  try {\n    const item = await prisma.appRole.create({ data: parsed.data })\n    res.status(201).json(item)\n  } catch (e: any) {\n    if (e.code === 'P2002') return res.status(409).json({ error: 'Role already exists' })\n    res.status(400).json({ error: e?.message || 'Failed to create role' })\n  }\n})\n\nrouter.patch('/:id', async (req, res) => {\n  const parsed = bodySchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  try {\n    const item = await prisma.appRole.update({ where: { id: req.params.id }, data: parsed.data })\n    res.json(item)\n  } catch (e: any) {\n    if (e.code === 'P2002') return res.status(409).json({ error: 'Role already exists' })\n    if (e.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    res.status(400).json({ error: e?.message || 'Failed to update role' })\n  }\n})\n\nrouter.delete('/:id', async (req, res) => {\n  const id = req.params.id\n  const force = String(req.query.force || '').toLowerCase() === 'true'\n  const toRoleId = (req.query.toRoleId as string) || ''\n  const count = await prisma.user.count({ where: { roleId: id } })\n  if (count > 0 && !force) return res.status(409).json({ error: 'Users reference this role' })\n  try {\n    if (count > 0 && force) {\n      let targetId = toRoleId\n      if (!targetId) {\n        // Find or create a fallback role named \"Unassigned\"\n        const unassigned = await prisma.appRole.upsert({\n          where: { name: 'Unassigned' },\n          update: {},\n          create: { name: 'Unassigned' },\n        })\n        targetId = unassigned.id\n      } else {\n        const exists = await prisma.appRole.findUnique({ where: { id: targetId } })\n        if (!exists) return res.status(400).json({ error: 'toRoleId not found' })\n        if (targetId === id) return res.status(400).json({ error: 'toRoleId cannot equal the role being deleted' })\n      }\n      await prisma.user.updateMany({ where: { roleId: id }, data: { roleId: targetId } })\n    }\n    await prisma.appRole.delete({ where: { id } })\n    res.status(204).end()\n  } catch (e: any) {\n    if (e.code === 'P2025') return res.status(404).json({ error: 'Not found' })\n    res.status(400).json({ error: e?.message || 'Failed to delete role' })\n  }\n})\n\nexport default router\n","import { Router } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\nimport bcrypt from 'bcryptjs'\nimport jwt from 'jsonwebtoken'\nimport { authRequired } from '../middleware/auth-required.ts'\nimport { isSuperAdminByUserId } from '../middleware/super-admin.ts'\nimport crypto from 'crypto'\nimport { loginRateLimiter } from '../middleware/security.ts'\nimport { getSuperAdminEmail } from '../utils/settings.ts'\nimport { emailEnabled, renderVerifyEmail, renderInviteEmail, renderPasswordResetEmail, sendMail } from '../utils/mailer.ts'\n\nconst prisma = new PrismaClient()\nconst db: any = prisma\nconst router = Router()\n\nconst strongPassword = z.string().min(8).regex(/^(?=.*[A-Za-z])(?=.*\\d).+$/, 'Password must include letters and numbers')\nconst loginSchema = z.object({ email: z.string().email(), password: z.string().min(4) })\nconst registerSchema = z.object({ name: z.string().min(1), email: z.string().email(), password: strongPassword, roleId: z.string(), departmentId: z.string() })\nconst signupSchema = z.object({\n  name: z.string().min(1),\n  email: z.string().email(),\n  password: strongPassword,\n  desiredDepartmentId: z.string(),\n  intendedRoleId: z.string().optional(),\n  managerName: z.string().optional(),\n  billable: z.coerce.boolean().optional(),\n})\nconst setPasswordSchema = z.object({ email: z.string().email(), password: strongPassword })\n\nfunction sign(userId: string) {\n  const secret = process.env.JWT_SECRET || 'dev-secret'\n  return jwt.sign({ sub: userId }, secret, { expiresIn: '15m' })\n}\n\nfunction hashToken(raw: string) {\n  return crypto.createHash('sha256').update(raw).digest('hex')\n}\n\nasync function createToken(userId: string, type: 'EMAIL_VERIFY' | 'PASSWORD_RESET' | 'REFRESH', ttlSeconds: number) {\n  const raw = crypto.randomBytes(32).toString('hex')\n  const tokenHash = hashToken(raw)\n  const expiresAt = new Date(Date.now() + ttlSeconds * 1000)\n  await db.authToken.create({ data: { userId, type: type as any, tokenHash, expiresAt } })\n  return { raw, expiresAt }\n}\n\nasync function consumeToken(type: 'EMAIL_VERIFY' | 'PASSWORD_RESET' | 'REFRESH', raw: string) {\n  const tokenHash = hashToken(raw)\n  const rec = await db.authToken.findFirst({ where: { tokenHash, type: type as any, usedAt: null, expiresAt: { gt: new Date() } } })\n  if (!rec) return null\n  await db.authToken.update({ where: { id: rec.id }, data: { usedAt: new Date() } })\n  return rec\n}\n\n// SECURE LOGIN: verify password; no auto-create except super admin from env\nrouter.post('/login', loginRateLimiter(), async (req, res) => {\n  const parsed = loginSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { email, password } = parsed.data\n  const lower = email.toLowerCase()\n  let user: any = null\n  try {\n    user = await prisma.user.findUnique({ where: { email: lower } })\n    const adminEmail = (await getSuperAdminEmail()).toLowerCase()\n    const adminEnvPass = String(process.env.SUPERADMIN_PASSWORD || '')\n    const isSuperAttempt = !!adminEmail && lower === adminEmail\n\n    // Super admin: allow env password; provision account if missing\n    if (isSuperAttempt && adminEnvPass && password === adminEnvPass) {\n      const role = await prisma.appRole.findFirst({ where: { name: { equals: 'Director', mode: 'insensitive' } } }) || await prisma.appRole.create({ data: { name: 'Director' } })\n      const dept = await prisma.department.findFirst({ where: { name: { equals: 'Executive Department', mode: 'insensitive' } } }) || await prisma.department.create({ data: { name: 'Executive Department' } })\n      if (!user) {\n        const hash = await bcrypt.hash(adminEnvPass, 10)\n        user = await prisma.user.create({ data: ({ name: 'Admin', email: lower, roleId: role.id, departmentId: dept.id, isActive: true, emailVerifiedAt: new Date(), passwordHash: hash } as any) })\n      } else if (!user.passwordHash) {\n        const hash = await bcrypt.hash(adminEnvPass, 10)\n        user = await prisma.user.update({ where: { id: user.id }, data: ({ passwordHash: hash, isActive: true, emailVerifiedAt: user.emailVerifiedAt || new Date() } as any) })\n      }\n    } else {\n      // Normal user: must exist, be active and verified, not locked, and password must match\n      if (!user || !user.passwordHash) return res.status(401).json({ error: 'Invalid credentials' })\n      if (user.lockedUntil && user.lockedUntil > new Date()) return res.status(403).json({ error: 'Account temporarily locked. Try again later.' })\n      const ok = await bcrypt.compare(password, user.passwordHash)\n      if (!ok) {\n        const attempts = (user.failedLoginAttempts || 0) + 1\n        const lock = attempts >= 5 ? { lockedUntil: new Date(Date.now() + 15 * 60 * 1000) } : {}\n        await prisma.user.update({ where: { id: user.id }, data: ({ failedLoginAttempts: attempts, ...lock } as any) })\n        return res.status(401).json({ error: 'Invalid credentials' })\n      }\n      if (!user.isActive || !user.emailVerifiedAt) return res.status(403).json({ error: 'Account not verified or inactive' })\n      // Reset attempts on success\n      user = await prisma.user.update({ where: { id: user.id }, data: ({ failedLoginAttempts: 0, lockedUntil: null, lastLoginAt: new Date() } as any) })\n    }\n  } catch (e: any) {\n    return res.status(400).json({ error: e?.message || 'Login failed' })\n  }\n\n  const token = sign(user.id)\n  // In dev, also drop an xuid cookie to resist any local token decode hiccups\n  const isProd = (process.env.NODE_ENV || '').toLowerCase() === 'production'\n  const allowDevHeaders = (process.env.ALLOW_DEV_HEADERS || '').toLowerCase() === 'true'\n  if (allowDevHeaders) {\n    res.cookie('xuid', user.id, { httpOnly: true, sameSite: 'lax', secure: isProd })\n  }\n  return res.json({ token, user: { id: user.id, name: user.name, email: user.email } })\n})\n\n// Public sign-up: create pending user, send verification; still inactive until approval\nrouter.post('/signup', loginRateLimiter(), async (req, res) => {\n  const body = signupSchema.parse(req.body || {})\n  const email = body.email.trim().toLowerCase()\n  const hash = await bcrypt.hash(body.password, 10)\n  try {\n    const existing = await prisma.user.findUnique({ where: { email } })\n    if (existing) return res.status(409).json({ error: 'Email already registered' })\n    const role = await prisma.appRole.findFirst({ where: { name: { equals: 'Client', mode: 'insensitive' } } }) || await prisma.appRole.create({ data: { name: 'Client' } })\n    const dept = await prisma.department.findUnique({ where: { id: body.desiredDepartmentId } })\n    if (!dept) return res.status(400).json({ error: 'Invalid department' })\n    const user = await prisma.user.create({ data: ({\n      name: body.name,\n      email,\n      roleId: role.id,\n      departmentId: dept.id,\n      passwordHash: hash,\n      isActive: false,\n      requestedDepartmentId: body.desiredDepartmentId,\n      intendedRoleId: body.intendedRoleId || null,\n      billable: !!body.billable,\n    } as any) })\n    const db: any = prisma\n    await db.approvalRequest.create({ data: ({ userId: user.id, requestedDepartmentId: body.desiredDepartmentId, requestedRoleId: body.intendedRoleId || null, billable: !!body.billable, referredBy: null, managerName: body.managerName || null } as any) })\n    // Send verification email token\n    const { raw } = await createToken(user.id, 'EMAIL_VERIFY', 24 * 3600)\n    const clientBase = process.env.FRONTEND_BASE_URL || 'http://localhost:5173'\n    const verifyUrl = `${clientBase}/invite/accept?token=${encodeURIComponent(raw)}`\n    if (emailEnabled()) {\n      const { subject, html } = renderVerifyEmail(verifyUrl)\n      await sendMail(user.email, subject, html)\n    }\n    return res.status(201).json({ ok: true, ...(emailEnabled() ? {} : { verifyUrl }), userId: user.id })\n  } catch (e: any) {\n    return res.status(400).json({ error: e?.message || 'Failed to sign up' })\n  }\n})\n\n// Optional: create a user with password\nrouter.post('/register', loginRateLimiter(), async (req, res) => {\n  // Only super admin can register users (unless explicitly allowed by OPEN_LOGIN in dev)\n  const auth = req.header('authorization') || ''\n  if (!auth.toLowerCase().startsWith('bearer ')) return res.status(401).json({ error: 'Authentication required' })\n  try {\n    const secret = process.env.JWT_SECRET || 'dev-secret'\n    const payload = jwt.verify(auth.slice(7), secret) as any\n    const ok = await isSuperAdminByUserId(String(payload?.sub || ''))\n    if (!ok) return res.status(403).json({ error: 'Admin only' })\n  } catch {\n    return res.status(401).json({ error: 'Invalid token' })\n  }\n  const parsed = registerSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { name, email, password, roleId, departmentId } = parsed.data\n  const hash = await bcrypt.hash(password, 10)\n  try {\n    const adminEmail = (await getSuperAdminEmail()).toLowerCase()\n    if (email.toLowerCase() === adminEmail) {\n      return res.status(400).json({ error: 'Cannot create another super admin' })\n    }\n    const user = await prisma.user.create({ data: ({ name, email: email.toLowerCase(), roleId, departmentId, passwordHash: hash, isActive: true } as any) })\n    // Issue email verification token (invite)\n    const { raw } = await createToken(user.id, 'EMAIL_VERIFY', 24 * 3600)\n    const clientBase = process.env.FRONTEND_BASE_URL || 'http://localhost:5173'\n    const verifyUrl = `${clientBase}/invite/accept?token=${encodeURIComponent(raw)}`\n    if (emailEnabled()) {\n      const { subject, html } = renderInviteEmail(verifyUrl, user.name)\n      await sendMail(user.email, subject, html)\n    }\n    res.status(201).json({ ok: true, user: { id: user.id, name: user.name, email: user.email }, ...(emailEnabled() ? {} : { verifyUrl }) })\n  } catch (e: any) {\n    return res.status(400).json({ error: e?.message || 'Failed to register' })\n  }\n})\n\n// Bootstrap an Admin account quickly in dev mode targeting SUPERADMIN_EMAIL\nrouter.post('/bootstrap-admin', async (_req, res) => {\n  const allowBootstrap = (process.env.ALLOW_ADMIN_BOOTSTRAP || process.env.ENABLE_DEV_AUTH || '').toLowerCase() === 'true'\n  if (!allowBootstrap) return res.status(403).json({ error: 'Forbidden' })\n  const adminEmail = (await getSuperAdminEmail()).toLowerCase()\n  const name = 'Admin'\n  // Ensure role/department\n  const role = await prisma.appRole.findFirst({ where: { name: { equals: 'Director', mode: 'insensitive' } } }) || await prisma.appRole.create({ data: { name: 'Director' } })\n  const dept = await prisma.department.findFirst({ where: { name: { equals: 'Executive Department', mode: 'insensitive' } } }) || await prisma.department.create({ data: { name: 'Executive Department' } })\n  let user = await prisma.user.findUnique({ where: { email: adminEmail } })\n  const adminEnvPass = String(process.env.SUPERADMIN_PASSWORD || '')\n  if (!user) {\n    const passHash = adminEnvPass ? await bcrypt.hash(adminEnvPass, 10) : null\n    user = await prisma.user.create({ data: ({ name, email: adminEmail, roleId: role.id, departmentId: dept.id, isActive: true, emailVerifiedAt: new Date(), ...(passHash ? { passwordHash: passHash } : {}) } as any) })\n  } else if (adminEnvPass && !user.passwordHash) {\n    // If password not set yet, initialize from env for convenience\n    const passHash = await bcrypt.hash(adminEnvPass, 10)\n    user = await prisma.user.update({ where: { id: user.id }, data: ({ passwordHash: passHash } as any) })\n  }\n  const token = sign(user.id)\n  const isProd = (process.env.NODE_ENV || '').toLowerCase() === 'production'\n  const allowDevHeaders = (process.env.ALLOW_DEV_HEADERS || '').toLowerCase() === 'true'\n  if (allowDevHeaders) {\n    res.cookie('xuid', user.id, { httpOnly: true, sameSite: 'lax', secure: isProd })\n  }\n  res.json({ ok: true, user: { id: user.id, name: user.name, email: user.email }, token })\n})\n\n// Dev utility: set password for an existing user by email\nrouter.post('/set-password', loginRateLimiter(), async (req, res) => {\n  // Restrict in production: self-service or admin only\n  const parsed = setPasswordSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { email, password } = parsed.data\n  const hash = await bcrypt.hash(password, 10)\n  try {\n    const prod = (process.env.NODE_ENV || '').toLowerCase() === 'production'\n    if (prod) {\n      const auth = req.header('authorization') || ''\n      if (!auth.toLowerCase().startsWith('bearer ')) return res.status(401).json({ error: 'Authentication required' })\n      const secret = process.env.JWT_SECRET || 'dev-secret'\n      try {\n        const payload = jwt.verify(auth.slice(7), secret) as any\n        const me = await prisma.user.findUnique({ where: { id: String(payload?.sub || '') }, include: { role: true } })\n        const r = String((me as any)?.role?.name || '').toLowerCase()\n        const isRoleAdmin = ['director','manager'].includes(r)\n        const isSuper = await isSuperAdminByUserId(String(payload?.sub || ''))\n        if (!(isRoleAdmin || isSuper) && String(me?.email || '').toLowerCase() !== email.toLowerCase()) {\n          return res.status(403).json({ error: 'Only admins or the same user can change password' })\n        }\n      } catch {\n        return res.status(401).json({ error: 'Invalid token' })\n      }\n    }\n    const user = await prisma.user.update({ where: { email: email.toLowerCase() }, data: ({ passwordHash: hash } as any) })\n    res.json({ ok: true, id: user.id })\n  } catch (e: any) {\n    return res.status(400).json({ error: e?.message || 'Failed to set password' })\n  }\n})\n\n// Public self-service registration (defaults to Client role if present)\nrouter.post('/public-register', loginRateLimiter(), async (req, res) => {\n  const allowPublic = (process.env.PUBLIC_REGISTRATION || '').toLowerCase() === 'true'\n  if (!allowPublic) return res.status(403).json({ error: 'Public registration is disabled' })\n  const body = z.object({ name: z.string().min(1), email: z.string().email(), password: strongPassword }).parse(req.body || {})\n  const email = body.email.trim().toLowerCase()\n  const hash = await bcrypt.hash(body.password, 10)\n  try {\n    const clientRole = await prisma.appRole.findFirst({ where: { name: { equals: 'Client', mode: 'insensitive' } } })\n    const anyDept = await prisma.department.findFirst({})\n    if (!clientRole || !anyDept) return res.status(500).json({ error: 'Server not configured for public registration' })\n    const user = await prisma.user.create({ data: ({ name: body.name, email, roleId: clientRole.id, departmentId: anyDept.id, passwordHash: hash, isActive: false } as any) })\n    const { raw } = await createToken(user.id, 'EMAIL_VERIFY', 24 * 3600)\n    const clientBase = process.env.FRONTEND_BASE_URL || 'http://localhost:5173'\n    const verifyUrl = `${clientBase}/invite/accept?token=${encodeURIComponent(raw)}`\n    if (emailEnabled()) {\n      const { subject, html } = renderVerifyEmail(verifyUrl)\n      await sendMail(user.email, subject, html)\n    }\n    res.status(201).json({ ok: true, message: 'Check your email to verify your account', ...(emailEnabled() ? {} : { verifyUrl }) })\n  } catch (e: any) {\n    if (e.code === 'P2002') return res.status(409).json({ error: 'Email already exists' })\n    res.status(400).json({ error: e?.message || 'Failed to register' })\n  }\n})\n\n// Verify email with token\nrouter.post('/verify-email', async (req, res) => {\n  const token = String((req.body?.token || req.query.token || '') as string)\n  if (!token) return res.status(400).json({ error: 'Missing token' })\n  const rec = await consumeToken('EMAIL_VERIFY', token)\n  if (!rec) return res.status(400).json({ error: 'Invalid or expired token' })\n  await prisma.user.update({ where: { id: rec.userId }, data: ({ emailVerifiedAt: new Date() } as any) })\n  res.json({ ok: true })\n})\n\n// Peek invite details without consuming the token\nrouter.get('/invite-info', async (req, res) => {\n  try {\n    const token = String(req.query.token || '')\n    if (!token) return res.status(400).json({ valid: false, status: 'invalid' })\n    const tokenHash = hashToken(token)\n    const rec = await db.authToken.findFirst({ where: { tokenHash, type: 'EMAIL_VERIFY' as any } })\n    if (!rec) return res.json({ valid: false, status: 'invalid' })\n    if (rec.usedAt) return res.json({ valid: false, status: 'used' })\n    if (rec.expiresAt <= new Date()) return res.json({ valid: false, status: 'expired' })\n    const user = await prisma.user.findUnique({ where: { id: rec.userId }, include: { role: true, department: true } })\n    if (!user) return res.json({ valid: false, status: 'invalid' })\n    return res.json({\n      valid: true,\n      status: 'ok',\n      data: { email: user.email, name: user.name, role: (user as any).role?.name, department: (user as any).department?.name },\n    })\n  } catch (e: any) {\n    return res.status(400).json({ valid: false, status: 'invalid', error: e?.message })\n  }\n})\n\n// Accept invitation: verify email and set initial password in one step\nrouter.post('/accept-invite', loginRateLimiter(), async (req, res) => {\n  const body = z.object({ token: z.string().min(16), password: strongPassword.optional(), name: z.string().min(1).optional(), phone: z.string().optional() }).parse(req.body || {})\n  const rec = await consumeToken('EMAIL_VERIFY', body.token)\n  if (!rec) return res.status(400).json({ error: 'Invalid or expired token' })\n  const data: any = { emailVerifiedAt: new Date() }\n  if (body.password) {\n    data.passwordHash = await bcrypt.hash(body.password, 10)\n  }\n  if (body.name) data.name = body.name\n  if (typeof body.phone === 'string') data.phone = body.phone\n  await prisma.user.update({ where: { id: rec.userId }, data })\n  res.json({ ok: true })\n})\n\n// Request password reset\nrouter.post('/request-password-reset', loginRateLimiter(), async (req, res) => {\n  const email = String(req.body?.email || '').toLowerCase()\n  if (!email) return res.status(400).json({ error: 'Email required' })\n  const user = await prisma.user.findUnique({ where: { email } })\n  // Always respond 200 to prevent enumeration\n  if (user) {\n    const { raw } = await createToken(user.id, 'PASSWORD_RESET', 3600)\n    const clientBase = process.env.FRONTEND_BASE_URL || 'http://localhost:5173'\n    const resetUrl = `${clientBase}/reset-password?token=${encodeURIComponent(raw)}`\n    if (emailEnabled()) {\n      const { subject, html } = renderPasswordResetEmail(resetUrl, user.name)\n      await sendMail(user.email, subject, html)\n    } else {\n      console.log('Password reset link (dev):', resetUrl)\n    }\n  }\n  res.json({ ok: true })\n})\n\nrouter.post('/reset-password', loginRateLimiter(), async (req, res) => {\n  const body = z.object({ token: z.string().min(16), password: strongPassword }).parse(req.body || {})\n  const rec = await consumeToken('PASSWORD_RESET', body.token)\n  if (!rec) return res.status(400).json({ error: 'Invalid or expired token' })\n  const hash = await bcrypt.hash(body.password, 10)\n  await prisma.user.update({ where: { id: rec.userId }, data: ({ passwordHash: hash } as any) })\n  res.json({ ok: true })\n})\n\n// Validate password reset token without consuming it\nrouter.get('/reset-password/validate', async (req, res) => {\n  const token = String(req.query.token || '')\n  if (!token) return res.status(400).json({ valid: false, status: 'invalid' })\n  try {\n    const tokenHash = hashToken(token)\n    const rec = await db.authToken.findFirst({ where: { tokenHash, type: 'PASSWORD_RESET' as any } })\n    if (!rec) return res.json({ valid: false, status: 'invalid' })\n    if (rec.usedAt) return res.json({ valid: false, status: 'used' })\n    if (rec.expiresAt <= new Date()) return res.json({ valid: false, status: 'expired' })\n    return res.json({ valid: true, status: 'ok' })\n  } catch (e: any) {\n    return res.status(400).json({ valid: false, status: 'invalid', error: e?.message })\n  }\n})\n\n// Refresh access token using refresh cookie\nrouter.post('/refresh', async (req, res) => {\n  const raw = (req.cookies?.rt || req.body?.refreshToken || '') as string\n  if (!raw) return res.status(401).json({ error: 'Missing refresh token' })\n  const rec = await consumeToken('REFRESH', raw)\n  if (!rec) return res.status(401).json({ error: 'Invalid or expired refresh token' })\n  const token = sign(rec.userId)\n  const { raw: newRt, expiresAt } = await createToken(rec.userId, 'REFRESH', 30 * 24 * 3600)\n  const isProd = (process.env.NODE_ENV || '').toLowerCase() === 'production'\n  res.cookie('rt', newRt, { httpOnly: true, secure: isProd, sameSite: 'lax', expires: expiresAt })\n  res.json({ token })\n})\n\nrouter.post('/logout', async (req, res) => {\n  const raw = (req.cookies?.rt || req.body?.refreshToken || '') as string\n  if (raw) {\n    const tokenHash = hashToken(raw)\n    await db.authToken.deleteMany({ where: { tokenHash, type: 'REFRESH' as any } })\n  }\n  res.clearCookie('rt')\n  res.json({ ok: true })\n})\n\n// --- DEV UTILITIES (guarded) ---\nconst DEV_AUTH = ((process.env.ENABLE_DEV_AUTH || '').toLowerCase() === 'true') || ((process.env.NODE_ENV || '').toLowerCase() !== 'production')\nif (DEV_AUTH) {\n  // Mark a user as verified\n  router.post('/dev/verify-email', async (req, res) => {\n    const email = String(req.body?.email || '').toLowerCase()\n    if (!email) return res.status(400).json({ error: 'Email required' })\n    try {\n      const u = await prisma.user.update({ where: { email }, data: ({ emailVerifiedAt: new Date(), isActive: true } as any) })\n      return res.json({ ok: true, id: u.id })\n    } catch (e: any) {\n      return res.status(400).json({ error: e?.message || 'Failed to verify' })\n    }\n  })\n  // Set a password without requiring auth\n  router.post('/dev/set-password', async (req, res) => {\n    const email = String(req.body?.email || '').toLowerCase()\n    const password = String(req.body?.password || '')\n    if (!email || !password) return res.status(400).json({ error: 'Email and password required' })\n    const hash = await bcrypt.hash(password, 10)\n    try {\n      const u = await prisma.user.update({ where: { email }, data: ({ passwordHash: hash } as any) })\n      return res.json({ ok: true, id: u.id })\n    } catch (e: any) {\n      return res.status(400).json({ error: e?.message || 'Failed to set password' })\n    }\n  })\n\n  // Impersonate a user (sets a dev cookie that middleware reads)\n  router.post('/dev/impersonate', async (req, res) => {\n    const { userId, email } = req.body || {}\n    let id = String(userId || '')\n    try {\n      if (!id && email) {\n        const u = await prisma.user.findUnique({ where: { email: String(email).toLowerCase() } })\n        if (!u) return res.status(404).json({ error: 'User not found' })\n        id = u.id\n      }\n      if (!id) return res.status(400).json({ error: 'userId or email required' })\n      // Ensure exists\n      const u = await prisma.user.findUnique({ where: { id } })\n      if (!u) return res.status(404).json({ error: 'User not found' })\n      const isProd = (process.env.NODE_ENV || '').toLowerCase() === 'production'\n      res.cookie('xuid', id, { httpOnly: true, sameSite: 'lax', secure: isProd })\n      return res.json({ ok: true, id })\n    } catch (e: any) {\n      return res.status(400).json({ error: e?.message || 'Failed to impersonate' })\n    }\n  })\n\n  // Clear impersonation\n  router.post('/dev/clear-impersonate', async (_req, res) => {\n    res.clearCookie('xuid')\n    res.json({ ok: true })\n  })\n}\n\nexport default router\n","import nodemailer from 'nodemailer'\n\nfunction isTruthy(v?: string) {\n  return String(v || '').toLowerCase() === 'true'\n}\n\nexport function emailEnabled() {\n  return !!process.env.SMTP_HOST && !!process.env.SMTP_USER && !!process.env.SMTP_PASS\n}\n\nexport function getTransport() {\n  if (!emailEnabled()) throw new Error('SMTP not configured')\n  const secure = isTruthy(process.env.SMTP_SECURE)\n  const port = Number(process.env.SMTP_PORT || (secure ? 465 : 587))\n  return nodemailer.createTransport({\n    host: process.env.SMTP_HOST,\n    port,\n    secure,\n    auth: { user: process.env.SMTP_USER as string, pass: process.env.SMTP_PASS as string },\n  })\n}\n\nexport async function sendMail(to: string, subject: string, html: string, text?: string) {\n  if (!emailEnabled()) return { ok: false, skipped: true }\n  const from = process.env.MAIL_FROM || process.env.SMTP_USER || 'no-reply@example.com'\n  const transporter = getTransport()\n  const info = await transporter.sendMail({ from, to, subject, text: text || html.replace(/<[^>]+>/g, ''), html })\n  return { ok: true, messageId: info.messageId }\n}\n\nexport function renderVerifyEmail(link: string) {\n  return {\n    subject: 'Verify your email',\n    html: `\n      <div style=\"font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:560px;margin:auto;padding:24px\">\n        <h2>Verify your email</h2>\n        <p>Click the button below to verify your email and continue.</p>\n        <p style=\"margin:24px 0\"><a href=\"${link}\" style=\"background:#2563eb;color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none\" target=\"_blank\" rel=\"noopener\">Verify Email</a></p>\n        <p>If the button doesn't work, copy and paste this link:</p>\n        <p><a href=\"${link}\">${link}</a></p>\n      </div>\n    `,\n  }\n}\n\nexport function renderInviteEmail(link: string, name?: string, roleName?: string, departmentName?: string) {\n  const brand = (process.env.MAIL_FROM || 'Remora').replace(/<.*?>/g, '').trim() || 'Remora'\n  const role = roleName ? String(roleName) : undefined\n  const dept = departmentName ? String(departmentName) : undefined\n  const tagStyle = 'display:inline-block;padding:6px 10px;border-radius:9999px;background:#F1F5F9;color:#0F172A;font-size:12px;font-weight:600;margin-right:8px;border:1px solid #E2E8F0'\n  return {\n    subject: `You're invited to ${brand}`,\n    html: `\n  <div style=\"background:#F8FAFC;padding:24px\">\n    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"max-width:640px;margin:0 auto;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden\">\n      <tr>\n        <td style=\"padding:32px 24px;background:linear-gradient(135deg,#7C3AED, #2563EB);color:#ffffff\">\n          <div style=\"font-size:20px;font-weight:700;letter-spacing:0.2px\">${brand}</div>\n          <div style=\"margin-top:8px;font-size:14px;opacity:0.9\">Secure invitation to join the workspace</div>\n        </td>\n      </tr>\n      <tr>\n        <td style=\"padding:28px 24px 8px 24px;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0f172a\">\n          <h2 style=\"margin:0 0 8px 0;font-size:22px;line-height:28px\">Welcome${name ? `, ${name}` : ''}</h2>\n          <p style=\"margin:0 0 12px 0;font-size:14px;line-height:22px;color:#334155\">You've been invited to join <strong>${brand}</strong>. Use the button below to create your password and activate your account.</p>\n          ${role || dept ? `\n          <div style=\"margin:14px 0 6px 0\">\n            ${role ? `<span style=\"${tagStyle}\">Role: ${role}</span>` : ''}\n            ${dept ? `<span style=\"${tagStyle}\">Department: ${dept}</span>` : ''}\n          </div>` : ''}\n          <div style=\"margin:20px 0 26px 0\">\n            <a href=\"${link}\" target=\"_blank\" rel=\"noopener\" style=\"background:#7C3AED;color:#fff;text-decoration:none;padding:12px 18px;border-radius:10px;font-weight:700;display:inline-block\">Accept Invitation</a>\n          </div>\n          <p style=\"margin:0 0 10px 0;font-size:12px;color:#64748B\">This link expires in 24 hours for your security.</p>\n          <p style=\"margin:0 0 8px 0;font-size:12px;color:#64748B\">If the button doesn't work, copy and paste this link into your browser:</p>\n          <p style=\"margin:0 0 18px 0;font-size:12px;word-break:break-all\"><a href=\"${link}\" style=\"color:#2563EB;text-decoration:none\">${link}</a></p>\n        </td>\n      </tr>\n      <tr>\n        <td style=\"padding:14px 24px;background:#F8FAFC;border-top:1px solid #e5e7eb;color:#64748B;font-size:12px\">\n          Sent by ${brand}. If you weren't expecting this invitation, you can ignore this email.\n        </td>\n      </tr>\n    </table>\n  </div>\n    `,\n  }\n}\n\nexport function renderApprovedEmail(baseUrl: string) {\n  const link = baseUrl.replace(/\\/$/, '') + '/login'\n  return {\n    subject: 'Your account has been approved',\n    html: `\n      <div style=\"font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:560px;margin:auto;padding:24px\">\n        <h2>You're in!</h2>\n        <p>Your account has been approved. You can now sign in.</p>\n        <p style=\"margin:24px 0\"><a href=\"${link}\" style=\"background:#2563eb;color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none\" target=\"_blank\" rel=\"noopener\">Sign in</a></p>\n      </div>\n    `,\n  }\n}\n\nexport function renderPasswordResetEmail(link: string, name?: string) {\n  const brand = (process.env.MAIL_FROM || 'Remora').replace(/<.*?>/g, '').trim() || 'Remora'\n  return {\n    subject: `${brand}: Reset your password`,\n    html: `\n  <div style=\"background:#F8FAFC;padding:24px\">\n    <table role=\"presentation\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\" style=\"max-width:640px;margin:0 auto;background:#ffffff;border:1px solid #e5e7eb;border-radius:14px;overflow:hidden\">\n      <tr>\n        <td style=\"padding:28px 24px;background:linear-gradient(135deg,#2563EB,#7C3AED);color:#fff\">\n          <div style=\"font-size:20px;font-weight:700;letter-spacing:0.2px\">${brand}</div>\n          <div style=\"margin-top:6px;font-size:14px;opacity:0.9\">Password reset request</div>\n        </td>\n      </tr>\n      <tr>\n        <td style=\"padding:24px;font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:#0f172a\">\n          <p style=\"margin:0 0 10px 0\">${name ? `Hi ${name},` : 'Hi,'}</p>\n          <p style=\"margin:0 0 16px 0;color:#334155;font-size:14px\">We received a request to reset your password. Click the button below to set a new password. This link expires in 60 minutes.</p>\n          <div style=\"margin:18px 0 24px 0\">\n            <a href=\"${link}\" target=\"_blank\" rel=\"noopener\" style=\"background:#2563EB;color:#fff;text-decoration:none;padding:12px 18px;border-radius:10px;font-weight:700;display:inline-block\">Reset Password</a>\n          </div>\n          <p style=\"margin:0 0 8px 0;font-size:12px;color:#64748B\">If the button doesn't work, copy and paste this link:</p>\n          <p style=\"margin:0 0 18px 0;font-size:12px;word-break:break-all\"><a href=\"${link}\" style=\"color:#2563EB;text-decoration:none\">${link}</a></p>\n          <p style=\"margin:0;font-size:12px;color:#64748B\">If you didn't request this change, you can safely ignore this email.</p>\n        </td>\n      </tr>\n    </table>\n  </div>`\n  }\n}\n","import { Router } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\nimport { requireSuperAdmin } from '../middleware/super-admin.ts'\nimport { emailEnabled, renderApprovedEmail, sendMail } from '../utils/mailer.ts'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\nasync function isSuperAdmin(userId: string | null) {\n  if (!userId) return false\n  const adminEmail = String(process.env.SUPERADMIN_EMAIL || '').trim().toLowerCase()\n  if (!adminEmail) return false\n  const u = await prisma.user.findUnique({ where: { id: userId } })\n  return !!u && String(u.email).toLowerCase() === adminEmail\n}\n\nasync function isDeptLead(userId: string | null, deptId: string | null) {\n  if (!userId || !deptId) return false\n  const db: any = prisma\n  const dept = await db.department.findUnique({ where: { id: deptId } })\n  return !!dept && String(dept.leadId || '') === String(userId)\n}\n\n// List pending approvals (super admin sees all; dept leads see only their dept)\nrouter.get('/pending', async (req, res) => {\n  const actorId = (req as any).userId as string | null\n  if (!actorId) return res.status(401).json({ error: 'Authentication required' })\n  const superAdmin = await isSuperAdmin(actorId)\n  const db: any = prisma\n  const leadDepts: any[] = await db.department.findMany({ where: { leadId: actorId } })\n  const where: any = { status: 'PENDING' }\n  if (!superAdmin) {\n    if (!leadDepts.length) return res.json({ items: [], total: 0 })\n    where.requestedDepartmentId = { in: leadDepts.map(d => d.id) }\n  }\n  const rows = await db.approvalRequest.findMany({ where, include: { user: true }, orderBy: { submittedAt: 'asc' } })\n  const items = rows.map((r: any) => ({\n    id: r.id,\n    userId: r.userId,\n    name: (r as any).user?.name || '',\n    email: (r as any).user?.email || '',\n    requestedDepartmentId: r.requestedDepartmentId,\n    requestedRoleId: r.requestedRoleId,\n    status: r.status,\n    billable: r.billable,\n    submittedAt: r.submittedAt,\n  }))\n  res.json({ items, total: items.length })\n})\n\n// Approve a user\nrouter.post('/:userId/approve', async (req, res) => {\n  const actorId = (req as any).userId as string | null\n  if (!actorId) return res.status(401).json({ error: 'Authentication required' })\n  const body = z.object({\n    departmentId: z.string().min(1),\n    roleId: z.string().min(1),\n    active: z.coerce.boolean().default(true),\n    billable: z.coerce.boolean().optional(),\n    billRate: z.coerce.number().optional(),\n    costRate: z.coerce.number().optional(),\n    utilizationTarget: z.coerce.number().optional(),\n    skills: z.array(z.string()).optional(),\n    managerId: z.string().optional(),\n  }).parse(req.body || {})\n  if (actorId === req.params.userId) return res.status(403).json({ error: 'Self-approval is not allowed' })\n  const superAdmin = await isSuperAdmin(actorId)\n  const isLead = await isDeptLead(actorId, body.departmentId)\n  if (!(superAdmin || isLead)) return res.status(403).json({ error: 'Not authorized to approve for this department' })\n\n  try {\n    const user = await prisma.user.update({\n      where: { id: req.params.userId },\n      data: ({\n        departmentId: body.departmentId,\n        roleId: body.roleId,\n        isActive: body.active,\n        billable: body.billable ?? false,\n        billRate: body.billRate,\n        costRate: body.costRate,\n        utilizationTarget: body.utilizationTarget,\n        skills: body.skills as any,\n        managerId: body.managerId || null,\n      } as any),\n    })\n    await (prisma as any).approvalRequest.update({ where: { userId: req.params.userId }, data: { status: 'APPROVED', decidedById: actorId, decidedAt: new Date() } })\n    // Audit\n    const db: any = prisma\n    await db.adminAudit.create({ data: { adminId: actorId!, targetUserId: user.id, action: 'APPROVE_USER', details: `dept=${body.departmentId}, role=${body.roleId}, active=${body.active}` } })\n    // Send welcome/approved email\n    if (emailEnabled()) {\n      const clientBase = process.env.FRONTEND_BASE_URL || 'http://localhost:5173'\n      const { subject, html } = renderApprovedEmail(clientBase)\n      try { await sendMail(user.email, subject, html) } catch {}\n    }\n    res.json({ ok: true, id: user.id })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Approval failed' })\n  }\n})\n\n// Reject a user\nrouter.post('/:userId/reject', async (req, res) => {\n  const actorId = (req as any).userId as string | null\n  if (!actorId) return res.status(401).json({ error: 'Authentication required' })\n  const body = z.object({ reason: z.string().min(3) }).parse(req.body || {})\n  if (actorId === req.params.userId) return res.status(403).json({ error: 'Self-rejection is not allowed' })\n  const db: any = prisma\n  const ar = await (db as any).approvalRequest.findUnique({ where: { userId: req.params.userId } })\n  const superAdmin = await isSuperAdmin(actorId)\n  const isLead = await isDeptLead(actorId, ar?.requestedDepartmentId || null)\n  if (!(superAdmin || isLead)) return res.status(403).json({ error: 'Not authorized to reject' })\n  try {\n    await (prisma as any).approvalRequest.update({ where: { userId: req.params.userId }, data: { status: 'REJECTED', reason: body.reason, decidedById: actorId, decidedAt: new Date() } })\n    await prisma.user.update({ where: { id: req.params.userId }, data: ({ isActive: false } as any) })\n    await db.adminAudit.create({ data: { adminId: actorId!, targetUserId: req.params.userId, action: 'REJECT_USER', details: body.reason } })\n    res.json({ ok: true })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Reject failed' })\n  }\n})\n\nexport default router\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport axios from 'axios'\nimport crypto from 'crypto'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\nfunction baseUrl(req: Request) {\n  const proto = (req.headers['x-forwarded-proto'] as string) || req.protocol\n  const host = req.get('host')\n  return `${proto}://${host}`\n}\n\nfunction clientBaseUrl(req: Request) {\n  const envBase = process.env.FRONTEND_BASE_URL || process.env.APP_BASE_URL\n  if (envBase) return String(envBase).replace(/\\/+$/, '')\n  const origin = req.get('origin')\n  if (origin) return origin.replace(/\\/+$/, '')\n  // Fallback to typical dev port for Vite\n  const api = baseUrl(req)\n  try {\n    const u = new URL(api)\n    return `${u.protocol}//${u.hostname}:5173`\n  } catch {\n    return 'http://localhost:5173'\n  }\n}\n\n// --- Encryption helpers for storing sensitive secrets (ICS URLs) ---\n// Uses AES-256-GCM with key derived from CALENDAR_ENC_KEY\nfunction getEncKey(): Buffer {\n  const raw = process.env.CALENDAR_ENC_KEY || process.env.JWT_SECRET || 'dev-secret'\n  // derive 32-byte key\n  return crypto.createHash('sha256').update(String(raw)).digest()\n}\nfunction encrypt(text: string): string {\n  const key = getEncKey()\n  const iv = crypto.randomBytes(12)\n  const cipher = crypto.createCipheriv('aes-256-gcm', key, iv)\n  const enc = Buffer.concat([cipher.update(Buffer.from(String(text), 'utf8')), cipher.final()])\n  const tag = cipher.getAuthTag()\n  return Buffer.concat([iv, tag, enc]).toString('base64')\n}\nfunction decrypt(payload: string): string {\n  try {\n    const buf = Buffer.from(String(payload), 'base64')\n    const iv = buf.subarray(0, 12)\n    const tag = buf.subarray(12, 28)\n    const data = buf.subarray(28)\n    const key = getEncKey()\n    const decipher = crypto.createDecipheriv('aes-256-gcm', key, iv)\n    decipher.setAuthTag(tag)\n    const dec = Buffer.concat([decipher.update(data), decipher.final()])\n    return dec.toString('utf8')\n  } catch {\n    return ''\n  }\n}\n\nfunction normalizeIcsUrl(u: string): string {\n  if (!u) return ''\n  let s = String(u).trim()\n  if (s.toLowerCase().startsWith('webcal://')) s = 'https://' + s.slice(9)\n  if (s.toLowerCase().startsWith('webcals://')) s = 'https://' + s.slice(10)\n  return s\n}\n\n// Short-lived OAuth state storage\nasync function createOAuthStateRecord(userId: string, provider: 'GOOGLE' | 'MICROSOFT') {\n  const expiresAt = new Date(Date.now() + 15 * 60 * 1000)\n  return prisma.calendarOAuthState.create({ data: { userId, provider: provider as any, expiresAt, nextPath: '/calendar' } })\n}\nasync function consumeOAuthStateRecord(id?: string | null) {\n  if (!id) return null\n  const rec = await prisma.calendarOAuthState.findUnique({ where: { id } })\n  if (!rec) return null\n  if (rec.expiresAt && rec.expiresAt.getTime() < Date.now()) {\n    await prisma.calendarOAuthState.delete({ where: { id: rec.id } })\n    return null\n  }\n  await prisma.calendarOAuthState.delete({ where: { id: rec.id } })\n  return rec\n}\n\n// Authenticated session initiators to obtain redirect URLs (headers available)\nrouter.post('/google/session', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const redirectUri = process.env.GOOGLE_REDIRECT_URI || `${baseUrl(req)}/api/calendar/google/callback`\n  if (!clientId) return res.status(500).json({ error: 'Missing GOOGLE_CLIENT_ID' })\n  const st = await createOAuthStateRecord(userId, 'GOOGLE')\n  const scope = ['openid','email','profile','https://www.googleapis.com/auth/calendar.readonly'].join(' ')\n  const state = Buffer.from(JSON.stringify({ sid: st.id, next: '/calendar' }), 'utf8').toString('base64url')\n  const url = new URL('https://accounts.google.com/o/oauth2/v2/auth')\n  url.searchParams.set('client_id', clientId)\n  url.searchParams.set('redirect_uri', redirectUri)\n  url.searchParams.set('response_type', 'code')\n  url.searchParams.set('scope', scope)\n  url.searchParams.set('access_type', 'offline')\n  url.searchParams.set('include_granted_scopes', 'true')\n  url.searchParams.set('prompt', 'consent')\n  url.searchParams.set('state', state)\n  res.json({ redirectUrl: url.toString() })\n})\n\n// --- Google OAuth ---\nrouter.get('/google/connect', async (req: Request, res: Response) => {\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const redirectUri = process.env.GOOGLE_REDIRECT_URI || `${baseUrl(req)}/api/calendar/google/callback`\n  const scope = [\n    'openid',\n    'email',\n    'profile',\n    'https://www.googleapis.com/auth/calendar.readonly',\n  ].join(' ')\n  if (!clientId) return res.status(500).send('Missing GOOGLE_CLIENT_ID')\n  // Accept uid via query (since Authorization headers aren't sent on redirects)\n  const uid = (req.query.uid as string) || ''\n  const userId = (req as any).userId || uid || ''\n  const state = Buffer.from(JSON.stringify({ userId, next: '/calendar' }), 'utf8').toString('base64url')\n  const url = new URL('https://accounts.google.com/o/oauth2/v2/auth')\n  url.searchParams.set('client_id', clientId)\n  url.searchParams.set('redirect_uri', redirectUri)\n  url.searchParams.set('response_type', 'code')\n  url.searchParams.set('scope', scope)\n  url.searchParams.set('access_type', 'offline')\n  url.searchParams.set('include_granted_scopes', 'true')\n  url.searchParams.set('prompt', 'consent')\n  url.searchParams.set('state', state)\n  res.redirect(url.toString())\n})\n\nrouter.get('/google/callback', async (req: Request, res: Response) => {\n  const code = req.query.code as string\n  const stateRaw = (req.query.state as string) || ''\n  let state: any = {}\n  try { state = JSON.parse(Buffer.from(stateRaw, 'base64url').toString('utf8')) } catch {}\n  let userId: string | null = null\n  if (state?.sid) {\n    const rec = await consumeOAuthStateRecord(state.sid)\n    userId = rec?.userId || null\n  } else {\n    const resolved = await resolveUserId(req)\n    userId = resolved || state?.userId || (req.query.uid as string) || null\n  }\n  if (!code) return res.status(400).send('Missing code')\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET\n  const redirectUri = process.env.GOOGLE_REDIRECT_URI || `${baseUrl(req)}/api/calendar/google/callback`\n  if (!clientId || !clientSecret) return res.status(500).send('Missing Google client credentials')\n  try {\n    if (!userId) return res.status(401).send('No user context; please log in and retry')\n    const tokenRes = await axios.post('https://oauth2.googleapis.com/token', new URLSearchParams({\n      code,\n      client_id: clientId,\n      client_secret: clientSecret,\n      redirect_uri: redirectUri,\n      grant_type: 'authorization_code',\n    }), { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })\n    const { access_token, refresh_token, expires_in, id_token, scope } = tokenRes.data || {}\n\n    // Extract email from id_token if present\n    let email = ''\n    if (id_token) {\n      try {\n        const payload = JSON.parse(Buffer.from(String(id_token).split('.')[1], 'base64').toString('utf8'))\n        email = String(payload?.email || '')\n      } catch {}\n    }\n    // Fallback: call userinfo\n    if (!email && access_token) {\n      try {\n        const uinfo = await axios.get('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${access_token}` } })\n        email = String(uinfo.data?.email || '')\n      } catch {}\n    }\n    const now = Date.now()\n    const expiresAt = expires_in ? new Date(now + Number(expires_in) * 1000) : null\n    // Verify user exists\n    const exists = await prisma.user.findUnique({ where: { id: userId } })\n    if (!exists) return res.status(400).send('User not found; ensure you are logged in')\n    await prisma.calendarAccount.upsert({\n      where: { userId_provider_email: { userId, provider: 'GOOGLE', email: email || 'unknown' } as any },\n      update: { accessToken: access_token, refreshToken: refresh_token || '', expiresAt: expiresAt as any, scope },\n      create: { id: undefined as any, userId, provider: 'GOOGLE' as any, email: email || 'unknown', accessToken: access_token, refreshToken: refresh_token || '', expiresAt: expiresAt as any, scope },\n    })\n    const nextPath = state?.next || '/calendar'\n    const clientBase = clientBaseUrl(req)\n    res.redirect(`${clientBase}${nextPath}`)\n  } catch (e: any) {\n    res.status(400).send(e?.response?.data || e?.message || 'Google OAuth failed')\n  }\n})\n\nasync function ensureGoogleToken(account: any, clientId: string, clientSecret: string) {\n  if (!account?.refreshToken) return account\n  const now = new Date()\n  if (account.expiresAt && new Date(account.expiresAt) > new Date(now.getTime() + 60_000)) return account\n  const params = new URLSearchParams({\n    client_id: clientId,\n    client_secret: clientSecret,\n    grant_type: 'refresh_token',\n    refresh_token: account.refreshToken,\n  })\n  const tokenRes = await axios.post('https://oauth2.googleapis.com/token', params, { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })\n  const { access_token, expires_in } = tokenRes.data || {}\n  const expiresAt = expires_in ? new Date(Date.now() + Number(expires_in) * 1000) : null\n  const updated = await prisma.calendarAccount.update({ where: { id: account.id }, data: { accessToken: access_token, expiresAt } })\n  return updated\n}\n\nrouter.get('/google/events', async (req: Request, res: Response) => {\n  const userId = (req as any).userId\n  if (!userId) return res.status(401).json({ error: 'x-user-id or Bearer token required' })\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET\n  if (!clientId || !clientSecret) return res.status(500).json({ error: 'Missing Google client credentials' })\n  const account = await prisma.calendarAccount.findFirst({ where: { userId, provider: 'GOOGLE' as any } })\n  if (!account) return res.status(200).json([])\n  try {\n    const acc = await ensureGoogleToken(account, clientId, clientSecret)\n    const now = new Date()\n    const timeMin = new Date(now.getTime() - 30 * 24 * 3600 * 1000).toISOString()\n    const timeMax = new Date(now.getTime() + 90 * 24 * 3600 * 1000).toISOString()\n    const eventsRes = await axios.get('https://www.googleapis.com/calendar/v3/calendars/primary/events', {\n      headers: { Authorization: `Bearer ${acc.accessToken}` },\n      params: { maxResults: 2500, singleEvents: true, orderBy: 'startTime', timeMin, timeMax },\n    })\n    res.json(Array.isArray(eventsRes.data?.items) ? eventsRes.data.items : [])\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to fetch Google events' })\n  }\n})\n\n// --- Microsoft OAuth (MS Graph) ---\nrouter.post('/microsoft/session', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const clientId = process.env.MS_CLIENT_ID\n  const tenant = process.env.MS_TENANT || 'common'\n  const redirectUri = process.env.MS_REDIRECT_URI || `${baseUrl(req)}/api/calendar/microsoft/callback`\n  if (!clientId) return res.status(500).json({ error: 'Missing MS_CLIENT_ID' })\n  const st = await createOAuthStateRecord(userId, 'MICROSOFT')\n  const state = Buffer.from(JSON.stringify({ sid: st.id, next: '/calendar' }), 'utf8').toString('base64url')\n  const url = new URL(`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/authorize`)\n  url.searchParams.set('client_id', clientId)\n  url.searchParams.set('response_type', 'code')\n  url.searchParams.set('redirect_uri', redirectUri)\n  url.searchParams.set('response_mode', 'query')\n  url.searchParams.set('scope', ['offline_access', 'User.Read', 'Calendars.Read'].join(' '))\n  url.searchParams.set('state', state)\n  res.json({ redirectUrl: url.toString() })\n})\nrouter.get('/microsoft/connect', async (req: Request, res: Response) => {\n  const clientId = process.env.MS_CLIENT_ID\n  const tenant = process.env.MS_TENANT || 'common'\n  const redirectUri = process.env.MS_REDIRECT_URI || `${baseUrl(req)}/api/calendar/microsoft/callback`\n  if (!clientId) return res.status(500).send('Missing MS_CLIENT_ID')\n  const uid = (req.query.uid as string) || ''\n  const userId = (req as any).userId || uid || ''\n  const state = Buffer.from(JSON.stringify({ userId, next: '/calendar' }), 'utf8').toString('base64url')\n  const url = new URL(`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/authorize`)\n  url.searchParams.set('client_id', clientId)\n  url.searchParams.set('response_type', 'code')\n  url.searchParams.set('redirect_uri', redirectUri)\n  url.searchParams.set('response_mode', 'query')\n  url.searchParams.set('scope', ['offline_access', 'User.Read', 'Calendars.Read'].join(' '))\n  url.searchParams.set('state', state)\n  res.redirect(url.toString())\n})\n\nrouter.get('/microsoft/callback', async (req: Request, res: Response) => {\n  const code = req.query.code as string\n  const stateRaw = (req.query.state as string) || ''\n  let state: any = {}\n  try { state = JSON.parse(Buffer.from(stateRaw, 'base64url').toString('utf8')) } catch {}\n  let userId: string | null = null\n  if (state?.sid) {\n    const rec = await consumeOAuthStateRecord(state.sid)\n    userId = rec?.userId || null\n  } else {\n    const resolved = await resolveUserId(req)\n    userId = resolved || state?.userId || (req.query.uid as string) || null\n  }\n  if (!code) return res.status(400).send('Missing code')\n  const clientId = process.env.MS_CLIENT_ID\n  const clientSecret = process.env.MS_CLIENT_SECRET\n  const tenant = process.env.MS_TENANT || 'common'\n  const redirectUri = process.env.MS_REDIRECT_URI || `${baseUrl(req)}/api/calendar/microsoft/callback`\n  if (!clientId || !clientSecret) return res.status(500).send('Missing Microsoft client credentials')\n  try {\n    const tokenRes = await axios.post(`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/token`, new URLSearchParams({\n      client_id: clientId,\n      client_secret: clientSecret,\n      grant_type: 'authorization_code',\n      code,\n      redirect_uri: redirectUri,\n      scope: ['offline_access', 'User.Read', 'Calendars.Read'].join(' '),\n    }), { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })\n    const { access_token, refresh_token, expires_in } = tokenRes.data || {}\n\n    // Get user email\n    let email = ''\n    try {\n      const meRes = await axios.get('https://graph.microsoft.com/v1.0/me', { headers: { Authorization: `Bearer ${access_token}` } })\n      email = String(meRes.data?.mail || meRes.data?.userPrincipalName || '')\n    } catch {}\n    const expiresAt = expires_in ? new Date(Date.now() + Number(expires_in) * 1000) : null\n    if (!userId) return res.status(401).send('No user context; please log in and retry')\n    const exists = await prisma.user.findUnique({ where: { id: userId } })\n    if (!exists) return res.status(400).send('User not found; ensure you are logged in')\n    await prisma.calendarAccount.upsert({\n      where: { userId_provider_email: { userId, provider: 'MICROSOFT', email: email || 'unknown' } as any },\n      update: { accessToken: access_token, refreshToken: refresh_token || '', expiresAt: expiresAt as any, scope: 'User.Read Calendars.Read offline_access' },\n      create: { id: undefined as any, userId, provider: 'MICROSOFT' as any, email: email || 'unknown', accessToken: access_token, refreshToken: refresh_token || '', expiresAt: expiresAt as any, scope: 'User.Read Calendars.Read offline_access' },\n    })\n    const nextPath = state?.next || '/calendar'\n    const clientBase = clientBaseUrl(req)\n    res.redirect(`${clientBase}${nextPath}`)\n  } catch (e: any) {\n    res.status(400).send(e?.response?.data || e?.message || 'Microsoft OAuth failed')\n  }\n})\n\nasync function ensureMsToken(account: any, tenant: string, clientId: string, clientSecret: string) {\n  if (!account?.refreshToken) return account\n  const now = new Date()\n  if (account.expiresAt && new Date(account.expiresAt) > new Date(now.getTime() + 60_000)) return account\n  const params = new URLSearchParams({\n    client_id: clientId,\n    client_secret: clientSecret,\n    grant_type: 'refresh_token',\n    refresh_token: account.refreshToken,\n    scope: 'offline_access User.Read Calendars.Read',\n  })\n  const tokenRes = await axios.post(`https://login.microsoftonline.com/${tenant}/oauth2/v2.0/token`, params, { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })\n  const { access_token, expires_in } = tokenRes.data || {}\n  const expiresAt = expires_in ? new Date(Date.now() + Number(expires_in) * 1000) : null\n  const updated = await prisma.calendarAccount.update({ where: { id: account.id }, data: { accessToken: access_token, expiresAt } })\n  return updated\n}\n\nrouter.get('/microsoft/events', async (req: Request, res: Response) => {\n  const userId = (req as any).userId\n  if (!userId) return res.status(401).json({ error: 'x-user-id or Bearer token required' })\n  const clientId = process.env.MS_CLIENT_ID\n  const clientSecret = process.env.MS_CLIENT_SECRET\n  const tenant = process.env.MS_TENANT || 'common'\n  if (!clientId || !clientSecret) return res.status(500).json({ error: 'Missing Microsoft client credentials' })\n  const account = await prisma.calendarAccount.findFirst({ where: { userId, provider: 'MICROSOFT' as any } })\n  if (!account) return res.status(200).json([])\n  try {\n    const acc = await ensureMsToken(account, tenant, clientId, clientSecret)\n    // Pull events window: past 30 days to next 90 days\n    const start = new Date(Date.now() - 30 * 24 * 3600 * 1000).toISOString()\n    const end = new Date(Date.now() + 90 * 24 * 3600 * 1000).toISOString()\n    const eventsRes = await axios.get('https://graph.microsoft.com/v1.0/me/calendarView', {\n      headers: { Authorization: `Bearer ${acc.accessToken}` },\n      params: { startDateTime: start, endDateTime: end, '$top': 1000, '$orderby': 'start/dateTime' },\n    })\n    res.json(Array.isArray(eventsRes.data?.value) ? eventsRes.data.value : [])\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to fetch Microsoft events' })\n  }\n})\n\n// Resolve an effective userId from token, header, or DEV_USER_ID, ensuring it exists\nasync function resolveUserId(req: Request): Promise<string | null> {\n  const primary = (req as any).userId as string | null\n  if (primary) {\n    const u = await prisma.user.findUnique({ where: { id: primary } })\n    if (u) return primary\n  }\n  const headerId = req.header('x-user-id') || null\n  if (headerId) {\n    const u = await prisma.user.findUnique({ where: { id: headerId } })\n    if (u) return headerId\n  }\n  const dev = process.env.DEV_USER_ID || null\n  if (dev) {\n    const u = await prisma.user.findUnique({ where: { id: dev } })\n    if (u) return dev\n  }\n  return null\n}\n\n// List linked calendar accounts for the current user\nrouter.get('/accounts', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'User not found; ensure you are logged in or DEV_USER_ID is valid.' })\n  const accts = await prisma.calendarAccount.findMany({\n    where: { userId },\n    select: { id: true, provider: true, email: true, updatedAt: true, createdAt: true, expiresAt: true },\n    orderBy: { createdAt: 'desc' },\n  })\n  res.json(accts)\n})\n\n// --- Per-user ICS URL sources (persisted) ---\nrouter.get('/sources', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'User not found; ensure you are logged in or DEV_USER_ID is valid.' })\n  const sources = await prisma.calendarSource.findMany({ where: { userId }, orderBy: { createdAt: 'desc' } })\n  // Never expose URL to client\n  res.json(sources.map(s => ({ id: s.id, type: s.type, name: s.name, color: s.color, enabled: s.enabled, createdAt: s.createdAt, updatedAt: s.updatedAt })))\n})\n\nrouter.post('/sources', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'User not found; ensure you are logged in or DEV_USER_ID is valid.' })\n  const { name, url, color, enabled } = req.body || {}\n  if (!name || !url) return res.status(400).json({ error: 'name and url are required' })\n  try {\n    const normalized = normalizeIcsUrl(String(url))\n    if (!/^https?:\\/\\//i.test(normalized)) return res.status(400).json({ error: 'Invalid ICS URL (must start with http/https or webcal/webcals)' })\n    const created = await prisma.calendarSource.create({\n      data: { userId, type: 'ICS_URL' as any, name, url: encrypt(normalized), color: color || '#10b981', enabled: enabled ?? true },\n    })\n    res.status(201).json({ id: created.id, type: created.type, name: created.name, color: created.color, enabled: created.enabled, createdAt: created.createdAt, updatedAt: created.updatedAt })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to create source' })\n  }\n})\n\nrouter.patch('/sources/:id', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'User not found; ensure you are logged in or DEV_USER_ID is valid.' })\n  const id = req.params.id\n  const { name, url, color, enabled } = req.body || {}\n  try {\n    // Ensure ownership\n    const src = await prisma.calendarSource.findUnique({ where: { id } })\n    if (!src || src.userId !== userId) return res.status(404).json({ error: 'Not found' })\n    const data: any = {}\n    if (name !== undefined) data.name = name\n    if (color !== undefined) data.color = color\n    if (enabled !== undefined) data.enabled = enabled\n    if (url !== undefined) {\n      const normalized = normalizeIcsUrl(String(url))\n      if (!/^https?:\\/\\//i.test(normalized)) return res.status(400).json({ error: 'Invalid ICS URL (must start with http/https or webcal/webcals)' })\n      data.url = encrypt(normalized)\n    }\n    const updated = await prisma.calendarSource.update({ where: { id }, data })\n    res.json({ id: updated.id, type: updated.type, name: updated.name, color: updated.color, enabled: updated.enabled, createdAt: updated.createdAt, updatedAt: updated.updatedAt })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to update source' })\n  }\n})\n\nrouter.delete('/sources/:id', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'User not found; ensure you are logged in or DEV_USER_ID is valid.' })\n  const id = req.params.id\n  try {\n    const src = await prisma.calendarSource.findUnique({ where: { id } })\n    if (!src || src.userId !== userId) return res.status(404).json({ error: 'Not found' })\n    await prisma.calendarSource.delete({ where: { id } })\n    res.status(204).end()\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to delete source' })\n  }\n})\n\n// Fetch and parse events for a given ICS source (server-side fetch; never expose URL)\nrouter.get('/sources/:id/events', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'User not found; ensure you are logged in or DEV_USER_ID is valid.' })\n  const id = req.params.id\n  const src = await prisma.calendarSource.findUnique({ where: { id } })\n  if (!src || src.userId !== userId) return res.status(404).json({ error: 'Not found' })\n  try {\n    const icsUrl = normalizeIcsUrl(decrypt(src.url))\n    if (!/^https?:\\/\\//i.test(icsUrl)) return res.status(400).json({ error: 'Invalid or undecryptable ICS URL' })\n    const r = await axios.get(icsUrl, { responseType: 'text', timeout: 15000, headers: { 'User-Agent': 'ProjectHubCalendar/1.0' } })\n    const text = String(r.data || '')\n    const events = parseICS(text, src.name)\n    res.json(events)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to load ICS events' })\n  }\n})\n\nexport default router\n\n// Lightweight ICS proxy to avoid browser CORS when fetching external calendars\nrouter.get('/ics', async (req: Request, res: Response) => {\n  try {\n    const url = String(req.query.url || req.query.u || '')\n    if (!url) return res.status(400).send('Missing url')\n    const parsed = new URL(url)\n    if (!/^https?:$/i.test(parsed.protocol)) return res.status(400).send('Only http/https supported')\n\n    const r = await axios.get(url, { responseType: 'text', timeout: 15000, headers: { 'User-Agent': 'ProjectHubCalendar/1.0' } })\n    // Force text/calendar so the client can parse\n    res.setHeader('Content-Type', 'text/calendar; charset=utf-8')\n    res.status(200).send(typeof r.data === 'string' ? r.data : String(r.data || ''))\n  } catch (e: any) {\n    res.status(400).send(e?.response?.statusText || e?.message || 'Failed to fetch ICS')\n  }\n})\n\n// Public holidays provider: prefers RapidAPI when configured, otherwise falls back to HolidayAPI.com\nrouter.get('/holidays', async (req: Request, res: Response) => {\n  try {\n    const country = String(req.query.country || process.env.HOLIDAY_DEFAULT_COUNTRY || 'US').toUpperCase()\n    const year = Number(req.query.year || new Date().getFullYear())\n    const month = req.query.month ? Number(req.query.month) : undefined\n\n    // Prefer RapidAPI if both key and host are provided\n    const rapidKey = process.env.RAPIDAPI_KEY || ''\n    const rapidHost = process.env.RAPIDAPI_HOLIDAYS_HOST || ''\n    if (rapidKey && rapidHost) {\n      try {\n        // Nager.Date via RapidAPI: GET /PublicHolidays/{year}/{country}\n        const url = new URL(`https://${rapidHost}/PublicHolidays/${year}/${country}`)\n        const r = await axios.get(url.toString(), {\n          timeout: 15000,\n          headers: { 'X-RapidAPI-Key': rapidKey, 'X-RapidAPI-Host': rapidHost },\n        })\n        const items: any[] = Array.isArray(r.data) ? r.data : []\n        const filtered = (month && month >= 1 && month <= 12)\n          ? items.filter((h: any) => {\n              const d = String(h?.date || '').slice(0, 10)\n              const m = Number(d.slice(5, 7))\n              return m === month\n            })\n          : items\n        const events = filtered.map((h: any) => {\n          const date = String(h?.date || '').slice(0, 10)\n          const name = String(h?.localName || h?.name || 'Public Holiday')\n          const types = Array.isArray(h?.types) ? h.types.join(', ') : (h?.type || 'Public holiday')\n          return {\n            id: `holiday-${country}-${date}-${(name).replace(/\\s+/g,'-').toLowerCase()}`,\n            title: name,\n            description: types,\n            type: 'reminder',\n            startTime: '00:00',\n            endTime: '23:59',\n            date,\n            priority: 'low',\n            status: 'scheduled',\n            createdBy: 'Public Holidays',\n            createdAt: new Date().toISOString(),\n          }\n        })\n        return res.json(events)\n      } catch (err) {\n        // Fallback to Nager.Date official API if RapidAPI call fails (subscription/limits)\n        try {\n          const url2 = new URL(`https://date.nager.at/api/v3/PublicHolidays/${year}/${country}`)\n          const r2 = await axios.get(url2.toString(), { timeout: 15000 })\n          const items: any[] = Array.isArray(r2.data) ? r2.data : []\n          const filtered = (month && month >= 1 && month <= 12)\n            ? items.filter((h: any) => {\n                const d = String(h?.date || '').slice(0, 10)\n                const m = Number(d.slice(5, 7))\n                return m === month\n              })\n            : items\n          const events = filtered.map((h: any) => ({\n            id: `holiday-${country}-${String(h.date).slice(0,10)}-${String(h.localName || h.name).replace(/\\s+/g,'-').toLowerCase()}`,\n            title: String(h.localName || h.name || 'Public Holiday'),\n            description: Array.isArray(h.types) ? h.types.join(', ') : (h.type || 'Public holiday'),\n            type: 'reminder',\n            startTime: '00:00',\n            endTime: '23:59',\n            date: String(h.date).slice(0,10),\n            priority: 'low',\n            status: 'scheduled',\n            createdBy: 'Public Holidays',\n            createdAt: new Date().toISOString(),\n          }))\n          return res.json(events)\n        } catch {}\n      }\n    }\n\n    // Fallback: HolidayAPI.com (requires HOLIDAY_API_KEY)\n    const key = process.env.HOLIDAY_API_KEY || ''\n    if (!key) {\n      // As a final fallback when no keys are configured at all, try Nager.Date official API directly\n      try {\n        const url2 = new URL(`https://date.nager.at/api/v3/PublicHolidays/${year}/${country}`)\n        const r2 = await axios.get(url2.toString(), { timeout: 15000 })\n        const items: any[] = Array.isArray(r2.data) ? r2.data : []\n        const filtered = (month && month >= 1 && month <= 12)\n          ? items.filter((h: any) => {\n              const d = String(h?.date || '').slice(0, 10)\n              const m = Number(d.slice(5, 7))\n              return m === month\n            })\n          : items\n        const events = filtered.map((h: any) => ({\n          id: `holiday-${country}-${String(h.date).slice(0,10)}-${String(h.localName || h.name).replace(/\\s+/g,'-').toLowerCase()}`,\n          title: String(h.localName || h.name || 'Public Holiday'),\n          description: Array.isArray(h.types) ? h.types.join(', ') : (h.type || 'Public holiday'),\n          type: 'reminder',\n          startTime: '00:00',\n          endTime: '23:59',\n          date: String(h.date).slice(0,10),\n          priority: 'low',\n          status: 'scheduled',\n          createdBy: 'Public Holidays',\n          createdAt: new Date().toISOString(),\n        }))\n        return res.json(events)\n      } catch {}\n      return res.status(200).json([])\n    }\n    const language = String(req.query.language || 'en')\n    const url = new URL('https://holidayapi.com/v1/holidays')\n    url.searchParams.set('key', key)\n    url.searchParams.set('country', country)\n    url.searchParams.set('year', String(year))\n    url.searchParams.set('public', 'true')\n    url.searchParams.set('language', language)\n    if (month && month >= 1 && month <= 12) url.searchParams.set('month', String(month))\n    const r = await axios.get(url.toString(), { timeout: 15000 })\n    const items: any[] = Array.isArray(r.data?.holidays) ? r.data.holidays : []\n    const events = items.map((h: any) => {\n      const date = String(h?.date || '').slice(0, 10)\n      const name = String(h?.name || 'Public Holiday')\n      return {\n        id: `holiday-${country}-${date}-${(h?.uuid || name).replace(/\\s+/g,'-').toLowerCase()}`,\n        title: name,\n        description: String(h?.type?.join?.(', ') || 'Public holiday'),\n        type: 'reminder',\n        startTime: '00:00',\n        endTime: '23:59',\n        date,\n        priority: 'low',\n        status: 'scheduled',\n        createdBy: 'HolidayAPI',\n        createdAt: new Date().toISOString(),\n      }\n    })\n    return res.json(events)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to load holidays' })\n  }\n})\n\n// --- Minimal ICS parser (shared logic with frontend, sanitized) ---\nfunction parseICS(text: string, sourceName: string) {\n  const rawLines = text.split(/\\r?\\n/)\n  const lines: string[] = []\n  for (let i = 0; i < rawLines.length; i++) {\n    const l = rawLines[i]\n    if (l.startsWith(' ') && lines.length > 0) lines[lines.length - 1] += l.slice(1)\n    else lines.push(l)\n  }\n  const out: any[] = []\n  let cursor: Record<string, string> | null = null\n  for (const l of lines) {\n    if (l.startsWith('BEGIN:VEVENT')) cursor = {}\n    else if (l.startsWith('END:VEVENT')) {\n      if (cursor) {\n        const uid = cursor['UID'] || Math.random().toString(36).slice(2)\n        const summary = cursor['SUMMARY'] || '(No title)'\n        const descRaw = (cursor['DESCRIPTION'] || '').replace(/\\\\n/g, '\\n')\n        const dtstart = cursor['DTSTART'] || cursor['DTSTART;VALUE=DATE'] || ''\n        const dtend = cursor['DTEND'] || cursor['DTEND;VALUE=DATE'] || ''\n        const st = parseIcsDate(dtstart)\n        const et = parseIcsDate(dtend || dtstart)\n        const location = cursor['LOCATION'] || ''\n        const urlProp = cursor['URL'] || ''\n        const all = `${urlProp}\\n${descRaw}\\n${location}`\n        const urls = (all.match(/https?:\\/\\/\\S+/g) || []) as string[]\n        const firstUrl = urls.find(u => u.toLowerCase().includes('teams.microsoft'))\n          || urls.find(u => u.toLowerCase().includes('zoom.us'))\n          || urls.find(u => u.toLowerCase().includes('meet.google.com'))\n          || urls[0]\n        const platform = detectPlatform(firstUrl)\n        const isAllDay = /VALUE=DATE/i.test(dtstart || '')\n        const type = firstUrl ? 'meeting' : (isAllDay ? 'reminder' : 'task')\n        out.push({\n          id: `ics-${uid}`,\n          title: summary,\n          description: stripUrls(descRaw),\n          type,\n          startTime: st.time,\n          endTime: et.time || st.time,\n          date: st.date,\n          priority: 'medium',\n          status: 'scheduled',\n          platform,\n          meetingLink: firstUrl,\n          attendees: [],\n          createdBy: sourceName,\n          createdAt: new Date().toISOString(),\n        })\n      }\n      cursor = null\n    } else if (cursor) {\n      const idx = l.indexOf(':')\n      if (idx > 0) {\n        const key = l.slice(0, idx).split(';')[0].toUpperCase()\n        const value = l.slice(idx + 1)\n        cursor[key] = value\n      }\n    }\n  }\n  return out\n}\n\nfunction parseIcsDate(val: string): { date: string; time: string } {\n  const m = String(val || '')\n  const datePart = m.slice(0, 8)\n  const year = datePart.slice(0, 4)\n  const month = datePart.slice(4, 6)\n  const day = datePart.slice(6, 8)\n  const date = `${year}-${month}-${day}`\n  let time = '00:00'\n  if (m.length >= 15 && m[8] === 'T') time = `${m.slice(9, 11)}:${m.slice(11, 13)}`\n  return { date, time }\n}\nfunction stripUrls(s: string): string {\n  return String(s || '').replace(/https?:\\/\\/\\S+/g, '').replace(/[ \\t]+\\n/g, '\\n').replace(/\\n{3,}/g, '\\n\\n').trim()\n}\nfunction detectPlatform(u?: string) {\n  const s = String(u || '').toLowerCase()\n  if (s.includes('aka.ms/jointeams')) return 'teams'\n  if (s.includes('teams.microsoft')) return 'teams'\n  if (s.includes('zoom.us')) return 'zoom'\n  if (s.includes('meet.google.com')) return 'google-meet'\n  return undefined\n}\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport axios from 'axios'\n// PDF text extractor (no official types)\n// eslint-disable-next-line @typescript-eslint/ban-ts-comment\n// @ts-ignore\nimport { extractAmount } from '../utils/slip-extract.ts'\n\nconst prisma = new PrismaClient()\nconst db: any = prisma\nconst router = Router()\n\nfunction baseUrl(req: Request) {\n  const proto = (req.headers['x-forwarded-proto'] as string) || req.protocol\n  const host = req.get('host')\n  return `${proto}://${host}`\n}\n\nfunction clientBaseUrl(req: Request) {\n  const envBase = process.env.FRONTEND_BASE_URL || process.env.APP_BASE_URL\n  if (envBase) return String(envBase).replace(/\\/+$/, '')\n  const origin = req.get('origin')\n  if (origin) return origin.replace(/\\/+$/, '')\n  // Fallback to typical dev port for Vite\n  const api = baseUrl(req)\n  try {\n    const u = new URL(api)\n    return `${u.protocol}//${u.hostname}:5173`\n  } catch {\n    return 'http://localhost:5173'\n  }\n}\n\nasync function resolveUserId(req: Request): Promise<string | null> {\n  const userId = (req as any).userId || null\n  if (!userId) return null\n  const user = await prisma.user.findUnique({ where: { id: String(userId) } })\n  return user ? user.id : null\n}\n\nasync function ensureGoogleToken(account: any, clientId: string, clientSecret: string) {\n  if (!account?.refreshToken) return account\n  const now = new Date()\n  if (account.expiresAt && new Date(account.expiresAt) > new Date(now.getTime() + 60_000)) return account\n  const params = new URLSearchParams({\n    client_id: clientId,\n    client_secret: clientSecret,\n    grant_type: 'refresh_token',\n    refresh_token: account.refreshToken,\n  })\n  const tokenRes = await axios.post('https://oauth2.googleapis.com/token', params, { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })\n  const { access_token, expires_in } = tokenRes.data || {}\n  const expiresAt = expires_in ? new Date(Date.now() + Number(expires_in) * 1000) : null\n  const updated = await prisma.calendarAccount.update({ where: { id: account.id }, data: { accessToken: access_token, expiresAt } })\n  return updated\n}\n\n// Begin OAuth session: return a redirect URL\nrouter.post('/google/session', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const redirectUri = process.env.GMAIL_REDIRECT_URI || `${baseUrl(req)}/api/gmail/google/callback`\n  if (!clientId) return res.status(500).json({ error: 'Missing GOOGLE_CLIENT_ID' })\n  const scope = [\n    'openid',\n    'email',\n    'profile',\n    'https://www.googleapis.com/auth/gmail.readonly',\n    'https://www.googleapis.com/auth/gmail.send',\n  ].join(' ')\n  const state = Buffer.from(JSON.stringify({ userId, next: '/slips-invoices' }), 'utf8').toString('base64url')\n  const url = new URL('https://accounts.google.com/o/oauth2/v2/auth')\n  url.searchParams.set('client_id', clientId)\n  url.searchParams.set('redirect_uri', redirectUri)\n  url.searchParams.set('response_type', 'code')\n  url.searchParams.set('scope', scope)\n  url.searchParams.set('access_type', 'offline')\n  url.searchParams.set('include_granted_scopes', 'true')\n  url.searchParams.set('prompt', 'consent')\n  url.searchParams.set('state', state)\n  res.json({ redirectUrl: url.toString() })\n})\n\n// OAuth callback\nrouter.get('/google/callback', async (req: Request, res: Response) => {\n  const code = req.query.code as string\n  const stateRaw = (req.query.state as string) || ''\n  let state: any = {}\n  try { state = JSON.parse(Buffer.from(stateRaw, 'base64url').toString('utf8')) } catch {}\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET\n  const redirectUri = process.env.GMAIL_REDIRECT_URI || `${baseUrl(req)}/api/gmail/google/callback`\n  if (!clientId || !clientSecret) return res.status(500).send('Missing Google client credentials')\n  try {\n    const userId = state?.userId || (await resolveUserId(req))\n    if (!userId) return res.status(401).send('No user context; please log in and retry')\n    const tokenRes = await axios.post('https://oauth2.googleapis.com/token', new URLSearchParams({\n      code,\n      client_id: clientId,\n      client_secret: clientSecret,\n      redirect_uri: redirectUri,\n      grant_type: 'authorization_code',\n    }), { headers: { 'Content-Type': 'application/x-www-form-urlencoded' } })\n    const { access_token, refresh_token, expires_in, id_token, scope } = tokenRes.data || {}\n\n    // Extract email\n    let email = ''\n    if (id_token) {\n      try {\n        const payload = JSON.parse(Buffer.from(String(id_token).split('.')[1], 'base64').toString('utf8'))\n        email = String(payload?.email || '')\n      } catch {}\n    }\n    if (!email && access_token) {\n      try {\n        const uinfo = await axios.get('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: `Bearer ${access_token}` } })\n        email = String(uinfo.data?.email || '')\n      } catch {}\n    }\n\n    const expiresAt = expires_in ? new Date(Date.now() + Number(expires_in) * 1000) : null\n    // Upsert into CalendarAccount as provider GOOGLE; reuse same table\n    await prisma.calendarAccount.upsert({\n      where: { userId_provider_email: { userId, provider: 'GOOGLE' as any, email: email || 'unknown' } as any },\n      update: { accessToken: access_token, refreshToken: refresh_token || '', expiresAt: expiresAt as any, scope },\n      create: { id: undefined as any, userId, provider: 'GOOGLE' as any, email: email || 'unknown', accessToken: access_token, refreshToken: refresh_token || '', expiresAt: expiresAt as any, scope },\n    })\n    const clientBase = clientBaseUrl(req)\n    const nextPath = state?.next || '/slips-invoices'\n    res.redirect(`${clientBase}${nextPath}`)\n  } catch (e: any) {\n    res.status(400).send(e?.response?.data || e?.message || 'Google OAuth failed')\n  }\n})\n\n// Connection status\nrouter.get('/status', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.json({ connected: false })\n  const acc = await prisma.calendarAccount.findFirst({ where: { userId, provider: 'GOOGLE' as any } })\n  res.json({ connected: !!acc, email: acc?.email || null, scope: acc?.scope || null })\n})\n\n// Send an invoice email via Gmail\nrouter.post('/send', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const { to, subject, html, text, template, invoice } = req.body || {}\n  if (!to || !subject || (!html && !text)) return res.status(400).json({ error: 'Missing to/subject/body' })\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET\n  if (!clientId || !clientSecret) return res.status(500).json({ error: 'Missing Google client credentials' })\n  const acc = await prisma.calendarAccount.findFirst({ where: { userId, provider: 'GOOGLE' as any } })\n  if (!acc) return res.status(400).json({ error: 'Google not connected' })\n  const scope = String(acc.scope || '')\n  if (!/gmail\\.send/.test(scope)) {\n    return res.status(409).json({ error: 'Gmail send scope not granted. Please connect Gmail.', scope })\n  }\n  try {\n    const tokenAcc = await ensureGoogleToken(acc, clientId, clientSecret)\n\n    function invoiceHtml(i: any): string {\n      const invNo = String(i?.invoiceNo || '')\n      const project = String(i?.projectName || '')\n      const phase = String(i?.phaseName || '')\n      const clientName = String(i?.clientName || '')\n      const issueDate = i?.issueDate ? new Date(i.issueDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : ''\n      const dueDate = i?.dueDate ? new Date(i.dueDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }) : ''\n      const currency = String(i?.currency || 'USD')\n      const totalNum = Number(i?.total || 0)\n      const totalFmt = new Intl.NumberFormat('en-US', { style: 'currency', currency }).format(totalNum)\n      const desc = String(i?.description || 'Project work')\n      return `<!doctype html><html><body style=\"margin:0;background:#0b1220;font-family:Arial,Helvetica,sans-serif;color:#e5e7eb;\">\n        <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"padding:16px;background:#0b1220;\">\n          <tr><td align=\"center\">\n            <table role=\"presentation\" width=\"680\" cellspacing=\"0\" cellpadding=\"0\" style=\"max-width:680px;background:#111827;border-radius:14px;overflow:hidden;border:1px solid #1f2937;\">\n              <tr>\n                <td style=\"background:#0ea5e9;color:#fff;padding:22px 24px;font-size:22px;font-weight:800;letter-spacing:.3px;\">\n                  Invoice ${invNo}\n                </td>\n              </tr>\n              <tr>\n                <td style=\"padding:22px 24px;\">\n                  <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"background:#1f2937;border-radius:12px;padding:18px;\">\n                    <tr><td style=\"color:#93c5fd;font-weight:700;padding-bottom:4px;\">Project:</td><td style=\"text-align:right;color:#e5e7eb;\">${project}</td></tr>\n                    <tr><td style=\"color:#93c5fd;font-weight:700;padding:6px 0 4px;\">Phase:</td><td style=\"text-align:right;color:#e5e7eb;\">${phase}</td></tr>\n                    ${clientName ? `<tr><td style=\\\"color:#93c5fd;font-weight:700;padding:6px 0 4px;\\\">Client:</td><td style=\\\"text-align:right;color:#e5e7eb;\\\">${clientName}</td></tr>` : ''}\n                    ${issueDate ? `<tr><td style=\\\"color:#93c5fd;font-weight:700;padding:6px 0 4px;\\\">Issue Date:</td><td style=\\\"text-align:right;color:#e5e7eb;\\\">${issueDate}</td></tr>` : ''}\n                    ${dueDate ? `<tr><td style=\\\"color:#93c5fd;font-weight:700;padding:6px 0 4px;\\\">Due Date:</td><td style=\\\"text-align:right;color:#e5e7eb;\\\">${dueDate}</td></tr>` : ''}\n                  </table>\n\n                  <h3 style=\"margin:22px 0 10px 0;font-size:18px;color:#e5e7eb;\">Invoice Details</h3>\n                  <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"border:1px solid #374151;border-radius:8px;overflow:hidden;\">\n                    <tr>\n                      <th align=\"left\" style=\"background:#111827;color:#e5e7eb;padding:10px 12px;border-right:1px solid #374151;\">Description</th>\n                      <th align=\"right\" style=\"background:#111827;color:#e5e7eb;padding:10px 12px;\">Amount</th>\n                    </tr>\n                    <tr>\n                      <td style=\"padding:10px 12px;border-top:1px solid #374151;border-right:1px solid #374151;\">${desc}</td>\n                      <td align=\"right\" style=\"padding:10px 12px;border-top:1px solid #374151;\">${totalFmt}</td>\n                    </tr>\n                    <tr>\n                      <td style=\"padding:10px 12px;border-top:1px solid #374151;background:#0b1220;font-weight:700;\">Total</td>\n                      <td align=\"right\" style=\"padding:10px 12px;border-top:1px solid #374151;background:#0b1220;font-weight:700;\">${totalFmt}</td>\n                    </tr>\n                  </table>\n\n                  <div style=\"margin-top:18px;border-left:4px solid #0ea5e9;background:#0f172a;padding:14px 16px;border-radius:8px;\">\n                    <div style=\"font-weight:800;color:#e5e7eb;margin-bottom:6px;\">Payment Instructions:</div>\n                    <div style=\"font-size:14px;color:#e5e7eb;line-height:20px;\">Please reply to this email with your payment receipt or bank transfer confirmation.</div>\n                    <div style=\"font-size:14px;color:#e5e7eb;line-height:20px;margin-top:6px;\">Include the invoice number (${invNo}) in your payment reference.</div>\n                  </div>\n                </td>\n              </tr>\n            </table>\n          </td></tr>\n        </table>\n      </body></html>`\n    }\n\n    const htmlOut = (html && String(html).trim().length > 0)\n      ? String(html)\n      : (String(template || '').toLowerCase() === 'invoice' && invoice ? invoiceHtml(invoice) : (() => {\n          const safeText = String(text || '').replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\\n/g, '<br/>')\n          return `<!doctype html><html><body style=\"margin:0;background:#f7fafc;font-family:Arial,Helvetica,sans-serif;color:#1f2937;\">\n            <table role=\"presentation\" width=\"100%\" cellspacing=\"0\" cellpadding=\"0\" style=\"background:#f7fafc;padding:24px;\">\n              <tr><td align=\"center\">\n                <table role=\"presentation\" width=\"600\" cellspacing=\"0\" cellpadding=\"0\" style=\"max-width:600px;background:#ffffff;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.06);overflow:hidden;\">\n                  <tr><td style=\"background:#0ea5e9;padding:20px 24px;color:#ffffff;font-size:18px;font-weight:700;\">${String(subject)}</td></tr>\n                  <tr><td style=\"padding:24px;font-size:14px;line-height:20px;\">${safeText}</td></tr>\n                  <tr><td style=\"background:#f3f4f6;padding:16px 24px;text-align:center;font-size:12px;color:#6b7280;\">Sent from Project Hub</td></tr>\n                </table>\n              </td></tr>\n            </table>\n          </body></html>`\n        })())\n    // Build RFC822 message\n    const boundary = 'mixed_' + Math.random().toString(36).slice(2)\n    const body = [\n      `To: ${to}`,\n      `Subject: ${subject}`,\n      'Content-Type: multipart/alternative; boundary=\"' + boundary + '\"',\n      '',\n      `--${boundary}`,\n      'Content-Type: text/plain; charset=\"UTF-8\"',\n      '',\n      text ? String(text) : '',\n      `--${boundary}`,\n      'Content-Type: text/html; charset=\"UTF-8\"',\n      '',\n      htmlOut,\n      `--${boundary}--`,\n      '',\n    ].join('\\r\\n')\n    const encoded = Buffer.from(body).toString('base64').replace(/\\+/g, '-').replace(/\\//g, '_').replace(/=+$/, '')\n    const sendRes = await axios.post('https://gmail.googleapis.com/gmail/v1/users/me/messages/send', { raw: encoded }, { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` } })\n\n    // Attempt to mark invoice as SENT when we can resolve it by invoiceNo\n    try {\n      const invNo = String((req.body as any)?.invoice?.invoiceNo || '').trim()\n      if (invNo) {\n        const inv = await prisma.invoice.findUnique({ where: { invoiceNo: invNo } })\n        if (inv && inv.status !== 'PAID') {\n          await prisma.invoice.update({ where: { id: inv.id }, data: { status: 'SENT' } })\n        }\n      }\n    } catch {}\n\n    res.json({ id: sendRes.data?.id || null })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to send email' })\n  }\n})\n\n// Pull recent bank emails and extract credits (very basic heuristic)\nrouter.get('/bank-credits', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET\n  if (!clientId || !clientSecret) return res.status(500).json({ error: 'Missing Google client credentials' })\n  const acc = await prisma.calendarAccount.findFirst({ where: { userId, provider: 'GOOGLE' as any } })\n  if (!acc) return res.status(409).json({ error: 'Google not connected' })\n  const scope = String(acc.scope || '')\n  const needsScope = !/gmail\\.readonly/.test(scope)\n  if (needsScope) {\n    return res.status(409).json({ error: 'Gmail scopes not granted. Please connect Gmail.', scope })\n  }\n  try {\n    const tokenAcc = await ensureGoogleToken(acc, clientId, clientSecret)\n    // Search last 14 days for suspected credit notifications\n    const q = 'newer_than:14d (subject:(credit OR deposit OR payment received) OR from:(bank))'\n    const list = await axios.get('https://gmail.googleapis.com/gmail/v1/users/me/messages', { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` }, params: { q, maxResults: 50 } })\n    const messages = Array.isArray(list.data?.messages) ? list.data.messages : []\n    const out: any[] = []\n    for (const m of messages) {\n      try {\n        const detail = await axios.get(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}`, { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` } })\n        const payload = detail.data?.payload\n        const headers = (payload?.headers || []) as Array<{ name: string; value: string }>\n        const subject = headers.find(h => h.name.toLowerCase() === 'subject')?.value || ''\n        const from = headers.find(h => h.name.toLowerCase() === 'from')?.value || ''\n        const receivedAt = new Date(Number(detail.data?.internalDate || Date.now())).toISOString()\n        // Extract amount heuristically\n        const snippet = String(detail.data?.snippet || '')\n        const amtMatch = snippet.match(/([A-Z]{3}|Rs\\.?|LKR|USD|GBP|EUR|AUD|CAD)?\\s?([\\d,]+(?:\\.\\d{1,2})?)/i)\n        let amountNum = 0\n        let currency = 'USD'\n        if (amtMatch) {\n          const cur = amtMatch[1] || ''\n          const amt = amtMatch[2] || '0'\n          amountNum = Number(amt.replace(/,/g, ''))\n          currency = cur && cur.length <= 4 ? cur.toUpperCase().replace('RS', 'LKR') : 'USD'\n        }\n        if (amountNum > 0) {\n          try {\n            await db.bankCredit.upsert({\n              where: { messageId: m.id },\n              update: {\n                amount: amountNum,\n                currency,\n                valueDate: receivedAt,\n                payerName: from || null,\n                bankRef: subject || null,\n                memo: snippet || null,\n                sourceMailbox: acc.email || 'gmail',\n                receivedAt,\n                status: 'UNMATCHED',\n                confidence: 0.5,\n              },\n              create: {\n                amount: amountNum,\n                currency,\n                valueDate: receivedAt,\n                payerName: from || null,\n                bankRef: subject || null,\n                memo: snippet || null,\n                sourceMailbox: acc.email || 'gmail',\n                messageId: m.id,\n                receivedAt,\n                status: 'UNMATCHED',\n                confidence: 0.5,\n              },\n            })\n          } catch {}\n\n          out.push({\n            id: `gmail-${m.id}`,\n            amount: amountNum,\n            currency,\n            valueDate: receivedAt,\n            payerName: from,\n            bankRef: subject,\n            memo: snippet,\n            sourceMailbox: acc.email || 'gmail',\n            messageId: m.id,\n            receivedAt,\n            status: 'Unmatched',\n          })\n        }\n      } catch {}\n    }\n    res.json(out)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to fetch bank credits' })\n  }\n})\n\n// Pull recent client replies with attachments (payment slips)\nrouter.get('/receipts', async (req: Request, res: Response) => {\n  const userId = await resolveUserId(req)\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET\n  if (!clientId || !clientSecret) return res.status(500).json({ error: 'Missing Google client credentials' })\n  const acc = await prisma.calendarAccount.findFirst({ where: { userId, provider: 'GOOGLE' as any } })\n  if (!acc) return res.status(409).json({ error: 'Google not connected' })\n  const scope = String(acc.scope || '')\n  const needsScope = !/gmail\\.readonly/.test(scope)\n  if (needsScope) {\n    return res.status(409).json({ error: 'Gmail scopes not granted. Please connect Gmail.', scope })\n  }\n\n  try {\n    const tokenAcc = await ensureGoogleToken(acc, clientId, clientSecret)\n    // Only pull reply emails to invoices we sent:\n    // - in inbox\n    // - has attachments\n    // - subject contains an invoice number pattern (e.g., INV-XXXX-XXX)\n    // Additional filtering below verifies the thread contains a \"SENT\" message from us with same invoice No\n    const q = 'newer_than:45d has:attachment in:inbox subject:INV-'\n    const list = await axios.get('https://gmail.googleapis.com/gmail/v1/users/me/messages', {\n      headers: { Authorization: `Bearer ${tokenAcc.accessToken}` },\n      params: { q, maxResults: 50 }\n    })\n    const messages = Array.isArray(list.data?.messages) ? list.data.messages : []\n    const out: any[] = []\n\n    const bounceFromRe = /(mailer-daemon|postmaster|no-reply|noreply|do-not-reply|bounce)@/i\n    const bounceSubjectRe = /(delivery status notification|undelivered mail|mail delivery failed|returned mail)/i\n    function looksLikeSlip(fileName: string, mimeType: string, subject: string, snippet: string, invoiceNo?: string | null) {\n      const name = (fileName || '').toLowerCase()\n      const subj = (subject || '').toLowerCase()\n      const snip = (snippet || '').toLowerCase()\n      const hasKeyword = /(slip|receipt|payment|transfer|deposit|bank-in|bank in|remittance)/i.test(name + ' ' + subj + ' ' + snip)\n      const pdf = /^application\\/pdf/i.test(mimeType)\n      const img = /^image\\//i.test(mimeType)\n      if (invoiceNo) return true\n      if (pdf && hasKeyword) return true\n      if (img && hasKeyword) return true\n      return false\n    }\n\n    for (const m of messages) {\n      try {\n        const detail = await axios.get(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}`, { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` } })\n        const msg = detail.data\n        const payload = msg?.payload\n        const headers = (payload?.headers || []) as Array<{ name: string; value: string }>\n        const subject = headers.find(h => h.name.toLowerCase() === 'subject')?.value || ''\n        const from = headers.find(h => h.name.toLowerCase() === 'from')?.value || ''\n        const replyTo = headers.find(h => h.name.toLowerCase() === 'reply-to')?.value || ''\n        const threadId = String(msg?.threadId || '')\n        const receivedAt = new Date(Number(msg?.internalDate || Date.now())).toISOString()\n        const snippet = String(msg?.snippet || '')\n\n        // Skip obvious bounces/no-replies\n        if (bounceFromRe.test(from) || bounceSubjectRe.test(subject)) {\n          continue\n        }\n\n        // Extract potential invoice number (e.g., INV-2025-001)\n        const invMatch = (subject + ' ' + snippet).match(/INV[-_ ]?\\d{4}[-_ ]?\\d{3,}/i)\n        const invoiceNo = invMatch ? invMatch[0].replace(/[_ ]/g, '-').toUpperCase() : null\n        // Require a recognizable invoice number\n        if (!invoiceNo) continue\n        // Invoice must exist in our DB\n        let invoice: any = null\n        try { invoice = await prisma.invoice.findUnique({ where: { invoiceNo } }) } catch {}\n        if (!invoice) continue\n\n        // Flatten parts to find attachments\n        const parts: any[] = []\n        function walkParts(p: any) {\n          if (!p) return\n          if (p.parts && Array.isArray(p.parts)) {\n            for (const sp of p.parts) walkParts(sp)\n          } else {\n            parts.push(p)\n          }\n        }\n        walkParts(payload)\n        const attachments = parts.filter(p => p?.body?.attachmentId && (\n          /^application\\/pdf/i.test(p.mimeType) || /^image\\//i.test(p.mimeType)\n        ))\n\n        // Ensure this message is in a thread that includes our original SENT message for the same invoice\n        try {\n          if (threadId) {\n            const threadRes = await axios.get(`https://gmail.googleapis.com/gmail/v1/users/me/threads/${threadId}`, { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` } })\n            const tMsgs = Array.isArray(threadRes.data?.messages) ? threadRes.data.messages : []\n            const hasSent = tMsgs.some((tm: any) => Array.isArray(tm?.labelIds) && tm.labelIds.includes('SENT'))\n            const subjInThread = tMsgs.some((tm: any) => {\n              const hs = (tm?.payload?.headers || []) as Array<{ name: string; value: string }>\n              const s = hs.find(h => h.name.toLowerCase() === 'subject')?.value || ''\n              return s.includes(invoiceNo)\n            })\n            if (!hasSent || !subjInThread) {\n              // Not a reply to our sent invoice; skip\n              continue\n            }\n          }\n        } catch {\n          // If thread fetch fails, skip to be strict\n          continue\n        }\n\n        for (const att of attachments) {\n          let savedReceipt: any = null\n          const fileName = att.filename || 'attachment'\n          const fileType = att.mimeType || 'application/octet-stream'\n          const attachmentId = att.body?.attachmentId\n          if (!attachmentId) continue\n          // Skip tiny inline images or tiny PDFs\n          const partSize = Number(att.body?.size || 0)\n          if (/^image\\//i.test(fileType) && partSize > 0 && partSize < 20000) continue\n          if (/^application\\/pdf/i.test(fileType) && partSize > 0 && partSize < 5000) continue\n          // We do not download binary here; provide a proxy URL for on-demand fetch\n          // Include account id so the proxy can fetch even without user session headers\n          const fileKey = `${baseUrl(req)}/api/gmail/messages/${m.id}/attachments/${attachmentId}?account=${encodeURIComponent(acc.id)}`\n\n          // Basic relevance filter to reduce noise\n          if (!looksLikeSlip(fileName, fileType, subject, snippet, invoiceNo)) {\n            continue\n          }\n\n          // Determine amount: prefer reading from slip content over email snippet\n          let amountNum: number | undefined = undefined\n          try {\n            const ares = await axios.get(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${m.id}/attachments/${attachmentId}`,\n              { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` } })\n            const dataB64 = ares.data?.data || ''\n            const buf = Buffer.from(String(dataB64).replace(/-/g, '+').replace(/_/g, '/'), 'base64')\n            amountNum = await extractAmount(buf, fileType)\n          } catch {}\n          // Do not fall back to email body; rely solely on slip content\n\n          // Persist to DB idempotently via unique (messageId,fileName)\n          try {\n            const commonData = {\n              paymentRequestId: invoiceNo || undefined,\n              invoiceId: invoice?.id || undefined,\n              projectId: invoice?.projectId || undefined,\n              phaseId: invoice?.phaseId || undefined,\n              source: 'email',\n              fileKey,\n              fileType,\n              fileSize: null,\n              amount: amountNum || null,\n              payerName: from || replyTo || null,\n              payerEmail: (from || '').replace(/.*<([^>]+)>.*/, '$1') || null,\n              // Do not auto-verify on ingestion; user must verify manually\n              status: 'SUBMITTED',\n              confidence: invoice ? 0.9 : 0.6,\n              senderEmail: (from || '').replace(/.*<([^>]+)>.*/, '$1') || null,\n              gmailThreadId: threadId || null,\n              receivedAt,\n            }\n            const dbRec = await db.paymentReceipt.upsert({\n              where: { messageId_fileName: { messageId: m.id, fileName } },\n              update: commonData,\n              create: { ...commonData, fileName, messageId: m.id, flags: [] },\n            })\n            savedReceipt = dbRec\n          } catch {}\n\n          const receiptCode = `RC-${String(m.id).slice(0,6).toUpperCase()}`\n          // If we have a saved receipt in DB, mirror its status/id/fileKey\n          const statusFromDb = savedReceipt?.status\n          const uiStatus = statusFromDb === 'VERIFIED' ? 'Verified' : statusFromDb === 'REJECTED' ? 'Rejected' : 'Submitted'\n          const idForUi = savedReceipt?.id || `gmail-${m.id}-${attachmentId}`\n          const fileKeyForUi = savedReceipt?.fileKey || fileKey\n          out.push({\n            id: idForUi,\n            paymentRequestId: invoiceNo || undefined,\n            invoiceNo: invoiceNo || undefined,\n            invoiceId: invoice?.id || undefined,\n            matchedInvoiceNo: invoiceNo || undefined,\n            receiptCode,\n            projectId: invoice?.projectId || 'unknown',\n            phaseId: invoice?.phaseId || 'unknown',\n            projectName: invoice ? '' : 'Unknown Project',\n            phaseName: invoice ? '' : 'Unknown Phase',\n            source: 'email',\n            fileKey: fileKeyForUi,\n            fileName,\n            fileType,\n            // size will be provided on proxy fetch; unknown here\n            amount: amountNum,\n            paidDate: undefined,\n            transactionRef: undefined,\n            payerName: from || replyTo || undefined,\n            payerEmail: (from || '').replace(/.*<([^>]+)>.*/, '$1'),\n            status: uiStatus,\n            confidence: invoice ? 0.9 : 0.6,\n            matchedInvoiceId: invoice?.id || undefined,\n            matchedAmount: invoice && amountNum ? amountNum : undefined,\n            flags: [],\n            senderEmail: (from || '').replace(/.*<([^>]+)>.*/, '$1'),\n            messageId: m.id,\n            gmailThreadId: threadId,\n            receivedAt,\n          })\n        }\n      } catch (e) {\n        // Skip individual message errors\n      }\n    }\n\n    res.json(out)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to fetch receipts' })\n  }\n})\n\n// Proxy an attachment download for inline viewing\nrouter.get('/messages/:messageId/attachments/:attachmentId', async (req: Request, res: Response) => {\n  const clientId = process.env.GOOGLE_CLIENT_ID\n  const clientSecret = process.env.GOOGLE_CLIENT_SECRET\n  if (!clientId || !clientSecret) return res.status(500).json({ error: 'Missing Google client credentials' })\n\n  // Resolve account: prefer explicit account query, else use authenticated user, else first GOOGLE account\n  const accountId = (req.query.account as string) || ''\n  let acc: any = null\n  if (accountId) {\n    acc = await prisma.calendarAccount.findUnique({ where: { id: accountId } })\n  }\n  if (!acc) {\n    const userId = await resolveUserId(req)\n    if (userId) {\n      acc = await prisma.calendarAccount.findFirst({ where: { userId, provider: 'GOOGLE' as any } })\n    }\n  }\n  if (!acc) {\n    acc = await prisma.calendarAccount.findFirst({ where: { provider: 'GOOGLE' as any } })\n  }\n  if (!acc) return res.status(409).json({ error: 'Google not connected' })\n  const scope = String(acc.scope || '')\n  const needsScope = !/gmail\\.readonly/.test(scope)\n  if (needsScope) {\n    return res.status(409).json({ error: 'Gmail scopes not granted. Please connect Gmail.', scope })\n  }\n\n  try {\n    const tokenAcc = await ensureGoogleToken(acc, clientId, clientSecret)\n    const { messageId, attachmentId } = req.params\n    // Fetch message to infer filename and mime type of this attachment\n    const msgRes = await axios.get(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${messageId}`, { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` } })\n    const payload = msgRes.data?.payload\n    // Walk to find the attachment part\n    let found: any = null\n    function walk(p: any) {\n      if (!p || found) return\n      if (p.parts && Array.isArray(p.parts)) {\n        for (const sp of p.parts) walk(sp)\n      } else if (p?.body?.attachmentId === attachmentId) {\n        found = p\n      }\n    }\n    walk(payload)\n    const mimeType = found?.mimeType || 'application/octet-stream'\n    const filename = found?.filename || 'attachment'\n    const attRes = await axios.get(`https://gmail.googleapis.com/gmail/v1/users/me/messages/${messageId}/attachments/${attachmentId}`, { headers: { Authorization: `Bearer ${tokenAcc.accessToken}` } })\n    const dataB64 = attRes.data?.data || ''\n    const buf = Buffer.from(String(dataB64).replace(/-/g, '+').replace(/_/g, '/'), 'base64')\n    res.setHeader('Content-Type', mimeType)\n    res.setHeader('Content-Disposition', `inline; filename=\"${filename.replace(/\"/g, '')}\"`)\n    // Allow embedding in iframe from different origins by removing frameguard\n    try { res.removeHeader('X-Frame-Options') } catch {}\n    res.setHeader('Cross-Origin-Resource-Policy', 'cross-origin')\n    res.send(buf)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to fetch attachment' })\n  }\n})\n\nexport default router\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\n\nconst prisma = new PrismaClient()\nconst db: any = prisma\nconst router = Router()\n\nfunction mapInvoice(i: any) {\n  return {\n    id: i.id,\n    invoiceNo: i.invoiceNo,\n    projectId: i.projectId,\n    phaseId: i.phaseId,\n    projectName: i.project?.title || '',\n    phaseName: i.phase?.name || '',\n    issueDate: i.issueDate,\n    dueDate: i.dueDate,\n    currency: i.currency,\n    subtotal: i.subtotal,\n    taxAmount: i.taxAmount,\n    total: i.total,\n    collected: i.collected,\n    outstanding: i.outstanding,\n    status: i.status,\n    pdfKey: i.pdfKey || null,\n    notes: i.notes || '',\n    createdAt: i.createdAt,\n    updatedAt: i.updatedAt,\n  }\n}\n\nrouter.get('/', async (_req: Request, res: Response) => {\n  const list = await db.invoice.findMany({\n    orderBy: { createdAt: 'desc' },\n    include: { project: true, phase: true },\n  })\n  res.json(list.map(mapInvoice))\n})\n\nconst createSchema = z.object({\n  invoiceNo: z.string(),\n  projectId: z.string(),\n  phaseId: z.string(),\n  issueDate: z.string(),\n  dueDate: z.string(),\n  currency: z.string().default('USD'),\n  subtotal: z.number().nonnegative().default(0),\n  taxAmount: z.number().nonnegative().default(0),\n  total: z.number().nonnegative().default(0),\n  notes: z.string().optional().default(''),\n})\n\nrouter.post('/', async (req: Request, res: Response) => {\n  const parsed = createSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const data = parsed.data\n  try {\n    const created = await db.invoice.create({\n      data: {\n        invoiceNo: data.invoiceNo,\n        projectId: data.projectId,\n        phaseId: data.phaseId,\n        issueDate: new Date(data.issueDate),\n        dueDate: new Date(data.dueDate),\n        currency: data.currency,\n        subtotal: data.subtotal,\n        taxAmount: data.taxAmount,\n        total: data.total,\n        collected: 0,\n        outstanding: data.total,\n        status: 'DRAFT',\n        notes: data.notes || '',\n      },\n      include: { project: true, phase: true },\n    })\n    res.status(201).json(mapInvoice(created))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to create invoice' })\n  }\n})\n\nconst updateSchema = createSchema.partial()\nrouter.patch('/:id', async (req: Request, res: Response) => {\n  const id = req.params.id\n  const parsed = updateSchema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const data = parsed.data as any\n  if (data.issueDate !== undefined) data.issueDate = new Date(data.issueDate)\n  if (data.dueDate !== undefined) data.dueDate = new Date(data.dueDate)\n  try {\n    const updated = await db.invoice.update({ where: { id }, data, include: { project: true, phase: true } })\n    res.json(mapInvoice(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to update invoice' })\n  }\n})\n\nrouter.delete('/:id', async (req: Request, res: Response) => {\n  const id = req.params.id\n  try {\n    await db.invoice.delete({ where: { id } })\n    res.status(204).end()\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to delete invoice' })\n  }\n})\n\nrouter.post('/:id/mark-paid', async (req: Request, res: Response) => {\n  const id = req.params.id\n  try {\n    const inv = await db.invoice.findUnique({ where: { id } })\n    if (!inv) return res.status(404).json({ error: 'Not found' })\n    const updated = await db.invoice.update({\n      where: { id },\n      data: { collected: inv.total, outstanding: 0, status: 'PAID' },\n      include: { project: true, phase: true },\n    })\n    res.json(mapInvoice(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to mark invoice paid' })\n  }\n})\n\nexport default router\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\nimport path from 'path'\nimport fs from 'fs/promises'\n\nconst prisma = new PrismaClient()\nconst db: any = prisma\nconst router = Router()\n\nfunction hasModel(name: string) {\n  const m = (db as any)[name]\n  return m && typeof m.findMany === 'function'\n}\n\nfunction mapReceipt(r: any) {\n  return {\n    id: r.id,\n    paymentRequestId: r.paymentRequestId || null,\n    invoiceId: r.invoiceId || null,\n    matchedInvoiceNo: r.invoice?.invoiceNo || null,\n    receiptCode: `RC-${String(r.messageId || r.id).slice(0,6).toUpperCase()}`,\n    projectId: r.projectId || null,\n    phaseId: r.phaseId || null,\n    projectName: r.project?.title || '',\n    phaseName: r.phase?.name || '',\n    source: r.source,\n    fileKey: r.fileKey || null,\n    fileName: r.fileName || null,\n    fileType: r.fileType || null,\n    fileSize: r.fileSize || null,\n    amount: r.amount || null,\n    paidDate: r.paidDate || null,\n    transactionRef: r.transactionRef || null,\n    payerName: r.payerName || null,\n    payerEmail: r.payerEmail || null,\n    status: r.status === 'VERIFIED' ? 'Verified' : r.status === 'REJECTED' ? 'Rejected' : 'Submitted',\n    confidence: r.confidence || null,\n    matchedInvoiceId: r.invoiceId || null,\n    matchedAmount: null,\n    flags: r.flags || [],\n    senderEmail: r.senderEmail || null,\n    messageId: r.messageId || null,\n    gmailThreadId: r.gmailThreadId || null,\n    receivedAt: r.receivedAt,\n    reviewedBy: r.reviewedBy || null,\n    reviewedAt: r.reviewedAt || null,\n    reviewNote: r.reviewNote || null,\n  }\n}\n\nrouter.get('/', async (_req: Request, res: Response) => {\n  if (!hasModel('paymentReceipt')) return res.json([])\n  const list = await db.paymentReceipt.findMany({ orderBy: { receivedAt: 'desc' }, include: { project: true, phase: true, invoice: true } })\n  res.json(list.map(mapReceipt))\n})\n\nrouter.post('/:id/verify', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('paymentReceipt')) return res.status(501).json({ error: 'Receipts persistence not migrated yet' })\n  const userId = (req as any).userId || 'system'\n  const body = z.object({ reviewNote: z.string().optional() }).parse(req.body || {})\n  try {\n    // Load previous state to make operation idempotent\n    const prev = await db.paymentReceipt.findUnique({ where: { id } })\n    if (!prev) return res.status(404).json({ error: 'Receipt not found' })\n\n    const wasVerified = String(prev.status || '').toUpperCase() === 'VERIFIED'\n\n    // If already verified, do not apply again or re-fetch file\n    if (wasVerified) {\n      try {\n        const prevFull = await db.paymentReceipt.findUnique({ where: { id }, include: { invoice: true, project: true, phase: true } })\n        return res.json(mapReceipt(prevFull))\n      } catch {\n        return res.json(mapReceipt(prev))\n      }\n    }\n\n    // Update receipt as verified (no-op if already verified)\n    const updated = await db.paymentReceipt.update({ where: { id }, data: { status: 'VERIFIED', reviewedBy: userId, reviewedAt: new Date(), reviewNote: body.reviewNote || undefined } , include: { invoice: true, project: true, phase: true }})\n\n    // Apply to invoice only once: if another receipt for same message/file is already VERIFIED, skip applying\n    let shouldApply = true\n    try {\n      if (prev.messageId || prev.fileName) {\n        const already = await db.paymentReceipt.findFirst({\n          where: {\n            id: { not: id },\n            status: 'VERIFIED',\n            OR: [\n              { messageId: prev.messageId || undefined, fileName: prev.fileName || undefined },\n              { messageId: prev.messageId || undefined },\n            ],\n          },\n        })\n        if (already) shouldApply = false\n      }\n    } catch {}\n\n    if (shouldApply && updated.invoiceId && updated.amount && updated.amount > 0) {\n      const inv = await db.invoice.findUnique({ where: { id: updated.invoiceId } })\n      if (inv) {\n        const newCollected = (inv.collected || 0) + Number(updated.amount)\n        const outstanding = Math.max(0, Number(inv.total) - newCollected)\n        const status = outstanding === 0 ? 'PAID' : newCollected > 0 ? 'PARTIALLY_PAID' : inv.status\n        await db.invoice.update({ where: { id: inv.id }, data: { collected: newCollected, outstanding, status } })\n      }\n    }\n    // Persist slip as Attachment and repoint fileKey to local path\n    try {\n      if (updated.fileKey) {\n        const axios = (await import('axios')).default\n        const resp = await axios.get(String(updated.fileKey), { responseType: 'arraybuffer' })\n        const buf = Buffer.from(resp.data)\n        const mime = String(resp.headers['content-type'] || updated.fileType || 'application/octet-stream')\n        const uploadDir = process.env.UPLOAD_DIR || 'uploads'\n        const recDir = path.resolve(process.cwd(), uploadDir, 'receipts')\n        await fs.mkdir(recDir, { recursive: true })\n        const extFromName = (updated.fileName || '').split('.').pop() || ''\n        const ext = extFromName ? extFromName.toLowerCase() : (mime.includes('pdf') ? 'pdf' : 'bin')\n        const filename = `${updated.id}.${ext}`\n        const absPath = path.join(recDir, filename)\n        await fs.writeFile(absPath, buf)\n        const relPath = path.posix.join('receipts', filename)\n        try { await db.attachment.create({ data: { filePath: relPath, fileType: mime, projectId: updated.projectId || null } }) } catch {}\n        await db.paymentReceipt.update({ where: { id: updated.id }, data: { fileKey: `/uploads/${relPath}` } })\n      }\n    } catch {}\n\n    res.json(mapReceipt(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to verify receipt' })\n  }\n})\n\nrouter.post('/:id/reject', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('paymentReceipt')) return res.status(501).json({ error: 'Receipts persistence not migrated yet' })\n  const userId = (req as any).userId || 'system'\n  const body = z.object({ reason: z.string(), reviewNote: z.string().optional() }).parse(req.body || {})\n  try {\n    const updated = await db.paymentReceipt.update({ where: { id }, data: { status: 'REJECTED', reviewedBy: userId, reviewedAt: new Date(), reviewNote: body.reviewNote || body.reason }, include: { invoice: true, project: true, phase: true } })\n    res.json(mapReceipt(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to reject receipt' })\n  }\n})\n\nrouter.get('/:id/suggestions', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('paymentReceipt')) return res.status(501).json({ error: 'Receipts persistence not migrated yet' })\n  const r = await db.paymentReceipt.findUnique({ where: { id } })\n  if (!r) return res.status(404).json({ error: 'Not found' })\n  const amt = r.amount || 0\n  const invs = await db.invoice.findMany({ where: { status: { in: ['SENT', 'PARTIALLY_PAID', 'OVERDUE', 'DRAFT'] } } })\n  const suggestions = invs\n    .map((i: any) => ({ invoice: i, delta: Math.abs((i.total || 0) - amt) }))\n    .sort((a: any, b: any) => a.delta - b.delta)\n    .slice(0, 5)\n    .map((x: any) => ({\n      id: x.invoice.id,\n      invoiceNo: x.invoice.invoiceNo,\n      projectId: x.invoice.projectId,\n      phaseId: x.invoice.phaseId,\n      projectName: '',\n      phaseName: '',\n      issueDate: x.invoice.issueDate,\n      dueDate: x.invoice.dueDate,\n      currency: x.invoice.currency,\n      subtotal: x.invoice.subtotal,\n      taxAmount: x.invoice.taxAmount,\n      total: x.invoice.total,\n      collected: x.invoice.collected,\n      outstanding: x.invoice.outstanding,\n      status: x.invoice.status,\n      pdfKey: x.invoice.pdfKey || null,\n      notes: x.invoice.notes || '',\n      createdAt: x.invoice.createdAt,\n      updatedAt: x.invoice.updatedAt,\n    }))\n  res.json(suggestions)\n})\n\nrouter.post('/:id/match', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('paymentReceipt')) return res.status(501).json({ error: 'Receipts persistence not migrated yet' })\n  const body = z.object({ invoiceId: z.string(), amount: z.number().nonnegative() }).parse(req.body || {})\n  const userId = (req as any).userId || 'system'\n  try {\n    const inv = await db.invoice.findUnique({ where: { id: body.invoiceId } })\n    if (!inv) return res.status(404).json({ error: 'Invoice not found' })\n    const rec = await db.paymentReceipt.findUnique({ where: { id } })\n    if (!rec) return res.status(404).json({ error: 'Receipt not found' })\n\n    await db.$transaction(async (tx: any) => {\n      await tx.paymentReceipt.update({ where: { id }, data: { invoiceId: body.invoiceId } })\n      await tx.paymentMatch.create({ data: { invoiceId: body.invoiceId, receiptId: id, amount: body.amount, matchedBy: String(userId), type: 'receipt' } })\n    })\n\n    const updated = await db.paymentReceipt.findUnique({ where: { id }, include: { invoice: true, project: true, phase: true } })\n    res.json(mapReceipt(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to match receipt' })\n  }\n})\n\nrouter.post('/:id/unmatch', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('paymentReceipt')) return res.status(501).json({ error: 'Receipts persistence not migrated yet' })\n  try {\n    const rec = await db.paymentReceipt.findUnique({ where: { id } })\n    if (!rec) return res.status(404).json({ error: 'Receipt not found' })\n    await db.paymentReceipt.update({ where: { id }, data: { invoiceId: null, status: 'SUBMITTED' } })\n    const updated = await db.paymentReceipt.findUnique({ where: { id }, include: { invoice: true, project: true, phase: true } })\n    res.json(mapReceipt(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to unmatch receipt' })\n  }\n})\n\n// Re-extract amount from the attached slip and update the receipt\nrouter.post('/:id/reextract', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('paymentReceipt')) return res.status(501).json({ error: 'Receipts persistence not migrated yet' })\n  try {\n    const r = await db.paymentReceipt.findUnique({ where: { id } })\n    if (!r) return res.status(404).json({ error: 'Receipt not found' })\n    if (!r.fileKey) return res.status(400).json({ error: 'No slip attached' })\n\n    // Fetch the file via proxy URL (should include content-type)\n    const axios = (await import('axios')).default\n    const resp = await axios.get(String(r.fileKey), { responseType: 'arraybuffer' })\n    const buf = Buffer.from(resp.data)\n    const mime = String(resp.headers['content-type'] || r.fileType || 'application/octet-stream')\n    const { extractAmount } = await import('../utils/slip-extract.ts')\n    const amount = await extractAmount(buf, mime)\n    if (amount === undefined) return res.status(422).json({ error: 'Could not extract amount from slip' })\n\n    const updated = await db.paymentReceipt.update({ where: { id }, data: { amount, confidence: Math.max(0.7, r.confidence || 0.7) } })\n    res.json(mapReceipt(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to re-extract amount' })\n  }\n})\n\nexport default router\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\n\nconst prisma = new PrismaClient()\nconst db: any = prisma\nconst router = Router()\n\nfunction hasModel(name: string) {\n  const m = (prisma as any)[name]\n  return m && typeof m.findMany === 'function'\n}\n\nfunction mapCredit(c: any) {\n  return {\n    id: c.id,\n    amount: c.amount,\n    currency: c.currency,\n    valueDate: c.valueDate,\n    payerName: c.payerName || null,\n    bankRef: c.bankRef || null,\n    memo: c.memo || null,\n    sourceMailbox: c.sourceMailbox,\n    messageId: c.messageId,\n    receivedAt: c.receivedAt,\n    matchedInvoiceId: c.matchedInvoiceId || null,\n    matchedAmount: c.matchedAmount || null,\n    confidence: c.confidence || null,\n    status: c.status === 'MATCHED' ? 'Matched' : c.status === 'NEEDS_REVIEW' ? 'NeedsReview' : 'Unmatched',\n    suggestions: [],\n  }\n}\n\nrouter.get('/', async (_req: Request, res: Response) => {\n  if (!hasModel('bankCredit')) return res.json([])\n  const list = await db.bankCredit.findMany({ orderBy: { receivedAt: 'desc' } })\n  res.json(list.map(mapCredit))\n})\n\nrouter.post('/:id/match', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('bankCredit')) return res.status(501).json({ error: 'Bank credits persistence not migrated yet' })\n  const body = z.object({ invoiceId: z.string(), confirm: z.boolean().optional() }).parse(req.body || {})\n  const userId = (req as any).userId || 'system'\n  try {\n    const credit = await db.bankCredit.findUnique({ where: { id } })\n    if (!credit) return res.status(404).json({ error: 'Bank credit not found' })\n    const inv = await db.invoice.findUnique({ where: { id: body.invoiceId } })\n    if (!inv) return res.status(404).json({ error: 'Invoice not found' })\n\n    await db.$transaction(async (tx: any) => {\n      await tx.bankCredit.update({ where: { id }, data: { matchedInvoiceId: body.invoiceId, matchedAmount: credit.amount, status: 'MATCHED', confidence: 0.95 } })\n      await tx.paymentMatch.create({ data: { invoiceId: body.invoiceId, bankCreditId: id, amount: credit.amount, matchedBy: String(userId), type: 'bank_credit' } })\n      await tx.invoice.update({ where: { id: body.invoiceId }, data: {\n        collected: inv.collected + credit.amount,\n        outstanding: Math.max(0, inv.total - (inv.collected + credit.amount)),\n        status: inv.total === (inv.collected + credit.amount) ? 'PAID' : (inv.collected + credit.amount) > 0 ? 'PARTIALLY_PAID' : inv.status,\n      } })\n    })\n\n    const updated = await db.bankCredit.findUnique({ where: { id } })\n    res.json(mapCredit(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to match bank credit' })\n  }\n})\n\nrouter.post('/:id/not-ours', async (req: Request, res: Response) => {\n  const id = req.params.id\n  if (!hasModel('bankCredit')) return res.status(501).json({ error: 'Bank credits persistence not migrated yet' })\n  try {\n    const updated = await db.bankCredit.update({ where: { id }, data: { status: 'MATCHED' } })\n    res.json(mapCredit(updated))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to mark bank credit' })\n  }\n})\n\nexport default router\n","import { Router, Request, Response } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport multer from 'multer'\nimport path from 'path'\nimport fs from 'fs/promises'\nimport { z } from 'zod'\n\nconst prisma = new PrismaClient()\nconst db: any = prisma\nconst router = Router()\n\n// Storage: uploads/documents/<timestamp>-<rand>-<sanitized-name>\nconst uploadDir = path.resolve(process.cwd(), 'uploads', 'documents')\nconst storage = multer.diskStorage({\n  destination: async (_req, _file, cb) => {\n    try { await fs.mkdir(uploadDir, { recursive: true }) } catch {}\n    cb(null, uploadDir)\n  },\n  filename: (_req, file, cb) => {\n    const name = String(file.originalname || 'file').replace(/[^a-zA-Z0-9._-]/g, '_')\n    const ext = path.extname(name)\n    const base = path.basename(name, ext)\n    const unique = `${Date.now()}-${Math.random().toString(36).slice(2, 8)}-${base}`\n    cb(null, `${unique}${ext}`)\n  }\n})\nconst upload = multer({ storage })\n\nfunction mapStatus(s: string): string {\n  switch (s) {\n    case 'DRAFT': return 'draft'\n    case 'IN_REVIEW': return 'in-review'\n    case 'APPROVED': return 'approved'\n    case 'NEEDS_CHANGES': return 'needs-changes'\n    case 'REJECTED': return 'rejected'\n    default: return 'draft'\n  }\n}\n\nfunction mapDocument(d: any) {\n  return {\n    id: d.id,\n    name: d.name,\n    fileUrl: d.filePath?.startsWith('/uploads') ? d.filePath : `/uploads/${d.filePath}`,\n    filePath: d.filePath,\n    status: mapStatus(d.status || 'DRAFT'),\n    reviewerId: d.reviewerId || null,\n    reviewer: d.reviewer ? { id: d.reviewer.id, name: d.reviewer.name, email: d.reviewer.email } : null,\n    reviewerRole: d.reviewer?.role?.name || null,\n    createdById: d.createdById,\n    createdBy: d.createdBy ? { id: d.createdBy.id, name: d.createdBy.name, email: d.createdBy.email } : null,\n    createdByRole: d.createdBy?.role?.name || null,\n    projectId: d.projectId || null,\n    phaseId: d.phaseId || null,\n    taskId: d.taskId || null,\n    projectName: d.project?.title || '',\n    phaseName: d.phase?.name || '',\n    taskTitle: d.task?.title || '',\n    reviewComment: d.reviewComment || null,\n    reviewedAt: d.reviewedAt || null,\n    version: d.version || 1,\n    createdAt: d.createdAt,\n  }\n}\n\n// Upload one or multiple documents and assign a reviewer\nrouter.post('/upload', upload.array('files'), async (req: Request, res: Response) => {\n  const userId = (req as any).userId as string | null\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n\n  const schema = z.object({\n    projectId: z.string(),\n    phaseId: z.string(),\n    taskId: z.string().optional().nullable(),\n    reviewerId: z.string(),\n    status: z.enum(['draft','in-review']).optional().default('in-review'),\n    name: z.string().optional(),\n  })\n\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { projectId, phaseId, taskId, reviewerId, status, name } = parsed.data\n\n  const files = (req.files as Express.Multer.File[]) || []\n  if (!files.length) return res.status(400).json({ error: 'No files uploaded (use field name \"files\")' })\n\n  try {\n    // Ensure project/phase exist; validate reviewer\n    const [project, phase, reviewer] = await Promise.all([\n      prisma.project.findUnique({ where: { id: projectId } }),\n      prisma.phase.findUnique({ where: { id: phaseId } }),\n      prisma.user.findUnique({ where: { id: reviewerId } }),\n    ])\n    if (!project) return res.status(400).json({ error: 'Invalid projectId' })\n    if (!phase || phase.projectId !== projectId) return res.status(400).json({ error: 'Invalid phaseId for project' })\n    if (!reviewer) return res.status(400).json({ error: 'Invalid reviewerId' })\n\n    const statusDb = status === 'in-review' ? 'IN_REVIEW' : 'DRAFT'\n    const created = [] as any[]\n    for (const f of files) {\n      const relPath = path.posix.join('documents', path.basename(f.path))\n      const doc = await db.document.create({\n        data: {\n          name: name || f.originalname || 'document',\n          filePath: relPath, // served at /uploads/<relPath>\n          projectId,\n          phaseId,\n          taskId: taskId || null,\n          reviewerId,\n          createdById: userId,\n          status: statusDb,\n        },\n        include: { reviewer: { include: { role: true } }, createdBy: { include: { role: true } }, project: true, phase: true, task: true },\n      })\n      created.push(mapDocument(doc))\n      // Add to task history timeline if associated with a task\n      try {\n        if (taskId) {\n          await prisma.historyEvent.create({\n            data: {\n              taskId: String(taskId),\n              type: 'DOCUMENT' as any,\n              message: `Document: ${doc.name}`,\n              createdById: userId,\n            },\n          })\n        }\n      } catch {}\n    }\n    res.status(201).json(created)\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to upload documents' })\n  }\n})\n\n// Documents assigned to the current user (inbox)\nrouter.get('/inbox', async (req: Request, res: Response) => {\n  const userId = (req as any).userId as string | null\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const rows = await db.document.findMany({\n    where: { reviewerId: userId },\n    orderBy: { createdAt: 'desc' },\n    include: { reviewer: { include: { role: true } }, createdBy: { include: { role: true } }, project: true, phase: true, task: true },\n  })\n  res.json(rows.map(mapDocument))\n})\n\n// Documents sent by current user\nrouter.get('/sent', async (req: Request, res: Response) => {\n  const userId = (req as any).userId as string | null\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const rows = await db.document.findMany({\n    where: { createdById: userId },\n    orderBy: { createdAt: 'desc' },\n    include: { reviewer: { include: { role: true } }, createdBy: { include: { role: true } }, project: true, phase: true, task: true },\n  })\n  res.json(rows.map(mapDocument))\n})\n\n// List documents for a specific task (used by Task Detail UI)\nrouter.get('/by-task/:taskId', async (req: Request, res: Response) => {\n  const taskId = req.params.taskId\n  if (!taskId) return res.status(400).json({ error: 'taskId required' })\n  try {\n    const rows = await db.document.findMany({\n      where: { taskId },\n      orderBy: { createdAt: 'desc' },\n      include: { reviewer: { include: { role: true } }, createdBy: { include: { role: true } }, project: true, phase: true, task: true },\n    })\n    res.json(rows.map(mapDocument))\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to load documents' })\n  }\n})\n\nrouter.get('/:id', async (req: Request, res: Response) => {\n  const d = await db.document.findUnique({\n    where: { id: req.params.id },\n    include: { reviewer: { include: { role: true } }, createdBy: { include: { role: true } }, project: true, phase: true, task: true },\n  })\n  if (!d) return res.status(404).json({ error: 'Not found' })\n  res.json(mapDocument(d))\n})\n\n// Reviewer updates status (approve / reject / needs-changes / in-review)\nrouter.patch('/:id/review', async (req: Request, res: Response) => {\n  const userId = (req as any).userId as string | null\n  if (!userId) return res.status(401).json({ error: 'Login required' })\n  const schema = z.object({\n    status: z.enum(['approved','rejected','needs-changes','in-review']),\n    reviewComment: z.string().optional(),\n  })\n  const parsed = schema.safeParse(req.body)\n  if (!parsed.success) return res.status(400).json(parsed.error.flatten())\n  const { status, reviewComment } = parsed.data\n  const d = await db.document.findUnique({ where: { id: req.params.id } })\n  if (!d) return res.status(404).json({ error: 'Not found' })\n  if (d.reviewerId !== userId) return res.status(403).json({ error: 'Only assigned reviewer can update status' })\n  const statusDb =\n    status === 'approved' ? 'APPROVED' :\n    status === 'rejected' ? 'REJECTED' :\n    status === 'needs-changes' ? 'NEEDS_CHANGES' : 'IN_REVIEW'\n\n  const updated = await db.document.update({\n    where: { id: d.id },\n    data: { status: statusDb, reviewComment: reviewComment || undefined, reviewedAt: new Date() },\n    include: { reviewer: { include: { role: true } }, createdBy: { include: { role: true } }, project: true, phase: true, task: true },\n  })\n  res.json(mapDocument(updated))\n})\n\nexport default router\n","import { Router } from 'express'\nimport { PrismaClient } from '@prisma/client'\nimport { z } from 'zod'\nimport bcrypt from 'bcryptjs'\nimport { requireSuperAdmin } from '../middleware/super-admin.ts'\nimport crypto from 'crypto'\nimport { emailEnabled, renderInviteEmail, sendMail } from '../utils/mailer.ts'\n\nconst prisma = new PrismaClient()\nconst router = Router()\n\n// Create or resolve role/department by name (case-insensitive)\nasync function ensureRole(name: string) {\n  const found = await prisma.appRole.findFirst({ where: { name: { equals: name, mode: 'insensitive' } } })\n  if (found) return found\n  return prisma.appRole.create({ data: { name } })\n}\nasync function ensureDepartment(name: string) {\n  const found = await prisma.department.findFirst({ where: { name: { equals: name, mode: 'insensitive' } } })\n  if (found) return found\n  return prisma.department.create({ data: { name } })\n}\n\n// Protect all admin endpoints\nrouter.use(requireSuperAdmin)\n\n// Admin register user without needing role/department IDs\nrouter.post('/register-user', async (req, res) => {\n  const body = z.object({\n    name: z.string().min(1),\n    email: z.string().email(),\n    password: z.string().min(6),\n    roleName: z.string().min(1),\n    departmentName: z.string().min(1),\n    verify: z.coerce.boolean().optional().default(true),\n    active: z.coerce.boolean().optional().default(true),\n  }).parse(req.body || {})\n\n  try {\n    // Prevent creating another super-admin account by email\n    const adminEmail = String(process.env.SUPERADMIN_EMAIL || '').trim().toLowerCase()\n    if (body.email.trim().toLowerCase() === adminEmail) {\n      return res.status(400).json({ error: 'Cannot create another super admin' })\n    }\n    const [role, dept] = await Promise.all([\n      ensureRole(body.roleName),\n      ensureDepartment(body.departmentName),\n    ])\n    const hash = await bcrypt.hash(body.password, 10)\n    const user = await prisma.user.create({\n      data: {\n        name: body.name,\n        email: body.email.toLowerCase(),\n        roleId: role.id,\n        departmentId: dept.id,\n        passwordHash: hash,\n        isActive: body.active,\n        emailVerifiedAt: body.verify ? new Date() : null,\n      },\n    })\n    res.status(201).json({\n      id: user.id,\n      name: user.name,\n      email: user.email,\n      role: role.name,\n      department: dept.name,\n      isActive: user.isActive,\n      verified: !!user.emailVerifiedAt,\n    })\n  } catch (e: any) {\n    if (e?.code === 'P2002') return res.status(409).json({ error: 'Email already exists' })\n    res.status(400).json({ error: e?.message || 'Failed to register user' })\n  }\n})\n\n// Convenience: list roles and departments (names only)\nrouter.get('/catalog', async (_req, res) => {\n  const [roles, depts] = await Promise.all([\n    prisma.appRole.findMany({ orderBy: { name: 'asc' } }),\n    prisma.department.findMany({ orderBy: { name: 'asc' } }),\n  ])\n  res.json({ roles: roles.map(r => r.name), departments: depts.map(d => d.name) })\n})\n\nexport default router\n\n// Invite a user by email: creates the user (approved/active), sends invite email to set password & verify\nrouter.post('/invite-user', async (req, res) => {\n  const body = z.object({\n    name: z.string().min(1),\n    email: z.string().email(),\n    roleName: z.string().min(1).optional(),\n    departmentName: z.string().min(1),\n  }).parse(req.body || {})\n  try {\n    // Resolve or create role/department\n    const role = body.roleName\n      ? await ensureRole(body.roleName)\n      : (await prisma.appRole.findFirst({ where: { name: { equals: 'Client', mode: 'insensitive' } } })) || await ensureRole('Client')\n    const dept = await ensureDepartment(body.departmentName)\n    const email = body.email.toLowerCase()\n    let user = await prisma.user.findUnique({ where: { email } })\n    if (!user) {\n      user = await prisma.user.create({ data: ({\n        name: body.name,\n        email,\n        roleId: (role as any).id,\n        departmentId: dept.id,\n        isActive: true,\n        emailVerifiedAt: null,\n      } as any) })\n    }\n    // Approve immediately\n    await prisma.approvalRequest.upsert({\n      where: { userId: user.id },\n      update: { status: 'APPROVED', decidedById: (req as any).userId, decidedAt: new Date() },\n      create: { userId: user.id, status: 'APPROVED', decidedById: (req as any).userId, decidedAt: new Date(), requestedDepartmentId: dept.id, requestedRoleId: (role as any).id },\n    })\n    // Create email verification token and send invite\n    const raw = await createVerifyToken(user.id, 24 * 3600)\n    // Fallback to our local helper\n    const clientBase = process.env.FRONTEND_BASE_URL || 'http://localhost:5173'\n    const verifyUrl = `${clientBase}/invite/accept?token=${encodeURIComponent(raw)}`\n    if (emailEnabled()) {\n      const { subject, html } = renderInviteEmail(verifyUrl, user.name, (role as any)?.name, dept.name)\n      await sendMail(user.email, subject, html)\n    }\n    res.status(201).json({ ok: true, id: user.id, email: user.email, ...(emailEnabled() ? {} : { verifyUrl }) })\n  } catch (e: any) {\n    if (e?.code === 'P2002') return res.status(409).json({ error: 'Email already exists' })\n    res.status(400).json({ error: e?.message || 'Failed to invite user' })\n  }\n})\n\n// --- Impersonation APIs ---\n// Start impersonation: sets an impersonation session cookie (impSid)\nrouter.post('/impersonation/start', async (req, res) => {\n  const body = z.object({ userId: z.string().min(1) }).parse(req.body || {})\n  const adminId = (req as any).userId as string\n  if (!adminId) return res.status(401).json({ error: 'Authentication required' })\n  try {\n    const target = await prisma.user.findUnique({ where: { id: body.userId } })\n    if (!target) return res.status(404).json({ error: 'User not found' })\n    const db: any = prisma\n    const session = await db.impersonationSession.create({ data: { adminId, userId: target.id } })\n    await db.adminAudit.create({ data: { adminId, targetUserId: target.id, action: 'IMPERSONATION_START', details: `path=/api/admin/impersonation/start` } })\n    const isProd = (process.env.NODE_ENV || '').toLowerCase() === 'production'\n    res.cookie('impSid', session.id, { httpOnly: true, sameSite: 'lax', secure: isProd })\n    res.json({ ok: true, sessionId: session.id, user: { id: target.id, name: target.name, email: target.email } })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to start impersonation' })\n  }\n})\n\nrouter.post('/impersonation/stop', async (req, res) => {\n  const adminId = (req as any).userId as string\n  const impSid = (req as any).cookies?.impSid || ''\n  if (!adminId) return res.status(401).json({ error: 'Authentication required' })\n  try {\n    if (impSid) {\n      const db: any = prisma\n      await db.impersonationSession.updateMany({ where: { id: String(impSid), adminId, endedAt: null }, data: { endedAt: new Date() } })\n    }\n    const db: any = prisma\n    await db.adminAudit.create({ data: { adminId, action: 'IMPERSONATION_STOP', details: `path=/api/admin/impersonation/stop` } })\n    res.clearCookie('impSid')\n    res.json({ ok: true })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to stop impersonation' })\n  }\n})\n\nrouter.get('/impersonation/status', async (req, res) => {\n  const adminId = (req as any).userId as string\n  const impSid = (req as any).cookies?.impSid || ''\n  if (!adminId) return res.status(401).json({ error: 'Authentication required' })\n  if (!impSid) return res.json({ active: false })\n  try {\n    const db: any = prisma\n    const session = await db.impersonationSession.findFirst({ where: { id: String(impSid), adminId, endedAt: null }, include: { user: true } })\n    if (!session) return res.json({ active: false })\n    res.json({ active: true, session: { id: session.id, user: { id: session.userId, name: session.user.name, email: session.user.email }, startedAt: session.startedAt } })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to read status' })\n  }\n})\n\n// Dangerous: purge all users except super admin. Attempts deletion; if constrained, deactivate and scrub.\nrouter.post('/purge-non-admin-users', async (_req, res) => {\n  const adminEmail = String(process.env.SUPERADMIN_EMAIL || '').trim().toLowerCase()\n  if (!adminEmail) return res.status(500).json({ error: 'SUPERADMIN_EMAIL not configured' })\n  try {\n    const survivor = await prisma.user.findFirst({ where: { email: adminEmail } })\n    let deleted = 0\n    let scrubbed = 0\n    const others = await prisma.user.findMany({ where: { NOT: { email: adminEmail } } })\n    for (const u of others) {\n      try {\n        await prisma.user.delete({ where: { id: u.id } })\n        deleted++\n      } catch {\n        // FKs present; scrub instead\n        const newEmail = `archived+${u.id}@example.com`\n        await prisma.user.update({ where: { id: u.id }, data: { isActive: false, email: newEmail, name: 'Archived User', passwordHash: null } as any })\n        scrubbed++\n      }\n    }\n    res.json({ ok: true, kept: survivor ? 1 : 0, deleted, scrubbed })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to purge users' })\n  }\n})\nfunction hashToken(raw: string) {\n  return crypto.createHash('sha256').update(raw).digest('hex')\n}\nasync function createVerifyToken(userId: string, ttlSeconds: number) {\n  const raw = crypto.randomBytes(32).toString('hex')\n  const tokenHash = hashToken(raw)\n  const expiresAt = new Date(Date.now() + ttlSeconds * 1000)\n  await prisma.authToken.create({ data: { userId, type: 'EMAIL_VERIFY' as any, tokenHash, expiresAt } })\n  return raw\n}\n","import { Router } from 'express'\nimport { z } from 'zod'\nimport { requireSuperAdmin } from '../middleware/super-admin.ts'\nimport { getSuperAdminEmail, setSuperAdminEmail } from '../utils/settings.ts'\n\nconst router = Router()\n\nrouter.get('/superadmin-email', requireSuperAdmin, async (_req, res) => {\n  const email = await getSuperAdminEmail()\n  const fromEnv = !!process.env.SUPERADMIN_EMAIL\n  res.json({ email, source: fromEnv ? 'env' : 'db' })\n})\n\nrouter.put('/superadmin-email', requireSuperAdmin, async (req, res) => {\n  const body = z.object({ email: z.string().email() }).parse(req.body || {})\n  const value = await setSuperAdminEmail(body.email)\n  res.json({ ok: true, email: value })\n})\n\nexport default router\n\n","import { Router, Request, Response } from 'express'\nimport multer from 'multer'\nimport axios from 'axios'\nimport fs from 'fs'\n\nconst router = Router()\n\n// Use multer to accept single audio blob\nconst upload = multer({ storage: multer.memoryStorage() })\n\nasync function sleep(ms: number) {\n  return new Promise(resolve => setTimeout(resolve, ms))\n}\n\nrouter.post('/transcribe', upload.single('audio'), async (req: Request, res: Response) => {\n  try {\n    const key = process.env.ASSEMBLYAI_API_KEY || ''\n    if (!key) return res.status(500).json({ error: 'Missing ASSEMBLYAI_API_KEY' })\n    const file = (req as any).file as Express.Multer.File\n    if (!file || !file.buffer) return res.status(400).json({ error: 'No audio uploaded (field name \"audio\")' })\n\n    // 1) Upload audio bytes to AssemblyAI\n    const uploadResp = await axios.post('https://api.assemblyai.com/v2/upload', file.buffer, {\n      headers: {\n        authorization: key,\n        'content-type': 'application/octet-stream',\n      },\n      maxBodyLength: Infinity,\n    })\n    const uploadUrl = uploadResp?.data?.upload_url\n    if (!uploadUrl) return res.status(400).json({ error: 'Failed to upload audio' })\n\n    // 2) Create transcript job\n    const trResp = await axios.post('https://api.assemblyai.com/v2/transcript', {\n      audio_url: uploadUrl,\n      punctuate: true,\n      format_text: true,\n    }, {\n      headers: { authorization: key, 'content-type': 'application/json' },\n    })\n    const trId = trResp?.data?.id\n    if (!trId) return res.status(400).json({ error: 'Failed to create transcript' })\n\n    // 3) Poll for completion\n    let text = ''\n    for (let i = 0; i < 30; i++) {\n      await sleep(2000)\n      const poll = await axios.get(`https://api.assemblyai.com/v2/transcript/${trId}`, {\n        headers: { authorization: key },\n      })\n      const status = String(poll?.data?.status || '')\n      if (status === 'completed') { text = String(poll?.data?.text || '') ; break }\n      if (status === 'error') {\n        return res.status(400).json({ error: poll?.data?.error || 'Transcription failed' })\n      }\n    }\n    if (!text) return res.status(504).json({ error: 'Transcription timeout' })\n    res.json({ text })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Failed to transcribe audio' })\n  }\n})\n\n// Issue an ephemeral token for AssemblyAI Realtime (prevents exposing permanent key to client)\nrouter.get('/realtime-token', async (_req: Request, res: Response) => {\n  try {\n    const key = process.env.ASSEMBLYAI_API_KEY || ''\n    if (!key) return res.status(500).json({ error: 'Missing ASSEMBLYAI_API_KEY' })\n\n    // Per Universal Streaming docs: omit model field; tokens default to Universal.\n    const headers = { authorization: key, 'content-type': 'application/json' }\n    const body = { expires_in: 3600 }\n    const r = await axios.post('https://api.assemblyai.com/v2/realtime/token', body, { headers })\n    const token = r?.data?.token\n    if (!token) return res.status(400).json({ error: 'Failed to obtain realtime token' })\n    res.json({ token, model: 'universal' })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.response?.data || e?.message || 'Failed to obtain realtime token' })\n  }\n})\n\nexport default router\n","import { Router, Request, Response } from 'express'\nimport axios from 'axios'\n\nconst router = Router()\n\n// Simple proxy to RapidAPI ChatGPT AI Chat Bot\nrouter.post('/send', async (req: Request, res: Response) => {\n  try {\n    const message = String(req.body?.message || '').trim()\n    if (!message) return res.status(400).json({ error: 'message is required' })\n\n    // Prefer Pipedream workflow if configured\n    const pdUrl = process.env.PIPEDREAM_CHAT_URL || ''\n    const pdKey = process.env.PIPEDREAM_API_KEY || ''\n    if (pdUrl) {\n      const extract = (d: any): string => {\n        if (!d) return ''\n        const fields = ['reply','response','answer','message','result','text']\n        for (const f of fields) {\n          if (typeof d?.[f] === 'string' && d[f].trim()) return d[f].trim()\n        }\n        // Common Pipedream Respond step: { body: { reply: '...', text: '...' } } or body as string\n        if (typeof d?.body === 'string' && d.body.trim()) return d.body.trim()\n        if (typeof d?.body === 'object' && d.body) {\n          for (const f of fields) {\n            const v = d.body[f]\n            if (typeof v === 'string' && v.trim()) return v.trim()\n          }\n        }\n        if (Array.isArray(d?.choices) && typeof d.choices[0]?.text === 'string') return d.choices[0].text.trim()\n        if (typeof d?.data?.text === 'string') return d.data.text.trim()\n        return ''\n      }\n      const jsonHeaders: Record<string, string> = { 'Content-Type': 'application/json' }\n      if (pdKey) { jsonHeaders['Authorization'] = `Bearer ${pdKey}`; jsonHeaders['x-api-key'] = pdKey }\n      const formHeaders: Record<string, string> = { 'Content-Type': 'application/x-www-form-urlencoded' }\n      if (pdKey) { formHeaders['Authorization'] = `Bearer ${pdKey}`; formHeaders['x-api-key'] = pdKey }\n      const attempts: Array<() => Promise<{ ok: boolean; status: number; data: any }>> = [\n        async () => ({ ok: true, status: 0, data: await (await axios.post(pdUrl, { message, userId: (req as any).userId || null, ts: new Date().toISOString() }, { headers: jsonHeaders, timeout: 30000, validateStatus: () => true })).data, }),\n        async () => ({ ok: true, status: 0, data: await (await axios.post(pdUrl, { text: message }, { headers: jsonHeaders, timeout: 30000, validateStatus: () => true })).data, }),\n        async () => ({ ok: true, status: 0, data: await (await axios.post(pdUrl, { prompt: message }, { headers: jsonHeaders, timeout: 30000, validateStatus: () => true })).data, }),\n        async () => ({ ok: true, status: 0, data: await (await axios.post(pdUrl, { query: message }, { headers: jsonHeaders, timeout: 30000, validateStatus: () => true })).data, }),\n        async () => ({ ok: true, status: 0, data: await (await axios.post(pdUrl, new URLSearchParams({ message }), { headers: formHeaders, timeout: 30000, validateStatus: () => true })).data, }),\n        async () => ({ ok: true, status: 0, data: await (await axios.get(`${pdUrl}?message=${encodeURIComponent(message)}`, { headers: jsonHeaders, timeout: 30000, validateStatus: () => true })).data, }),\n      ]\n      for (const fn of attempts) {\n        try {\n          const resp = await fn()\n          const reply = extract(resp.data)\n          if (reply) return res.json({ reply })\n        } catch (err: any) {\n          const code = err?.response?.status\n          const data = err?.response?.data\n          console.warn('Pipedream upstream error', { code, data: typeof data === 'string' ? data : JSON.stringify(data) })\n          if (code === 401 || code === 403) return res.status(code).json({ error: 'Pipedream authentication failed. Check PIPEDREAM_API_KEY or workflow auth.' })\n        }\n      }\n      // As a last-resort fallback, if Pipedream responded with any string, surface it\n      try {\n        const probe = await axios.get(pdUrl, { timeout: 5000, validateStatus: () => true })\n        const data = probe?.data\n        if (typeof data === 'string' && data.trim()) return res.json({ reply: data.substring(0, 1000) })\n      } catch {}\n      return res.status(502).json({ error: 'Pipedream workflow error (no reply). Ensure your workflow responds with { reply: \"...\" } or a text body.' })\n    }\n\n    // Fallback: RapidAPI provider if configured\n    const key = process.env.RAPIDAPI_CHAT_KEY || process.env.RAPIDAPI_KEY || ''\n    const host = process.env.RAPIDAPI_CHAT_HOST || 'chatgpt-ai-chat-bot.p.rapidapi.com'\n    if (!key) return res.status(500).json({ error: 'Missing chatbot provider configuration' })\n\n    const headers = { 'X-RapidAPI-Key': key, 'X-RapidAPI-Host': host }\n    const timeout = 30000\n\n    const extract = (data: any): string => {\n      if (!data) return ''\n      const fields = ['response', 'answer', 'message', 'result', 'reply', 'content']\n      for (const f of fields) {\n        if (typeof data[f] === 'string' && data[f].trim()) return data[f].trim()\n      }\n      // Some APIs return { data: { text: '...' } }\n      if (typeof data?.data?.text === 'string') return data.data.text.trim()\n      if (Array.isArray(data?.choices) && data.choices[0]?.text) return String(data.choices[0].text).trim()\n      return ''\n    }\n\n    // Try a sequence of endpoints/encodings commonly exposed by this RapidAPI\n    const attempts: Array<() => Promise<string>> = [\n      async () => {\n        const url = new URL(`https://${host}/ask`)\n        url.searchParams.set('query', message)\n        const r = await axios.get(url.toString(), { headers, timeout })\n        return extract(r.data)\n      },\n      async () => {\n        const url = `https://${host}/chat`\n        const r = await axios.post(url, { message }, { headers: { ...headers, 'Content-Type': 'application/json' }, timeout })\n        return extract(r.data)\n      },\n    ]\n\n    for (const attempt of attempts) {\n      try {\n        const txt = await attempt()\n        if (txt) return res.json({ reply: txt })\n      } catch (err: any) {\n        // log and continue to next attempt\n        const code = err?.response?.status\n        const data = err?.response?.data\n        console.warn('Chatbot upstream error', { code, data: typeof data === 'string' ? data : JSON.stringify(data) })\n        if (code === 403) {\n          return res.status(403).json({ error: 'Upstream says your RapidAPI key is not subscribed to this API. Subscribe to the API or set RAPIDAPI_CHAT_KEY for a subscribed app.' })\n        }\n        if (code === 429) {\n          const retryAfter = err?.response?.headers?.['retry-after'] || null\n          return res.status(429).json({ error: 'Upstream rate limit reached. Please wait and try again.', retryAfter })\n        }\n      }\n    }\n\n    return res.status(502).json({ error: 'Chatbot upstream did not return a response' })\n  } catch (e: any) {\n    res.status(400).json({ error: e?.message || 'Chatbot failed' })\n  }\n})\n\nexport default router\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AASA,SAAS,mBAAmB,MAAkC;AAC5D,QAAM,MAAM,OAAO,QAAQ,EAAE;AAC7B,QAAM,QAAQ,IAAI,MAAM,OAAO,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC,EAAE,OAAO,OAAO;AAElE,QAAM,eAAe;AAGrB,WAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,UAAM,KAAK,MAAM,CAAC;AAClB,UAAM,IAAI,GAAG,MAAM,YAAY;AAC/B,QAAI,KAAK,EAAE,CAAC,GAAG;AACb,YAAM,MAAM,OAAO,EAAE,CAAC,EAAE,QAAQ,MAAM,EAAE,CAAC;AACzC,UAAI,CAAC,OAAO,MAAM,GAAG,EAAG,QAAO;AAAA,IACjC;AAAA,EACF;AAGA,WAAS,IAAI,GAAG,IAAI,MAAM,QAAQ,KAAK;AACrC,UAAM,MAAM,GAAG,MAAM,CAAC,CAAC,IAAI,MAAM,IAAI,CAAC,KAAK,EAAE;AAC7C,UAAM,IAAI,IAAI,MAAM,YAAY;AAChC,QAAI,KAAK,EAAE,CAAC,GAAG;AACb,YAAM,MAAM,OAAO,EAAE,CAAC,EAAE,QAAQ,MAAM,EAAE,CAAC;AACzC,UAAI,CAAC,OAAO,MAAM,GAAG,EAAG,QAAO;AAAA,IACjC;AAAA,EACF;AAGA,QAAM,IAAI,IAAI,MAAM,YAAY;AAChC,MAAI,KAAK,EAAE,CAAC,GAAG;AACb,UAAM,MAAM,OAAO,EAAE,CAAC,EAAE,QAAQ,MAAM,EAAE,CAAC;AACzC,QAAI,CAAC,OAAO,MAAM,GAAG,EAAG,QAAO;AAAA,EACjC;AAEA,SAAO;AACT;AAEA,eAAsB,qBAAqB,QAA6C;AACtF,MAAI;AACF,UAAM,SAAS,UAAM,iBAAAA,SAAS,MAAM;AACpC,WAAO,mBAAmB,OAAO,QAAQ,QAAQ,EAAE,CAAC;AAAA,EACtD,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAEA,eAAsB,uBAAuB,QAA6C;AACxF,MAAI;AACF,UAAM,EAAE,KAAK,IAAI,MAAM,iBAAAC,QAAU,UAAU,QAAQ,OAAO,EAAE,QAAQ,MAAM;AAAA,IAAC,EAAE,CAAC;AAC9E,WAAO,mBAAmB,OAAO,MAAM,QAAQ,EAAE,CAAC;AAAA,EACpD,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAEA,eAAsB,cAAc,QAAgB,UAA+C;AACjG,MAAI,qBAAqB,KAAK,QAAQ,EAAG,QAAO,qBAAqB,MAAM;AAC3E,MAAI,YAAY,KAAK,QAAQ,EAAG,QAAO,uBAAuB,MAAM;AACpE,SAAO;AACT;AAnEA,IAIA,kBAGA;AAPA;AAAA;AAAA;AAIA,uBAAqB;AAGrB,uBAAsB;AAAA;AAAA;;;ACPtB,IAAAC,aAAe;AACf,IAAAC,eAAiB;AACjB,oBAAmB;AAcnB,IAAAC,mBAAoB;AACpB,kBAAiB;AACjB,oBAAmB;AACnB,IAAAC,kBAA6B;;;ACnB7B,oBAAmB;AACnB,gCAAsB;AAGf,SAAS,mBAAmB;AACjC,aAAO,cAAAC,SAAO;AAAA,IACZ,uBAAuB;AAAA;AAAA,IACvB,2BAA2B;AAAA,EAC7B,CAAC;AACH;AAEO,SAAS,mBAAmB;AACjC,aAAO,0BAAAC,SAAU;AAAA,IACf,UAAU,KAAK,KAAK;AAAA,IACpB,KAAK;AAAA,IACL,iBAAiB;AAAA,IACjB,eAAe;AAAA,IACf,SAAS;AAAA,EACX,CAAC;AACH;AAEO,SAAS,mBAAgC;AAC9C,QAAM,YAAY,QAAQ,IAAI,kBAAkB,IAAI,YAAY,MAAM;AACtE,QAAM,YAAY,QAAQ,IAAI,qBAAqB,QAAQ,IAAI,gBAAgB;AAC/E,QAAM,UAAU,YAAY,UAAU,MAAM,GAAG,EAAE,IAAI,OAAK,EAAE,KAAK,CAAC,IAAI,CAAC;AACvE,SAAO,YAAY,QAAQ,WAAW,IAClC,EAAE,QAAQ,MAAM,aAAa,KAAK,IAClC,EAAE,QAAQ,SAAS,aAAa,KAAK;AAC3C;;;AC5BA,qBAA0C;AAC1C,oBAAyC;AACzC,iBAAkB;AAElB,IAAM,SAAS,IAAI,2BAAa;AAChC,IAAM,aAAS,uBAAO;AAEtB,SAAS,iBAAiB,OAAiC;AACzD,QAAM,QAAQ,MAAM;AACpB,MAAI,UAAU,EAAG,QAAO;AACxB,QAAM,YAAY,MAAM,OAAO,OAAK,EAAE,WAAW,WAAW,EAAE;AAC9D,SAAO,KAAK,MAAO,YAAY,QAAS,GAAG;AAC7C;AAEA,eAAe,wBAAwB,WAAmB;AACxD,QAAM,SAAS,MAAM,OAAO,MAAM,SAAS;AAAA,IACzC,OAAO,EAAE,UAAU;AAAA,IACnB,SAAS,EAAE,OAAO,EAAE,QAAQ,EAAE,IAAI,MAAM,QAAQ,KAAK,EAAE,EAAE;AAAA,EAC3D,CAAC;AACD,QAAM,WAAW,OAAO,QAAQ,OAAK,EAAE,KAAK;AAC5C,QAAM,WAAW,iBAAiB,QAAQ;AAE1C,QAAM,cAAc,MAAM,OAAO,QAAQ,UAAU;AAAA,IACjD,MAAM,EAAE,cAAc,KAAK;AAAA,IAC3B,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,UAAU,EAAE,EAAE;AAAA,EAC1C,CAAC;AACD,QAAM,WAAW,YAAY,KAAK,gBAAgB;AAClD,QAAM,YAAY,KAAK,MAAO,WAAW,KAAM,GAAG,IAAI;AAEtD,QAAM,UAAU,MAAM,OAAO,QAAQ,WAAW;AAAA,IAC9C,OAAO,EAAE,IAAI,UAAU;AAAA,IACvB,QAAQ,EAAE,gBAAgB,KAAK;AAAA,EACjC,CAAC;AACD,QAAM,iBAAiB,SAAS,kBAAkB;AAClD,QAAM,YAAY,KAAK,IAAI,iBAAiB,WAAW,CAAC;AACxD,SAAO,EAAE,UAAU,WAAW,WAAW,eAAe;AAC1D;AAEA,OAAO,IAAI,KAAK,OAAO,MAAe,QAAkB;AACtD,QAAM,WAAW,MAAM,OAAO,QAAQ,SAAS;AAAA,IAC7C,SAAS;AAAA,MACP,QAAQ,EAAE,SAAS,EAAE,OAAO,EAAE,QAAQ,EAAE,QAAQ,KAAK,EAAE,EAAE,EAAE;AAAA,MAC3D,aAAa,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE;AAAA,IACzC;AAAA,IACA,SAAS,EAAE,WAAW,OAAO;AAAA,EAC/B,CAAC;AACD,QAAM,SAAS,MAAM,QAAQ;AAAA,IAC3B,SAAS,IAAI,OAAM,MAAK;AACtB,YAAM,WAAW,EAAE,OAAO,QAAQ,QAAM,GAAG,KAAK;AAChD,YAAM,WAAW,iBAAiB,QAAQ;AAC1C,YAAM,MAAM,MAAM,OAAO,QAAQ,UAAU;AAAA,QACzC,MAAM,EAAE,cAAc,KAAK;AAAA,QAC3B,OAAO,EAAE,MAAM,EAAE,OAAO,EAAE,WAAW,EAAE,GAAG,EAAE,EAAE;AAAA,MAChD,CAAC;AACD,YAAM,YAAY,KAAK,OAAQ,IAAI,KAAK,gBAAgB,KAAK,KAAM,GAAG,IAAI;AAC1E,YAAM,YAAY,KAAK,IAAI,EAAE,iBAAiB,WAAW,CAAC;AAG1D,YAAM,aAAa,EAAE,OAClB,IAAI,QAAM,GAAG,SAAS,EACtB,OAAO,OAAO,EACd,KAAK,CAAC,GAAQ,MAAW,IAAI,KAAK,CAAC,EAAE,QAAQ,IAAI,IAAI,KAAK,CAAC,EAAE,QAAQ,CAAC,EAAE,CAAC;AAC5E,YAAM,WAAW,EAAE,OAChB,IAAI,QAAM,GAAG,OAAO,EACpB,OAAO,OAAO,EACd,KAAK,CAAC,GAAQ,MAAW,IAAI,KAAK,CAAC,EAAE,QAAQ,IAAI,IAAI,KAAK,CAAC,EAAE,QAAQ,CAAC,EAAE,CAAC;AAC5E,YAAM,YAAY,EAAE,aAAa,cAAc;AAC/C,YAAM,UAAU,EAAE,WAAW,YAAY;AACzC,aAAO;AAAA,QACL,GAAG;AAAA,QACH,QAAQ;AAAA,QACR,aAAa,EAAE;AAAA,QACf;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,QACA;AAAA,MACF;AAAA,IACF,CAAC;AAAA,EACH;AACA,MAAI,KAAK,MAAM;AACjB,CAAC;AAGD,OAAO,IAAI,UAAU,OAAO,MAAe,QAAkB;AAC3D,QAAM,WAAW,MAAM,OAAO,QAAQ,SAAS;AAAA,IAC7C,SAAS,EAAE,WAAW,OAAO;AAAA,IAC7B,QAAQ;AAAA,MACN,IAAI;AAAA,MACJ,OAAO;AAAA,MACP,QAAQ,EAAE,QAAQ,EAAE,IAAI,MAAM,MAAM,KAAK,EAAE;AAAA,IAC7C;AAAA,EACF,CAAC;AACD,MAAI,KAAK,SAAS,IAAI,QAAM,EAAE,IAAI,EAAE,IAAI,MAAM,EAAE,OAAO,QAAQ,EAAE,OAAO,IAAI,SAAO,EAAE,IAAI,GAAG,IAAI,MAAM,GAAG,KAAK,EAAE,EAAE,EAAE,CAAC;AACvH,CAAC;AAED,IAAM,sBAAsB,aAAE,OAAO;AAAA,EACnC,MAAM,aAAE,OAAO;AAAA,EACf,OAAO,aAAE,OAAO;AAAA,EAChB,aAAa,aAAE,OAAO,EAAE,QAAQ,EAAE;AAAA,EAClC,SAAS,aAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,gBAAgB,aAAE,OAAO,EAAE,IAAI,EAAE,YAAY,EAAE,QAAQ,CAAC;AAAA,EACxD,YAAY,aAAE,KAAK,CAAC,WAAW,QAAQ,SAAS,CAAC,EAAE,QAAQ,MAAM;AAAA,EACjE,QAAQ,aAAE,KAAK,CAAC,YAAY,eAAe,WAAW,aAAa,WAAW,CAAC,EAAE,QAAQ,UAAU;AAAA,EACnG,WAAW,aAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EAC1C,SAAS,aAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EACxC,eAAe,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAC1D,CAAC;AAED,OAAO,KAAK,KAAK,OAAO,KAAc,QAAkB;AACtD,QAAM,SAAS,oBAAoB,UAAU,IAAI,IAAI;AACrD,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,OAAO,OAAO;AAEpB,MAAI,KAAK,UAAW,MAAK,YAAY,IAAI,KAAK,KAAK,SAAS;AAC5D,MAAI,KAAK,QAAS,MAAK,UAAU,IAAI,KAAK,KAAK,OAAO;AACtD,MAAI,KAAK,aAAa,KAAK,WAAW,KAAK,YAAY,KAAK,SAAS;AACnE,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+CAA+C,CAAC;AAAA,EACvF;AACA,MAAI;AACF,UAAM,EAAE,eAAe,GAAG,YAAY,IAAI;AAC1C,UAAM,UAAU,MAAM,OAAO,QAAQ,OAAO,EAAE,MAAM,YAAY,CAAC;AAEjE,QAAI,iBAAiB,cAAc,SAAS,GAAG;AAC7C,YAAM,UAAU,MAAM,kBAAkB,QAAQ,aAAa;AAC7D,iBAAW,UAAU,eAAe;AAClC,cAAM,OAAQ,QAAQ,MAAM,KAAK;AACjC,cAAM,OAAO,kBAAkB,OAAO;AAAA,UACpC,OAAO,EAAE,kBAAkB,EAAE,WAAW,QAAQ,IAAI,OAAO,EAAE;AAAA,UAC7D,QAAQ,EAAE,KAAK;AAAA,UACf,QAAQ,EAAE,WAAW,QAAQ,IAAI,QAAQ,KAAK;AAAA,QAChD,CAAC;AAAA,MACH;AAAA,IACF;AAEA,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAED,OAAO,IAAI,QAAQ,OAAO,KAAc,QAAkB;AACxD,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,UAAU,MAAM,OAAO,QAAQ,WAAW;AAAA,IAC9C,OAAO,EAAE,GAAG;AAAA,IACZ,SAAS;AAAA,MACP,QAAQ,EAAE,SAAS,EAAE,OAAO,EAAE,SAAS,EAAE,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,EAAE,EAAE,EAAE,EAAE;AAAA,MACtF,aAAa,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE;AAAA,MACvC,OAAO;AAAA,IACT;AAAA,EACF,CAAC;AACD,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAChE,QAAM,OAAO,MAAM,wBAAwB,EAAE;AAC7C,MAAI,KAAK,EAAE,GAAG,SAAS,GAAG,KAAK,CAAC;AAClC,CAAC;AAGD,OAAO,IAAI,gBAAgB,OAAO,KAAc,QAAkB;AAChE,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,cAAc,MAAM,OAAO,kBAAkB,SAAS;AAAA,IAC1D,OAAO,EAAE,WAAW,GAAG;AAAA,IACvB,SAAS,EAAE,MAAM,KAAK;AAAA,IACtB,SAAS,EAAE,MAAM,EAAE,MAAM,MAAM,EAAE;AAAA,EACnC,CAAC;AACD,QAAM,QAAQ,YAAY,IAAI,OAAK,EAAE,IAAI;AACzC,MAAI,KAAK,KAAK;AAChB,CAAC;AAED,IAAM,sBAAsB,oBAAoB,QAAQ;AACxD,OAAO,MAAM,QAAQ,OAAO,KAAc,QAAkB;AAC1D,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,SAAS,oBAAoB,UAAU,IAAI,IAAI;AACrD,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,OAAY,EAAE,GAAG,OAAO,KAAK;AACnC,MAAI,KAAK,cAAc,OAAW,MAAK,YAAY,KAAK,YAAY,IAAI,KAAK,KAAK,SAAS,IAAI;AAC/F,MAAI,KAAK,YAAY,OAAW,MAAK,UAAU,KAAK,UAAU,IAAI,KAAK,KAAK,OAAO,IAAI;AACvF,MAAI,KAAK,aAAa,KAAK,WAAW,KAAK,YAAY,KAAK,SAAS;AACnE,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+CAA+C,CAAC;AAAA,EACvF;AACA,QAAM,UAAU,MAAM,OAAO,QAAQ,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,KAAK,CAAC;AACnE,QAAM,OAAO,MAAM,wBAAwB,EAAE;AAC7C,MAAI,KAAK,EAAE,GAAG,SAAS,GAAG,KAAK,CAAC;AAClC,CAAC;AAED,OAAO,KAAK,eAAe,OAAO,KAAc,QAAkB;AAChE,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,SAAS,aAAE,OAAO;AAAA,IACtB,MAAM,aAAE,OAAO;AAAA,IACf,aAAa,aAAE,OAAO,EAAE,SAAS;AAAA,IACjC,WAAW,aAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,IAC1C,SAAS,aAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,EAC1C,CAAC;AACD,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,MAAM,aAAa,WAAW,QAAQ,IAAI,OAAO;AACzD,QAAM,QAAQ,MAAM,OAAO,MAAM,OAAO;AAAA,IACtC,MAAM;AAAA,MACJ;AAAA,MACA;AAAA,MACA,WAAW,YAAY,IAAI,KAAK,SAAS,IAAI;AAAA,MAC7C,SAAS,UAAU,IAAI,KAAK,OAAO,IAAI;AAAA,MACvC,WAAW;AAAA,IACb;AAAA,EACF,CAAC;AACD,MAAI,OAAO,GAAG,EAAE,KAAK,KAAK;AAC5B,CAAC;AAGD,OAAO,MAAM,wBAAwB,OAAO,KAAc,QAAkB;AAC1E,QAAM,YAAY,IAAI,OAAO;AAC7B,QAAM,UAAU,IAAI,OAAO;AAE3B,QAAM,SAAS,aAAE,OAAO;AAAA,IACtB,MAAM,aAAE,OAAO,EAAE,SAAS;AAAA,IAC1B,aAAa,aAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,IAC5C,WAAW,aAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS;AAAA,IACrD,SAAS,aAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS;AAAA,EACrD,CAAC;AAED,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AAGvE,QAAM,QAAQ,MAAM,OAAO,MAAM,UAAU,EAAE,OAAO,EAAE,IAAI,SAAS,UAAU,EAAE,CAAC;AAChF,MAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8BAA8B,CAAC;AAEhF,QAAM,OAAY,EAAE,GAAG,OAAO,KAAK;AACnC,MAAI,KAAK,cAAc,OAAW,MAAK,YAAY,KAAK,YAAY,IAAI,KAAK,KAAK,SAAS,IAAI;AAC/F,MAAI,KAAK,YAAY,OAAW,MAAK,UAAU,KAAK,UAAU,IAAI,KAAK,KAAK,OAAO,IAAI;AAEvF,MAAI;AACF,UAAM,UAAU,MAAM,OAAO,MAAM,OAAO,EAAE,OAAO,EAAE,IAAI,QAAQ,GAAG,KAAK,CAAC;AAC1E,QAAI,KAAK,OAAO;AAAA,EAClB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,yBAAyB,CAAC;AAAA,EACxE;AACF,CAAC;AAGD,OAAO,KAAK,gBAAgB,OAAO,KAAc,QAAkB;AACjE,QAAM,YAAY,IAAI,OAAO;AAC7B,QAAM,SAAS,aAAE,OAAO,EAAE,SAAS,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,IAAI,CAAC,GAAG,MAAM,aAAE,KAAK,CAAC,YAAW,WAAU,cAAa,QAAO,YAAW,KAAK,CAAC,EAAE,SAAS,EAAE,CAAC;AACrJ,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,SAAS,KAAK,IAAI,OAAO;AACjC,MAAI;AACF,QAAI,UAAkC,CAAC;AACvC,QAAI,CAAC,MAAM;AACT,gBAAU,MAAM,kBAAkB,QAAQ,OAAO;AAAA,IACnD;AACA,QAAI,QAAQ;AACZ,eAAW,UAAU,SAAS;AAC5B,YAAM,IAAK,QAAQ,QAAQ,MAAM,KAAK;AACtC,YAAM,OAAO,kBAAkB,OAAO;AAAA,QACpC,OAAO,EAAE,kBAAkB,EAAE,WAAW,OAAO,EAAE;AAAA,QACjD,QAAQ,EAAE,MAAM,EAAE;AAAA,QAClB,QAAQ,EAAE,WAAW,QAAQ,MAAM,EAAE;AAAA,MACvC,CAAC;AACD;AAAA,IACF;AACA,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,MAAM,CAAC;AAAA,EAChC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAGD,OAAO,OAAO,gBAAgB,OAAO,KAAc,QAAkB;AACnE,QAAM,YAAY,IAAI,OAAO;AAC7B,QAAM,SAAS,aAAE,OAAO,EAAE,SAAS,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,IAAI,CAAC,EAAE,CAAC;AAC/D,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,QAAQ,IAAI,OAAO;AAC3B,MAAI;AACF,UAAM,SAAS,MAAM,OAAO,kBAAkB,WAAW;AAAA,MACvD,OAAO,EAAE,WAAW,QAAQ,EAAE,IAAI,QAAQ,EAAE;AAAA,IAC9C,CAAC;AACD,QAAI,KAAK,EAAE,OAAO,OAAO,MAAM,CAAC;AAAA,EAClC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAGD,OAAO,KAAK,8BAA8B,OAAO,KAAc,QAAkB;AAC/E,QAAM,YAAY,IAAI,OAAO;AAC7B,QAAM,UAAU,IAAI,OAAO;AAE3B,QAAM,SAAS,aAAE,OAAO;AAAA,IACtB,OAAO,aAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IACvB,aAAa,aAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE;AAAA,IAC7C,SAAS,aAAE,OAAO,EAAE,SAAS;AAAA;AAAA,IAC7B,QAAQ,aAAE,KAAK,CAAC,eAAe,eAAe,WAAW,WAAW,CAAC,EAAE,SAAS,EAAE,QAAQ,aAAa;AAAA,IACvG,iBAAiB,aAAE,MAAM,aAAE,OAAO,CAAC,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;AAAA,IAC1D,UAAU,aAAE,KAAK,CAAC,OAAM,UAAS,QAAO,UAAU,CAAC,EAAE,SAAS;AAAA,EAChE,CAAC;AAED,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,OAAO,aAAa,SAAS,QAAQ,iBAAiB,SAAS,IAAI,OAAO;AAElF,MAAI;AAEF,UAAM,QAAQ,MAAM,OAAO,MAAM,UAAU,EAAE,OAAO,EAAE,IAAI,SAAS,UAAU,EAAE,CAAC;AAChF,QAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8BAA8B,CAAC;AAGhF,QAAI;AACJ,QAAI,SAAS;AACX,YAAM,SAAS,IAAI,KAAK,OAAO;AAC/B,UAAI,MAAM,OAAO,QAAQ,CAAC,GAAG;AAC3B,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yBAAyB,CAAC;AAAA,MACjE;AACA,YAAM;AAAA,IACR;AAIA,UAAM,sBAAsB,gBAAgB,SACxC,MAAM,OAAO,kBAAkB,SAAS;AAAA,MACtC,OAAO,EAAE,WAAW,QAAQ,EAAE,IAAI,gBAAgB,EAAE;AAAA,MACpD,QAAQ,EAAE,IAAI,MAAM,QAAQ,KAAK;AAAA,IACnC,CAAC,IACD,CAAC;AAEL,UAAM,kBAAkB,IAAI,IAAI,oBAAoB,IAAI,OAAK,EAAE,MAAM,CAAC;AACtE,UAAM,kBAAkB,mBAAmB,CAAC,GAAG,OAAO,CAAC,QAAgB,CAAC,gBAAgB,IAAI,GAAG,CAAC;AAEhG,QAAI,qBAAuC,CAAC;AAC5C,QAAI,eAAe,SAAS,GAAG;AAE7B,YAAM,UAAU,MAAM,kBAAkB,QAAQ,cAAc;AAC9D,YAAM,OAAO,kBAAkB,WAAW;AAAA,QACxC,MAAM,eAAe,IAAI,CAAC,SAAiB,EAAE,WAAW,QAAQ,KAAK,MAAO,QAAQ,GAAG,KAAK,WAAmB,EAAE;AAAA,QACjH,gBAAgB;AAAA,MAClB,CAAC;AACD,2BAAqB,MAAM,OAAO,kBAAkB,SAAS;AAAA,QAC3D,OAAO,EAAE,WAAW,QAAQ,EAAE,IAAI,eAAe,EAAE;AAAA,QACnD,QAAQ,EAAE,IAAI,KAAK;AAAA,MACrB,CAAC;AAAA,IACH;AAEA,UAAM,UAAU,MAAM,OAAO,KAAK,OAAO;AAAA,MACvC,MAAO;AAAA,QACL;AAAA,QACA,aAAa,eAAe;AAAA,QAC5B;AAAA,QACA,SAAS;AAAA,QACT,UAAW,YAAY;AAAA,QACvB;AAAA,QACA,WAAY,oBAAoB,UAAU,mBAAmB,SACzD,EAAE,SAAS,CAAC,GAAG,qBAAqB,GAAG,kBAAkB,EAAE,IAAI,QAAM,EAAE,IAAI,EAAE,GAAG,EAAE,EAAE,IACpF;AAAA,MACN;AAAA,MACA,SAAS;AAAA,QACP,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE;AAAA,MACvC;AAAA,IACF,CAAC;AAED,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO;AAAA,EAC9B,SAAS,GAAQ;AACf,YAAQ,MAAM,yBAAyB,CAAC;AACxC,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAED,IAAO,mBAAQ;AAEf,eAAe,kBAAkBC,UAAsB,SAAoD;AACzG,MAAI,CAAC,WAAW,QAAQ,WAAW,EAAG,QAAO,CAAC;AAC9C,QAAM,QAAQ,MAAMA,SAAO,KAAK,SAAS;AAAA,IACvC,OAAO,EAAE,IAAI,EAAE,IAAI,QAAQ,EAAE;AAAA,IAC7B,SAAS,EAAE,MAAM,MAAM,YAAY,KAAK;AAAA,EAC1C,CAAC;AACD,QAAM,MAA8B,CAAC;AACrC,aAAW,KAAK,OAAO;AACrB,UAAM,WAAW,EAAE,MAAM,QAAQ,IAAI,YAAY;AACjD,UAAM,QAAQ,EAAE,YAAY,QAAQ,IAAI,YAAY;AACpD,QAAI,KAAa;AACjB,QAAI,CAAC,YAAY,WAAW,QAAQ,cAAc,YAAY,KAAK,EAAE,SAAS,OAAO,GAAG;AACtF,WAAK;AAAA,IACP,WAAW,KAAK,SAAS,KAAK,GAAG;AAC/B,WAAK;AAAA,IACP,WAAW,YAAY,UAAU;AAE/B,WAAK;AAAA,IACP;AACA,QAAI,EAAE,EAAE,IAAI;AAAA,EACd;AACA,SAAO;AACT;;;ACtYA,IAAAC,kBAA0C;AAC1C,IAAAC,iBAAsD;AACtD,IAAAC,cAAkB;AAElB,IAAMC,UAAS,IAAI,4BAAa;AAChC,IAAMC,cAAS,wBAAO;AAEtBA,QAAO,KAAK,0BAA0B,OAAO,KAAc,QAAkB;AAC3E,QAAM,UAAU,IAAI,OAAO;AAC3B,QAAM,SAAS,cAAE,OAAO;AAAA,IACtB,OAAO,cAAE,OAAO;AAAA,IAChB,aAAa,cAAE,OAAO,EAAE,QAAQ,EAAE;AAAA,IAClC,SAAS,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,IACxC,UAAU,cAAE,KAAK,CAAC,OAAM,UAAS,QAAO,UAAU,CAAC,EAAE,SAAS;AAAA,EAChE,CAAC;AACD,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,OAAO,aAAa,SAAS,SAAS,IAAI,OAAO;AACzD,QAAM,OAAO,MAAMD,QAAO,KAAK,OAAO,EAAE,MAAO,EAAE,OAAO,aAAa,UAAW,YAAY,UAAkB,SAAS,UAAU,IAAI,KAAK,OAAO,IAAI,MAAM,QAAQ,EAAU,CAAC;AAC9K,MAAI,OAAO,GAAG,EAAE,KAAK,IAAI;AAC3B,CAAC;AAEDC,QAAO,IAAI,QAAQ,OAAO,KAAc,QAAkB;AACxD,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,OAAO,MAAMD,QAAO,KAAK,WAAW;AAAA,IACxC,OAAO,EAAE,GAAG;AAAA,IACZ,SAAS;AAAA,MACP,UAAU;AAAA,MACV,UAAU;AAAA,QACR,SAAS;AAAA,UACP,QAAQ;AAAA,UACR,SAAS,EAAE,SAAS,EAAE,QAAQ,KAAK,EAAE;AAAA,UACrC,UAAU;AAAA,QACZ;AAAA,QACA,SAAS,EAAE,WAAW,MAAM;AAAA,MAC9B;AAAA,MACA,WAAW;AAAA,MACX,OAAO,EAAE,SAAS,EAAE,SAAS,KAAK,EAAE;AAAA,MACpC,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE;AAAA,MACrC,SAAS,EAAE,SAAS,EAAE,WAAW,OAAO,EAAE;AAAA,IAC5C;AAAA,EACF,CAAC;AACD,MAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC7D,MAAI,KAAK,IAAI;AACf,CAAC;AAEDC,QAAO,MAAM,QAAQ,OAAO,KAAc,QAAkB;AAC1D,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,SAAS,cAAE,OAAO;AAAA,IACtB,OAAO,cAAE,OAAO,EAAE,SAAS;AAAA,IAC3B,aAAa,cAAE,OAAO,EAAE,SAAS;AAAA,IACjC,QAAQ,cAAE,WAAW,yBAAU,EAAE,SAAS;AAAA,IAC1C,SAAS,cAAE,OAAO,EAAE,SAAS,EAAE,SAAS,EAAE,SAAS;AAAA,IACnD,UAAU,cAAE,KAAK,CAAC,OAAM,UAAS,QAAO,UAAU,CAAC,EAAE,SAAS;AAAA,IAC9D,iBAAiB,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,SAAS;AAAA,EAChD,CAAC;AACD,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,iBAAiB,GAAG,KAAK,IAAI,OAAO;AAC5C,QAAM,OAAY,EAAE,GAAG,KAAK;AAC5B,MAAI,KAAK,YAAY,QAAW;AAC9B,SAAK,UAAU,KAAK,UAAU,IAAI,KAAK,KAAK,OAAO,IAAI;AAAA,EACzD;AAEA,QAAMD,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,KAAK,CAAC;AAGhD,MAAI,oBAAoB,QAAW;AAEjC,UAAM,IAAI,MAAMA,QAAO,KAAK,WAAW;AAAA,MACrC,OAAO,EAAE,GAAG;AAAA,MACZ,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,WAAW,KAAK,EAAE,EAAE;AAAA,IACnD,CAAC;AACD,UAAM,YAAY,GAAG,OAAO;AAC5B,QAAI,CAAC,UAAW,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+BAA+B,CAAC;AAGrF,UAAM,WAAW,gBAAgB,SAC7B,MAAMA,QAAO,kBAAkB,SAAS,EAAE,OAAO,EAAE,WAAW,QAAQ,EAAE,IAAI,gBAAgB,EAAE,GAAG,QAAQ,EAAE,IAAI,MAAM,QAAQ,KAAK,EAAE,CAAC,IACrI,CAAC;AACL,UAAM,cAAc,IAAI,IAAI,SAAS,IAAI,OAAK,EAAE,MAAM,CAAC;AACvD,UAAM,WAAW,mBAAmB,CAAC,GAAG,OAAO,CAAC,QAAgB,CAAC,YAAY,IAAI,GAAG,CAAC;AACrF,QAAI,QAAQ,SAAS,GAAG;AACtB,YAAMA,QAAO,kBAAkB,WAAW,EAAE,MAAM,QAAQ,IAAI,CAAC,SAAiB,EAAE,WAAW,QAAQ,KAAK,MAAM,WAAW,EAAE,GAAG,gBAAgB,KAAK,CAAC;AAAA,IACxJ;AACA,UAAM,iBAAiB,gBAAgB,SACnC,MAAMA,QAAO,kBAAkB,SAAS,EAAE,OAAO,EAAE,WAAW,QAAQ,EAAE,IAAI,gBAAgB,EAAE,GAAG,QAAQ,EAAE,IAAI,KAAK,EAAE,CAAC,IACvH,CAAC;AAGL,UAAMA,QAAO,KAAK,OAAO;AAAA,MACvB,OAAO,EAAE,GAAG;AAAA,MACZ,MAAM;AAAA,QACJ,WAAW,EAAE,KAAK,CAAC,GAAG,GAAI,eAAe,SAAS,EAAE,SAAS,eAAe,IAAI,QAAM,EAAE,IAAI,EAAE,GAAG,EAAE,EAAE,IAAI,CAAC,EAAG;AAAA,MAC/G;AAAA,IACF,CAAC;AAAA,EACH;AAEA,QAAM,UAAU,MAAMA,QAAO,KAAK,WAAW;AAAA,IAC3C,OAAO,EAAE,GAAG;AAAA,IACZ,SAAS,EAAE,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,EAAE;AAAA,EACpD,CAAC;AACD,MAAI,KAAK,OAAO;AAClB,CAAC;AAGDC,QAAO,KAAK,qBAAqB,OAAO,KAAc,QAAkB;AACtE,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qBAAqB,CAAC;AACxE,QAAM,SAAS,IAAI,OAAO;AAC1B,QAAM,SAAS,cAAE,OAAO;AAAA,IACtB,SAAS,cAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IACzB,UAAU,cAAE,OAAO,EAAE,SAAS;AAAA,IAC9B,gBAAgB,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,SAAS;AAAA,EAC/C,CAAC;AACD,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,SAAS,UAAU,eAAe,IAAI,OAAO;AAErD,MAAI;AAEF,UAAM,OAAO,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,EAAE,CAAC;AACnE,QAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AAElE,UAAM,UAAU,MAAMA,QAAO,QAAQ,OAAO;AAAA,MAC1C,MAAM;AAAA,QACJ;AAAA,QACA,UAAU;AAAA,QACV;AAAA,QACA,UAAU,YAAY;AAAA,QACtB,GAAI,kBAAkB,eAAe,SACjC,EAAE,UAAU,EAAE,SAAS,eAAe,IAAI,SAAO,EAAE,GAAG,EAAE,EAAE,EAAE,IAC5D,CAAC;AAAA,MACP;AAAA,MACA,SAAS,EAAE,QAAQ,MAAM,SAAS,EAAE,SAAS,EAAE,QAAQ,KAAK,EAAE,GAAG,UAAU,KAAK;AAAA,IAClF,CAAC;AAGD,UAAM,UAAU,QAAQ,SAAS,MAAM,GAAG,QAAQ,MAAM,GAAG,GAAG,CAAC,WAAM;AACrE,UAAMA,QAAO,aAAa,OAAO;AAAA,MAC/B,MAAM;AAAA,QACJ;AAAA,QACA,MAAM,2BAAY;AAAA,QAClB,SAAS,YAAY,OAAO;AAAA,QAC5B,aAAa;AAAA,MACf;AAAA,IACF,CAAC;AAED,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAGDC,QAAO,IAAI,qBAAqB,OAAO,KAAc,QAAkB;AACrE,QAAM,SAAS,IAAI,OAAO;AAC1B,MAAI;AACF,UAAM,WAAW,MAAMD,QAAO,QAAQ,SAAS;AAAA,MAC7C,OAAO,EAAE,QAAQ,UAAU,KAAK;AAAA,MAChC,SAAS,EAAE,QAAQ,MAAM,SAAS,EAAE,SAAS,EAAE,QAAQ,KAAK,EAAE,GAAG,UAAU,KAAK;AAAA,MAChF,SAAS,EAAE,WAAW,MAAM;AAAA,IAC9B,CAAC;AACD,QAAI,KAAK,QAAQ;AAAA,EACnB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,0BAA0B,CAAC;AAAA,EACzE;AACF,CAAC;AAGDC,QAAO,IAAI,oBAAoB,OAAO,KAAc,QAAkB;AACpE,QAAM,SAAS,IAAI,OAAO;AAC1B,MAAI;AACF,UAAM,UAAU,MAAMD,QAAO,aAAa,SAAS;AAAA,MACjD,OAAO,EAAE,OAAO;AAAA,MAChB,SAAS,EAAE,WAAW,OAAO;AAAA,MAC7B,SAAS,EAAE,WAAW,KAAK;AAAA,IAC7B,CAAC;AACD,QAAI,KAAK,OAAO;AAAA,EAClB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,yBAAyB,CAAC;AAAA,EACxE;AACF,CAAC;AAED,IAAO,gBAAQC;;;ACxLf,IAAAC,kBAA0C;AAC1C,IAAAC,iBAA6B;AAC7B,IAAAC,cAAkB;AAClB,oBAAmB;AACnB,gBAAe;AACf,kBAAiB;AAEjB,IAAMC,UAAS,IAAI,4BAAa;AAChC,IAAMC,cAAS,wBAAO;AAGtB,IAAM,aAAa,YAAAC,QAAK,QAAQ,QAAQ,IAAI,GAAG,SAAS;AACxD,IAAI;AAAE,YAAAC,QAAG,UAAU,YAAY,EAAE,WAAW,KAAK,CAAC;AAAE,SAAS,GAAG;AAAC;AAEjE,IAAM,UAAU,cAAAC,QAAO,YAAY;AAAA,EACjC,aAAa,CAAC,MAAe,OAAY,OAAyC,GAAG,MAAM,UAAU;AAAA,EACrG,UAAU,CAAC,MAAe,MAAW,OAA6C;AAChF,UAAM,SAAS,GAAG,KAAK,IAAI,CAAC,IAAI,KAAK,MAAM,KAAK,OAAO,IAAI,GAAG,CAAC;AAC/D,UAAM,OAAO,KAAK,aAAa,QAAQ,oBAAoB,GAAG;AAC9D,OAAG,MAAM,GAAG,MAAM,IAAI,IAAI,EAAE;AAAA,EAC9B;AACF,CAAC;AACD,IAAM,aAAS,cAAAA,SAAO,EAAE,QAAQ,CAAC;AAEjC,IAAM,eAAe,cAAE,OAAO;AAAA,EAC5B,WAAW,cAAE,OAAO,EAAE,SAAS;AAAA,EAC/B,SAAS,cAAE,OAAO,EAAE,SAAS;AAAA,EAC7B,aAAa,cAAE,OAAO;AACxB,CAAC;AAGDH,QAAO,KAAK,2BAA2B,OAAO,OAAO,MAAM,GAAG,OAAO,KAAc,QAAkB;AACnG,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qBAAqB,CAAC;AACxE,QAAM,SAAS,IAAI,OAAO;AAC1B,QAAM,SAAS,aAAa,UAAU,IAAI,IAAI;AAC9C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,WAAW,SAAS,YAAY,IAAI,OAAO;AACnD,QAAM,QAAQ,IAAI,KAAK,SAAS;AAChC,QAAM,MAAM,IAAI,KAAK,OAAO;AAC5B,QAAM,eAAe,KAAK,IAAI,GAAG,KAAK,OAAO,IAAI,QAAQ,IAAI,MAAM,QAAQ,KAAK,GAAK,CAAC;AACtF,MAAI;AACF,QAAI;AACJ,QAAK,IAAY,MAAM;AAErB,YAAM,OAAQ,IAAY;AAE1B,YAAM,OAAO,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,GAAG,SAAS,EAAE,OAAO,KAAK,EAAE,CAAC;AAC7F,YAAM,YAAY,MAAM,OAAO;AAC/B,YAAM,aAAa,MAAMA,QAAO,WAAW,OAAO;AAAA,QAChD,MAAM;AAAA,UACJ,UAAU,YAAAE,QAAK,SAAS,QAAQ,IAAI,GAAG,YAAAA,QAAK,KAAK,YAAY,KAAK,QAAQ,CAAC;AAAA,UAC3E,UAAU,KAAK,YAAY;AAAA,UAC3B,WAAW,aAAa;AAAA,QAC1B;AAAA,MACF,CAAC;AACD,qBAAe,WAAW;AAAA,IAC5B;AAEA,UAAM,MAAM,MAAMF,QAAO,QAAQ,OAAO;AAAA,MACtC,MAAM,EAAE,QAAQ,QAAQ,WAAW,OAAO,SAAS,KAAK,cAAc,aAAa,aAAa;AAAA,IAClG,CAAC;AACD,QAAI;AAEF,YAAMA,QAAO,aAAa,OAAO;AAAA,QAC/B,MAAM;AAAA,UACJ;AAAA,UACA,MAAM;AAAA,UACN,SAAS,UAAU,KAAK,MAAO,eAAe,KAAM,EAAE,IAAI,EAAE,MAAM,WAAW;AAAA,UAC7E,aAAa,OAAO,MAAM;AAAA,QAC5B;AAAA,MACF,CAAC;AAAA,IACH,QAAQ;AAAA,IAAC;AACT,QAAI,OAAO,GAAG,EAAE,KAAK,GAAG;AAAA,EAC1B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,4BAA4B,CAAC;AAAA,EAC3E;AACF,CAAC;AAEDC,QAAO,IAAI,2BAA2B,OAAO,KAAc,QAAkB;AAC3E,QAAM,QAAS,IAAI,MAAM,SAAoB;AAC7C,QAAM,SAAS,IAAI,OAAO;AAC1B,QAAM,QAAa,EAAE,OAAO;AAC5B,MAAI,UAAU,QAAQ;AACpB,UAAM,SAAU,IAAY;AAC5B,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qBAAqB,CAAC;AACxE,UAAM,SAAS;AAAA,EACjB;AACA,QAAM,OAAO,MAAMD,QAAO,QAAQ,SAAS,EAAE,OAAO,SAAS,EAAE,WAAW,OAAO,GAAG,SAAS,EAAE,YAAY,KAAK,EAAE,CAAC;AACnH,MAAI,KAAK,IAAI;AACf,CAAC;AAED,IAAO,mBAAQC;;;AC5Ff,IAAAI,kBAAuB;AACvB,IAAAC,iBAA6B;AAC7B,IAAAC,cAAkB;;;ACDlB,IAAAC,iBAA6B;;;ACD7B,IAAAC,iBAA6B;AAE7B,IAAMC,UAAS,IAAI,4BAAa;AAEhC,IAAI,cAA6B;AACjC,IAAI,WAAW;AAEf,eAAsB,qBAAsC;AAC1D,QAAM,MAAM,KAAK,IAAI;AACrB,MAAI,eAAe,MAAM,WAAW,IAAO,QAAO;AAClD,QAAM,MAAM,MAAMA,QAAO,cAAc,WAAW,EAAE,OAAO,EAAE,KAAK,mBAAmB,EAAE,CAAC,EAAE,MAAM,MAAM,IAAI;AAC1G,QAAM,WAAW,OAAO,QAAQ,IAAI,oBAAoB,EAAE,EAAE,KAAK;AACjE,QAAM,SAAS,KAAK,SAAS,YAAY,qBAAqB,KAAK;AACnE,gBAAc;AACd,aAAW;AACX,SAAO;AACT;AAEA,eAAsB,mBAAmB,OAAe;AACtD,QAAM,QAAQ,MAAM,KAAK;AACzB,QAAMA,QAAO,cAAc,OAAO,EAAE,OAAO,EAAE,KAAK,mBAAmB,GAAG,QAAQ,EAAE,MAAM,GAAG,QAAQ,EAAE,KAAK,oBAAoB,MAAM,EAAE,CAAC;AACvI,gBAAc;AACd,aAAW,KAAK,IAAI;AACpB,SAAO;AACT;;;ADpBA,IAAMC,UAAS,IAAI,4BAAa;AAEhC,eAAsB,kBAAkB,KAAc,KAAe,MAAoB;AACvF,MAAI;AACF,UAAM,cAAc,MAAM,mBAAmB,GAAG,YAAY;AAC5D,QAAI,CAAC,YAAY;AACf,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qCAAqC,CAAC;AAAA,IAC7E;AACA,UAAM,uBAAwB,IAAY;AAC1C,UAAM,SAAU,IAAY;AAC5B,QAAI,CAAC,UAAU,CAAC,qBAAsB,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAGtG,QAAI,sBAAsB;AACxB,YAAM,YAAY,MAAMA,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,qBAAqB,EAAE,CAAC;AACtF,UAAI,CAAC,UAAW,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gBAAgB,CAAC;AACtE,YAAMC,gBAAe,UAAU,MAAM,YAAY,MAAM;AACvD,UAAI,CAACA,cAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,aAAa,CAAC;AACrE,MAAC,IAAY,OAAO;AACrB,aAAO,KAAK;AAAA,IACd;AAGA,UAAM,OAAO,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAQ,EAAE,CAAC;AACpE,QAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,eAAe,CAAC;AAChE,UAAM,UAAU,KAAK,MAAM,YAAY,MAAM;AAC7C,QAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,aAAa,CAAC;AAChE,IAAC,IAAY,OAAO;AACrB,WAAO,KAAK;AAAA,EACd,SAAS,GAAQ;AACf,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,uBAAuB,CAAC;AAAA,EAC7E;AACF;AAEA,eAAsB,qBAAqB,QAAuB;AAChE,MAAI,CAAC,OAAQ,QAAO;AACpB,QAAM,aAAa,OAAO,QAAQ,IAAI,oBAAoB,EAAE,EAAE,KAAK,EAAE,YAAY;AACjF,MAAI,CAAC,WAAY,QAAO;AACxB,QAAM,OAAO,MAAMA,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,EAAE,CAAC;AACnE,SAAO,CAAC,CAAC,QAAQ,KAAK,MAAM,YAAY,MAAM;AAChD;;;ADrCA,IAAME,UAAS,IAAI,4BAAa;AAChC,IAAMC,cAAS,wBAAO;AAEtB,IAAM,mBAAmB,cAAE,OAAO;AAAA,EAChC,MAAM,cAAE,OAAO,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,QAAQ,CAAC;AAAA,EAClD,OAAO,cAAE,OAAO,OAAO,EAAE,IAAI,EAAE,SAAS,EAAE,IAAI,GAAG,EAAE,QAAQ,EAAE;AAAA,EAC7D,QAAQ,cAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,QAAQ,cAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,cAAc,cAAE,OAAO,EAAE,SAAS;AAAA,EAClC,UAAU,cAAE,OAAO,QAAQ,EAAE,SAAS;AACxC,CAAC;AAEDA,QAAO,IAAI,KAAK,mBAAmB,OAAO,KAAK,QAAQ;AACrD,QAAM,SAAS,iBAAiB,UAAU,IAAI,KAAK;AACnD,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,MAAM,OAAO,QAAQ,QAAQ,cAAc,SAAS,IAAI,OAAO;AACvE,QAAM,QAAa,CAAC;AACpB,MAAI,QAAQ;AACV,UAAM,KAAK;AAAA,MACT,EAAE,MAAM,EAAE,UAAU,QAAQ,MAAM,cAAc,EAAE;AAAA,MAClD,EAAE,OAAO,EAAE,UAAU,OAAO,YAAY,GAAG,MAAM,cAAc,EAAE;AAAA,IACnE;AAAA,EACF;AACA,MAAI,OAAQ,OAAM,SAAS;AAC3B,MAAI,aAAc,OAAM,eAAe;AACvC,MAAI,aAAa,OAAW,OAAM,WAAW;AAE7C,QAAM,CAAC,OAAO,IAAI,IAAI,MAAM,QAAQ,IAAI;AAAA,IACtCD,QAAO,KAAK,MAAM,EAAE,MAAM,CAAC;AAAA,IAC3BA,QAAO,KAAK,SAAS;AAAA,MACnB;AAAA,MACA,SAAS,EAAE,MAAM,EAAE,QAAQ,EAAE,MAAM,KAAK,EAAE,GAAG,YAAY,EAAE,QAAQ,EAAE,MAAM,KAAK,EAAE,EAAE;AAAA,MACpF,SAAS,CAAC,EAAE,WAAW,OAAO,CAAC;AAAA,MAC/B,OAAO,OAAO,KAAK;AAAA,MACnB,MAAM;AAAA,IACR,CAAC;AAAA,EACH,CAAC;AACD,QAAM,QAAQ,KAAK,IAAI,QAAM;AAAA,IAC3B,IAAI,EAAE;AAAA,IACN,MAAM,EAAE;AAAA,IACR,OAAO,EAAE;AAAA,IACT,UAAU,EAAE;AAAA,IACZ,UAAU,CAAC,CAAE,EAAU;AAAA,IACvB,QAAS,EAAU;AAAA,IACnB,cAAe,EAAU;AAAA,IACzB,WAAW,EAAE;AAAA,IACb,WAAW,EAAE;AAAA,IACb,MAAO,EAAU,MAAM,MAAM,cAAc,KAAK;AAAA,IAChD,YAAa,EAAU,YAAY,QAAQ;AAAA,EAC7C,EAAE;AACF,MAAI,KAAK,EAAE,OAAO,MAAM,OAAO,MAAM,CAAC;AACxC,CAAC;AAED,IAAM,mBAAmB,cAAE,OAAO;AAAA,EAChC,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACtB,OAAO,cAAE,OAAO,EAAE,MAAM;AAAA,EACxB,QAAQ,cAAE,OAAO;AAAA,EACjB,cAAc,cAAE,OAAO;AAAA,EACvB,UAAU,cAAE,QAAQ,EAAE,SAAS;AACjC,CAAC;AAEDC,QAAO,KAAK,KAAK,mBAAmB,OAAO,KAAK,QAAQ;AACtD,QAAM,SAAS,iBAAiB,UAAU,IAAI,IAAI;AAClD,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,MAAM,OAAO,QAAQ,cAAc,SAAS,IAAI,OAAO;AAC/D,MAAI;AACF,UAAM,OAAO,MAAMD,QAAO,KAAK,OAAO;AAAA,MACpC,MAAM,EAAE,MAAM,OAAO,MAAM,KAAK,EAAE,YAAY,GAAG,QAAQ,cAAc,UAAU,YAAY,KAAK;AAAA,IACpG,CAAC;AACD,QAAI,OAAO,GAAG,EAAE,KAAK,IAAI;AAAA,EAC3B,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,WAAW,EAAE,MAAM,QAAQ,SAAS,OAAO,GAAG;AAC3D,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AAAA,IAC/D;AACA,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAIDC,QAAO,IAAI,OAAO,OAAO,KAAK,QAAQ;AACpC,QAAM,OAAO,OAAO,IAAI,OAAO,eAAe,KAAK,EAAE;AACrD,QAAM,mBAAmB,QAAQ,IAAI,qBAAqB,IAAI,YAAY,MAAM;AAChF,MAAI,SAAU,IAAY;AAC1B,MAAI,IAAS;AAEb,MAAI;AAEF,UAAM,YAAY,KAAK,YAAY,EAAE,WAAW,SAAS;AACzD,QAAI,aAAa,CAAC,UAAU,iBAAiB;AAC3C,YAAM,aAAc,IAAY,SAAS,QAAQ;AACjD,UAAI,WAAY,UAAS,OAAO,UAAU;AAAA,IAC5C;AACA,QAAI,QAAQ;AACV,UAAI,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,GAAG,SAAS,EAAE,MAAM,MAAM,YAAY,KAAK,EAAE,CAAC;AAAA,IACvG;AAEA,QAAI,CAAC,KAAK,mBAAmB,CAAC,WAAW;AACvC,YAAM,QAAQ,OAAO,IAAI,OAAO,SAAS,KAAK,IAAI,MAAM,SAAS,EAAE,EAAE,YAAY;AACjF,UAAI,OAAO;AACT,YAAI,MAAMA,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,MAAM,GAAG,SAAS,EAAE,MAAM,MAAM,YAAY,KAAK,EAAE,CAAC;AAAA,MAClG;AAAA,IACF;AAEA,QAAI,CAAC,KAAK,mBAAmB,CAAC,WAAW;AACvC,UAAI,MAAMA,QAAO,KAAK,UAAU,EAAE,SAAS,EAAE,MAAM,MAAM,YAAY,KAAK,GAAG,SAAS,EAAE,WAAW,MAAM,EAAE,CAAC;AAAA,IAC9G;AAEA,QAAI,CAAC,GAAG;AACN,YAAM,OAAO,MAAMA,QAAO,QAAQ,UAAU,CAAC,CAAC,KAAK,MAAMA,QAAO,QAAQ,OAAO,EAAE,MAAM,EAAE,MAAM,WAAW,EAAE,CAAC;AAC7G,YAAM,OAAO,MAAMA,QAAO,WAAW,UAAU,CAAC,CAAC,KAAK,MAAMA,QAAO,WAAW,OAAO,EAAE,MAAM,EAAE,MAAM,uBAAuB,EAAE,CAAC;AAC/H,UAAI,MAAMA,QAAO,KAAK,OAAO,EAAE,MAAO,EAAE,MAAM,SAAS,OAAO,qBAAqB,QAAQ,KAAK,IAAI,cAAc,KAAK,IAAI,UAAU,MAAM,iBAAiB,oBAAI,KAAK,EAAE,GAAW,SAAS,EAAE,MAAM,MAAM,YAAY,KAAK,EAAE,CAAC;AAAA,IAC/N;AAGA,UAAM,YAAY,MAAM,qBAAqB,MAAM;AACnD,UAAM,cAAc,MAAM,mBAAmB,GAAG,YAAY;AAC5D,UAAM,UAAU,aAAc,CAAC,CAAC,cAAc,OAAO,GAAG,SAAS,EAAE,EAAE,YAAY,MAAM;AAEvF,UAAM,KAAK;AAAA,MACT,IAAI,EAAE;AAAA,MACN,MAAM,EAAE;AAAA,MACR,OAAO,EAAE;AAAA,MACT,UAAU,EAAE;AAAA,MACZ,MAAM,UAAU,UAAY,EAAU,MAAM,MAAM,cAAc,KAAK;AAAA,MACrE,YAAa,EAAU,YAAY,QAAQ;AAAA,MAC3C,aAAY,oBAAI,KAAK,GAAE,YAAY;AAAA,MACnC,cAAc;AAAA,IAChB;AACA,QAAI,KAAK,EAAE;AAAA,EACb,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,iCAAiC,CAAC;AAAA,EAChF;AACF,CAAC;AAEDC,QAAO,IAAI,QAAQ,mBAAmB,OAAO,KAAK,QAAQ;AACxD,QAAM,IAAI,MAAMD,QAAO,KAAK,WAAW;AAAA,IACrC,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG;AAAA,IAC3B,SAAS,EAAE,MAAM,MAAM,YAAY,KAAK;AAAA,EAC1C,CAAC;AACD,MAAI,CAAC,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1D,QAAM,OAAO;AAAA,IACX,IAAI,EAAE;AAAA,IACN,MAAM,EAAE;AAAA,IACR,OAAO,EAAE;AAAA,IACT,UAAU,EAAE;AAAA,IACZ,UAAU,CAAC,CAAE,EAAU;AAAA,IACvB,QAAS,EAAU;AAAA,IACnB,cAAe,EAAU;AAAA,IACzB,WAAW,EAAE;AAAA,IACb,WAAW,EAAE;AAAA,IACb,MAAO,EAAU,MAAM,MAAM,cAAc,KAAK;AAAA,IAChD,YAAa,EAAU,YAAY,QAAQ;AAAA,EAC7C;AACA,MAAI,KAAK,IAAI;AACf,CAAC;AAED,IAAM,mBAAmB,iBAAiB,QAAQ;AAClDC,QAAO,MAAM,QAAQ,mBAAmB,OAAO,KAAK,QAAQ;AAC1D,QAAM,SAAS,iBAAiB,UAAU,IAAI,IAAI;AAClD,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,OAAO,EAAE,GAAG,OAAO,KAAK;AAC9B,MAAI,KAAK,MAAO,MAAK,QAAQ,KAAK,MAAM,KAAK,EAAE,YAAY;AAC3D,MAAI;AACF,UAAM,OAAO,MAAMD,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,GAAG,KAAK,CAAC;AAC5E,QAAI,KAAK,IAAI;AAAA,EACf,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,WAAW,EAAE,MAAM,QAAQ,SAAS,OAAO,GAAG;AAC3D,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AAAA,IAC/D;AACA,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAEDC,QAAO,OAAO,QAAQ,mBAAmB,OAAO,KAAK,QAAQ;AAC3D,QAAM,KAAK,OAAO,IAAI,OAAO,EAAE;AAC/B,QAAM,OAAO,OAAO,IAAI,MAAM,QAAQ,IAAI,MAAM,SAAS,EAAE,EAAE,YAAY,MAAM;AAC/E,MAAI;AACF,UAAM,IAAI,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACxD,QAAI,CAAC,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1D,UAAM,aAAa,OAAO,QAAQ,IAAI,oBAAoB,EAAE,EAAE,KAAK,EAAE,YAAY;AACjF,QAAI,cAAc,OAAO,EAAE,KAAK,EAAE,YAAY,MAAM,YAAY;AAC9D,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iCAAiC,CAAC;AAAA,IACzE;AAEA,QAAI,MAAM;AAER,YAAM,YAAY,MAAMA,QAAO,KAAK,UAAU,EAAE,OAAO,EAAE,OAAO,WAAW,EAAE,CAAC;AAC9E,UAAI,CAAC,UAAW,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6BAA6B,CAAC;AACnF,YAAMA,QAAO,aAAa,OAAO,OAAO;AAEtC,cAAM,GAAG,kBAAkB,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AAE/D,cAAM,GAAG,QAAQ,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AACrD,cAAM,GAAG,aAAa,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AAE1D,cAAM,GAAG,UAAU,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AAEvD,cAAM,GAAG,mBAAmB,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AAChE,cAAM,GAAG,eAAe,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AAC5D,cAAM,GAAG,gBAAgB,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AAE7D,cAAM,GAAG,SAAS,WAAW,EAAE,OAAO,EAAE,YAAY,GAAG,GAAG,MAAM,EAAE,YAAY,KAAK,EAAE,CAAC;AACtF,cAAM,GAAG,SAAS,WAAW,EAAE,OAAO,EAAE,aAAa,GAAG,GAAG,MAAM,EAAE,aAAa,UAAU,GAAG,EAAE,CAAC;AAEhG,cAAM,GAAG,aAAa,WAAW,EAAE,OAAO,EAAE,aAAa,GAAG,GAAG,MAAM,EAAE,aAAa,UAAU,GAAG,EAAE,CAAC;AAEpG,cAAM,GAAG,QAAQ,WAAW,EAAE,OAAO,EAAE,UAAU,GAAG,GAAG,MAAM,EAAE,UAAU,UAAU,GAAG,EAAE,CAAC;AAEzF,cAAM,GAAG,QAAQ,WAAW,EAAE,OAAO,EAAE,SAAS,GAAG,GAAG,MAAM,EAAE,SAAS,KAAK,EAAE,CAAC;AAE/E,YAAI;AACF,gBAAME,MAAU;AAChB,gBAAMA,IAAG,qBAAqB,WAAW,EAAE,OAAO,EAAE,IAAI,CAAC,EAAE,QAAQ,GAAG,GAAG,EAAE,SAAS,GAAG,CAAC,EAAE,EAAE,CAAC;AAAA,QAC/F,QAAQ;AAAA,QAAC;AAET,cAAM,GAAG,KAAK,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAAA,MACxC,CAAC;AACD,aAAO,IAAI,OAAO,GAAG,EAAE,IAAI;AAAA,IAC7B;AAGA,QAAI;AACF,YAAMF,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAC1C,aAAO,IAAI,OAAO,GAAG,EAAE,IAAI;AAAA,IAC7B,SAAS,GAAQ;AACf,UAAI,GAAG,SAAS,WAAW,GAAG,SAAS,WAAW,OAAO,GAAG,WAAW,EAAE,EAAE,YAAY,EAAE,SAAS,aAAa,GAAG;AAChH,cAAM,WAAW,YAAY,EAAE;AAC/B,cAAMA,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAO,EAAE,UAAU,OAAO,OAAO,UAAU,MAAM,iBAAiB,cAAc,KAAK,EAAU,CAAC;AAC1I,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,MAAM,UAAU,KAAK,CAAC;AAAA,MAC1D;AACA,YAAM;AAAA,IACR;AAAA,EACF,SAAS,GAAQ;AACf,QAAI,GAAG,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC3E,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EAC9E;AACF,CAAC;AAED,IAAO,gBAAQC;;;AGvPf,IAAAE,kBAAuB;AACvB,IAAAC,iBAA6B;AAC7B,IAAAC,cAAkB;AAElB,IAAMC,UAAS,IAAI,4BAAa;AAChC,IAAMC,cAAS,wBAAO;AAEtBA,QAAO,IAAI,KAAK,OAAO,MAAM,QAAQ;AACnC,QAAM,QAAQ,MAAMD,QAAO,WAAW,SAAS,EAAE,SAAS,EAAE,MAAM,MAAM,EAAE,CAAC;AAC3E,MAAI,KAAK,KAAK;AAChB,CAAC;AAED,IAAM,aAAa,cAAE,OAAO,EAAE,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC;AAEvDC,QAAO,KAAK,KAAK,OAAO,KAAK,QAAQ;AACnC,QAAM,SAAS,WAAW,UAAU,IAAI,IAAI;AAC5C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,MAAI;AACF,UAAM,OAAO,MAAMD,QAAO,WAAW,OAAO,EAAE,MAAM,OAAO,KAAK,CAAC;AACjE,QAAI,OAAO,GAAG,EAAE,KAAK,IAAI;AAAA,EAC3B,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4BAA4B,CAAC;AAC1F,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,8BAA8B,CAAC;AAAA,EAC7E;AACF,CAAC;AAEDC,QAAO,MAAM,QAAQ,OAAO,KAAK,QAAQ;AACvC,QAAM,SAAS,WAAW,UAAU,IAAI,IAAI;AAC5C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,MAAI;AACF,UAAM,OAAO,MAAMD,QAAO,WAAW,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,GAAG,MAAM,OAAO,KAAK,CAAC;AAC/F,QAAI,KAAK,IAAI;AAAA,EACf,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4BAA4B,CAAC;AAC1F,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,8BAA8B,CAAC;AAAA,EAC7E;AACF,CAAC;AAGDC,QAAO,MAAM,aAAa,OAAO,KAAK,QAAQ;AAC5C,QAAM,OAAO,cAAE,OAAO,EAAE,QAAQ,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACzE,MAAI;AACF,UAAM,OAAO,MAAMD,QAAO,WAAW,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,GAAG,MAAM,EAAE,QAAQ,KAAK,OAAO,EAAS,CAAC;AAClH,QAAI,KAAK,IAAI;AAAA,EACf,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,qBAAqB,CAAC;AAAA,EACpE;AACF,CAAC;AAGDC,QAAO,MAAM,iBAAiB,OAAO,KAAK,QAAQ;AAChD,QAAM,OAAO,cAAE,OAAO,EAAE,UAAU,cAAE,OAAO,QAAQ,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACvF,MAAI;AACF,UAAM,OAAO,MAAMD,QAAO,WAAW,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,GAAG,MAAM,KAAY,CAAC;AAC/F,QAAI,KAAK,IAAI;AAAA,EACf,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,4BAA4B,CAAC;AAAA,EAC3E;AACF,CAAC;AAEDC,QAAO,OAAO,QAAQ,OAAO,KAAK,QAAQ;AACxC,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,QAAQ,OAAO,IAAI,MAAM,SAAS,EAAE,EAAE,YAAY,MAAM;AAC9D,QAAM,WAAY,IAAI,MAAM,YAAuB;AACnD,QAAM,QAAQ,MAAMD,QAAO,KAAK,MAAM,EAAE,OAAO,EAAE,cAAc,GAAG,EAAE,CAAC;AACrE,MAAI,QAAQ,KAAK,CAAC,OAAO;AACvB,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kCAAkC,CAAC;AAAA,EAC1E;AACA,MAAI;AACF,QAAI,QAAQ,KAAK,OAAO;AACtB,UAAI,WAAW;AACf,UAAI,CAAC,UAAU;AAEb,cAAM,aAAa,MAAMA,QAAO,WAAW,OAAO;AAAA,UAChD,OAAO,EAAE,MAAM,aAAa;AAAA,UAC5B,QAAQ,CAAC;AAAA,UACT,QAAQ,EAAE,MAAM,aAAa;AAAA,QAC/B,CAAC;AACD,mBAAW,WAAW;AAAA,MACxB,OAAO;AACL,cAAM,SAAS,MAAMA,QAAO,WAAW,WAAW,EAAE,OAAO,EAAE,IAAI,SAAS,EAAE,CAAC;AAC7E,YAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qBAAqB,CAAC;AACxE,YAAI,aAAa,GAAI,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qDAAqD,CAAC;AAAA,MAClH;AAEA,YAAMA,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,cAAc,GAAG,GAAG,MAAM,EAAE,cAAc,SAAS,EAAE,CAAC;AAAA,IAChG;AACA,UAAMA,QAAO,WAAW,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAChD,QAAI,OAAO,GAAG,EAAE,IAAI;AAAA,EACtB,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,8BAA8B,CAAC;AAAA,EAC7E;AACF,CAAC;AAED,IAAO,sBAAQC;;;AClGf,IAAAC,kBAAuB;AACvB,IAAAC,iBAA6B;AAC7B,IAAAC,cAAkB;AAElB,IAAMC,UAAS,IAAI,4BAAa;AAChC,IAAMC,cAAS,wBAAO;AAEtBA,QAAO,IAAI,KAAK,OAAO,MAAM,QAAQ;AACnC,QAAM,QAAQ,MAAMD,QAAO,QAAQ,SAAS,EAAE,SAAS,EAAE,MAAM,MAAM,EAAE,CAAC;AACxE,MAAI,KAAK,KAAK;AAChB,CAAC;AAED,IAAME,cAAa,cAAE,OAAO,EAAE,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC;AAEvDD,QAAO,KAAK,KAAK,OAAO,KAAK,QAAQ;AACnC,QAAM,SAASC,YAAW,UAAU,IAAI,IAAI;AAC5C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,MAAI;AACF,UAAM,OAAO,MAAMF,QAAO,QAAQ,OAAO,EAAE,MAAM,OAAO,KAAK,CAAC;AAC9D,QAAI,OAAO,GAAG,EAAE,KAAK,IAAI;AAAA,EAC3B,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sBAAsB,CAAC;AACpF,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAEDC,QAAO,MAAM,QAAQ,OAAO,KAAK,QAAQ;AACvC,QAAM,SAASC,YAAW,UAAU,IAAI,IAAI;AAC5C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,MAAI;AACF,UAAM,OAAO,MAAMF,QAAO,QAAQ,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,GAAG,MAAM,OAAO,KAAK,CAAC;AAC5F,QAAI,KAAK,IAAI;AAAA,EACf,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sBAAsB,CAAC;AACpF,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAEDC,QAAO,OAAO,QAAQ,OAAO,KAAK,QAAQ;AACxC,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,QAAQ,OAAO,IAAI,MAAM,SAAS,EAAE,EAAE,YAAY,MAAM;AAC9D,QAAM,WAAY,IAAI,MAAM,YAAuB;AACnD,QAAM,QAAQ,MAAMD,QAAO,KAAK,MAAM,EAAE,OAAO,EAAE,QAAQ,GAAG,EAAE,CAAC;AAC/D,MAAI,QAAQ,KAAK,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4BAA4B,CAAC;AAC3F,MAAI;AACF,QAAI,QAAQ,KAAK,OAAO;AACtB,UAAI,WAAW;AACf,UAAI,CAAC,UAAU;AAEb,cAAM,aAAa,MAAMA,QAAO,QAAQ,OAAO;AAAA,UAC7C,OAAO,EAAE,MAAM,aAAa;AAAA,UAC5B,QAAQ,CAAC;AAAA,UACT,QAAQ,EAAE,MAAM,aAAa;AAAA,QAC/B,CAAC;AACD,mBAAW,WAAW;AAAA,MACxB,OAAO;AACL,cAAM,SAAS,MAAMA,QAAO,QAAQ,WAAW,EAAE,OAAO,EAAE,IAAI,SAAS,EAAE,CAAC;AAC1E,YAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qBAAqB,CAAC;AACxE,YAAI,aAAa,GAAI,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+CAA+C,CAAC;AAAA,MAC5G;AACA,YAAMA,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,QAAQ,GAAG,GAAG,MAAM,EAAE,QAAQ,SAAS,EAAE,CAAC;AAAA,IACpF;AACA,UAAMA,QAAO,QAAQ,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAC7C,QAAI,OAAO,GAAG,EAAE,IAAI;AAAA,EACtB,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1E,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAED,IAAO,gBAAQC;;;ACvEf,IAAAE,kBAAuB;AACvB,IAAAC,iBAA6B;AAC7B,IAAAC,cAAkB;AAClB,sBAAmB;AACnB,0BAAgB;AAGhB,oBAAmB;;;ACPnB,wBAAuB;AAEvB,SAAS,SAAS,GAAY;AAC5B,SAAO,OAAO,KAAK,EAAE,EAAE,YAAY,MAAM;AAC3C;AAEO,SAAS,eAAe;AAC7B,SAAO,CAAC,CAAC,QAAQ,IAAI,aAAa,CAAC,CAAC,QAAQ,IAAI,aAAa,CAAC,CAAC,QAAQ,IAAI;AAC7E;AAEO,SAAS,eAAe;AAC7B,MAAI,CAAC,aAAa,EAAG,OAAM,IAAI,MAAM,qBAAqB;AAC1D,QAAM,SAAS,SAAS,QAAQ,IAAI,WAAW;AAC/C,QAAMC,QAAO,OAAO,QAAQ,IAAI,cAAc,SAAS,MAAM,IAAI;AACjE,SAAO,kBAAAC,QAAW,gBAAgB;AAAA,IAChC,MAAM,QAAQ,IAAI;AAAA,IAClB,MAAAD;AAAA,IACA;AAAA,IACA,MAAM,EAAE,MAAM,QAAQ,IAAI,WAAqB,MAAM,QAAQ,IAAI,UAAoB;AAAA,EACvF,CAAC;AACH;AAEA,eAAsB,SAAS,IAAY,SAAiB,MAAc,MAAe;AACvF,MAAI,CAAC,aAAa,EAAG,QAAO,EAAE,IAAI,OAAO,SAAS,KAAK;AACvD,QAAM,OAAO,QAAQ,IAAI,aAAa,QAAQ,IAAI,aAAa;AAC/D,QAAM,cAAc,aAAa;AACjC,QAAM,OAAO,MAAM,YAAY,SAAS,EAAE,MAAM,IAAI,SAAS,MAAM,QAAQ,KAAK,QAAQ,YAAY,EAAE,GAAG,KAAK,CAAC;AAC/G,SAAO,EAAE,IAAI,MAAM,WAAW,KAAK,UAAU;AAC/C;AAEO,SAAS,kBAAkB,MAAc;AAC9C,SAAO;AAAA,IACL,SAAS;AAAA,IACT,MAAM;AAAA;AAAA;AAAA;AAAA,4CAIkC,IAAI;AAAA;AAAA,sBAE1B,IAAI,KAAK,IAAI;AAAA;AAAA;AAAA,EAGjC;AACF;AAEO,SAAS,kBAAkB,MAAc,MAAe,UAAmB,gBAAyB;AACzG,QAAM,SAAS,QAAQ,IAAI,aAAa,UAAU,QAAQ,UAAU,EAAE,EAAE,KAAK,KAAK;AAClF,QAAM,OAAO,WAAW,OAAO,QAAQ,IAAI;AAC3C,QAAM,OAAO,iBAAiB,OAAO,cAAc,IAAI;AACvD,QAAM,WAAW;AACjB,SAAO;AAAA,IACL,SAAS,qBAAqB,KAAK;AAAA,IACnC,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA,6EAKmE,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,gFAMF,OAAO,KAAK,IAAI,KAAK,EAAE;AAAA,2HACoB,KAAK;AAAA,YACpH,QAAQ,OAAO;AAAA;AAAA,cAEb,OAAO,gBAAgB,QAAQ,WAAW,IAAI,YAAY,EAAE;AAAA,cAC5D,OAAO,gBAAgB,QAAQ,iBAAiB,IAAI,YAAY,EAAE;AAAA,oBAC5D,EAAE;AAAA;AAAA,uBAEC,IAAI;AAAA;AAAA;AAAA;AAAA,sFAI2D,IAAI,gDAAgD,IAAI;AAAA;AAAA;AAAA;AAAA;AAAA,oBAK1H,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAMvB;AACF;AAEO,SAAS,oBAAoBE,UAAiB;AACnD,QAAM,OAAOA,SAAQ,QAAQ,OAAO,EAAE,IAAI;AAC1C,SAAO;AAAA,IACL,SAAS;AAAA,IACT,MAAM;AAAA;AAAA;AAAA;AAAA,4CAIkC,IAAI;AAAA;AAAA;AAAA,EAG9C;AACF;AAEO,SAAS,yBAAyB,MAAc,MAAe;AACpE,QAAM,SAAS,QAAQ,IAAI,aAAa,UAAU,QAAQ,UAAU,EAAE,EAAE,KAAK,KAAK;AAClF,SAAO;AAAA,IACL,SAAS,GAAG,KAAK;AAAA,IACjB,MAAM;AAAA;AAAA;AAAA;AAAA;AAAA,6EAKmE,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,yCAMzC,OAAO,MAAM,IAAI,MAAM,KAAK;AAAA;AAAA;AAAA,uBAG9C,IAAI;AAAA;AAAA;AAAA,sFAG2D,IAAI,gDAAgD,IAAI;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,EAM5I;AACF;;;ADvHA,IAAMC,UAAS,IAAI,4BAAa;AAChC,IAAM,KAAUA;AAChB,IAAMC,cAAS,wBAAO;AAEtB,IAAM,iBAAiB,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,MAAM,8BAA8B,2CAA2C;AACxH,IAAM,cAAc,cAAE,OAAO,EAAE,OAAO,cAAE,OAAO,EAAE,MAAM,GAAG,UAAU,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC;AACvF,IAAM,iBAAiB,cAAE,OAAO,EAAE,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,GAAG,OAAO,cAAE,OAAO,EAAE,MAAM,GAAG,UAAU,gBAAgB,QAAQ,cAAE,OAAO,GAAG,cAAc,cAAE,OAAO,EAAE,CAAC;AAC9J,IAAM,eAAe,cAAE,OAAO;AAAA,EAC5B,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EACtB,OAAO,cAAE,OAAO,EAAE,MAAM;AAAA,EACxB,UAAU;AAAA,EACV,qBAAqB,cAAE,OAAO;AAAA,EAC9B,gBAAgB,cAAE,OAAO,EAAE,SAAS;AAAA,EACpC,aAAa,cAAE,OAAO,EAAE,SAAS;AAAA,EACjC,UAAU,cAAE,OAAO,QAAQ,EAAE,SAAS;AACxC,CAAC;AACD,IAAM,oBAAoB,cAAE,OAAO,EAAE,OAAO,cAAE,OAAO,EAAE,MAAM,GAAG,UAAU,eAAe,CAAC;AAE1F,SAAS,KAAK,QAAgB;AAC5B,QAAM,SAAS,QAAQ,IAAI,cAAc;AACzC,SAAO,oBAAAC,QAAI,KAAK,EAAE,KAAK,OAAO,GAAG,QAAQ,EAAE,WAAW,MAAM,CAAC;AAC/D;AAEA,SAAS,UAAU,KAAa;AAC9B,SAAO,cAAAC,QAAO,WAAW,QAAQ,EAAE,OAAO,GAAG,EAAE,OAAO,KAAK;AAC7D;AAEA,eAAe,YAAY,QAAgB,MAAqD,YAAoB;AAClH,QAAM,MAAM,cAAAA,QAAO,YAAY,EAAE,EAAE,SAAS,KAAK;AACjD,QAAM,YAAY,UAAU,GAAG;AAC/B,QAAM,YAAY,IAAI,KAAK,KAAK,IAAI,IAAI,aAAa,GAAI;AACzD,QAAM,GAAG,UAAU,OAAO,EAAE,MAAM,EAAE,QAAQ,MAAmB,WAAW,UAAU,EAAE,CAAC;AACvF,SAAO,EAAE,KAAK,UAAU;AAC1B;AAEA,eAAe,aAAa,MAAqD,KAAa;AAC5F,QAAM,YAAY,UAAU,GAAG;AAC/B,QAAM,MAAM,MAAM,GAAG,UAAU,UAAU,EAAE,OAAO,EAAE,WAAW,MAAmB,QAAQ,MAAM,WAAW,EAAE,IAAI,oBAAI,KAAK,EAAE,EAAE,EAAE,CAAC;AACjI,MAAI,CAAC,IAAK,QAAO;AACjB,QAAM,GAAG,UAAU,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,GAAG,GAAG,MAAM,EAAE,QAAQ,oBAAI,KAAK,EAAE,EAAE,CAAC;AACjF,SAAO;AACT;AAGAF,QAAO,KAAK,UAAU,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AAC5D,QAAM,SAAS,YAAY,UAAU,IAAI,IAAI;AAC7C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,OAAO,SAAS,IAAI,OAAO;AACnC,QAAM,QAAQ,MAAM,YAAY;AAChC,MAAI,OAAY;AAChB,MAAI;AACF,WAAO,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,OAAO,MAAM,EAAE,CAAC;AAC/D,UAAM,cAAc,MAAM,mBAAmB,GAAG,YAAY;AAC5D,UAAM,eAAe,OAAO,QAAQ,IAAI,uBAAuB,EAAE;AACjE,UAAM,iBAAiB,CAAC,CAAC,cAAc,UAAU;AAGjD,QAAI,kBAAkB,gBAAgB,aAAa,cAAc;AAC/D,YAAM,OAAO,MAAMA,QAAO,QAAQ,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,YAAY,MAAM,cAAc,EAAE,EAAE,CAAC,KAAK,MAAMA,QAAO,QAAQ,OAAO,EAAE,MAAM,EAAE,MAAM,WAAW,EAAE,CAAC;AAC3K,YAAM,OAAO,MAAMA,QAAO,WAAW,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,wBAAwB,MAAM,cAAc,EAAE,EAAE,CAAC,KAAK,MAAMA,QAAO,WAAW,OAAO,EAAE,MAAM,EAAE,MAAM,uBAAuB,EAAE,CAAC;AACzM,UAAI,CAAC,MAAM;AACT,cAAM,OAAO,MAAM,gBAAAI,QAAO,KAAK,cAAc,EAAE;AAC/C,eAAO,MAAMJ,QAAO,KAAK,OAAO,EAAE,MAAO,EAAE,MAAM,SAAS,OAAO,OAAO,QAAQ,KAAK,IAAI,cAAc,KAAK,IAAI,UAAU,MAAM,iBAAiB,oBAAI,KAAK,GAAG,cAAc,KAAK,EAAU,CAAC;AAAA,MAC7L,WAAW,CAAC,KAAK,cAAc;AAC7B,cAAM,OAAO,MAAM,gBAAAI,QAAO,KAAK,cAAc,EAAE;AAC/C,eAAO,MAAMJ,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,KAAK,GAAG,GAAG,MAAO,EAAE,cAAc,MAAM,UAAU,MAAM,iBAAiB,KAAK,mBAAmB,oBAAI,KAAK,EAAE,EAAU,CAAC;AAAA,MACxK;AAAA,IACF,OAAO;AAEL,UAAI,CAAC,QAAQ,CAAC,KAAK,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sBAAsB,CAAC;AAC7F,UAAI,KAAK,eAAe,KAAK,cAAc,oBAAI,KAAK,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+CAA+C,CAAC;AAC5I,YAAM,KAAK,MAAM,gBAAAI,QAAO,QAAQ,UAAU,KAAK,YAAY;AAC3D,UAAI,CAAC,IAAI;AACP,cAAM,YAAY,KAAK,uBAAuB,KAAK;AACnD,cAAM,OAAO,YAAY,IAAI,EAAE,aAAa,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,GAAI,EAAE,IAAI,CAAC;AACvF,cAAMJ,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,KAAK,GAAG,GAAG,MAAO,EAAE,qBAAqB,UAAU,GAAG,KAAK,EAAU,CAAC;AAC9G,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sBAAsB,CAAC;AAAA,MAC9D;AACA,UAAI,CAAC,KAAK,YAAY,CAAC,KAAK,gBAAiB,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mCAAmC,CAAC;AAEtH,aAAO,MAAMA,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,KAAK,GAAG,GAAG,MAAO,EAAE,qBAAqB,GAAG,aAAa,MAAM,aAAa,oBAAI,KAAK,EAAE,EAAU,CAAC;AAAA,IACnJ;AAAA,EACF,SAAS,GAAQ;AACf,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,eAAe,CAAC;AAAA,EACrE;AAEA,QAAM,QAAQ,KAAK,KAAK,EAAE;AAE1B,QAAM,UAAU,QAAQ,IAAI,YAAY,IAAI,YAAY,MAAM;AAC9D,QAAM,mBAAmB,QAAQ,IAAI,qBAAqB,IAAI,YAAY,MAAM;AAChF,MAAI,iBAAiB;AACnB,QAAI,OAAO,QAAQ,KAAK,IAAI,EAAE,UAAU,MAAM,UAAU,OAAO,QAAQ,OAAO,CAAC;AAAA,EACjF;AACA,SAAO,IAAI,KAAK,EAAE,OAAO,MAAM,EAAE,IAAI,KAAK,IAAI,MAAM,KAAK,MAAM,OAAO,KAAK,MAAM,EAAE,CAAC;AACtF,CAAC;AAGDC,QAAO,KAAK,WAAW,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AAC7D,QAAM,OAAO,aAAa,MAAM,IAAI,QAAQ,CAAC,CAAC;AAC9C,QAAM,QAAQ,KAAK,MAAM,KAAK,EAAE,YAAY;AAC5C,QAAM,OAAO,MAAM,gBAAAG,QAAO,KAAK,KAAK,UAAU,EAAE;AAChD,MAAI;AACF,UAAM,WAAW,MAAMJ,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC;AAClE,QAAI,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAC/E,UAAM,OAAO,MAAMA,QAAO,QAAQ,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,UAAU,MAAM,cAAc,EAAE,EAAE,CAAC,KAAK,MAAMA,QAAO,QAAQ,OAAO,EAAE,MAAM,EAAE,MAAM,SAAS,EAAE,CAAC;AACvK,UAAM,OAAO,MAAMA,QAAO,WAAW,WAAW,EAAE,OAAO,EAAE,IAAI,KAAK,oBAAoB,EAAE,CAAC;AAC3F,QAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qBAAqB,CAAC;AACtE,UAAM,OAAO,MAAMA,QAAO,KAAK,OAAO,EAAE,MAAO;AAAA,MAC7C,MAAM,KAAK;AAAA,MACX;AAAA,MACA,QAAQ,KAAK;AAAA,MACb,cAAc,KAAK;AAAA,MACnB,cAAc;AAAA,MACd,UAAU;AAAA,MACV,uBAAuB,KAAK;AAAA,MAC5B,gBAAgB,KAAK,kBAAkB;AAAA,MACvC,UAAU,CAAC,CAAC,KAAK;AAAA,IACnB,EAAU,CAAC;AACX,UAAMK,MAAUL;AAChB,UAAMK,IAAG,gBAAgB,OAAO,EAAE,MAAO,EAAE,QAAQ,KAAK,IAAI,uBAAuB,KAAK,qBAAqB,iBAAiB,KAAK,kBAAkB,MAAM,UAAU,CAAC,CAAC,KAAK,UAAU,YAAY,MAAM,aAAa,KAAK,eAAe,KAAK,EAAU,CAAC;AAEzP,UAAM,EAAE,IAAI,IAAI,MAAM,YAAY,KAAK,IAAI,gBAAgB,KAAK,IAAI;AACpE,UAAM,aAAa,QAAQ,IAAI,qBAAqB;AACpD,UAAM,YAAY,GAAG,UAAU,wBAAwB,mBAAmB,GAAG,CAAC;AAC9E,QAAI,aAAa,GAAG;AAClB,YAAM,EAAE,SAAS,KAAK,IAAI,kBAAkB,SAAS;AACrD,YAAM,SAAS,KAAK,OAAO,SAAS,IAAI;AAAA,IAC1C;AACA,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,MAAM,GAAI,aAAa,IAAI,CAAC,IAAI,EAAE,UAAU,GAAI,QAAQ,KAAK,GAAG,CAAC;AAAA,EACrG,SAAS,GAAQ;AACf,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,oBAAoB,CAAC;AAAA,EAC1E;AACF,CAAC;AAGDJ,QAAO,KAAK,aAAa,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AAE/D,QAAM,OAAO,IAAI,OAAO,eAAe,KAAK;AAC5C,MAAI,CAAC,KAAK,YAAY,EAAE,WAAW,SAAS,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC/G,MAAI;AACF,UAAM,SAAS,QAAQ,IAAI,cAAc;AACzC,UAAM,UAAU,oBAAAC,QAAI,OAAO,KAAK,MAAM,CAAC,GAAG,MAAM;AAChD,UAAM,KAAK,MAAM,qBAAqB,OAAO,SAAS,OAAO,EAAE,CAAC;AAChE,QAAI,CAAC,GAAI,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,aAAa,CAAC;AAAA,EAC9D,QAAQ;AACN,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gBAAgB,CAAC;AAAA,EACxD;AACA,QAAM,SAAS,eAAe,UAAU,IAAI,IAAI;AAChD,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,MAAM,OAAO,UAAU,QAAQ,aAAa,IAAI,OAAO;AAC/D,QAAM,OAAO,MAAM,gBAAAE,QAAO,KAAK,UAAU,EAAE;AAC3C,MAAI;AACF,UAAM,cAAc,MAAM,mBAAmB,GAAG,YAAY;AAC5D,QAAI,MAAM,YAAY,MAAM,YAAY;AACtC,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAAA,IAC5E;AACA,UAAM,OAAO,MAAMJ,QAAO,KAAK,OAAO,EAAE,MAAO,EAAE,MAAM,OAAO,MAAM,YAAY,GAAG,QAAQ,cAAc,cAAc,MAAM,UAAU,KAAK,EAAU,CAAC;AAEvJ,UAAM,EAAE,IAAI,IAAI,MAAM,YAAY,KAAK,IAAI,gBAAgB,KAAK,IAAI;AACpE,UAAM,aAAa,QAAQ,IAAI,qBAAqB;AACpD,UAAM,YAAY,GAAG,UAAU,wBAAwB,mBAAmB,GAAG,CAAC;AAC9E,QAAI,aAAa,GAAG;AAClB,YAAM,EAAE,SAAS,KAAK,IAAI,kBAAkB,WAAW,KAAK,IAAI;AAChE,YAAM,SAAS,KAAK,OAAO,SAAS,IAAI;AAAA,IAC1C;AACA,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,MAAM,MAAM,EAAE,IAAI,KAAK,IAAI,MAAM,KAAK,MAAM,OAAO,KAAK,MAAM,GAAG,GAAI,aAAa,IAAI,CAAC,IAAI,EAAE,UAAU,EAAG,CAAC;AAAA,EACxI,SAAS,GAAQ;AACf,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,qBAAqB,CAAC;AAAA,EAC3E;AACF,CAAC;AAGDC,QAAO,KAAK,oBAAoB,OAAO,MAAM,QAAQ;AACnD,QAAM,kBAAkB,QAAQ,IAAI,yBAAyB,QAAQ,IAAI,mBAAmB,IAAI,YAAY,MAAM;AAClH,MAAI,CAAC,eAAgB,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AACvE,QAAM,cAAc,MAAM,mBAAmB,GAAG,YAAY;AAC5D,QAAM,OAAO;AAEb,QAAM,OAAO,MAAMD,QAAO,QAAQ,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,YAAY,MAAM,cAAc,EAAE,EAAE,CAAC,KAAK,MAAMA,QAAO,QAAQ,OAAO,EAAE,MAAM,EAAE,MAAM,WAAW,EAAE,CAAC;AAC3K,QAAM,OAAO,MAAMA,QAAO,WAAW,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,wBAAwB,MAAM,cAAc,EAAE,EAAE,CAAC,KAAK,MAAMA,QAAO,WAAW,OAAO,EAAE,MAAM,EAAE,MAAM,uBAAuB,EAAE,CAAC;AACzM,MAAI,OAAO,MAAMA,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,OAAO,WAAW,EAAE,CAAC;AACxE,QAAM,eAAe,OAAO,QAAQ,IAAI,uBAAuB,EAAE;AACjE,MAAI,CAAC,MAAM;AACT,UAAM,WAAW,eAAe,MAAM,gBAAAI,QAAO,KAAK,cAAc,EAAE,IAAI;AACtE,WAAO,MAAMJ,QAAO,KAAK,OAAO,EAAE,MAAO,EAAE,MAAM,OAAO,YAAY,QAAQ,KAAK,IAAI,cAAc,KAAK,IAAI,UAAU,MAAM,iBAAiB,oBAAI,KAAK,GAAG,GAAI,WAAW,EAAE,cAAc,SAAS,IAAI,CAAC,EAAG,EAAU,CAAC;AAAA,EACtN,WAAW,gBAAgB,CAAC,KAAK,cAAc;AAE7C,UAAM,WAAW,MAAM,gBAAAI,QAAO,KAAK,cAAc,EAAE;AACnD,WAAO,MAAMJ,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,KAAK,GAAG,GAAG,MAAO,EAAE,cAAc,SAAS,EAAU,CAAC;AAAA,EACvG;AACA,QAAM,QAAQ,KAAK,KAAK,EAAE;AAC1B,QAAM,UAAU,QAAQ,IAAI,YAAY,IAAI,YAAY,MAAM;AAC9D,QAAM,mBAAmB,QAAQ,IAAI,qBAAqB,IAAI,YAAY,MAAM;AAChF,MAAI,iBAAiB;AACnB,QAAI,OAAO,QAAQ,KAAK,IAAI,EAAE,UAAU,MAAM,UAAU,OAAO,QAAQ,OAAO,CAAC;AAAA,EACjF;AACA,MAAI,KAAK,EAAE,IAAI,MAAM,MAAM,EAAE,IAAI,KAAK,IAAI,MAAM,KAAK,MAAM,OAAO,KAAK,MAAM,GAAG,MAAM,CAAC;AACzF,CAAC;AAGDC,QAAO,KAAK,iBAAiB,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AAEnE,QAAM,SAAS,kBAAkB,UAAU,IAAI,IAAI;AACnD,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,OAAO,SAAS,IAAI,OAAO;AACnC,QAAM,OAAO,MAAM,gBAAAG,QAAO,KAAK,UAAU,EAAE;AAC3C,MAAI;AACF,UAAM,QAAQ,QAAQ,IAAI,YAAY,IAAI,YAAY,MAAM;AAC5D,QAAI,MAAM;AACR,YAAM,OAAO,IAAI,OAAO,eAAe,KAAK;AAC5C,UAAI,CAAC,KAAK,YAAY,EAAE,WAAW,SAAS,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC/G,YAAM,SAAS,QAAQ,IAAI,cAAc;AACzC,UAAI;AACF,cAAM,UAAU,oBAAAF,QAAI,OAAO,KAAK,MAAM,CAAC,GAAG,MAAM;AAChD,cAAM,KAAK,MAAMF,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,SAAS,OAAO,EAAE,EAAE,GAAG,SAAS,EAAE,MAAM,KAAK,EAAE,CAAC;AAC9G,cAAM,IAAI,OAAQ,IAAY,MAAM,QAAQ,EAAE,EAAE,YAAY;AAC5D,cAAM,cAAc,CAAC,YAAW,SAAS,EAAE,SAAS,CAAC;AACrD,cAAM,UAAU,MAAM,qBAAqB,OAAO,SAAS,OAAO,EAAE,CAAC;AACrE,YAAI,EAAE,eAAe,YAAY,OAAO,IAAI,SAAS,EAAE,EAAE,YAAY,MAAM,MAAM,YAAY,GAAG;AAC9F,iBAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mDAAmD,CAAC;AAAA,QAC3F;AAAA,MACF,QAAQ;AACN,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gBAAgB,CAAC;AAAA,MACxD;AAAA,IACF;AACA,UAAM,OAAO,MAAMA,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,OAAO,MAAM,YAAY,EAAE,GAAG,MAAO,EAAE,cAAc,KAAK,EAAU,CAAC;AACtH,QAAI,KAAK,EAAE,IAAI,MAAM,IAAI,KAAK,GAAG,CAAC;AAAA,EACpC,SAAS,GAAQ;AACf,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,yBAAyB,CAAC;AAAA,EAC/E;AACF,CAAC;AAGDC,QAAO,KAAK,oBAAoB,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AACtE,QAAM,eAAe,QAAQ,IAAI,uBAAuB,IAAI,YAAY,MAAM;AAC9E,MAAI,CAAC,YAAa,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kCAAkC,CAAC;AAC1F,QAAM,OAAO,cAAE,OAAO,EAAE,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,GAAG,OAAO,cAAE,OAAO,EAAE,MAAM,GAAG,UAAU,eAAe,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AAC5H,QAAM,QAAQ,KAAK,MAAM,KAAK,EAAE,YAAY;AAC5C,QAAM,OAAO,MAAM,gBAAAG,QAAO,KAAK,KAAK,UAAU,EAAE;AAChD,MAAI;AACF,UAAM,aAAa,MAAMJ,QAAO,QAAQ,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,UAAU,MAAM,cAAc,EAAE,EAAE,CAAC;AAChH,UAAM,UAAU,MAAMA,QAAO,WAAW,UAAU,CAAC,CAAC;AACpD,QAAI,CAAC,cAAc,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gDAAgD,CAAC;AACnH,UAAM,OAAO,MAAMA,QAAO,KAAK,OAAO,EAAE,MAAO,EAAE,MAAM,KAAK,MAAM,OAAO,QAAQ,WAAW,IAAI,cAAc,QAAQ,IAAI,cAAc,MAAM,UAAU,MAAM,EAAU,CAAC;AACzK,UAAM,EAAE,IAAI,IAAI,MAAM,YAAY,KAAK,IAAI,gBAAgB,KAAK,IAAI;AACpE,UAAM,aAAa,QAAQ,IAAI,qBAAqB;AACpD,UAAM,YAAY,GAAG,UAAU,wBAAwB,mBAAmB,GAAG,CAAC;AAC9E,QAAI,aAAa,GAAG;AAClB,YAAM,EAAE,SAAS,KAAK,IAAI,kBAAkB,SAAS;AACrD,YAAM,SAAS,KAAK,OAAO,SAAS,IAAI;AAAA,IAC1C;AACA,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,MAAM,SAAS,2CAA2C,GAAI,aAAa,IAAI,CAAC,IAAI,EAAE,UAAU,EAAG,CAAC;AAAA,EACjI,SAAS,GAAQ;AACf,QAAI,EAAE,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AACrF,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,qBAAqB,CAAC;AAAA,EACpE;AACF,CAAC;AAGDC,QAAO,KAAK,iBAAiB,OAAO,KAAK,QAAQ;AAC/C,QAAM,QAAQ,OAAQ,IAAI,MAAM,SAAS,IAAI,MAAM,SAAS,EAAa;AACzE,MAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gBAAgB,CAAC;AAClE,QAAM,MAAM,MAAM,aAAa,gBAAgB,KAAK;AACpD,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAC3E,QAAMD,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,MAAO,EAAE,iBAAiB,oBAAI,KAAK,EAAE,EAAU,CAAC;AACtG,MAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AACvB,CAAC;AAGDC,QAAO,IAAI,gBAAgB,OAAO,KAAK,QAAQ;AAC7C,MAAI;AACF,UAAM,QAAQ,OAAO,IAAI,MAAM,SAAS,EAAE;AAC1C,QAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,QAAQ,UAAU,CAAC;AAC3E,UAAM,YAAY,UAAU,KAAK;AACjC,UAAM,MAAM,MAAM,GAAG,UAAU,UAAU,EAAE,OAAO,EAAE,WAAW,MAAM,eAAsB,EAAE,CAAC;AAC9F,QAAI,CAAC,IAAK,QAAO,IAAI,KAAK,EAAE,OAAO,OAAO,QAAQ,UAAU,CAAC;AAC7D,QAAI,IAAI,OAAQ,QAAO,IAAI,KAAK,EAAE,OAAO,OAAO,QAAQ,OAAO,CAAC;AAChE,QAAI,IAAI,aAAa,oBAAI,KAAK,EAAG,QAAO,IAAI,KAAK,EAAE,OAAO,OAAO,QAAQ,UAAU,CAAC;AACpF,UAAM,OAAO,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,SAAS,EAAE,MAAM,MAAM,YAAY,KAAK,EAAE,CAAC;AAClH,QAAI,CAAC,KAAM,QAAO,IAAI,KAAK,EAAE,OAAO,OAAO,QAAQ,UAAU,CAAC;AAC9D,WAAO,IAAI,KAAK;AAAA,MACd,OAAO;AAAA,MACP,QAAQ;AAAA,MACR,MAAM,EAAE,OAAO,KAAK,OAAO,MAAM,KAAK,MAAM,MAAO,KAAa,MAAM,MAAM,YAAa,KAAa,YAAY,KAAK;AAAA,IACzH,CAAC;AAAA,EACH,SAAS,GAAQ;AACf,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,QAAQ,WAAW,OAAO,GAAG,QAAQ,CAAC;AAAA,EACpF;AACF,CAAC;AAGDC,QAAO,KAAK,kBAAkB,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AACpE,QAAM,OAAO,cAAE,OAAO,EAAE,OAAO,cAAE,OAAO,EAAE,IAAI,EAAE,GAAG,UAAU,eAAe,SAAS,GAAG,MAAM,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS,GAAG,OAAO,cAAE,OAAO,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AAChL,QAAM,MAAM,MAAM,aAAa,gBAAgB,KAAK,KAAK;AACzD,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAC3E,QAAM,OAAY,EAAE,iBAAiB,oBAAI,KAAK,EAAE;AAChD,MAAI,KAAK,UAAU;AACjB,SAAK,eAAe,MAAM,gBAAAG,QAAO,KAAK,KAAK,UAAU,EAAE;AAAA,EACzD;AACA,MAAI,KAAK,KAAM,MAAK,OAAO,KAAK;AAChC,MAAI,OAAO,KAAK,UAAU,SAAU,MAAK,QAAQ,KAAK;AACtD,QAAMJ,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,KAAK,CAAC;AAC5D,MAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AACvB,CAAC;AAGDC,QAAO,KAAK,2BAA2B,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AAC7E,QAAM,QAAQ,OAAO,IAAI,MAAM,SAAS,EAAE,EAAE,YAAY;AACxD,MAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACnE,QAAM,OAAO,MAAMD,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC;AAE9D,MAAI,MAAM;AACR,UAAM,EAAE,IAAI,IAAI,MAAM,YAAY,KAAK,IAAI,kBAAkB,IAAI;AACjE,UAAM,aAAa,QAAQ,IAAI,qBAAqB;AACpD,UAAM,WAAW,GAAG,UAAU,yBAAyB,mBAAmB,GAAG,CAAC;AAC9E,QAAI,aAAa,GAAG;AAClB,YAAM,EAAE,SAAS,KAAK,IAAI,yBAAyB,UAAU,KAAK,IAAI;AACtE,YAAM,SAAS,KAAK,OAAO,SAAS,IAAI;AAAA,IAC1C,OAAO;AACL,cAAQ,IAAI,8BAA8B,QAAQ;AAAA,IACpD;AAAA,EACF;AACA,MAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AACvB,CAAC;AAEDC,QAAO,KAAK,mBAAmB,iBAAiB,GAAG,OAAO,KAAK,QAAQ;AACrE,QAAM,OAAO,cAAE,OAAO,EAAE,OAAO,cAAE,OAAO,EAAE,IAAI,EAAE,GAAG,UAAU,eAAe,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACnG,QAAM,MAAM,MAAM,aAAa,kBAAkB,KAAK,KAAK;AAC3D,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAC3E,QAAM,OAAO,MAAM,gBAAAG,QAAO,KAAK,KAAK,UAAU,EAAE;AAChD,QAAMJ,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,MAAO,EAAE,cAAc,KAAK,EAAU,CAAC;AAC7F,MAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AACvB,CAAC;AAGDC,QAAO,IAAI,4BAA4B,OAAO,KAAK,QAAQ;AACzD,QAAM,QAAQ,OAAO,IAAI,MAAM,SAAS,EAAE;AAC1C,MAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,QAAQ,UAAU,CAAC;AAC3E,MAAI;AACF,UAAM,YAAY,UAAU,KAAK;AACjC,UAAM,MAAM,MAAM,GAAG,UAAU,UAAU,EAAE,OAAO,EAAE,WAAW,MAAM,iBAAwB,EAAE,CAAC;AAChG,QAAI,CAAC,IAAK,QAAO,IAAI,KAAK,EAAE,OAAO,OAAO,QAAQ,UAAU,CAAC;AAC7D,QAAI,IAAI,OAAQ,QAAO,IAAI,KAAK,EAAE,OAAO,OAAO,QAAQ,OAAO,CAAC;AAChE,QAAI,IAAI,aAAa,oBAAI,KAAK,EAAG,QAAO,IAAI,KAAK,EAAE,OAAO,OAAO,QAAQ,UAAU,CAAC;AACpF,WAAO,IAAI,KAAK,EAAE,OAAO,MAAM,QAAQ,KAAK,CAAC;AAAA,EAC/C,SAAS,GAAQ;AACf,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,OAAO,QAAQ,WAAW,OAAO,GAAG,QAAQ,CAAC;AAAA,EACpF;AACF,CAAC;AAGDA,QAAO,KAAK,YAAY,OAAO,KAAK,QAAQ;AAC1C,QAAM,MAAO,IAAI,SAAS,MAAM,IAAI,MAAM,gBAAgB;AAC1D,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wBAAwB,CAAC;AACxE,QAAM,MAAM,MAAM,aAAa,WAAW,GAAG;AAC7C,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mCAAmC,CAAC;AACnF,QAAM,QAAQ,KAAK,IAAI,MAAM;AAC7B,QAAM,EAAE,KAAK,OAAO,UAAU,IAAI,MAAM,YAAY,IAAI,QAAQ,WAAW,KAAK,KAAK,IAAI;AACzF,QAAM,UAAU,QAAQ,IAAI,YAAY,IAAI,YAAY,MAAM;AAC9D,MAAI,OAAO,MAAM,OAAO,EAAE,UAAU,MAAM,QAAQ,QAAQ,UAAU,OAAO,SAAS,UAAU,CAAC;AAC/F,MAAI,KAAK,EAAE,MAAM,CAAC;AACpB,CAAC;AAEDA,QAAO,KAAK,WAAW,OAAO,KAAK,QAAQ;AACzC,QAAM,MAAO,IAAI,SAAS,MAAM,IAAI,MAAM,gBAAgB;AAC1D,MAAI,KAAK;AACP,UAAM,YAAY,UAAU,GAAG;AAC/B,UAAM,GAAG,UAAU,WAAW,EAAE,OAAO,EAAE,WAAW,MAAM,UAAiB,EAAE,CAAC;AAAA,EAChF;AACA,MAAI,YAAY,IAAI;AACpB,MAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AACvB,CAAC;AAGD,IAAM,YAAa,QAAQ,IAAI,mBAAmB,IAAI,YAAY,MAAM,WAAa,QAAQ,IAAI,YAAY,IAAI,YAAY,MAAM;AACnI,IAAI,UAAU;AAEZ,EAAAA,QAAO,KAAK,qBAAqB,OAAO,KAAK,QAAQ;AACnD,UAAM,QAAQ,OAAO,IAAI,MAAM,SAAS,EAAE,EAAE,YAAY;AACxD,QAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACnE,QAAI;AACF,YAAM,IAAI,MAAMD,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,MAAM,GAAG,MAAO,EAAE,iBAAiB,oBAAI,KAAK,GAAG,UAAU,KAAK,EAAU,CAAC;AACvH,aAAO,IAAI,KAAK,EAAE,IAAI,MAAM,IAAI,EAAE,GAAG,CAAC;AAAA,IACxC,SAAS,GAAQ;AACf,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,mBAAmB,CAAC;AAAA,IACzE;AAAA,EACF,CAAC;AAED,EAAAC,QAAO,KAAK,qBAAqB,OAAO,KAAK,QAAQ;AACnD,UAAM,QAAQ,OAAO,IAAI,MAAM,SAAS,EAAE,EAAE,YAAY;AACxD,UAAM,WAAW,OAAO,IAAI,MAAM,YAAY,EAAE;AAChD,QAAI,CAAC,SAAS,CAAC,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8BAA8B,CAAC;AAC7F,UAAM,OAAO,MAAM,gBAAAG,QAAO,KAAK,UAAU,EAAE;AAC3C,QAAI;AACF,YAAM,IAAI,MAAMJ,QAAO,KAAK,OAAO,EAAE,OAAO,EAAE,MAAM,GAAG,MAAO,EAAE,cAAc,KAAK,EAAU,CAAC;AAC9F,aAAO,IAAI,KAAK,EAAE,IAAI,MAAM,IAAI,EAAE,GAAG,CAAC;AAAA,IACxC,SAAS,GAAQ;AACf,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,yBAAyB,CAAC;AAAA,IAC/E;AAAA,EACF,CAAC;AAGD,EAAAC,QAAO,KAAK,oBAAoB,OAAO,KAAK,QAAQ;AAClD,UAAM,EAAE,QAAQ,MAAM,IAAI,IAAI,QAAQ,CAAC;AACvC,QAAI,KAAK,OAAO,UAAU,EAAE;AAC5B,QAAI;AACF,UAAI,CAAC,MAAM,OAAO;AAChB,cAAMK,KAAI,MAAMN,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,OAAO,OAAO,KAAK,EAAE,YAAY,EAAE,EAAE,CAAC;AACxF,YAAI,CAACM,GAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AAC/D,aAAKA,GAAE;AAAA,MACT;AACA,UAAI,CAAC,GAAI,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAE1E,YAAM,IAAI,MAAMN,QAAO,KAAK,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACxD,UAAI,CAAC,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AAC/D,YAAM,UAAU,QAAQ,IAAI,YAAY,IAAI,YAAY,MAAM;AAC9D,UAAI,OAAO,QAAQ,IAAI,EAAE,UAAU,MAAM,UAAU,OAAO,QAAQ,OAAO,CAAC;AAC1E,aAAO,IAAI,KAAK,EAAE,IAAI,MAAM,GAAG,CAAC;AAAA,IAClC,SAAS,GAAQ;AACf,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,IAC9E;AAAA,EACF,CAAC;AAGD,EAAAC,QAAO,KAAK,0BAA0B,OAAO,MAAM,QAAQ;AACzD,QAAI,YAAY,MAAM;AACtB,QAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AAAA,EACvB,CAAC;AACH;AAEA,IAAO,eAAQA;;;AE1bf,IAAAM,kBAAuB;AACvB,IAAAC,kBAA6B;AAC7B,IAAAC,cAAkB;AAIlB,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,cAAS,wBAAO;AAEtB,eAAe,aAAa,QAAuB;AACjD,MAAI,CAAC,OAAQ,QAAO;AACpB,QAAM,aAAa,OAAO,QAAQ,IAAI,oBAAoB,EAAE,EAAE,KAAK,EAAE,YAAY;AACjF,MAAI,CAAC,WAAY,QAAO;AACxB,QAAM,IAAI,MAAMD,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,EAAE,CAAC;AAChE,SAAO,CAAC,CAAC,KAAK,OAAO,EAAE,KAAK,EAAE,YAAY,MAAM;AAClD;AAEA,eAAe,WAAW,QAAuB,QAAuB;AACtE,MAAI,CAAC,UAAU,CAAC,OAAQ,QAAO;AAC/B,QAAME,MAAUF;AAChB,QAAM,OAAO,MAAME,IAAG,WAAW,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,EAAE,CAAC;AACrE,SAAO,CAAC,CAAC,QAAQ,OAAO,KAAK,UAAU,EAAE,MAAM,OAAO,MAAM;AAC9D;AAGAD,QAAO,IAAI,YAAY,OAAO,KAAK,QAAQ;AACzC,QAAM,UAAW,IAAY;AAC7B,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC9E,QAAM,aAAa,MAAM,aAAa,OAAO;AAC7C,QAAMC,MAAUF;AAChB,QAAM,YAAmB,MAAME,IAAG,WAAW,SAAS,EAAE,OAAO,EAAE,QAAQ,QAAQ,EAAE,CAAC;AACpF,QAAM,QAAa,EAAE,QAAQ,UAAU;AACvC,MAAI,CAAC,YAAY;AACf,QAAI,CAAC,UAAU,OAAQ,QAAO,IAAI,KAAK,EAAE,OAAO,CAAC,GAAG,OAAO,EAAE,CAAC;AAC9D,UAAM,wBAAwB,EAAE,IAAI,UAAU,IAAI,OAAK,EAAE,EAAE,EAAE;AAAA,EAC/D;AACA,QAAM,OAAO,MAAMA,IAAG,gBAAgB,SAAS,EAAE,OAAO,SAAS,EAAE,MAAM,KAAK,GAAG,SAAS,EAAE,aAAa,MAAM,EAAE,CAAC;AAClH,QAAM,QAAQ,KAAK,IAAI,CAAC,OAAY;AAAA,IAClC,IAAI,EAAE;AAAA,IACN,QAAQ,EAAE;AAAA,IACV,MAAO,EAAU,MAAM,QAAQ;AAAA,IAC/B,OAAQ,EAAU,MAAM,SAAS;AAAA,IACjC,uBAAuB,EAAE;AAAA,IACzB,iBAAiB,EAAE;AAAA,IACnB,QAAQ,EAAE;AAAA,IACV,UAAU,EAAE;AAAA,IACZ,aAAa,EAAE;AAAA,EACjB,EAAE;AACF,MAAI,KAAK,EAAE,OAAO,OAAO,MAAM,OAAO,CAAC;AACzC,CAAC;AAGDD,QAAO,KAAK,oBAAoB,OAAO,KAAK,QAAQ;AAClD,QAAM,UAAW,IAAY;AAC7B,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC9E,QAAM,OAAO,cAAE,OAAO;AAAA,IACpB,cAAc,cAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IAC9B,QAAQ,cAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IACxB,QAAQ,cAAE,OAAO,QAAQ,EAAE,QAAQ,IAAI;AAAA,IACvC,UAAU,cAAE,OAAO,QAAQ,EAAE,SAAS;AAAA,IACtC,UAAU,cAAE,OAAO,OAAO,EAAE,SAAS;AAAA,IACrC,UAAU,cAAE,OAAO,OAAO,EAAE,SAAS;AAAA,IACrC,mBAAmB,cAAE,OAAO,OAAO,EAAE,SAAS;AAAA,IAC9C,QAAQ,cAAE,MAAM,cAAE,OAAO,CAAC,EAAE,SAAS;AAAA,IACrC,WAAW,cAAE,OAAO,EAAE,SAAS;AAAA,EACjC,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACvB,MAAI,YAAY,IAAI,OAAO,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,+BAA+B,CAAC;AACxG,QAAM,aAAa,MAAM,aAAa,OAAO;AAC7C,QAAM,SAAS,MAAM,WAAW,SAAS,KAAK,YAAY;AAC1D,MAAI,EAAE,cAAc,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gDAAgD,CAAC;AAEnH,MAAI;AACF,UAAM,OAAO,MAAMD,SAAO,KAAK,OAAO;AAAA,MACpC,OAAO,EAAE,IAAI,IAAI,OAAO,OAAO;AAAA,MAC/B,MAAO;AAAA,QACL,cAAc,KAAK;AAAA,QACnB,QAAQ,KAAK;AAAA,QACb,UAAU,KAAK;AAAA,QACf,UAAU,KAAK,YAAY;AAAA,QAC3B,UAAU,KAAK;AAAA,QACf,UAAU,KAAK;AAAA,QACf,mBAAmB,KAAK;AAAA,QACxB,QAAQ,KAAK;AAAA,QACb,WAAW,KAAK,aAAa;AAAA,MAC/B;AAAA,IACF,CAAC;AACD,UAAOA,SAAe,gBAAgB,OAAO,EAAE,OAAO,EAAE,QAAQ,IAAI,OAAO,OAAO,GAAG,MAAM,EAAE,QAAQ,YAAY,aAAa,SAAS,WAAW,oBAAI,KAAK,EAAE,EAAE,CAAC;AAEhK,UAAME,MAAUF;AAChB,UAAME,IAAG,WAAW,OAAO,EAAE,MAAM,EAAE,SAAS,SAAU,cAAc,KAAK,IAAI,QAAQ,gBAAgB,SAAS,QAAQ,KAAK,YAAY,UAAU,KAAK,MAAM,YAAY,KAAK,MAAM,GAAG,EAAE,CAAC;AAE3L,QAAI,aAAa,GAAG;AAClB,YAAM,aAAa,QAAQ,IAAI,qBAAqB;AACpD,YAAM,EAAE,SAAS,KAAK,IAAI,oBAAoB,UAAU;AACxD,UAAI;AAAE,cAAM,SAAS,KAAK,OAAO,SAAS,IAAI;AAAA,MAAE,QAAQ;AAAA,MAAC;AAAA,IAC3D;AACA,QAAI,KAAK,EAAE,IAAI,MAAM,IAAI,KAAK,GAAG,CAAC;AAAA,EACpC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,kBAAkB,CAAC;AAAA,EACjE;AACF,CAAC;AAGDD,QAAO,KAAK,mBAAmB,OAAO,KAAK,QAAQ;AACjD,QAAM,UAAW,IAAY;AAC7B,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC9E,QAAM,OAAO,cAAE,OAAO,EAAE,QAAQ,cAAE,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACzE,MAAI,YAAY,IAAI,OAAO,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,gCAAgC,CAAC;AACzG,QAAMC,MAAUF;AAChB,QAAM,KAAK,MAAOE,IAAW,gBAAgB,WAAW,EAAE,OAAO,EAAE,QAAQ,IAAI,OAAO,OAAO,EAAE,CAAC;AAChG,QAAM,aAAa,MAAM,aAAa,OAAO;AAC7C,QAAM,SAAS,MAAM,WAAW,SAAS,IAAI,yBAAyB,IAAI;AAC1E,MAAI,EAAE,cAAc,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAC9F,MAAI;AACF,UAAOF,SAAe,gBAAgB,OAAO,EAAE,OAAO,EAAE,QAAQ,IAAI,OAAO,OAAO,GAAG,MAAM,EAAE,QAAQ,YAAY,QAAQ,KAAK,QAAQ,aAAa,SAAS,WAAW,oBAAI,KAAK,EAAE,EAAE,CAAC;AACrL,UAAMA,SAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,OAAO,GAAG,MAAO,EAAE,UAAU,MAAM,EAAU,CAAC;AACjG,UAAME,IAAG,WAAW,OAAO,EAAE,MAAM,EAAE,SAAS,SAAU,cAAc,IAAI,OAAO,QAAQ,QAAQ,eAAe,SAAS,KAAK,OAAO,EAAE,CAAC;AACxI,QAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AAAA,EACvB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,gBAAgB,CAAC;AAAA,EAC/D;AACF,CAAC;AAED,IAAO,oBAAQD;;;AC3Hf,IAAAE,kBAA0C;AAC1C,IAAAC,kBAA6B;AAC7B,mBAAkB;AAClB,IAAAC,iBAAmB;AAEnB,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,cAAS,wBAAO;AAEtB,SAAS,QAAQ,KAAc;AAC7B,QAAM,QAAS,IAAI,QAAQ,mBAAmB,KAAgB,IAAI;AAClE,QAAM,OAAO,IAAI,IAAI,MAAM;AAC3B,SAAO,GAAG,KAAK,MAAM,IAAI;AAC3B;AAEA,SAAS,cAAc,KAAc;AACnC,QAAM,UAAU,QAAQ,IAAI,qBAAqB,QAAQ,IAAI;AAC7D,MAAI,QAAS,QAAO,OAAO,OAAO,EAAE,QAAQ,QAAQ,EAAE;AACtD,QAAM,SAAS,IAAI,IAAI,QAAQ;AAC/B,MAAI,OAAQ,QAAO,OAAO,QAAQ,QAAQ,EAAE;AAE5C,QAAM,MAAM,QAAQ,GAAG;AACvB,MAAI;AACF,UAAM,IAAI,IAAI,IAAI,GAAG;AACrB,WAAO,GAAG,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACrC,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAIA,SAAS,YAAoB;AAC3B,QAAM,MAAM,QAAQ,IAAI,oBAAoB,QAAQ,IAAI,cAAc;AAEtE,SAAO,eAAAC,QAAO,WAAW,QAAQ,EAAE,OAAO,OAAO,GAAG,CAAC,EAAE,OAAO;AAChE;AACA,SAAS,QAAQ,MAAsB;AACrC,QAAM,MAAM,UAAU;AACtB,QAAM,KAAK,eAAAA,QAAO,YAAY,EAAE;AAChC,QAAM,SAAS,eAAAA,QAAO,eAAe,eAAe,KAAK,EAAE;AAC3D,QAAM,MAAM,OAAO,OAAO,CAAC,OAAO,OAAO,OAAO,KAAK,OAAO,IAAI,GAAG,MAAM,CAAC,GAAG,OAAO,MAAM,CAAC,CAAC;AAC5F,QAAM,MAAM,OAAO,WAAW;AAC9B,SAAO,OAAO,OAAO,CAAC,IAAI,KAAK,GAAG,CAAC,EAAE,SAAS,QAAQ;AACxD;AACA,SAAS,QAAQ,SAAyB;AACxC,MAAI;AACF,UAAM,MAAM,OAAO,KAAK,OAAO,OAAO,GAAG,QAAQ;AACjD,UAAM,KAAK,IAAI,SAAS,GAAG,EAAE;AAC7B,UAAM,MAAM,IAAI,SAAS,IAAI,EAAE;AAC/B,UAAM,OAAO,IAAI,SAAS,EAAE;AAC5B,UAAM,MAAM,UAAU;AACtB,UAAM,WAAW,eAAAA,QAAO,iBAAiB,eAAe,KAAK,EAAE;AAC/D,aAAS,WAAW,GAAG;AACvB,UAAM,MAAM,OAAO,OAAO,CAAC,SAAS,OAAO,IAAI,GAAG,SAAS,MAAM,CAAC,CAAC;AACnE,WAAO,IAAI,SAAS,MAAM;AAAA,EAC5B,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAEA,SAAS,gBAAgB,GAAmB;AAC1C,MAAI,CAAC,EAAG,QAAO;AACf,MAAI,IAAI,OAAO,CAAC,EAAE,KAAK;AACvB,MAAI,EAAE,YAAY,EAAE,WAAW,WAAW,EAAG,KAAI,aAAa,EAAE,MAAM,CAAC;AACvE,MAAI,EAAE,YAAY,EAAE,WAAW,YAAY,EAAG,KAAI,aAAa,EAAE,MAAM,EAAE;AACzE,SAAO;AACT;AAGA,eAAe,uBAAuB,QAAgB,UAAkC;AACtF,QAAM,YAAY,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,GAAI;AACtD,SAAOF,SAAO,mBAAmB,OAAO,EAAE,MAAM,EAAE,QAAQ,UAA2B,WAAW,UAAU,YAAY,EAAE,CAAC;AAC3H;AACA,eAAe,wBAAwB,IAAoB;AACzD,MAAI,CAAC,GAAI,QAAO;AAChB,QAAM,MAAM,MAAMA,SAAO,mBAAmB,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACxE,MAAI,CAAC,IAAK,QAAO;AACjB,MAAI,IAAI,aAAa,IAAI,UAAU,QAAQ,IAAI,KAAK,IAAI,GAAG;AACzD,UAAMA,SAAO,mBAAmB,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,GAAG,EAAE,CAAC;AAChE,WAAO;AAAA,EACT;AACA,QAAMA,SAAO,mBAAmB,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,GAAG,EAAE,CAAC;AAChE,SAAO;AACT;AAGAC,QAAO,KAAK,mBAAmB,OAAO,KAAc,QAAkB;AACpE,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,cAAc,QAAQ,IAAI,uBAAuB,GAAG,QAAQ,GAAG,CAAC;AACtE,MAAI,CAAC,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAChF,QAAM,KAAK,MAAM,uBAAuB,QAAQ,QAAQ;AACxD,QAAM,QAAQ,CAAC,UAAS,SAAQ,WAAU,mDAAmD,EAAE,KAAK,GAAG;AACvG,QAAM,QAAQ,OAAO,KAAK,KAAK,UAAU,EAAE,KAAK,GAAG,IAAI,MAAM,YAAY,CAAC,GAAG,MAAM,EAAE,SAAS,WAAW;AACzG,QAAM,MAAM,IAAI,IAAI,8CAA8C;AAClE,MAAI,aAAa,IAAI,aAAa,QAAQ;AAC1C,MAAI,aAAa,IAAI,gBAAgB,WAAW;AAChD,MAAI,aAAa,IAAI,iBAAiB,MAAM;AAC5C,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,aAAa,IAAI,eAAe,SAAS;AAC7C,MAAI,aAAa,IAAI,0BAA0B,MAAM;AACrD,MAAI,aAAa,IAAI,UAAU,SAAS;AACxC,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,KAAK,EAAE,aAAa,IAAI,SAAS,EAAE,CAAC;AAC1C,CAAC;AAGDA,QAAO,IAAI,mBAAmB,OAAO,KAAc,QAAkB;AACnE,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,cAAc,QAAQ,IAAI,uBAAuB,GAAG,QAAQ,GAAG,CAAC;AACtE,QAAM,QAAQ;AAAA,IACZ;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,EAAE,KAAK,GAAG;AACV,MAAI,CAAC,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,0BAA0B;AAErE,QAAM,MAAO,IAAI,MAAM,OAAkB;AACzC,QAAM,SAAU,IAAY,UAAU,OAAO;AAC7C,QAAM,QAAQ,OAAO,KAAK,KAAK,UAAU,EAAE,QAAQ,MAAM,YAAY,CAAC,GAAG,MAAM,EAAE,SAAS,WAAW;AACrG,QAAM,MAAM,IAAI,IAAI,8CAA8C;AAClE,MAAI,aAAa,IAAI,aAAa,QAAQ;AAC1C,MAAI,aAAa,IAAI,gBAAgB,WAAW;AAChD,MAAI,aAAa,IAAI,iBAAiB,MAAM;AAC5C,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,aAAa,IAAI,eAAe,SAAS;AAC7C,MAAI,aAAa,IAAI,0BAA0B,MAAM;AACrD,MAAI,aAAa,IAAI,UAAU,SAAS;AACxC,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,SAAS,IAAI,SAAS,CAAC;AAC7B,CAAC;AAEDA,QAAO,IAAI,oBAAoB,OAAO,KAAc,QAAkB;AACpE,QAAM,OAAO,IAAI,MAAM;AACvB,QAAM,WAAY,IAAI,MAAM,SAAoB;AAChD,MAAI,QAAa,CAAC;AAClB,MAAI;AAAE,YAAQ,KAAK,MAAM,OAAO,KAAK,UAAU,WAAW,EAAE,SAAS,MAAM,CAAC;AAAA,EAAE,QAAQ;AAAA,EAAC;AACvF,MAAI,SAAwB;AAC5B,MAAI,OAAO,KAAK;AACd,UAAM,MAAM,MAAM,wBAAwB,MAAM,GAAG;AACnD,aAAS,KAAK,UAAU;AAAA,EAC1B,OAAO;AACL,UAAM,WAAW,MAAM,cAAc,GAAG;AACxC,aAAS,YAAY,OAAO,UAAW,IAAI,MAAM,OAAkB;AAAA,EACrE;AACA,MAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,cAAc;AACrD,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,QAAM,cAAc,QAAQ,IAAI,uBAAuB,GAAG,QAAQ,GAAG,CAAC;AACtE,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,mCAAmC;AAC/F,MAAI;AACF,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,0CAA0C;AACnF,UAAM,WAAW,MAAM,aAAAE,QAAM,KAAK,uCAAuC,IAAI,gBAAgB;AAAA,MAC3F;AAAA,MACA,WAAW;AAAA,MACX,eAAe;AAAA,MACf,cAAc;AAAA,MACd,YAAY;AAAA,IACd,CAAC,GAAG,EAAE,SAAS,EAAE,gBAAgB,oCAAoC,EAAE,CAAC;AACxE,UAAM,EAAE,cAAc,eAAe,YAAY,UAAU,MAAM,IAAI,SAAS,QAAQ,CAAC;AAGvF,QAAI,QAAQ;AACZ,QAAI,UAAU;AACZ,UAAI;AACF,cAAM,UAAU,KAAK,MAAM,OAAO,KAAK,OAAO,QAAQ,EAAE,MAAM,GAAG,EAAE,CAAC,GAAG,QAAQ,EAAE,SAAS,MAAM,CAAC;AACjG,gBAAQ,OAAO,SAAS,SAAS,EAAE;AAAA,MACrC,QAAQ;AAAA,MAAC;AAAA,IACX;AAEA,QAAI,CAAC,SAAS,cAAc;AAC1B,UAAI;AACF,cAAM,QAAQ,MAAM,aAAAA,QAAM,IAAI,iDAAiD,EAAE,SAAS,EAAE,eAAe,UAAU,YAAY,GAAG,EAAE,CAAC;AACvI,gBAAQ,OAAO,MAAM,MAAM,SAAS,EAAE;AAAA,MACxC,QAAQ;AAAA,MAAC;AAAA,IACX;AACA,UAAM,MAAM,KAAK,IAAI;AACrB,UAAM,YAAY,aAAa,IAAI,KAAK,MAAM,OAAO,UAAU,IAAI,GAAI,IAAI;AAE3E,UAAM,SAAS,MAAMH,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,EAAE,CAAC;AACrE,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,0CAA0C;AACnF,UAAMA,SAAO,gBAAgB,OAAO;AAAA,MAClC,OAAO,EAAE,uBAAuB,EAAE,QAAQ,UAAU,UAAU,OAAO,SAAS,UAAU,EAAS;AAAA,MACjG,QAAQ,EAAE,aAAa,cAAc,cAAc,iBAAiB,IAAI,WAA6B,MAAM;AAAA,MAC3G,QAAQ,EAAE,IAAI,QAAkB,QAAQ,UAAU,UAAiB,OAAO,SAAS,WAAW,aAAa,cAAc,cAAc,iBAAiB,IAAI,WAA6B,MAAM;AAAA,IACjM,CAAC;AACD,UAAM,WAAW,OAAO,QAAQ;AAChC,UAAM,aAAa,cAAc,GAAG;AACpC,QAAI,SAAS,GAAG,UAAU,GAAG,QAAQ,EAAE;AAAA,EACzC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,GAAG,UAAU,QAAQ,GAAG,WAAW,qBAAqB;AAAA,EAC/E;AACF,CAAC;AAED,eAAe,kBAAkB,SAAc,UAAkB,cAAsB;AACrF,MAAI,CAAC,SAAS,aAAc,QAAO;AACnC,QAAM,MAAM,oBAAI,KAAK;AACrB,MAAI,QAAQ,aAAa,IAAI,KAAK,QAAQ,SAAS,IAAI,IAAI,KAAK,IAAI,QAAQ,IAAI,GAAM,EAAG,QAAO;AAChG,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,WAAW;AAAA,IACX,eAAe;AAAA,IACf,YAAY;AAAA,IACZ,eAAe,QAAQ;AAAA,EACzB,CAAC;AACD,QAAM,WAAW,MAAM,aAAAG,QAAM,KAAK,uCAAuC,QAAQ,EAAE,SAAS,EAAE,gBAAgB,oCAAoC,EAAE,CAAC;AACrJ,QAAM,EAAE,cAAc,WAAW,IAAI,SAAS,QAAQ,CAAC;AACvD,QAAM,YAAY,aAAa,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,UAAU,IAAI,GAAI,IAAI;AAClF,QAAM,UAAU,MAAMH,SAAO,gBAAgB,OAAO,EAAE,OAAO,EAAE,IAAI,QAAQ,GAAG,GAAG,MAAM,EAAE,aAAa,cAAc,UAAU,EAAE,CAAC;AACjI,SAAO;AACT;AAEAC,QAAO,IAAI,kBAAkB,OAAO,KAAc,QAAkB;AAClE,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qCAAqC,CAAC;AACxF,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAC1G,QAAM,UAAU,MAAMD,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,QAAQ,UAAU,SAAgB,EAAE,CAAC;AACvG,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAC,CAAC;AAC5C,MAAI;AACF,UAAM,MAAM,MAAM,kBAAkB,SAAS,UAAU,YAAY;AACnE,UAAM,MAAM,oBAAI,KAAK;AACrB,UAAM,UAAU,IAAI,KAAK,IAAI,QAAQ,IAAI,KAAK,KAAK,OAAO,GAAI,EAAE,YAAY;AAC5E,UAAM,UAAU,IAAI,KAAK,IAAI,QAAQ,IAAI,KAAK,KAAK,OAAO,GAAI,EAAE,YAAY;AAC5E,UAAM,YAAY,MAAM,aAAAG,QAAM,IAAI,mEAAmE;AAAA,MACnG,SAAS,EAAE,eAAe,UAAU,IAAI,WAAW,GAAG;AAAA,MACtD,QAAQ,EAAE,YAAY,MAAM,cAAc,MAAM,SAAS,aAAa,SAAS,QAAQ;AAAA,IACzF,CAAC;AACD,QAAI,KAAK,MAAM,QAAQ,UAAU,MAAM,KAAK,IAAI,UAAU,KAAK,QAAQ,CAAC,CAAC;AAAA,EAC3E,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,gCAAgC,CAAC;AAAA,EACpG;AACF,CAAC;AAGDF,QAAO,KAAK,sBAAsB,OAAO,KAAc,QAAkB;AACvE,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,SAAS,QAAQ,IAAI,aAAa;AACxC,QAAM,cAAc,QAAQ,IAAI,mBAAmB,GAAG,QAAQ,GAAG,CAAC;AAClE,MAAI,CAAC,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AAC5E,QAAM,KAAK,MAAM,uBAAuB,QAAQ,WAAW;AAC3D,QAAM,QAAQ,OAAO,KAAK,KAAK,UAAU,EAAE,KAAK,GAAG,IAAI,MAAM,YAAY,CAAC,GAAG,MAAM,EAAE,SAAS,WAAW;AACzG,QAAM,MAAM,IAAI,IAAI,qCAAqC,MAAM,wBAAwB;AACvF,MAAI,aAAa,IAAI,aAAa,QAAQ;AAC1C,MAAI,aAAa,IAAI,iBAAiB,MAAM;AAC5C,MAAI,aAAa,IAAI,gBAAgB,WAAW;AAChD,MAAI,aAAa,IAAI,iBAAiB,OAAO;AAC7C,MAAI,aAAa,IAAI,SAAS,CAAC,kBAAkB,aAAa,gBAAgB,EAAE,KAAK,GAAG,CAAC;AACzF,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,KAAK,EAAE,aAAa,IAAI,SAAS,EAAE,CAAC;AAC1C,CAAC;AACDA,QAAO,IAAI,sBAAsB,OAAO,KAAc,QAAkB;AACtE,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,SAAS,QAAQ,IAAI,aAAa;AACxC,QAAM,cAAc,QAAQ,IAAI,mBAAmB,GAAG,QAAQ,GAAG,CAAC;AAClE,MAAI,CAAC,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,sBAAsB;AACjE,QAAM,MAAO,IAAI,MAAM,OAAkB;AACzC,QAAM,SAAU,IAAY,UAAU,OAAO;AAC7C,QAAM,QAAQ,OAAO,KAAK,KAAK,UAAU,EAAE,QAAQ,MAAM,YAAY,CAAC,GAAG,MAAM,EAAE,SAAS,WAAW;AACrG,QAAM,MAAM,IAAI,IAAI,qCAAqC,MAAM,wBAAwB;AACvF,MAAI,aAAa,IAAI,aAAa,QAAQ;AAC1C,MAAI,aAAa,IAAI,iBAAiB,MAAM;AAC5C,MAAI,aAAa,IAAI,gBAAgB,WAAW;AAChD,MAAI,aAAa,IAAI,iBAAiB,OAAO;AAC7C,MAAI,aAAa,IAAI,SAAS,CAAC,kBAAkB,aAAa,gBAAgB,EAAE,KAAK,GAAG,CAAC;AACzF,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,SAAS,IAAI,SAAS,CAAC;AAC7B,CAAC;AAEDA,QAAO,IAAI,uBAAuB,OAAO,KAAc,QAAkB;AACvE,QAAM,OAAO,IAAI,MAAM;AACvB,QAAM,WAAY,IAAI,MAAM,SAAoB;AAChD,MAAI,QAAa,CAAC;AAClB,MAAI;AAAE,YAAQ,KAAK,MAAM,OAAO,KAAK,UAAU,WAAW,EAAE,SAAS,MAAM,CAAC;AAAA,EAAE,QAAQ;AAAA,EAAC;AACvF,MAAI,SAAwB;AAC5B,MAAI,OAAO,KAAK;AACd,UAAM,MAAM,MAAM,wBAAwB,MAAM,GAAG;AACnD,aAAS,KAAK,UAAU;AAAA,EAC1B,OAAO;AACL,UAAM,WAAW,MAAM,cAAc,GAAG;AACxC,aAAS,YAAY,OAAO,UAAW,IAAI,MAAM,OAAkB;AAAA,EACrE;AACA,MAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,cAAc;AACrD,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,QAAM,SAAS,QAAQ,IAAI,aAAa;AACxC,QAAM,cAAc,QAAQ,IAAI,mBAAmB,GAAG,QAAQ,GAAG,CAAC;AAClE,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,sCAAsC;AAClG,MAAI;AACF,UAAM,WAAW,MAAM,aAAAE,QAAM,KAAK,qCAAqC,MAAM,sBAAsB,IAAI,gBAAgB;AAAA,MACrH,WAAW;AAAA,MACX,eAAe;AAAA,MACf,YAAY;AAAA,MACZ;AAAA,MACA,cAAc;AAAA,MACd,OAAO,CAAC,kBAAkB,aAAa,gBAAgB,EAAE,KAAK,GAAG;AAAA,IACnE,CAAC,GAAG,EAAE,SAAS,EAAE,gBAAgB,oCAAoC,EAAE,CAAC;AACxE,UAAM,EAAE,cAAc,eAAe,WAAW,IAAI,SAAS,QAAQ,CAAC;AAGtE,QAAI,QAAQ;AACZ,QAAI;AACF,YAAM,QAAQ,MAAM,aAAAA,QAAM,IAAI,uCAAuC,EAAE,SAAS,EAAE,eAAe,UAAU,YAAY,GAAG,EAAE,CAAC;AAC7H,cAAQ,OAAO,MAAM,MAAM,QAAQ,MAAM,MAAM,qBAAqB,EAAE;AAAA,IACxE,QAAQ;AAAA,IAAC;AACT,UAAM,YAAY,aAAa,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,UAAU,IAAI,GAAI,IAAI;AAClF,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,0CAA0C;AACnF,UAAM,SAAS,MAAMH,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,EAAE,CAAC;AACrE,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,0CAA0C;AACnF,UAAMA,SAAO,gBAAgB,OAAO;AAAA,MAClC,OAAO,EAAE,uBAAuB,EAAE,QAAQ,UAAU,aAAa,OAAO,SAAS,UAAU,EAAS;AAAA,MACpG,QAAQ,EAAE,aAAa,cAAc,cAAc,iBAAiB,IAAI,WAA6B,OAAO,0CAA0C;AAAA,MACtJ,QAAQ,EAAE,IAAI,QAAkB,QAAQ,UAAU,aAAoB,OAAO,SAAS,WAAW,aAAa,cAAc,cAAc,iBAAiB,IAAI,WAA6B,OAAO,0CAA0C;AAAA,IAC/O,CAAC;AACD,UAAM,WAAW,OAAO,QAAQ;AAChC,UAAM,aAAa,cAAc,GAAG;AACpC,QAAI,SAAS,GAAG,UAAU,GAAG,QAAQ,EAAE;AAAA,EACzC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,GAAG,UAAU,QAAQ,GAAG,WAAW,wBAAwB;AAAA,EAClF;AACF,CAAC;AAED,eAAe,cAAc,SAAc,QAAgB,UAAkB,cAAsB;AACjG,MAAI,CAAC,SAAS,aAAc,QAAO;AACnC,QAAM,MAAM,oBAAI,KAAK;AACrB,MAAI,QAAQ,aAAa,IAAI,KAAK,QAAQ,SAAS,IAAI,IAAI,KAAK,IAAI,QAAQ,IAAI,GAAM,EAAG,QAAO;AAChG,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,WAAW;AAAA,IACX,eAAe;AAAA,IACf,YAAY;AAAA,IACZ,eAAe,QAAQ;AAAA,IACvB,OAAO;AAAA,EACT,CAAC;AACD,QAAM,WAAW,MAAM,aAAAG,QAAM,KAAK,qCAAqC,MAAM,sBAAsB,QAAQ,EAAE,SAAS,EAAE,gBAAgB,oCAAoC,EAAE,CAAC;AAC/K,QAAM,EAAE,cAAc,WAAW,IAAI,SAAS,QAAQ,CAAC;AACvD,QAAM,YAAY,aAAa,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,UAAU,IAAI,GAAI,IAAI;AAClF,QAAM,UAAU,MAAMH,SAAO,gBAAgB,OAAO,EAAE,OAAO,EAAE,IAAI,QAAQ,GAAG,GAAG,MAAM,EAAE,aAAa,cAAc,UAAU,EAAE,CAAC;AACjI,SAAO;AACT;AAEAC,QAAO,IAAI,qBAAqB,OAAO,KAAc,QAAkB;AACrE,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qCAAqC,CAAC;AACxF,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,QAAM,SAAS,QAAQ,IAAI,aAAa;AACxC,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uCAAuC,CAAC;AAC7G,QAAM,UAAU,MAAMD,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,QAAQ,UAAU,YAAmB,EAAE,CAAC;AAC1G,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAC,CAAC;AAC5C,MAAI;AACF,UAAM,MAAM,MAAM,cAAc,SAAS,QAAQ,UAAU,YAAY;AAEvE,UAAM,QAAQ,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,OAAO,GAAI,EAAE,YAAY;AACvE,UAAM,MAAM,IAAI,KAAK,KAAK,IAAI,IAAI,KAAK,KAAK,OAAO,GAAI,EAAE,YAAY;AACrE,UAAM,YAAY,MAAM,aAAAG,QAAM,IAAI,oDAAoD;AAAA,MACpF,SAAS,EAAE,eAAe,UAAU,IAAI,WAAW,GAAG;AAAA,MACtD,QAAQ,EAAE,eAAe,OAAO,aAAa,KAAK,QAAQ,KAAM,YAAY,iBAAiB;AAAA,IAC/F,CAAC;AACD,QAAI,KAAK,MAAM,QAAQ,UAAU,MAAM,KAAK,IAAI,UAAU,KAAK,QAAQ,CAAC,CAAC;AAAA,EAC3E,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,mCAAmC,CAAC;AAAA,EACvG;AACF,CAAC;AAGD,eAAe,cAAc,KAAsC;AACjE,QAAM,UAAW,IAAY;AAC7B,MAAI,SAAS;AACX,UAAM,IAAI,MAAMH,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,QAAQ,EAAE,CAAC;AACjE,QAAI,EAAG,QAAO;AAAA,EAChB;AACA,QAAM,WAAW,IAAI,OAAO,WAAW,KAAK;AAC5C,MAAI,UAAU;AACZ,UAAM,IAAI,MAAMA,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,SAAS,EAAE,CAAC;AAClE,QAAI,EAAG,QAAO;AAAA,EAChB;AACA,QAAM,MAAM,QAAQ,IAAI,eAAe;AACvC,MAAI,KAAK;AACP,UAAM,IAAI,MAAMA,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,IAAI,EAAE,CAAC;AAC7D,QAAI,EAAG,QAAO;AAAA,EAChB;AACA,SAAO;AACT;AAGAC,QAAO,IAAI,aAAa,OAAO,KAAc,QAAkB;AAC7D,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oEAAoE,CAAC;AACvH,QAAM,QAAQ,MAAMD,SAAO,gBAAgB,SAAS;AAAA,IAClD,OAAO,EAAE,OAAO;AAAA,IAChB,QAAQ,EAAE,IAAI,MAAM,UAAU,MAAM,OAAO,MAAM,WAAW,MAAM,WAAW,MAAM,WAAW,KAAK;AAAA,IACnG,SAAS,EAAE,WAAW,OAAO;AAAA,EAC/B,CAAC;AACD,MAAI,KAAK,KAAK;AAChB,CAAC;AAGDC,QAAO,IAAI,YAAY,OAAO,KAAc,QAAkB;AAC5D,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oEAAoE,CAAC;AACvH,QAAM,UAAU,MAAMD,SAAO,eAAe,SAAS,EAAE,OAAO,EAAE,OAAO,GAAG,SAAS,EAAE,WAAW,OAAO,EAAE,CAAC;AAE1G,MAAI,KAAK,QAAQ,IAAI,QAAM,EAAE,IAAI,EAAE,IAAI,MAAM,EAAE,MAAM,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,SAAS,EAAE,SAAS,WAAW,EAAE,WAAW,WAAW,EAAE,UAAU,EAAE,CAAC;AAC3J,CAAC;AAEDC,QAAO,KAAK,YAAY,OAAO,KAAc,QAAkB;AAC7D,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oEAAoE,CAAC;AACvH,QAAM,EAAE,MAAM,KAAK,OAAO,QAAQ,IAAI,IAAI,QAAQ,CAAC;AACnD,MAAI,CAAC,QAAQ,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4BAA4B,CAAC;AACrF,MAAI;AACF,UAAM,aAAa,gBAAgB,OAAO,GAAG,CAAC;AAC9C,QAAI,CAAC,gBAAgB,KAAK,UAAU,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iEAAiE,CAAC;AAC9I,UAAM,UAAU,MAAMD,SAAO,eAAe,OAAO;AAAA,MACjD,MAAM,EAAE,QAAQ,MAAM,WAAkB,MAAM,KAAK,QAAQ,UAAU,GAAG,OAAO,SAAS,WAAW,SAAS,WAAW,KAAK;AAAA,IAC9H,CAAC;AACD,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,QAAQ,IAAI,MAAM,QAAQ,MAAM,MAAM,QAAQ,MAAM,OAAO,QAAQ,OAAO,SAAS,QAAQ,SAAS,WAAW,QAAQ,WAAW,WAAW,QAAQ,UAAU,CAAC;AAAA,EAC7L,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,0BAA0B,CAAC;AAAA,EACzE;AACF,CAAC;AAEDC,QAAO,MAAM,gBAAgB,OAAO,KAAc,QAAkB;AAClE,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oEAAoE,CAAC;AACvH,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,EAAE,MAAM,KAAK,OAAO,QAAQ,IAAI,IAAI,QAAQ,CAAC;AACnD,MAAI;AAEF,UAAM,MAAM,MAAMD,SAAO,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACpE,QAAI,CAAC,OAAO,IAAI,WAAW,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AACrF,UAAM,OAAY,CAAC;AACnB,QAAI,SAAS,OAAW,MAAK,OAAO;AACpC,QAAI,UAAU,OAAW,MAAK,QAAQ;AACtC,QAAI,YAAY,OAAW,MAAK,UAAU;AAC1C,QAAI,QAAQ,QAAW;AACrB,YAAM,aAAa,gBAAgB,OAAO,GAAG,CAAC;AAC9C,UAAI,CAAC,gBAAgB,KAAK,UAAU,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iEAAiE,CAAC;AAC9I,WAAK,MAAM,QAAQ,UAAU;AAAA,IAC/B;AACA,UAAM,UAAU,MAAMA,SAAO,eAAe,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,KAAK,CAAC;AAC1E,QAAI,KAAK,EAAE,IAAI,QAAQ,IAAI,MAAM,QAAQ,MAAM,MAAM,QAAQ,MAAM,OAAO,QAAQ,OAAO,SAAS,QAAQ,SAAS,WAAW,QAAQ,WAAW,WAAW,QAAQ,UAAU,CAAC;AAAA,EACjL,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,0BAA0B,CAAC;AAAA,EACzE;AACF,CAAC;AAEDC,QAAO,OAAO,gBAAgB,OAAO,KAAc,QAAkB;AACnE,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oEAAoE,CAAC;AACvH,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI;AACF,UAAM,MAAM,MAAMD,SAAO,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACpE,QAAI,CAAC,OAAO,IAAI,WAAW,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AACrF,UAAMA,SAAO,eAAe,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACpD,QAAI,OAAO,GAAG,EAAE,IAAI;AAAA,EACtB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,0BAA0B,CAAC;AAAA,EACzE;AACF,CAAC;AAGDC,QAAO,IAAI,uBAAuB,OAAO,KAAc,QAAkB;AACvE,QAAM,SAAS,MAAM,cAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oEAAoE,CAAC;AACvH,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,MAAM,MAAMD,SAAO,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACpE,MAAI,CAAC,OAAO,IAAI,WAAW,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AACrF,MAAI;AACF,UAAM,SAAS,gBAAgB,QAAQ,IAAI,GAAG,CAAC;AAC/C,QAAI,CAAC,gBAAgB,KAAK,MAAM,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mCAAmC,CAAC;AAC5G,UAAM,IAAI,MAAM,aAAAG,QAAM,IAAI,QAAQ,EAAE,cAAc,QAAQ,SAAS,MAAO,SAAS,EAAE,cAAc,yBAAyB,EAAE,CAAC;AAC/H,UAAM,OAAO,OAAO,EAAE,QAAQ,EAAE;AAChC,UAAM,SAAS,SAAS,MAAM,IAAI,IAAI;AACtC,QAAI,KAAK,MAAM;AAAA,EACjB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,4BAA4B,CAAC;AAAA,EAC3E;AACF,CAAC;AAED,IAAO,mBAAQF;AAGfA,QAAO,IAAI,QAAQ,OAAO,KAAc,QAAkB;AACxD,MAAI;AACF,UAAM,MAAM,OAAO,IAAI,MAAM,OAAO,IAAI,MAAM,KAAK,EAAE;AACrD,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,aAAa;AACnD,UAAM,SAAS,IAAI,IAAI,GAAG;AAC1B,QAAI,CAAC,aAAa,KAAK,OAAO,QAAQ,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,2BAA2B;AAEhG,UAAM,IAAI,MAAM,aAAAE,QAAM,IAAI,KAAK,EAAE,cAAc,QAAQ,SAAS,MAAO,SAAS,EAAE,cAAc,yBAAyB,EAAE,CAAC;AAE5H,QAAI,UAAU,gBAAgB,8BAA8B;AAC5D,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO,EAAE,SAAS,WAAW,EAAE,OAAO,OAAO,EAAE,QAAQ,EAAE,CAAC;AAAA,EACjF,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,GAAG,UAAU,cAAc,GAAG,WAAW,qBAAqB;AAAA,EACrF;AACF,CAAC;AAGDF,QAAO,IAAI,aAAa,OAAO,KAAc,QAAkB;AAC7D,MAAI;AACF,UAAM,UAAU,OAAO,IAAI,MAAM,WAAW,QAAQ,IAAI,2BAA2B,IAAI,EAAE,YAAY;AACrG,UAAM,OAAO,OAAO,IAAI,MAAM,SAAQ,oBAAI,KAAK,GAAE,YAAY,CAAC;AAC9D,UAAM,QAAQ,IAAI,MAAM,QAAQ,OAAO,IAAI,MAAM,KAAK,IAAI;AAG1D,UAAM,WAAW,QAAQ,IAAI,gBAAgB;AAC7C,UAAM,YAAY,QAAQ,IAAI,0BAA0B;AACxD,QAAI,YAAY,WAAW;AACzB,UAAI;AAEF,cAAMG,OAAM,IAAI,IAAI,WAAW,SAAS,mBAAmB,IAAI,IAAI,OAAO,EAAE;AAC5E,cAAMC,KAAI,MAAM,aAAAF,QAAM,IAAIC,KAAI,SAAS,GAAG;AAAA,UACxC,SAAS;AAAA,UACT,SAAS,EAAE,kBAAkB,UAAU,mBAAmB,UAAU;AAAA,QACtE,CAAC;AACD,cAAME,SAAe,MAAM,QAAQD,GAAE,IAAI,IAAIA,GAAE,OAAO,CAAC;AACvD,cAAM,WAAY,SAAS,SAAS,KAAK,SAAS,KAC9CC,OAAM,OAAO,CAAC,MAAW;AACvB,gBAAM,IAAI,OAAO,GAAG,QAAQ,EAAE,EAAE,MAAM,GAAG,EAAE;AAC3C,gBAAM,IAAI,OAAO,EAAE,MAAM,GAAG,CAAC,CAAC;AAC9B,iBAAO,MAAM;AAAA,QACf,CAAC,IACDA;AACJ,cAAMC,UAAS,SAAS,IAAI,CAAC,MAAW;AACtC,gBAAM,OAAO,OAAO,GAAG,QAAQ,EAAE,EAAE,MAAM,GAAG,EAAE;AAC9C,gBAAM,OAAO,OAAO,GAAG,aAAa,GAAG,QAAQ,gBAAgB;AAC/D,gBAAM,QAAQ,MAAM,QAAQ,GAAG,KAAK,IAAI,EAAE,MAAM,KAAK,IAAI,IAAK,GAAG,QAAQ;AACzE,iBAAO;AAAA,YACL,IAAI,WAAW,OAAO,IAAI,IAAI,IAAK,KAAM,QAAQ,QAAO,GAAG,EAAE,YAAY,CAAC;AAAA,YAC1E,OAAO;AAAA,YACP,aAAa;AAAA,YACb,MAAM;AAAA,YACN,WAAW;AAAA,YACX,SAAS;AAAA,YACT;AAAA,YACA,UAAU;AAAA,YACV,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,UACpC;AAAA,QACF,CAAC;AACD,eAAO,IAAI,KAAKA,OAAM;AAAA,MACxB,SAAS,KAAK;AAEZ,YAAI;AACF,gBAAM,OAAO,IAAI,IAAI,+CAA+C,IAAI,IAAI,OAAO,EAAE;AACrF,gBAAM,KAAK,MAAM,aAAAJ,QAAM,IAAI,KAAK,SAAS,GAAG,EAAE,SAAS,KAAM,CAAC;AAC9D,gBAAMG,SAAe,MAAM,QAAQ,GAAG,IAAI,IAAI,GAAG,OAAO,CAAC;AACzD,gBAAM,WAAY,SAAS,SAAS,KAAK,SAAS,KAC9CA,OAAM,OAAO,CAAC,MAAW;AACvB,kBAAM,IAAI,OAAO,GAAG,QAAQ,EAAE,EAAE,MAAM,GAAG,EAAE;AAC3C,kBAAM,IAAI,OAAO,EAAE,MAAM,GAAG,CAAC,CAAC;AAC9B,mBAAO,MAAM;AAAA,UACf,CAAC,IACDA;AACJ,gBAAMC,UAAS,SAAS,IAAI,CAAC,OAAY;AAAA,YACvC,IAAI,WAAW,OAAO,IAAI,OAAO,EAAE,IAAI,EAAE,MAAM,GAAE,EAAE,CAAC,IAAI,OAAO,EAAE,aAAa,EAAE,IAAI,EAAE,QAAQ,QAAO,GAAG,EAAE,YAAY,CAAC;AAAA,YACvH,OAAO,OAAO,EAAE,aAAa,EAAE,QAAQ,gBAAgB;AAAA,YACvD,aAAa,MAAM,QAAQ,EAAE,KAAK,IAAI,EAAE,MAAM,KAAK,IAAI,IAAK,EAAE,QAAQ;AAAA,YACtE,MAAM;AAAA,YACN,WAAW;AAAA,YACX,SAAS;AAAA,YACT,MAAM,OAAO,EAAE,IAAI,EAAE,MAAM,GAAE,EAAE;AAAA,YAC/B,UAAU;AAAA,YACV,QAAQ;AAAA,YACR,WAAW;AAAA,YACX,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,UACpC,EAAE;AACF,iBAAO,IAAI,KAAKA,OAAM;AAAA,QACxB,QAAQ;AAAA,QAAC;AAAA,MACX;AAAA,IACF;AAGA,UAAM,MAAM,QAAQ,IAAI,mBAAmB;AAC3C,QAAI,CAAC,KAAK;AAER,UAAI;AACF,cAAM,OAAO,IAAI,IAAI,+CAA+C,IAAI,IAAI,OAAO,EAAE;AACrF,cAAM,KAAK,MAAM,aAAAJ,QAAM,IAAI,KAAK,SAAS,GAAG,EAAE,SAAS,KAAM,CAAC;AAC9D,cAAMG,SAAe,MAAM,QAAQ,GAAG,IAAI,IAAI,GAAG,OAAO,CAAC;AACzD,cAAM,WAAY,SAAS,SAAS,KAAK,SAAS,KAC9CA,OAAM,OAAO,CAAC,MAAW;AACvB,gBAAM,IAAI,OAAO,GAAG,QAAQ,EAAE,EAAE,MAAM,GAAG,EAAE;AAC3C,gBAAM,IAAI,OAAO,EAAE,MAAM,GAAG,CAAC,CAAC;AAC9B,iBAAO,MAAM;AAAA,QACf,CAAC,IACDA;AACJ,cAAMC,UAAS,SAAS,IAAI,CAAC,OAAY;AAAA,UACvC,IAAI,WAAW,OAAO,IAAI,OAAO,EAAE,IAAI,EAAE,MAAM,GAAE,EAAE,CAAC,IAAI,OAAO,EAAE,aAAa,EAAE,IAAI,EAAE,QAAQ,QAAO,GAAG,EAAE,YAAY,CAAC;AAAA,UACvH,OAAO,OAAO,EAAE,aAAa,EAAE,QAAQ,gBAAgB;AAAA,UACvD,aAAa,MAAM,QAAQ,EAAE,KAAK,IAAI,EAAE,MAAM,KAAK,IAAI,IAAK,EAAE,QAAQ;AAAA,UACtE,MAAM;AAAA,UACN,WAAW;AAAA,UACX,SAAS;AAAA,UACT,MAAM,OAAO,EAAE,IAAI,EAAE,MAAM,GAAE,EAAE;AAAA,UAC/B,UAAU;AAAA,UACV,QAAQ;AAAA,UACR,WAAW;AAAA,UACX,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,EAAE;AACF,eAAO,IAAI,KAAKA,OAAM;AAAA,MACxB,QAAQ;AAAA,MAAC;AACT,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,CAAC,CAAC;AAAA,IAChC;AACA,UAAM,WAAW,OAAO,IAAI,MAAM,YAAY,IAAI;AAClD,UAAM,MAAM,IAAI,IAAI,oCAAoC;AACxD,QAAI,aAAa,IAAI,OAAO,GAAG;AAC/B,QAAI,aAAa,IAAI,WAAW,OAAO;AACvC,QAAI,aAAa,IAAI,QAAQ,OAAO,IAAI,CAAC;AACzC,QAAI,aAAa,IAAI,UAAU,MAAM;AACrC,QAAI,aAAa,IAAI,YAAY,QAAQ;AACzC,QAAI,SAAS,SAAS,KAAK,SAAS,GAAI,KAAI,aAAa,IAAI,SAAS,OAAO,KAAK,CAAC;AACnF,UAAM,IAAI,MAAM,aAAAJ,QAAM,IAAI,IAAI,SAAS,GAAG,EAAE,SAAS,KAAM,CAAC;AAC5D,UAAM,QAAe,MAAM,QAAQ,EAAE,MAAM,QAAQ,IAAI,EAAE,KAAK,WAAW,CAAC;AAC1E,UAAM,SAAS,MAAM,IAAI,CAAC,MAAW;AACnC,YAAM,OAAO,OAAO,GAAG,QAAQ,EAAE,EAAE,MAAM,GAAG,EAAE;AAC9C,YAAM,OAAO,OAAO,GAAG,QAAQ,gBAAgB;AAC/C,aAAO;AAAA,QACL,IAAI,WAAW,OAAO,IAAI,IAAI,KAAK,GAAG,QAAQ,MAAM,QAAQ,QAAO,GAAG,EAAE,YAAY,CAAC;AAAA,QACrF,OAAO;AAAA,QACP,aAAa,OAAO,GAAG,MAAM,OAAO,IAAI,KAAK,gBAAgB;AAAA,QAC7D,MAAM;AAAA,QACN,WAAW;AAAA,QACX,SAAS;AAAA,QACT;AAAA,QACA,UAAU;AAAA,QACV,QAAQ;AAAA,QACR,WAAW;AAAA,QACX,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,MACpC;AAAA,IACF,CAAC;AACD,WAAO,IAAI,KAAK,MAAM;AAAA,EACxB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,0BAA0B,CAAC;AAAA,EAC9F;AACF,CAAC;AAGD,SAAS,SAAS,MAAc,YAAoB;AAClD,QAAM,WAAW,KAAK,MAAM,OAAO;AACnC,QAAM,QAAkB,CAAC;AACzB,WAAS,IAAI,GAAG,IAAI,SAAS,QAAQ,KAAK;AACxC,UAAM,IAAI,SAAS,CAAC;AACpB,QAAI,EAAE,WAAW,GAAG,KAAK,MAAM,SAAS,EAAG,OAAM,MAAM,SAAS,CAAC,KAAK,EAAE,MAAM,CAAC;AAAA,QAC1E,OAAM,KAAK,CAAC;AAAA,EACnB;AACA,QAAM,MAAa,CAAC;AACpB,MAAI,SAAwC;AAC5C,aAAW,KAAK,OAAO;AACrB,QAAI,EAAE,WAAW,cAAc,EAAG,UAAS,CAAC;AAAA,aACnC,EAAE,WAAW,YAAY,GAAG;AACnC,UAAI,QAAQ;AACV,cAAM,MAAM,OAAO,KAAK,KAAK,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,MAAM,CAAC;AAC/D,cAAM,UAAU,OAAO,SAAS,KAAK;AACrC,cAAM,WAAW,OAAO,aAAa,KAAK,IAAI,QAAQ,QAAQ,IAAI;AAClE,cAAM,UAAU,OAAO,SAAS,KAAK,OAAO,oBAAoB,KAAK;AACrE,cAAM,QAAQ,OAAO,OAAO,KAAK,OAAO,kBAAkB,KAAK;AAC/D,cAAM,KAAK,aAAa,OAAO;AAC/B,cAAM,KAAK,aAAa,SAAS,OAAO;AACxC,cAAM,WAAW,OAAO,UAAU,KAAK;AACvC,cAAM,UAAU,OAAO,KAAK,KAAK;AACjC,cAAM,MAAM,GAAG,OAAO;AAAA,EAAK,OAAO;AAAA,EAAK,QAAQ;AAC/C,cAAM,OAAQ,IAAI,MAAM,iBAAiB,KAAK,CAAC;AAC/C,cAAM,WAAW,KAAK,KAAK,OAAK,EAAE,YAAY,EAAE,SAAS,iBAAiB,CAAC,KACtE,KAAK,KAAK,OAAK,EAAE,YAAY,EAAE,SAAS,SAAS,CAAC,KAClD,KAAK,KAAK,OAAK,EAAE,YAAY,EAAE,SAAS,iBAAiB,CAAC,KAC1D,KAAK,CAAC;AACX,cAAM,WAAW,eAAe,QAAQ;AACxC,cAAM,WAAW,cAAc,KAAK,WAAW,EAAE;AACjD,cAAM,OAAO,WAAW,YAAa,WAAW,aAAa;AAC7D,YAAI,KAAK;AAAA,UACP,IAAI,OAAO,GAAG;AAAA,UACd,OAAO;AAAA,UACP,aAAa,UAAU,OAAO;AAAA,UAC9B;AAAA,UACA,WAAW,GAAG;AAAA,UACd,SAAS,GAAG,QAAQ,GAAG;AAAA,UACvB,MAAM,GAAG;AAAA,UACT,UAAU;AAAA,UACV,QAAQ;AAAA,UACR;AAAA,UACA,aAAa;AAAA,UACb,WAAW,CAAC;AAAA,UACZ,WAAW;AAAA,UACX,YAAW,oBAAI,KAAK,GAAE,YAAY;AAAA,QACpC,CAAC;AAAA,MACH;AACA,eAAS;AAAA,IACX,WAAW,QAAQ;AACjB,YAAM,MAAM,EAAE,QAAQ,GAAG;AACzB,UAAI,MAAM,GAAG;AACX,cAAM,MAAM,EAAE,MAAM,GAAG,GAAG,EAAE,MAAM,GAAG,EAAE,CAAC,EAAE,YAAY;AACtD,cAAM,QAAQ,EAAE,MAAM,MAAM,CAAC;AAC7B,eAAO,GAAG,IAAI;AAAA,MAChB;AAAA,IACF;AAAA,EACF;AACA,SAAO;AACT;AAEA,SAAS,aAAa,KAA6C;AACjE,QAAM,IAAI,OAAO,OAAO,EAAE;AAC1B,QAAM,WAAW,EAAE,MAAM,GAAG,CAAC;AAC7B,QAAM,OAAO,SAAS,MAAM,GAAG,CAAC;AAChC,QAAM,QAAQ,SAAS,MAAM,GAAG,CAAC;AACjC,QAAM,MAAM,SAAS,MAAM,GAAG,CAAC;AAC/B,QAAM,OAAO,GAAG,IAAI,IAAI,KAAK,IAAI,GAAG;AACpC,MAAI,OAAO;AACX,MAAI,EAAE,UAAU,MAAM,EAAE,CAAC,MAAM,IAAK,QAAO,GAAG,EAAE,MAAM,GAAG,EAAE,CAAC,IAAI,EAAE,MAAM,IAAI,EAAE,CAAC;AAC/E,SAAO,EAAE,MAAM,KAAK;AACtB;AACA,SAAS,UAAU,GAAmB;AACpC,SAAO,OAAO,KAAK,EAAE,EAAE,QAAQ,mBAAmB,EAAE,EAAE,QAAQ,aAAa,IAAI,EAAE,QAAQ,WAAW,MAAM,EAAE,KAAK;AACnH;AACA,SAAS,eAAe,GAAY;AAClC,QAAM,IAAI,OAAO,KAAK,EAAE,EAAE,YAAY;AACtC,MAAI,EAAE,SAAS,kBAAkB,EAAG,QAAO;AAC3C,MAAI,EAAE,SAAS,iBAAiB,EAAG,QAAO;AAC1C,MAAI,EAAE,SAAS,SAAS,EAAG,QAAO;AAClC,MAAI,EAAE,SAAS,iBAAiB,EAAG,QAAO;AAC1C,SAAO;AACT;;;ACxtBA,IAAAK,mBAA0C;AAC1C,IAAAC,kBAA6B;AAC7B,IAAAC,gBAAkB;AAIlB;AAEA,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,MAAUD;AAChB,IAAME,eAAS,yBAAO;AAEtB,SAASC,SAAQ,KAAc;AAC7B,QAAM,QAAS,IAAI,QAAQ,mBAAmB,KAAgB,IAAI;AAClE,QAAM,OAAO,IAAI,IAAI,MAAM;AAC3B,SAAO,GAAG,KAAK,MAAM,IAAI;AAC3B;AAEA,SAASC,eAAc,KAAc;AACnC,QAAM,UAAU,QAAQ,IAAI,qBAAqB,QAAQ,IAAI;AAC7D,MAAI,QAAS,QAAO,OAAO,OAAO,EAAE,QAAQ,QAAQ,EAAE;AACtD,QAAM,SAAS,IAAI,IAAI,QAAQ;AAC/B,MAAI,OAAQ,QAAO,OAAO,QAAQ,QAAQ,EAAE;AAE5C,QAAM,MAAMD,SAAQ,GAAG;AACvB,MAAI;AACF,UAAM,IAAI,IAAI,IAAI,GAAG;AACrB,WAAO,GAAG,EAAE,QAAQ,KAAK,EAAE,QAAQ;AAAA,EACrC,QAAQ;AACN,WAAO;AAAA,EACT;AACF;AAEA,eAAeE,eAAc,KAAsC;AACjE,QAAM,SAAU,IAAY,UAAU;AACtC,MAAI,CAAC,OAAQ,QAAO;AACpB,QAAM,OAAO,MAAML,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,MAAM,EAAE,EAAE,CAAC;AAC3E,SAAO,OAAO,KAAK,KAAK;AAC1B;AAEA,eAAeM,mBAAkB,SAAc,UAAkB,cAAsB;AACrF,MAAI,CAAC,SAAS,aAAc,QAAO;AACnC,QAAM,MAAM,oBAAI,KAAK;AACrB,MAAI,QAAQ,aAAa,IAAI,KAAK,QAAQ,SAAS,IAAI,IAAI,KAAK,IAAI,QAAQ,IAAI,GAAM,EAAG,QAAO;AAChG,QAAM,SAAS,IAAI,gBAAgB;AAAA,IACjC,WAAW;AAAA,IACX,eAAe;AAAA,IACf,YAAY;AAAA,IACZ,eAAe,QAAQ;AAAA,EACzB,CAAC;AACD,QAAM,WAAW,MAAM,cAAAC,QAAM,KAAK,uCAAuC,QAAQ,EAAE,SAAS,EAAE,gBAAgB,oCAAoC,EAAE,CAAC;AACrJ,QAAM,EAAE,cAAc,WAAW,IAAI,SAAS,QAAQ,CAAC;AACvD,QAAM,YAAY,aAAa,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,UAAU,IAAI,GAAI,IAAI;AAClF,QAAM,UAAU,MAAMP,SAAO,gBAAgB,OAAO,EAAE,OAAO,EAAE,IAAI,QAAQ,GAAG,GAAG,MAAM,EAAE,aAAa,cAAc,UAAU,EAAE,CAAC;AACjI,SAAO;AACT;AAGAE,SAAO,KAAK,mBAAmB,OAAO,KAAc,QAAkB;AACpE,QAAM,SAAS,MAAMG,eAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,cAAc,QAAQ,IAAI,sBAAsB,GAAGF,SAAQ,GAAG,CAAC;AACrE,MAAI,CAAC,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2BAA2B,CAAC;AAChF,QAAM,QAAQ;AAAA,IACZ;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EACF,EAAE,KAAK,GAAG;AACV,QAAM,QAAQ,OAAO,KAAK,KAAK,UAAU,EAAE,QAAQ,MAAM,kBAAkB,CAAC,GAAG,MAAM,EAAE,SAAS,WAAW;AAC3G,QAAM,MAAM,IAAI,IAAI,8CAA8C;AAClE,MAAI,aAAa,IAAI,aAAa,QAAQ;AAC1C,MAAI,aAAa,IAAI,gBAAgB,WAAW;AAChD,MAAI,aAAa,IAAI,iBAAiB,MAAM;AAC5C,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,aAAa,IAAI,eAAe,SAAS;AAC7C,MAAI,aAAa,IAAI,0BAA0B,MAAM;AACrD,MAAI,aAAa,IAAI,UAAU,SAAS;AACxC,MAAI,aAAa,IAAI,SAAS,KAAK;AACnC,MAAI,KAAK,EAAE,aAAa,IAAI,SAAS,EAAE,CAAC;AAC1C,CAAC;AAGDD,SAAO,IAAI,oBAAoB,OAAO,KAAc,QAAkB;AACpE,QAAM,OAAO,IAAI,MAAM;AACvB,QAAM,WAAY,IAAI,MAAM,SAAoB;AAChD,MAAI,QAAa,CAAC;AAClB,MAAI;AAAE,YAAQ,KAAK,MAAM,OAAO,KAAK,UAAU,WAAW,EAAE,SAAS,MAAM,CAAC;AAAA,EAAE,QAAQ;AAAA,EAAC;AACvF,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,QAAM,cAAc,QAAQ,IAAI,sBAAsB,GAAGC,SAAQ,GAAG,CAAC;AACrE,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,mCAAmC;AAC/F,MAAI;AACF,UAAM,SAAS,OAAO,UAAW,MAAME,eAAc,GAAG;AACxD,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,0CAA0C;AACnF,UAAM,WAAW,MAAM,cAAAE,QAAM,KAAK,uCAAuC,IAAI,gBAAgB;AAAA,MAC3F;AAAA,MACA,WAAW;AAAA,MACX,eAAe;AAAA,MACf,cAAc;AAAA,MACd,YAAY;AAAA,IACd,CAAC,GAAG,EAAE,SAAS,EAAE,gBAAgB,oCAAoC,EAAE,CAAC;AACxE,UAAM,EAAE,cAAc,eAAe,YAAY,UAAU,MAAM,IAAI,SAAS,QAAQ,CAAC;AAGvF,QAAI,QAAQ;AACZ,QAAI,UAAU;AACZ,UAAI;AACF,cAAM,UAAU,KAAK,MAAM,OAAO,KAAK,OAAO,QAAQ,EAAE,MAAM,GAAG,EAAE,CAAC,GAAG,QAAQ,EAAE,SAAS,MAAM,CAAC;AACjG,gBAAQ,OAAO,SAAS,SAAS,EAAE;AAAA,MACrC,QAAQ;AAAA,MAAC;AAAA,IACX;AACA,QAAI,CAAC,SAAS,cAAc;AAC1B,UAAI;AACF,cAAM,QAAQ,MAAM,cAAAA,QAAM,IAAI,iDAAiD,EAAE,SAAS,EAAE,eAAe,UAAU,YAAY,GAAG,EAAE,CAAC;AACvI,gBAAQ,OAAO,MAAM,MAAM,SAAS,EAAE;AAAA,MACxC,QAAQ;AAAA,MAAC;AAAA,IACX;AAEA,UAAM,YAAY,aAAa,IAAI,KAAK,KAAK,IAAI,IAAI,OAAO,UAAU,IAAI,GAAI,IAAI;AAElF,UAAMP,SAAO,gBAAgB,OAAO;AAAA,MAClC,OAAO,EAAE,uBAAuB,EAAE,QAAQ,UAAU,UAAiB,OAAO,SAAS,UAAU,EAAS;AAAA,MACxG,QAAQ,EAAE,aAAa,cAAc,cAAc,iBAAiB,IAAI,WAA6B,MAAM;AAAA,MAC3G,QAAQ,EAAE,IAAI,QAAkB,QAAQ,UAAU,UAAiB,OAAO,SAAS,WAAW,aAAa,cAAc,cAAc,iBAAiB,IAAI,WAA6B,MAAM;AAAA,IACjM,CAAC;AACD,UAAM,aAAaI,eAAc,GAAG;AACpC,UAAM,WAAW,OAAO,QAAQ;AAChC,QAAI,SAAS,GAAG,UAAU,GAAG,QAAQ,EAAE;AAAA,EACzC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,GAAG,UAAU,QAAQ,GAAG,WAAW,qBAAqB;AAAA,EAC/E;AACF,CAAC;AAGDF,SAAO,IAAI,WAAW,OAAO,KAAc,QAAkB;AAC3D,QAAM,SAAS,MAAMG,eAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,KAAK,EAAE,WAAW,MAAM,CAAC;AACjD,QAAM,MAAM,MAAML,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,QAAQ,UAAU,SAAgB,EAAE,CAAC;AACnG,MAAI,KAAK,EAAE,WAAW,CAAC,CAAC,KAAK,OAAO,KAAK,SAAS,MAAM,OAAO,KAAK,SAAS,KAAK,CAAC;AACrF,CAAC;AAGDE,SAAO,KAAK,SAAS,OAAO,KAAc,QAAkB;AAC1D,QAAM,SAAS,MAAMG,eAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,EAAE,IAAI,SAAS,MAAM,MAAM,UAAU,QAAQ,IAAI,IAAI,QAAQ,CAAC;AACpE,MAAI,CAAC,MAAM,CAAC,WAAY,CAAC,QAAQ,CAAC,KAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AACzG,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAC1G,QAAM,MAAM,MAAML,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,QAAQ,UAAU,SAAgB,EAAE,CAAC;AACnG,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AACvE,QAAM,QAAQ,OAAO,IAAI,SAAS,EAAE;AACpC,MAAI,CAAC,cAAc,KAAK,KAAK,GAAG;AAC9B,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uDAAuD,MAAM,CAAC;AAAA,EACrG;AACA,MAAI;AAGF,QAASQ,eAAT,SAAqB,GAAgB;AACnC,YAAM,QAAQ,OAAO,GAAG,aAAa,EAAE;AACvC,YAAM,UAAU,OAAO,GAAG,eAAe,EAAE;AAC3C,YAAM,QAAQ,OAAO,GAAG,aAAa,EAAE;AACvC,YAAM,aAAa,OAAO,GAAG,cAAc,EAAE;AAC7C,YAAM,YAAY,GAAG,YAAY,IAAI,KAAK,EAAE,SAAS,EAAE,mBAAmB,SAAS,EAAE,MAAM,WAAW,OAAO,QAAQ,KAAK,UAAU,CAAC,IAAI;AACzI,YAAM,UAAU,GAAG,UAAU,IAAI,KAAK,EAAE,OAAO,EAAE,mBAAmB,SAAS,EAAE,MAAM,WAAW,OAAO,QAAQ,KAAK,UAAU,CAAC,IAAI;AACnI,YAAM,WAAW,OAAO,GAAG,YAAY,KAAK;AAC5C,YAAM,WAAW,OAAO,GAAG,SAAS,CAAC;AACrC,YAAM,WAAW,IAAI,KAAK,aAAa,SAAS,EAAE,OAAO,YAAY,SAAS,CAAC,EAAE,OAAO,QAAQ;AAChG,YAAM,OAAO,OAAO,GAAG,eAAe,cAAc;AACpD,aAAO;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,4BAMe,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,iJAMgH,OAAO;AAAA,8IACV,KAAK;AAAA,sBAC7H,aAAa,4HAAgI,UAAU,eAAe,EAAE;AAAA,sBACxK,YAAY,gIAAoI,SAAS,eAAe,EAAE;AAAA,sBAC1K,UAAU,8HAAkI,OAAO,eAAe,EAAE;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,mHAUvE,IAAI;AAAA,kGACrB,QAAQ;AAAA;AAAA;AAAA;AAAA,qIAI2B,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,6HAOhB,KAAK;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAQ9H;AAzDS,sBAAAA;AAFT,UAAM,WAAW,MAAMF,mBAAkB,KAAK,UAAU,YAAY;AA6DpE,UAAM,UAAW,QAAQ,OAAO,IAAI,EAAE,KAAK,EAAE,SAAS,IAClD,OAAO,IAAI,IACV,OAAO,YAAY,EAAE,EAAE,YAAY,MAAM,aAAa,UAAUE,aAAY,OAAO,KAAK,MAAM;AAC7F,YAAM,WAAW,OAAO,QAAQ,EAAE,EAAE,QAAQ,MAAM,OAAO,EAAE,QAAQ,MAAM,MAAM,EAAE,QAAQ,MAAM,MAAM,EAAE,QAAQ,OAAO,OAAO;AAC7H,aAAO;AAAA;AAAA;AAAA;AAAA,uHAIsG,OAAO,OAAO,CAAC;AAAA,kFACpD,QAAQ;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,IAMlF,GAAG;AAEP,UAAM,WAAW,WAAW,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,MAAM,CAAC;AAC9D,UAAM,OAAO;AAAA,MACX,OAAO,EAAE;AAAA,MACT,YAAY,OAAO;AAAA,MACnB,oDAAoD,WAAW;AAAA,MAC/D;AAAA,MACA,KAAK,QAAQ;AAAA,MACb;AAAA,MACA;AAAA,MACA,OAAO,OAAO,IAAI,IAAI;AAAA,MACtB,KAAK,QAAQ;AAAA,MACb;AAAA,MACA;AAAA,MACA;AAAA,MACA,KAAK,QAAQ;AAAA,MACb;AAAA,IACF,EAAE,KAAK,MAAM;AACb,UAAM,UAAU,OAAO,KAAK,IAAI,EAAE,SAAS,QAAQ,EAAE,QAAQ,OAAO,GAAG,EAAE,QAAQ,OAAO,GAAG,EAAE,QAAQ,OAAO,EAAE;AAC9G,UAAM,UAAU,MAAM,cAAAD,QAAM,KAAK,gEAAgE,EAAE,KAAK,QAAQ,GAAG,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,EAAE,CAAC;AAGnL,QAAI;AACF,YAAM,QAAQ,OAAQ,IAAI,MAAc,SAAS,aAAa,EAAE,EAAE,KAAK;AACvE,UAAI,OAAO;AACT,cAAM,MAAM,MAAMP,SAAO,QAAQ,WAAW,EAAE,OAAO,EAAE,WAAW,MAAM,EAAE,CAAC;AAC3E,YAAI,OAAO,IAAI,WAAW,QAAQ;AAChC,gBAAMA,SAAO,QAAQ,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,GAAG,GAAG,MAAM,EAAE,QAAQ,OAAO,EAAE,CAAC;AAAA,QACjF;AAAA,MACF;AAAA,IACF,QAAQ;AAAA,IAAC;AAET,QAAI,KAAK,EAAE,IAAI,QAAQ,MAAM,MAAM,KAAK,CAAC;AAAA,EAC3C,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,uBAAuB,CAAC;AAAA,EAC3F;AACF,CAAC;AAGDE,SAAO,IAAI,iBAAiB,OAAO,KAAc,QAAkB;AACjE,QAAM,SAAS,MAAMG,eAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAC1G,QAAM,MAAM,MAAML,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,QAAQ,UAAU,SAAgB,EAAE,CAAC;AACnG,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AACvE,QAAM,QAAQ,OAAO,IAAI,SAAS,EAAE;AACpC,QAAM,aAAa,CAAC,kBAAkB,KAAK,KAAK;AAChD,MAAI,YAAY;AACd,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mDAAmD,MAAM,CAAC;AAAA,EACjG;AACA,MAAI;AACF,UAAM,WAAW,MAAMM,mBAAkB,KAAK,UAAU,YAAY;AAEpE,UAAM,IAAI;AACV,UAAM,OAAO,MAAM,cAAAC,QAAM,IAAI,2DAA2D,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,GAAG,QAAQ,EAAE,GAAG,YAAY,GAAG,EAAE,CAAC;AACvL,UAAM,WAAW,MAAM,QAAQ,KAAK,MAAM,QAAQ,IAAI,KAAK,KAAK,WAAW,CAAC;AAC5E,UAAM,MAAa,CAAC;AACpB,eAAW,KAAK,UAAU;AACxB,UAAI;AACF,cAAM,SAAS,MAAM,cAAAA,QAAM,IAAI,2DAA2D,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,EAAE,CAAC;AAClK,cAAM,UAAU,OAAO,MAAM;AAC7B,cAAM,UAAW,SAAS,WAAW,CAAC;AACtC,cAAM,UAAU,QAAQ,KAAK,OAAK,EAAE,KAAK,YAAY,MAAM,SAAS,GAAG,SAAS;AAChF,cAAM,OAAO,QAAQ,KAAK,OAAK,EAAE,KAAK,YAAY,MAAM,MAAM,GAAG,SAAS;AAC1E,cAAM,aAAa,IAAI,KAAK,OAAO,OAAO,MAAM,gBAAgB,KAAK,IAAI,CAAC,CAAC,EAAE,YAAY;AAEzF,cAAM,UAAU,OAAO,OAAO,MAAM,WAAW,EAAE;AACjD,cAAM,WAAW,QAAQ,MAAM,qEAAqE;AACpG,YAAI,YAAY;AAChB,YAAI,WAAW;AACf,YAAI,UAAU;AACZ,gBAAM,MAAM,SAAS,CAAC,KAAK;AAC3B,gBAAM,MAAM,SAAS,CAAC,KAAK;AAC3B,sBAAY,OAAO,IAAI,QAAQ,MAAM,EAAE,CAAC;AACxC,qBAAW,OAAO,IAAI,UAAU,IAAI,IAAI,YAAY,EAAE,QAAQ,MAAM,KAAK,IAAI;AAAA,QAC/E;AACA,YAAI,YAAY,GAAG;AACjB,cAAI;AACF,kBAAMN,IAAG,WAAW,OAAO;AAAA,cACzB,OAAO,EAAE,WAAW,EAAE,GAAG;AAAA,cACzB,QAAQ;AAAA,gBACN,QAAQ;AAAA,gBACR;AAAA,gBACA,WAAW;AAAA,gBACX,WAAW,QAAQ;AAAA,gBACnB,SAAS,WAAW;AAAA,gBACpB,MAAM,WAAW;AAAA,gBACjB,eAAe,IAAI,SAAS;AAAA,gBAC5B;AAAA,gBACA,QAAQ;AAAA,gBACR,YAAY;AAAA,cACd;AAAA,cACA,QAAQ;AAAA,gBACN,QAAQ;AAAA,gBACR;AAAA,gBACA,WAAW;AAAA,gBACX,WAAW,QAAQ;AAAA,gBACnB,SAAS,WAAW;AAAA,gBACpB,MAAM,WAAW;AAAA,gBACjB,eAAe,IAAI,SAAS;AAAA,gBAC5B,WAAW,EAAE;AAAA,gBACb;AAAA,gBACA,QAAQ;AAAA,gBACR,YAAY;AAAA,cACd;AAAA,YACF,CAAC;AAAA,UACH,QAAQ;AAAA,UAAC;AAET,cAAI,KAAK;AAAA,YACP,IAAI,SAAS,EAAE,EAAE;AAAA,YACjB,QAAQ;AAAA,YACR;AAAA,YACA,WAAW;AAAA,YACX,WAAW;AAAA,YACX,SAAS;AAAA,YACT,MAAM;AAAA,YACN,eAAe,IAAI,SAAS;AAAA,YAC5B,WAAW,EAAE;AAAA,YACb;AAAA,YACA,QAAQ;AAAA,UACV,CAAC;AAAA,QACH;AAAA,MACF,QAAQ;AAAA,MAAC;AAAA,IACX;AACA,QAAI,KAAK,GAAG;AAAA,EACd,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,+BAA+B,CAAC;AAAA,EACnG;AACF,CAAC;AAGDC,SAAO,IAAI,aAAa,OAAO,KAAc,QAAkB;AAC7D,QAAM,SAAS,MAAMG,eAAc,GAAG;AACtC,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAC1G,QAAM,MAAM,MAAML,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,QAAQ,UAAU,SAAgB,EAAE,CAAC;AACnG,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AACvE,QAAM,QAAQ,OAAO,IAAI,SAAS,EAAE;AACpC,QAAM,aAAa,CAAC,kBAAkB,KAAK,KAAK;AAChD,MAAI,YAAY;AACd,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mDAAmD,MAAM,CAAC;AAAA,EACjG;AAEA,MAAI;AAiBF,QAASS,iBAAT,SAAuB,UAAkB,UAAkB,SAAiB,SAAiB,WAA2B;AACtH,YAAM,QAAQ,YAAY,IAAI,YAAY;AAC1C,YAAM,QAAQ,WAAW,IAAI,YAAY;AACzC,YAAM,QAAQ,WAAW,IAAI,YAAY;AACzC,YAAM,aAAa,sEAAsE,KAAK,OAAO,MAAM,OAAO,MAAM,IAAI;AAC5H,YAAM,MAAM,qBAAqB,KAAK,QAAQ;AAC9C,YAAM,MAAM,YAAY,KAAK,QAAQ;AACrC,UAAI,UAAW,QAAO;AACtB,UAAI,OAAO,WAAY,QAAO;AAC9B,UAAI,OAAO,WAAY,QAAO;AAC9B,aAAO;AAAA,IACT;AAXS,wBAAAA;AAhBT,UAAM,WAAW,MAAMH,mBAAkB,KAAK,UAAU,YAAY;AAMpE,UAAM,IAAI;AACV,UAAM,OAAO,MAAM,cAAAC,QAAM,IAAI,2DAA2D;AAAA,MACtF,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG;AAAA,MAC3D,QAAQ,EAAE,GAAG,YAAY,GAAG;AAAA,IAC9B,CAAC;AACD,UAAM,WAAW,MAAM,QAAQ,KAAK,MAAM,QAAQ,IAAI,KAAK,KAAK,WAAW,CAAC;AAC5E,UAAM,MAAa,CAAC;AAEpB,UAAM,eAAe;AACrB,UAAM,kBAAkB;AAcxB,eAAW,KAAK,UAAU;AACxB,UAAI;AA6BF,YAASG,aAAT,SAAmB,GAAQ;AACzB,cAAI,CAAC,EAAG;AACR,cAAI,EAAE,SAAS,MAAM,QAAQ,EAAE,KAAK,GAAG;AACrC,uBAAW,MAAM,EAAE,MAAO,CAAAA,WAAU,EAAE;AAAA,UACxC,OAAO;AACL,kBAAM,KAAK,CAAC;AAAA,UACd;AAAA,QACF;AAPS,wBAAAA;AA5BT,cAAM,SAAS,MAAM,cAAAH,QAAM,IAAI,2DAA2D,EAAE,EAAE,IAAI,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,EAAE,CAAC;AAClK,cAAM,MAAM,OAAO;AACnB,cAAM,UAAU,KAAK;AACrB,cAAM,UAAW,SAAS,WAAW,CAAC;AACtC,cAAM,UAAU,QAAQ,KAAK,OAAK,EAAE,KAAK,YAAY,MAAM,SAAS,GAAG,SAAS;AAChF,cAAM,OAAO,QAAQ,KAAK,OAAK,EAAE,KAAK,YAAY,MAAM,MAAM,GAAG,SAAS;AAC1E,cAAM,UAAU,QAAQ,KAAK,OAAK,EAAE,KAAK,YAAY,MAAM,UAAU,GAAG,SAAS;AACjF,cAAM,WAAW,OAAO,KAAK,YAAY,EAAE;AAC3C,cAAM,aAAa,IAAI,KAAK,OAAO,KAAK,gBAAgB,KAAK,IAAI,CAAC,CAAC,EAAE,YAAY;AACjF,cAAM,UAAU,OAAO,KAAK,WAAW,EAAE;AAGzC,YAAI,aAAa,KAAK,IAAI,KAAK,gBAAgB,KAAK,OAAO,GAAG;AAC5D;AAAA,QACF;AAGA,cAAM,YAAY,UAAU,MAAM,SAAS,MAAM,6BAA6B;AAC9E,cAAM,YAAY,WAAW,SAAS,CAAC,EAAE,QAAQ,SAAS,GAAG,EAAE,YAAY,IAAI;AAE/E,YAAI,CAAC,UAAW;AAEhB,YAAI,UAAe;AACnB,YAAI;AAAE,oBAAU,MAAMP,SAAO,QAAQ,WAAW,EAAE,OAAO,EAAE,UAAU,EAAE,CAAC;AAAA,QAAE,QAAQ;AAAA,QAAC;AACnF,YAAI,CAAC,QAAS;AAGd,cAAM,QAAe,CAAC;AAStB,QAAAU,WAAU,OAAO;AACjB,cAAM,cAAc,MAAM,OAAO,OAAK,GAAG,MAAM,iBAC7C,qBAAqB,KAAK,EAAE,QAAQ,KAAK,YAAY,KAAK,EAAE,QAAQ,EACrE;AAGD,YAAI;AACF,cAAI,UAAU;AACZ,kBAAM,YAAY,MAAM,cAAAH,QAAM,IAAI,0DAA0D,QAAQ,IAAI,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,EAAE,CAAC;AACxK,kBAAM,QAAQ,MAAM,QAAQ,UAAU,MAAM,QAAQ,IAAI,UAAU,KAAK,WAAW,CAAC;AACnF,kBAAM,UAAU,MAAM,KAAK,CAAC,OAAY,MAAM,QAAQ,IAAI,QAAQ,KAAK,GAAG,SAAS,SAAS,MAAM,CAAC;AACnG,kBAAM,eAAe,MAAM,KAAK,CAAC,OAAY;AAC3C,oBAAM,KAAM,IAAI,SAAS,WAAW,CAAC;AACrC,oBAAM,IAAI,GAAG,KAAK,OAAK,EAAE,KAAK,YAAY,MAAM,SAAS,GAAG,SAAS;AACrE,qBAAO,EAAE,SAAS,SAAS;AAAA,YAC7B,CAAC;AACD,gBAAI,CAAC,WAAW,CAAC,cAAc;AAE7B;AAAA,YACF;AAAA,UACF;AAAA,QACF,QAAQ;AAEN;AAAA,QACF;AAEA,mBAAW,OAAO,aAAa;AAC7B,cAAI,eAAoB;AACxB,gBAAM,WAAW,IAAI,YAAY;AACjC,gBAAM,WAAW,IAAI,YAAY;AACjC,gBAAM,eAAe,IAAI,MAAM;AAC/B,cAAI,CAAC,aAAc;AAEnB,gBAAM,WAAW,OAAO,IAAI,MAAM,QAAQ,CAAC;AAC3C,cAAI,YAAY,KAAK,QAAQ,KAAK,WAAW,KAAK,WAAW,IAAO;AACpE,cAAI,qBAAqB,KAAK,QAAQ,KAAK,WAAW,KAAK,WAAW,IAAM;AAG5E,gBAAM,UAAU,GAAGJ,SAAQ,GAAG,CAAC,uBAAuB,EAAE,EAAE,gBAAgB,YAAY,YAAY,mBAAmB,IAAI,EAAE,CAAC;AAG5H,cAAI,CAACM,eAAc,UAAU,UAAU,SAAS,SAAS,SAAS,GAAG;AACnE;AAAA,UACF;AAGA,cAAI,YAAgC;AACpC,cAAI;AACF,kBAAM,OAAO,MAAM,cAAAF,QAAM;AAAA,cAAI,2DAA2D,EAAE,EAAE,gBAAgB,YAAY;AAAA,cACtH,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,EAAE;AAAA,YAAC;AAClE,kBAAM,UAAU,KAAK,MAAM,QAAQ;AACnC,kBAAM,MAAM,OAAO,KAAK,OAAO,OAAO,EAAE,QAAQ,MAAM,GAAG,EAAE,QAAQ,MAAM,GAAG,GAAG,QAAQ;AACvF,wBAAY,MAAM,cAAc,KAAK,QAAQ;AAAA,UAC/C,QAAQ;AAAA,UAAC;AAIT,cAAI;AACF,kBAAM,aAAa;AAAA,cACjB,kBAAkB,aAAa;AAAA,cAC/B,WAAW,SAAS,MAAM;AAAA,cAC1B,WAAW,SAAS,aAAa;AAAA,cACjC,SAAS,SAAS,WAAW;AAAA,cAC7B,QAAQ;AAAA,cACR;AAAA,cACA;AAAA,cACA,UAAU;AAAA,cACV,QAAQ,aAAa;AAAA,cACrB,WAAW,QAAQ,WAAW;AAAA,cAC9B,aAAa,QAAQ,IAAI,QAAQ,iBAAiB,IAAI,KAAK;AAAA;AAAA,cAE3D,QAAQ;AAAA,cACR,YAAY,UAAU,MAAM;AAAA,cAC5B,cAAc,QAAQ,IAAI,QAAQ,iBAAiB,IAAI,KAAK;AAAA,cAC5D,eAAe,YAAY;AAAA,cAC3B;AAAA,YACF;AACA,kBAAM,QAAQ,MAAMN,IAAG,eAAe,OAAO;AAAA,cAC3C,OAAO,EAAE,oBAAoB,EAAE,WAAW,EAAE,IAAI,SAAS,EAAE;AAAA,cAC3D,QAAQ;AAAA,cACR,QAAQ,EAAE,GAAG,YAAY,UAAU,WAAW,EAAE,IAAI,OAAO,CAAC,EAAE;AAAA,YAChE,CAAC;AACD,2BAAe;AAAA,UACjB,QAAQ;AAAA,UAAC;AAET,gBAAM,cAAc,MAAM,OAAO,EAAE,EAAE,EAAE,MAAM,GAAE,CAAC,EAAE,YAAY,CAAC;AAE/D,gBAAM,eAAe,cAAc;AACnC,gBAAM,WAAW,iBAAiB,aAAa,aAAa,iBAAiB,aAAa,aAAa;AACvG,gBAAM,UAAU,cAAc,MAAM,SAAS,EAAE,EAAE,IAAI,YAAY;AACjE,gBAAM,eAAe,cAAc,WAAW;AAC9C,cAAI,KAAK;AAAA,YACP,IAAI;AAAA,YACJ,kBAAkB,aAAa;AAAA,YAC/B,WAAW,aAAa;AAAA,YACxB,WAAW,SAAS,MAAM;AAAA,YAC1B,kBAAkB,aAAa;AAAA,YAC/B;AAAA,YACA,WAAW,SAAS,aAAa;AAAA,YACjC,SAAS,SAAS,WAAW;AAAA,YAC7B,aAAa,UAAU,KAAK;AAAA,YAC5B,WAAW,UAAU,KAAK;AAAA,YAC1B,QAAQ;AAAA,YACR,SAAS;AAAA,YACT;AAAA,YACA;AAAA;AAAA,YAEA,QAAQ;AAAA,YACR,UAAU;AAAA,YACV,gBAAgB;AAAA,YAChB,WAAW,QAAQ,WAAW;AAAA,YAC9B,aAAa,QAAQ,IAAI,QAAQ,iBAAiB,IAAI;AAAA,YACtD,QAAQ;AAAA,YACR,YAAY,UAAU,MAAM;AAAA,YAC5B,kBAAkB,SAAS,MAAM;AAAA,YACjC,eAAe,WAAW,YAAY,YAAY;AAAA,YAClD,OAAO,CAAC;AAAA,YACR,cAAc,QAAQ,IAAI,QAAQ,iBAAiB,IAAI;AAAA,YACvD,WAAW,EAAE;AAAA,YACb,eAAe;AAAA,YACf;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF,SAAS,GAAG;AAAA,MAEZ;AAAA,IACF;AAEA,QAAI,KAAK,GAAG;AAAA,EACd,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC/F;AACF,CAAC;AAGDC,SAAO,IAAI,kDAAkD,OAAO,KAAc,QAAkB;AAClG,QAAM,WAAW,QAAQ,IAAI;AAC7B,QAAM,eAAe,QAAQ,IAAI;AACjC,MAAI,CAAC,YAAY,CAAC,aAAc,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAG1G,QAAM,YAAa,IAAI,MAAM,WAAsB;AACnD,MAAI,MAAW;AACf,MAAI,WAAW;AACb,UAAM,MAAMF,SAAO,gBAAgB,WAAW,EAAE,OAAO,EAAE,IAAI,UAAU,EAAE,CAAC;AAAA,EAC5E;AACA,MAAI,CAAC,KAAK;AACR,UAAM,SAAS,MAAMK,eAAc,GAAG;AACtC,QAAI,QAAQ;AACV,YAAM,MAAML,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,QAAQ,UAAU,SAAgB,EAAE,CAAC;AAAA,IAC/F;AAAA,EACF;AACA,MAAI,CAAC,KAAK;AACR,UAAM,MAAMA,SAAO,gBAAgB,UAAU,EAAE,OAAO,EAAE,UAAU,SAAgB,EAAE,CAAC;AAAA,EACvF;AACA,MAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AACvE,QAAM,QAAQ,OAAO,IAAI,SAAS,EAAE;AACpC,QAAM,aAAa,CAAC,kBAAkB,KAAK,KAAK;AAChD,MAAI,YAAY;AACd,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mDAAmD,MAAM,CAAC;AAAA,EACjG;AAEA,MAAI;AAQF,QAASW,QAAT,SAAc,GAAQ;AACpB,UAAI,CAAC,KAAK,MAAO;AACjB,UAAI,EAAE,SAAS,MAAM,QAAQ,EAAE,KAAK,GAAG;AACrC,mBAAW,MAAM,EAAE,MAAO,CAAAA,MAAK,EAAE;AAAA,MACnC,WAAW,GAAG,MAAM,iBAAiB,cAAc;AACjD,gBAAQ;AAAA,MACV;AAAA,IACF;AAPS,eAAAA;AAPT,UAAM,WAAW,MAAML,mBAAkB,KAAK,UAAU,YAAY;AACpE,UAAM,EAAE,WAAW,aAAa,IAAI,IAAI;AAExC,UAAM,SAAS,MAAM,cAAAC,QAAM,IAAI,2DAA2D,SAAS,IAAI,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,EAAE,CAAC;AACvK,UAAM,UAAU,OAAO,MAAM;AAE7B,QAAI,QAAa;AASjB,IAAAI,MAAK,OAAO;AACZ,UAAM,WAAW,OAAO,YAAY;AACpC,UAAM,WAAW,OAAO,YAAY;AACpC,UAAM,SAAS,MAAM,cAAAJ,QAAM,IAAI,2DAA2D,SAAS,gBAAgB,YAAY,IAAI,EAAE,SAAS,EAAE,eAAe,UAAU,SAAS,WAAW,GAAG,EAAE,CAAC;AACnM,UAAM,UAAU,OAAO,MAAM,QAAQ;AACrC,UAAM,MAAM,OAAO,KAAK,OAAO,OAAO,EAAE,QAAQ,MAAM,GAAG,EAAE,QAAQ,MAAM,GAAG,GAAG,QAAQ;AACvF,QAAI,UAAU,gBAAgB,QAAQ;AACtC,QAAI,UAAU,uBAAuB,qBAAqB,SAAS,QAAQ,MAAM,EAAE,CAAC,GAAG;AAEvF,QAAI;AAAE,UAAI,aAAa,iBAAiB;AAAA,IAAE,QAAQ;AAAA,IAAC;AACnD,QAAI,UAAU,gCAAgC,cAAc;AAC5D,QAAI,KAAK,GAAG;AAAA,EACd,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,6BAA6B,CAAC;AAAA,EACjG;AACF,CAAC;AAED,IAAO,gBAAQL;;;ACvoBf,IAAAU,mBAA0C;AAC1C,IAAAC,kBAA6B;AAC7B,IAAAC,cAAkB;AAElB,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,MAAUD;AAChB,IAAME,eAAS,yBAAO;AAEtB,SAAS,WAAW,GAAQ;AAC1B,SAAO;AAAA,IACL,IAAI,EAAE;AAAA,IACN,WAAW,EAAE;AAAA,IACb,WAAW,EAAE;AAAA,IACb,SAAS,EAAE;AAAA,IACX,aAAa,EAAE,SAAS,SAAS;AAAA,IACjC,WAAW,EAAE,OAAO,QAAQ;AAAA,IAC5B,WAAW,EAAE;AAAA,IACb,SAAS,EAAE;AAAA,IACX,UAAU,EAAE;AAAA,IACZ,UAAU,EAAE;AAAA,IACZ,WAAW,EAAE;AAAA,IACb,OAAO,EAAE;AAAA,IACT,WAAW,EAAE;AAAA,IACb,aAAa,EAAE;AAAA,IACf,QAAQ,EAAE;AAAA,IACV,QAAQ,EAAE,UAAU;AAAA,IACpB,OAAO,EAAE,SAAS;AAAA,IAClB,WAAW,EAAE;AAAA,IACb,WAAW,EAAE;AAAA,EACf;AACF;AAEAA,SAAO,IAAI,KAAK,OAAO,MAAe,QAAkB;AACtD,QAAM,OAAO,MAAMD,IAAG,QAAQ,SAAS;AAAA,IACrC,SAAS,EAAE,WAAW,OAAO;AAAA,IAC7B,SAAS,EAAE,SAAS,MAAM,OAAO,KAAK;AAAA,EACxC,CAAC;AACD,MAAI,KAAK,KAAK,IAAI,UAAU,CAAC;AAC/B,CAAC;AAED,IAAME,gBAAe,cAAE,OAAO;AAAA,EAC5B,WAAW,cAAE,OAAO;AAAA,EACpB,WAAW,cAAE,OAAO;AAAA,EACpB,SAAS,cAAE,OAAO;AAAA,EAClB,WAAW,cAAE,OAAO;AAAA,EACpB,SAAS,cAAE,OAAO;AAAA,EAClB,UAAU,cAAE,OAAO,EAAE,QAAQ,KAAK;AAAA,EAClC,UAAU,cAAE,OAAO,EAAE,YAAY,EAAE,QAAQ,CAAC;AAAA,EAC5C,WAAW,cAAE,OAAO,EAAE,YAAY,EAAE,QAAQ,CAAC;AAAA,EAC7C,OAAO,cAAE,OAAO,EAAE,YAAY,EAAE,QAAQ,CAAC;AAAA,EACzC,OAAO,cAAE,OAAO,EAAE,SAAS,EAAE,QAAQ,EAAE;AACzC,CAAC;AAEDD,SAAO,KAAK,KAAK,OAAO,KAAc,QAAkB;AACtD,QAAM,SAASC,cAAa,UAAU,IAAI,IAAI;AAC9C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,OAAO,OAAO;AACpB,MAAI;AACF,UAAM,UAAU,MAAMF,IAAG,QAAQ,OAAO;AAAA,MACtC,MAAM;AAAA,QACJ,WAAW,KAAK;AAAA,QAChB,WAAW,KAAK;AAAA,QAChB,SAAS,KAAK;AAAA,QACd,WAAW,IAAI,KAAK,KAAK,SAAS;AAAA,QAClC,SAAS,IAAI,KAAK,KAAK,OAAO;AAAA,QAC9B,UAAU,KAAK;AAAA,QACf,UAAU,KAAK;AAAA,QACf,WAAW,KAAK;AAAA,QAChB,OAAO,KAAK;AAAA,QACZ,WAAW;AAAA,QACX,aAAa,KAAK;AAAA,QAClB,QAAQ;AAAA,QACR,OAAO,KAAK,SAAS;AAAA,MACvB;AAAA,MACA,SAAS,EAAE,SAAS,MAAM,OAAO,KAAK;AAAA,IACxC,CAAC;AACD,QAAI,OAAO,GAAG,EAAE,KAAK,WAAW,OAAO,CAAC;AAAA,EAC1C,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAED,IAAM,eAAeE,cAAa,QAAQ;AAC1CD,SAAO,MAAM,QAAQ,OAAO,KAAc,QAAkB;AAC1D,QAAM,KAAK,IAAI,OAAO;AACtB,QAAM,SAAS,aAAa,UAAU,IAAI,IAAI;AAC9C,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,OAAO,OAAO;AACpB,MAAI,KAAK,cAAc,OAAW,MAAK,YAAY,IAAI,KAAK,KAAK,SAAS;AAC1E,MAAI,KAAK,YAAY,OAAW,MAAK,UAAU,IAAI,KAAK,KAAK,OAAO;AACpE,MAAI;AACF,UAAM,UAAU,MAAMD,IAAG,QAAQ,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,SAAS,EAAE,SAAS,MAAM,OAAO,KAAK,EAAE,CAAC;AACxG,QAAI,KAAK,WAAW,OAAO,CAAC;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAEDC,SAAO,OAAO,QAAQ,OAAO,KAAc,QAAkB;AAC3D,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI;AACF,UAAMD,IAAG,QAAQ,OAAO,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACzC,QAAI,OAAO,GAAG,EAAE,IAAI;AAAA,EACtB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAEDC,SAAO,KAAK,kBAAkB,OAAO,KAAc,QAAkB;AACnE,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI;AACF,UAAM,MAAM,MAAMD,IAAG,QAAQ,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACzD,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC5D,UAAM,UAAU,MAAMA,IAAG,QAAQ,OAAO;AAAA,MACtC,OAAO,EAAE,GAAG;AAAA,MACZ,MAAM,EAAE,WAAW,IAAI,OAAO,aAAa,GAAG,QAAQ,OAAO;AAAA,MAC7D,SAAS,EAAE,SAAS,MAAM,OAAO,KAAK;AAAA,IACxC,CAAC;AACD,QAAI,KAAK,WAAW,OAAO,CAAC;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,8BAA8B,CAAC;AAAA,EAC7E;AACF,CAAC;AAED,IAAO,mBAAQC;;;AC5Hf,IAAAE,mBAA0C;AAC1C,IAAAC,kBAA6B;AAC7B,IAAAC,eAAkB;AAClB,IAAAC,eAAiB;AACjB,sBAAe;AAEf,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,MAAUD;AAChB,IAAME,eAAS,yBAAO;AAEtB,SAAS,SAAS,MAAc;AAC9B,QAAM,IAAKD,IAAW,IAAI;AAC1B,SAAO,KAAK,OAAO,EAAE,aAAa;AACpC;AAEA,SAAS,WAAW,GAAQ;AAC1B,SAAO;AAAA,IACL,IAAI,EAAE;AAAA,IACN,kBAAkB,EAAE,oBAAoB;AAAA,IACxC,WAAW,EAAE,aAAa;AAAA,IAC1B,kBAAkB,EAAE,SAAS,aAAa;AAAA,IAC1C,aAAa,MAAM,OAAO,EAAE,aAAa,EAAE,EAAE,EAAE,MAAM,GAAE,CAAC,EAAE,YAAY,CAAC;AAAA,IACvE,WAAW,EAAE,aAAa;AAAA,IAC1B,SAAS,EAAE,WAAW;AAAA,IACtB,aAAa,EAAE,SAAS,SAAS;AAAA,IACjC,WAAW,EAAE,OAAO,QAAQ;AAAA,IAC5B,QAAQ,EAAE;AAAA,IACV,SAAS,EAAE,WAAW;AAAA,IACtB,UAAU,EAAE,YAAY;AAAA,IACxB,UAAU,EAAE,YAAY;AAAA,IACxB,UAAU,EAAE,YAAY;AAAA,IACxB,QAAQ,EAAE,UAAU;AAAA,IACpB,UAAU,EAAE,YAAY;AAAA,IACxB,gBAAgB,EAAE,kBAAkB;AAAA,IACpC,WAAW,EAAE,aAAa;AAAA,IAC1B,YAAY,EAAE,cAAc;AAAA,IAC5B,QAAQ,EAAE,WAAW,aAAa,aAAa,EAAE,WAAW,aAAa,aAAa;AAAA,IACtF,YAAY,EAAE,cAAc;AAAA,IAC5B,kBAAkB,EAAE,aAAa;AAAA,IACjC,eAAe;AAAA,IACf,OAAO,EAAE,SAAS,CAAC;AAAA,IACnB,aAAa,EAAE,eAAe;AAAA,IAC9B,WAAW,EAAE,aAAa;AAAA,IAC1B,eAAe,EAAE,iBAAiB;AAAA,IAClC,YAAY,EAAE;AAAA,IACd,YAAY,EAAE,cAAc;AAAA,IAC5B,YAAY,EAAE,cAAc;AAAA,IAC5B,YAAY,EAAE,cAAc;AAAA,EAC9B;AACF;AAEAC,SAAO,IAAI,KAAK,OAAO,MAAe,QAAkB;AACtD,MAAI,CAAC,SAAS,gBAAgB,EAAG,QAAO,IAAI,KAAK,CAAC,CAAC;AACnD,QAAM,OAAO,MAAMD,IAAG,eAAe,SAAS,EAAE,SAAS,EAAE,YAAY,OAAO,GAAG,SAAS,EAAE,SAAS,MAAM,OAAO,MAAM,SAAS,KAAK,EAAE,CAAC;AACzI,MAAI,KAAK,KAAK,IAAI,UAAU,CAAC;AAC/B,CAAC;AAEDC,SAAO,KAAK,eAAe,OAAO,KAAc,QAAkB;AAChE,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAAC,SAAS,gBAAgB,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAC/G,QAAM,SAAU,IAAY,UAAU;AACtC,QAAM,OAAO,eAAE,OAAO,EAAE,YAAY,eAAE,OAAO,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACjF,MAAI;AAEF,UAAM,OAAO,MAAMD,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AACjE,QAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oBAAoB,CAAC;AAErE,UAAM,cAAc,OAAO,KAAK,UAAU,EAAE,EAAE,YAAY,MAAM;AAGhE,QAAI,aAAa;AACf,UAAI;AACF,cAAM,WAAW,MAAMA,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,GAAG,SAAS,EAAE,SAAS,MAAM,SAAS,MAAM,OAAO,KAAK,EAAE,CAAC;AAC7H,eAAO,IAAI,KAAK,WAAW,QAAQ,CAAC;AAAA,MACtC,QAAQ;AACN,eAAO,IAAI,KAAK,WAAW,IAAI,CAAC;AAAA,MAClC;AAAA,IACF;AAGA,UAAM,UAAU,MAAMA,IAAG,eAAe,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,EAAE,QAAQ,YAAY,YAAY,QAAQ,YAAY,oBAAI,KAAK,GAAG,YAAY,KAAK,cAAc,OAAU,GAAI,SAAS,EAAE,SAAS,MAAM,SAAS,MAAM,OAAO,KAAK,EAAC,CAAC;AAG5O,QAAI,cAAc;AAClB,QAAI;AACF,UAAI,KAAK,aAAa,KAAK,UAAU;AACnC,cAAM,UAAU,MAAMA,IAAG,eAAe,UAAU;AAAA,UAChD,OAAO;AAAA,YACL,IAAI,EAAE,KAAK,GAAG;AAAA,YACd,QAAQ;AAAA,YACR,IAAI;AAAA,cACF,EAAE,WAAW,KAAK,aAAa,QAAW,UAAU,KAAK,YAAY,OAAU;AAAA,cAC/E,EAAE,WAAW,KAAK,aAAa,OAAU;AAAA,YAC3C;AAAA,UACF;AAAA,QACF,CAAC;AACD,YAAI,QAAS,eAAc;AAAA,MAC7B;AAAA,IACF,QAAQ;AAAA,IAAC;AAET,QAAI,eAAe,QAAQ,aAAa,QAAQ,UAAU,QAAQ,SAAS,GAAG;AAC5E,YAAM,MAAM,MAAMA,IAAG,QAAQ,WAAW,EAAE,OAAO,EAAE,IAAI,QAAQ,UAAU,EAAE,CAAC;AAC5E,UAAI,KAAK;AACP,cAAM,gBAAgB,IAAI,aAAa,KAAK,OAAO,QAAQ,MAAM;AACjE,cAAM,cAAc,KAAK,IAAI,GAAG,OAAO,IAAI,KAAK,IAAI,YAAY;AAChE,cAAM,SAAS,gBAAgB,IAAI,SAAS,eAAe,IAAI,mBAAmB,IAAI;AACtF,cAAMA,IAAG,QAAQ,OAAO,EAAE,OAAO,EAAE,IAAI,IAAI,GAAG,GAAG,MAAM,EAAE,WAAW,cAAc,aAAa,OAAO,EAAE,CAAC;AAAA,MAC3G;AAAA,IACF;AAEA,QAAI;AACF,UAAI,QAAQ,SAAS;AACnB,cAAME,UAAS,MAAM,OAAO,OAAO,GAAG;AACtC,cAAM,OAAO,MAAMA,OAAM,IAAI,OAAO,QAAQ,OAAO,GAAG,EAAE,cAAc,cAAc,CAAC;AACrF,cAAM,MAAM,OAAO,KAAK,KAAK,IAAI;AACjC,cAAM,OAAO,OAAO,KAAK,QAAQ,cAAc,KAAK,QAAQ,YAAY,0BAA0B;AAClG,cAAMC,aAAY,QAAQ,IAAI,cAAc;AAC5C,cAAM,SAAS,aAAAC,QAAK,QAAQ,QAAQ,IAAI,GAAGD,YAAW,UAAU;AAChE,cAAM,gBAAAE,QAAG,MAAM,QAAQ,EAAE,WAAW,KAAK,CAAC;AAC1C,cAAM,eAAe,QAAQ,YAAY,IAAI,MAAM,GAAG,EAAE,IAAI,KAAK;AACjE,cAAM,MAAM,cAAc,YAAY,YAAY,IAAK,KAAK,SAAS,KAAK,IAAI,QAAQ;AACtF,cAAM,WAAW,GAAG,QAAQ,EAAE,IAAI,GAAG;AACrC,cAAM,UAAU,aAAAD,QAAK,KAAK,QAAQ,QAAQ;AAC1C,cAAM,gBAAAC,QAAG,UAAU,SAAS,GAAG;AAC/B,cAAM,UAAU,aAAAD,QAAK,MAAM,KAAK,YAAY,QAAQ;AACpD,YAAI;AAAE,gBAAMJ,IAAG,WAAW,OAAO,EAAE,MAAM,EAAE,UAAU,SAAS,UAAU,MAAM,WAAW,QAAQ,aAAa,KAAK,EAAE,CAAC;AAAA,QAAE,QAAQ;AAAA,QAAC;AACjI,cAAMA,IAAG,eAAe,OAAO,EAAE,OAAO,EAAE,IAAI,QAAQ,GAAG,GAAG,MAAM,EAAE,SAAS,YAAY,OAAO,GAAG,EAAE,CAAC;AAAA,MACxG;AAAA,IACF,QAAQ;AAAA,IAAC;AAET,QAAI,KAAK,WAAW,OAAO,CAAC;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAEDC,SAAO,KAAK,eAAe,OAAO,KAAc,QAAkB;AAChE,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAAC,SAAS,gBAAgB,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAC/G,QAAM,SAAU,IAAY,UAAU;AACtC,QAAM,OAAO,eAAE,OAAO,EAAE,QAAQ,eAAE,OAAO,GAAG,YAAY,eAAE,OAAO,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACrG,MAAI;AACF,UAAM,UAAU,MAAMD,IAAG,eAAe,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,EAAE,QAAQ,YAAY,YAAY,QAAQ,YAAY,oBAAI,KAAK,GAAG,YAAY,KAAK,cAAc,KAAK,OAAO,GAAG,SAAS,EAAE,SAAS,MAAM,SAAS,MAAM,OAAO,KAAK,EAAE,CAAC;AAC9O,QAAI,KAAK,WAAW,OAAO,CAAC;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAEDC,SAAO,IAAI,oBAAoB,OAAO,KAAc,QAAkB;AACpE,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAAC,SAAS,gBAAgB,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAC/G,QAAM,IAAI,MAAMD,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAC9D,MAAI,CAAC,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1D,QAAM,MAAM,EAAE,UAAU;AACxB,QAAM,OAAO,MAAMA,IAAG,QAAQ,SAAS,EAAE,OAAO,EAAE,QAAQ,EAAE,IAAI,CAAC,QAAQ,kBAAkB,WAAW,OAAO,EAAE,EAAE,EAAE,CAAC;AACpH,QAAM,cAAc,KACjB,IAAI,CAAC,OAAY,EAAE,SAAS,GAAG,OAAO,KAAK,KAAK,EAAE,SAAS,KAAK,GAAG,EAAE,EAAE,EACvE,KAAK,CAAC,GAAQ,MAAW,EAAE,QAAQ,EAAE,KAAK,EAC1C,MAAM,GAAG,CAAC,EACV,IAAI,CAAC,OAAY;AAAA,IAChB,IAAI,EAAE,QAAQ;AAAA,IACd,WAAW,EAAE,QAAQ;AAAA,IACrB,WAAW,EAAE,QAAQ;AAAA,IACrB,SAAS,EAAE,QAAQ;AAAA,IACnB,aAAa;AAAA,IACb,WAAW;AAAA,IACX,WAAW,EAAE,QAAQ;AAAA,IACrB,SAAS,EAAE,QAAQ;AAAA,IACnB,UAAU,EAAE,QAAQ;AAAA,IACpB,UAAU,EAAE,QAAQ;AAAA,IACpB,WAAW,EAAE,QAAQ;AAAA,IACrB,OAAO,EAAE,QAAQ;AAAA,IACjB,WAAW,EAAE,QAAQ;AAAA,IACrB,aAAa,EAAE,QAAQ;AAAA,IACvB,QAAQ,EAAE,QAAQ;AAAA,IAClB,QAAQ,EAAE,QAAQ,UAAU;AAAA,IAC5B,OAAO,EAAE,QAAQ,SAAS;AAAA,IAC1B,WAAW,EAAE,QAAQ;AAAA,IACrB,WAAW,EAAE,QAAQ;AAAA,EACvB,EAAE;AACJ,MAAI,KAAK,WAAW;AACtB,CAAC;AAEDC,SAAO,KAAK,cAAc,OAAO,KAAc,QAAkB;AAC/D,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAAC,SAAS,gBAAgB,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAC/G,QAAM,OAAO,eAAE,OAAO,EAAE,WAAW,eAAE,OAAO,GAAG,QAAQ,eAAE,OAAO,EAAE,YAAY,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACvG,QAAM,SAAU,IAAY,UAAU;AACtC,MAAI;AACF,UAAM,MAAM,MAAMD,IAAG,QAAQ,WAAW,EAAE,OAAO,EAAE,IAAI,KAAK,UAAU,EAAE,CAAC;AACzE,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oBAAoB,CAAC;AACpE,UAAM,MAAM,MAAMA,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAChE,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oBAAoB,CAAC;AAEpE,UAAMA,IAAG,aAAa,OAAO,OAAY;AACvC,YAAM,GAAG,eAAe,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,EAAE,WAAW,KAAK,UAAU,EAAE,CAAC;AACrF,YAAM,GAAG,aAAa,OAAO,EAAE,MAAM,EAAE,WAAW,KAAK,WAAW,WAAW,IAAI,QAAQ,KAAK,QAAQ,WAAW,OAAO,MAAM,GAAG,MAAM,UAAU,EAAE,CAAC;AAAA,IACtJ,CAAC;AAED,UAAM,UAAU,MAAMA,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,GAAG,SAAS,EAAE,SAAS,MAAM,SAAS,MAAM,OAAO,KAAK,EAAE,CAAC;AAC5H,QAAI,KAAK,WAAW,OAAO,CAAC;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,0BAA0B,CAAC;AAAA,EACzE;AACF,CAAC;AAEDC,SAAO,KAAK,gBAAgB,OAAO,KAAc,QAAkB;AACjE,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAAC,SAAS,gBAAgB,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAC/G,MAAI;AACF,UAAM,MAAM,MAAMD,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAChE,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oBAAoB,CAAC;AACpE,UAAMA,IAAG,eAAe,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,EAAE,WAAW,MAAM,QAAQ,YAAY,EAAE,CAAC;AAChG,UAAM,UAAU,MAAMA,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,GAAG,SAAS,EAAE,SAAS,MAAM,SAAS,MAAM,OAAO,KAAK,EAAE,CAAC;AAC5H,QAAI,KAAK,WAAW,OAAO,CAAC;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,4BAA4B,CAAC;AAAA,EAC3E;AACF,CAAC;AAGDC,SAAO,KAAK,kBAAkB,OAAO,KAAc,QAAkB;AACnE,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAAC,SAAS,gBAAgB,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wCAAwC,CAAC;AAC/G,MAAI;AACF,UAAM,IAAI,MAAMD,IAAG,eAAe,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAC9D,QAAI,CAAC,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oBAAoB,CAAC;AAClE,QAAI,CAAC,EAAE,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,mBAAmB,CAAC;AAGzE,UAAME,UAAS,MAAM,OAAO,OAAO,GAAG;AACtC,UAAM,OAAO,MAAMA,OAAM,IAAI,OAAO,EAAE,OAAO,GAAG,EAAE,cAAc,cAAc,CAAC;AAC/E,UAAM,MAAM,OAAO,KAAK,KAAK,IAAI;AACjC,UAAM,OAAO,OAAO,KAAK,QAAQ,cAAc,KAAK,EAAE,YAAY,0BAA0B;AAC5F,UAAM,EAAE,eAAAI,eAAc,IAAI,MAAM;AAChC,UAAM,SAAS,MAAMA,eAAc,KAAK,IAAI;AAC5C,QAAI,WAAW,OAAW,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qCAAqC,CAAC;AAErG,UAAM,UAAU,MAAMN,IAAG,eAAe,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,EAAE,QAAQ,YAAY,KAAK,IAAI,KAAK,EAAE,cAAc,GAAG,EAAE,EAAE,CAAC;AAClI,QAAI,KAAK,WAAW,OAAO,CAAC;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,8BAA8B,CAAC;AAAA,EAC7E;AACF,CAAC;AAED,IAAO,mBAAQC;;;ACtPf,IAAAM,mBAA0C;AAC1C,IAAAC,kBAA6B;AAC7B,IAAAC,eAAkB;AAElB,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,MAAUD;AAChB,IAAME,eAAS,yBAAO;AAEtB,SAASC,UAAS,MAAc;AAC9B,QAAM,IAAKH,SAAe,IAAI;AAC9B,SAAO,KAAK,OAAO,EAAE,aAAa;AACpC;AAEA,SAAS,UAAU,GAAQ;AACzB,SAAO;AAAA,IACL,IAAI,EAAE;AAAA,IACN,QAAQ,EAAE;AAAA,IACV,UAAU,EAAE;AAAA,IACZ,WAAW,EAAE;AAAA,IACb,WAAW,EAAE,aAAa;AAAA,IAC1B,SAAS,EAAE,WAAW;AAAA,IACtB,MAAM,EAAE,QAAQ;AAAA,IAChB,eAAe,EAAE;AAAA,IACjB,WAAW,EAAE;AAAA,IACb,YAAY,EAAE;AAAA,IACd,kBAAkB,EAAE,oBAAoB;AAAA,IACxC,eAAe,EAAE,iBAAiB;AAAA,IAClC,YAAY,EAAE,cAAc;AAAA,IAC5B,QAAQ,EAAE,WAAW,YAAY,YAAY,EAAE,WAAW,iBAAiB,gBAAgB;AAAA,IAC3F,aAAa,CAAC;AAAA,EAChB;AACF;AAEAE,SAAO,IAAI,KAAK,OAAO,MAAe,QAAkB;AACtD,MAAI,CAACC,UAAS,YAAY,EAAG,QAAO,IAAI,KAAK,CAAC,CAAC;AAC/C,QAAM,OAAO,MAAMF,IAAG,WAAW,SAAS,EAAE,SAAS,EAAE,YAAY,OAAO,EAAE,CAAC;AAC7E,MAAI,KAAK,KAAK,IAAI,SAAS,CAAC;AAC9B,CAAC;AAEDC,SAAO,KAAK,cAAc,OAAO,KAAc,QAAkB;AAC/D,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAACC,UAAS,YAAY,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4CAA4C,CAAC;AAC/G,QAAM,OAAO,eAAE,OAAO,EAAE,WAAW,eAAE,OAAO,GAAG,SAAS,eAAE,QAAQ,EAAE,SAAS,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACtG,QAAM,SAAU,IAAY,UAAU;AACtC,MAAI;AACF,UAAM,SAAS,MAAMF,IAAG,WAAW,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAC/D,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wBAAwB,CAAC;AAC3E,UAAM,MAAM,MAAMA,IAAG,QAAQ,WAAW,EAAE,OAAO,EAAE,IAAI,KAAK,UAAU,EAAE,CAAC;AACzE,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oBAAoB,CAAC;AAEpE,UAAMA,IAAG,aAAa,OAAO,OAAY;AACvC,YAAM,GAAG,WAAW,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,EAAE,kBAAkB,KAAK,WAAW,eAAe,OAAO,QAAQ,QAAQ,WAAW,YAAY,KAAK,EAAE,CAAC;AAC3J,YAAM,GAAG,aAAa,OAAO,EAAE,MAAM,EAAE,WAAW,KAAK,WAAW,cAAc,IAAI,QAAQ,OAAO,QAAQ,WAAW,OAAO,MAAM,GAAG,MAAM,cAAc,EAAE,CAAC;AAC7J,YAAM,GAAG,QAAQ,OAAO,EAAE,OAAO,EAAE,IAAI,KAAK,UAAU,GAAG,MAAM;AAAA,QAC7D,WAAW,IAAI,YAAY,OAAO;AAAA,QAClC,aAAa,KAAK,IAAI,GAAG,IAAI,SAAS,IAAI,YAAY,OAAO,OAAO;AAAA,QACpE,QAAQ,IAAI,UAAW,IAAI,YAAY,OAAO,SAAU,SAAU,IAAI,YAAY,OAAO,SAAU,IAAI,mBAAmB,IAAI;AAAA,MAChI,EAAE,CAAC;AAAA,IACL,CAAC;AAED,UAAM,UAAU,MAAMA,IAAG,WAAW,WAAW,EAAE,OAAO,EAAE,GAAG,EAAE,CAAC;AAChE,QAAI,KAAK,UAAU,OAAO,CAAC;AAAA,EAC7B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,8BAA8B,CAAC;AAAA,EAC7E;AACF,CAAC;AAEDC,SAAO,KAAK,iBAAiB,OAAO,KAAc,QAAkB;AAClE,QAAM,KAAK,IAAI,OAAO;AACtB,MAAI,CAACC,UAAS,YAAY,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,4CAA4C,CAAC;AAC/G,MAAI;AACF,UAAM,UAAU,MAAMF,IAAG,WAAW,OAAO,EAAE,OAAO,EAAE,GAAG,GAAG,MAAM,EAAE,QAAQ,UAAU,EAAE,CAAC;AACzF,QAAI,KAAK,UAAU,OAAO,CAAC;AAAA,EAC7B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,6BAA6B,CAAC;AAAA,EAC5E;AACF,CAAC;AAED,IAAO,uBAAQC;;;AC9Ef,IAAAE,mBAA0C;AAC1C,IAAAC,kBAA6B;AAC7B,IAAAC,iBAAmB;AACnB,IAAAC,eAAiB;AACjB,IAAAC,mBAAe;AACf,IAAAC,eAAkB;AAElB,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,MAAUD;AAChB,IAAME,eAAS,yBAAO;AAGtB,IAAM,YAAY,aAAAC,QAAK,QAAQ,QAAQ,IAAI,GAAG,WAAW,WAAW;AACpE,IAAMC,WAAU,eAAAC,QAAO,YAAY;AAAA,EACjC,aAAa,OAAO,MAAM,OAAO,OAAO;AACtC,QAAI;AAAE,YAAM,iBAAAC,QAAG,MAAM,WAAW,EAAE,WAAW,KAAK,CAAC;AAAA,IAAE,QAAQ;AAAA,IAAC;AAC9D,OAAG,MAAM,SAAS;AAAA,EACpB;AAAA,EACA,UAAU,CAAC,MAAM,MAAM,OAAO;AAC5B,UAAM,OAAO,OAAO,KAAK,gBAAgB,MAAM,EAAE,QAAQ,oBAAoB,GAAG;AAChF,UAAM,MAAM,aAAAH,QAAK,QAAQ,IAAI;AAC7B,UAAM,OAAO,aAAAA,QAAK,SAAS,MAAM,GAAG;AACpC,UAAM,SAAS,GAAG,KAAK,IAAI,CAAC,IAAI,KAAK,OAAO,EAAE,SAAS,EAAE,EAAE,MAAM,GAAG,CAAC,CAAC,IAAI,IAAI;AAC9E,OAAG,MAAM,GAAG,MAAM,GAAG,GAAG,EAAE;AAAA,EAC5B;AACF,CAAC;AACD,IAAMI,cAAS,eAAAF,SAAO,EAAE,SAAAD,SAAQ,CAAC;AAEjC,SAAS,UAAU,GAAmB;AACpC,UAAQ,GAAG;AAAA,IACT,KAAK;AAAS,aAAO;AAAA,IACrB,KAAK;AAAa,aAAO;AAAA,IACzB,KAAK;AAAY,aAAO;AAAA,IACxB,KAAK;AAAiB,aAAO;AAAA,IAC7B,KAAK;AAAY,aAAO;AAAA,IACxB;AAAS,aAAO;AAAA,EAClB;AACF;AAEA,SAAS,YAAY,GAAQ;AAC3B,SAAO;AAAA,IACL,IAAI,EAAE;AAAA,IACN,MAAM,EAAE;AAAA,IACR,SAAS,EAAE,UAAU,WAAW,UAAU,IAAI,EAAE,WAAW,YAAY,EAAE,QAAQ;AAAA,IACjF,UAAU,EAAE;AAAA,IACZ,QAAQ,UAAU,EAAE,UAAU,OAAO;AAAA,IACrC,YAAY,EAAE,cAAc;AAAA,IAC5B,UAAU,EAAE,WAAW,EAAE,IAAI,EAAE,SAAS,IAAI,MAAM,EAAE,SAAS,MAAM,OAAO,EAAE,SAAS,MAAM,IAAI;AAAA,IAC/F,cAAc,EAAE,UAAU,MAAM,QAAQ;AAAA,IACxC,aAAa,EAAE;AAAA,IACf,WAAW,EAAE,YAAY,EAAE,IAAI,EAAE,UAAU,IAAI,MAAM,EAAE,UAAU,MAAM,OAAO,EAAE,UAAU,MAAM,IAAI;AAAA,IACpG,eAAe,EAAE,WAAW,MAAM,QAAQ;AAAA,IAC1C,WAAW,EAAE,aAAa;AAAA,IAC1B,SAAS,EAAE,WAAW;AAAA,IACtB,QAAQ,EAAE,UAAU;AAAA,IACpB,aAAa,EAAE,SAAS,SAAS;AAAA,IACjC,WAAW,EAAE,OAAO,QAAQ;AAAA,IAC5B,WAAW,EAAE,MAAM,SAAS;AAAA,IAC5B,eAAe,EAAE,iBAAiB;AAAA,IAClC,YAAY,EAAE,cAAc;AAAA,IAC5B,SAAS,EAAE,WAAW;AAAA,IACtB,WAAW,EAAE;AAAA,EACf;AACF;AAGAF,SAAO,KAAK,WAAWK,QAAO,MAAM,OAAO,GAAG,OAAO,KAAc,QAAkB;AACnF,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AAEpE,QAAM,SAAS,eAAE,OAAO;AAAA,IACtB,WAAW,eAAE,OAAO;AAAA,IACpB,SAAS,eAAE,OAAO;AAAA,IAClB,QAAQ,eAAE,OAAO,EAAE,SAAS,EAAE,SAAS;AAAA,IACvC,YAAY,eAAE,OAAO;AAAA,IACrB,QAAQ,eAAE,KAAK,CAAC,SAAQ,WAAW,CAAC,EAAE,SAAS,EAAE,QAAQ,WAAW;AAAA,IACpE,MAAM,eAAE,OAAO,EAAE,SAAS;AAAA,EAC5B,CAAC;AAED,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,WAAW,SAAS,QAAQ,YAAY,QAAQ,KAAK,IAAI,OAAO;AAExE,QAAM,QAAS,IAAI,SAAmC,CAAC;AACvD,MAAI,CAAC,MAAM,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6CAA6C,CAAC;AAEtG,MAAI;AAEF,UAAM,CAAC,SAAS,OAAO,QAAQ,IAAI,MAAM,QAAQ,IAAI;AAAA,MACnDP,SAAO,QAAQ,WAAW,EAAE,OAAO,EAAE,IAAI,UAAU,EAAE,CAAC;AAAA,MACtDA,SAAO,MAAM,WAAW,EAAE,OAAO,EAAE,IAAI,QAAQ,EAAE,CAAC;AAAA,MAClDA,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,WAAW,EAAE,CAAC;AAAA,IACtD,CAAC;AACD,QAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oBAAoB,CAAC;AACxE,QAAI,CAAC,SAAS,MAAM,cAAc,UAAW,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8BAA8B,CAAC;AACjH,QAAI,CAAC,SAAU,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qBAAqB,CAAC;AAE1E,UAAM,WAAW,WAAW,cAAc,cAAc;AACxD,UAAM,UAAU,CAAC;AACjB,eAAW,KAAK,OAAO;AACrB,YAAM,UAAU,aAAAG,QAAK,MAAM,KAAK,aAAa,aAAAA,QAAK,SAAS,EAAE,IAAI,CAAC;AAClE,YAAM,MAAM,MAAMF,IAAG,SAAS,OAAO;AAAA,QACnC,MAAM;AAAA,UACJ,MAAM,QAAQ,EAAE,gBAAgB;AAAA,UAChC,UAAU;AAAA;AAAA,UACV;AAAA,UACA;AAAA,UACA,QAAQ,UAAU;AAAA,UAClB;AAAA,UACA,aAAa;AAAA,UACb,QAAQ;AAAA,QACV;AAAA,QACA,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,SAAS,MAAM,OAAO,MAAM,MAAM,KAAK;AAAA,MACnI,CAAC;AACD,cAAQ,KAAK,YAAY,GAAG,CAAC;AAE7B,UAAI;AACF,YAAI,QAAQ;AACV,gBAAMD,SAAO,aAAa,OAAO;AAAA,YAC/B,MAAM;AAAA,cACJ,QAAQ,OAAO,MAAM;AAAA,cACrB,MAAM;AAAA,cACN,SAAS,aAAa,IAAI,IAAI;AAAA,cAC9B,aAAa;AAAA,YACf;AAAA,UACF,CAAC;AAAA,QACH;AAAA,MACF,QAAQ;AAAA,MAAC;AAAA,IACX;AACA,QAAI,OAAO,GAAG,EAAE,KAAK,OAAO;AAAA,EAC9B,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,6BAA6B,CAAC;AAAA,EAC5E;AACF,CAAC;AAGDE,SAAO,IAAI,UAAU,OAAO,KAAc,QAAkB;AAC1D,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,OAAO,MAAMD,IAAG,SAAS,SAAS;AAAA,IACtC,OAAO,EAAE,YAAY,OAAO;AAAA,IAC5B,SAAS,EAAE,WAAW,OAAO;AAAA,IAC7B,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,SAAS,MAAM,OAAO,MAAM,MAAM,KAAK;AAAA,EACnI,CAAC;AACD,MAAI,KAAK,KAAK,IAAI,WAAW,CAAC;AAChC,CAAC;AAGDC,SAAO,IAAI,SAAS,OAAO,KAAc,QAAkB;AACzD,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,OAAO,MAAMD,IAAG,SAAS,SAAS;AAAA,IACtC,OAAO,EAAE,aAAa,OAAO;AAAA,IAC7B,SAAS,EAAE,WAAW,OAAO;AAAA,IAC7B,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,SAAS,MAAM,OAAO,MAAM,MAAM,KAAK;AAAA,EACnI,CAAC;AACD,MAAI,KAAK,KAAK,IAAI,WAAW,CAAC;AAChC,CAAC;AAGDC,SAAO,IAAI,oBAAoB,OAAO,KAAc,QAAkB;AACpE,QAAM,SAAS,IAAI,OAAO;AAC1B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kBAAkB,CAAC;AACrE,MAAI;AACF,UAAM,OAAO,MAAMD,IAAG,SAAS,SAAS;AAAA,MACtC,OAAO,EAAE,OAAO;AAAA,MAChB,SAAS,EAAE,WAAW,OAAO;AAAA,MAC7B,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,SAAS,MAAM,OAAO,MAAM,MAAM,KAAK;AAAA,IACnI,CAAC;AACD,QAAI,KAAK,KAAK,IAAI,WAAW,CAAC;AAAA,EAChC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,2BAA2B,CAAC;AAAA,EAC1E;AACF,CAAC;AAEDC,SAAO,IAAI,QAAQ,OAAO,KAAc,QAAkB;AACxD,QAAM,IAAI,MAAMD,IAAG,SAAS,WAAW;AAAA,IACrC,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG;AAAA,IAC3B,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,SAAS,MAAM,OAAO,MAAM,MAAM,KAAK;AAAA,EACnI,CAAC;AACD,MAAI,CAAC,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1D,MAAI,KAAK,YAAY,CAAC,CAAC;AACzB,CAAC;AAGDC,SAAO,MAAM,eAAe,OAAO,KAAc,QAAkB;AACjE,QAAM,SAAU,IAAY;AAC5B,MAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,QAAM,SAAS,eAAE,OAAO;AAAA,IACtB,QAAQ,eAAE,KAAK,CAAC,YAAW,YAAW,iBAAgB,WAAW,CAAC;AAAA,IAClE,eAAe,eAAE,OAAO,EAAE,SAAS;AAAA,EACrC,CAAC;AACD,QAAM,SAAS,OAAO,UAAU,IAAI,IAAI;AACxC,MAAI,CAAC,OAAO,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,OAAO,MAAM,QAAQ,CAAC;AACvE,QAAM,EAAE,QAAQ,cAAc,IAAI,OAAO;AACzC,QAAM,IAAI,MAAMD,IAAG,SAAS,WAAW,EAAE,OAAO,EAAE,IAAI,IAAI,OAAO,GAAG,EAAE,CAAC;AACvE,MAAI,CAAC,EAAG,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,YAAY,CAAC;AAC1D,MAAI,EAAE,eAAe,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2CAA2C,CAAC;AAC9G,QAAM,WACJ,WAAW,aAAa,aACxB,WAAW,aAAa,aACxB,WAAW,kBAAkB,kBAAkB;AAEjD,QAAM,UAAU,MAAMA,IAAG,SAAS,OAAO;AAAA,IACvC,OAAO,EAAE,IAAI,EAAE,GAAG;AAAA,IAClB,MAAM,EAAE,QAAQ,UAAU,eAAe,iBAAiB,QAAW,YAAY,oBAAI,KAAK,EAAE;AAAA,IAC5F,SAAS,EAAE,UAAU,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,WAAW,EAAE,SAAS,EAAE,MAAM,KAAK,EAAE,GAAG,SAAS,MAAM,OAAO,MAAM,MAAM,KAAK;AAAA,EACnI,CAAC;AACD,MAAI,KAAK,YAAY,OAAO,CAAC;AAC/B,CAAC;AAED,IAAO,oBAAQC;;;ACnNf,IAAAM,mBAAuB;AACvB,IAAAC,kBAA6B;AAC7B,IAAAC,eAAkB;AAClB,IAAAC,mBAAmB;AAEnB,IAAAC,iBAAmB;AAGnB,IAAMC,WAAS,IAAI,6BAAa;AAChC,IAAMC,eAAS,yBAAO;AAGtB,eAAe,WAAW,MAAc;AACtC,QAAM,QAAQ,MAAMD,SAAO,QAAQ,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,MAAM,MAAM,cAAc,EAAE,EAAE,CAAC;AACvG,MAAI,MAAO,QAAO;AAClB,SAAOA,SAAO,QAAQ,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC;AACjD;AACA,eAAe,iBAAiB,MAAc;AAC5C,QAAM,QAAQ,MAAMA,SAAO,WAAW,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,MAAM,MAAM,cAAc,EAAE,EAAE,CAAC;AAC1G,MAAI,MAAO,QAAO;AAClB,SAAOA,SAAO,WAAW,OAAO,EAAE,MAAM,EAAE,KAAK,EAAE,CAAC;AACpD;AAGAC,SAAO,IAAI,iBAAiB;AAG5BA,SAAO,KAAK,kBAAkB,OAAO,KAAK,QAAQ;AAChD,QAAM,OAAO,eAAE,OAAO;AAAA,IACpB,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IACtB,OAAO,eAAE,OAAO,EAAE,MAAM;AAAA,IACxB,UAAU,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IAC1B,UAAU,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IAC1B,gBAAgB,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IAChC,QAAQ,eAAE,OAAO,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,IAClD,QAAQ,eAAE,OAAO,QAAQ,EAAE,SAAS,EAAE,QAAQ,IAAI;AAAA,EACpD,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AAEvB,MAAI;AAEF,UAAM,aAAa,OAAO,QAAQ,IAAI,oBAAoB,EAAE,EAAE,KAAK,EAAE,YAAY;AACjF,QAAI,KAAK,MAAM,KAAK,EAAE,YAAY,MAAM,YAAY;AAClD,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,oCAAoC,CAAC;AAAA,IAC5E;AACA,UAAM,CAAC,MAAM,IAAI,IAAI,MAAM,QAAQ,IAAI;AAAA,MACrC,WAAW,KAAK,QAAQ;AAAA,MACxB,iBAAiB,KAAK,cAAc;AAAA,IACtC,CAAC;AACD,UAAM,OAAO,MAAM,iBAAAC,QAAO,KAAK,KAAK,UAAU,EAAE;AAChD,UAAM,OAAO,MAAMF,SAAO,KAAK,OAAO;AAAA,MACpC,MAAM;AAAA,QACJ,MAAM,KAAK;AAAA,QACX,OAAO,KAAK,MAAM,YAAY;AAAA,QAC9B,QAAQ,KAAK;AAAA,QACb,cAAc,KAAK;AAAA,QACnB,cAAc;AAAA,QACd,UAAU,KAAK;AAAA,QACf,iBAAiB,KAAK,SAAS,oBAAI,KAAK,IAAI;AAAA,MAC9C;AAAA,IACF,CAAC;AACD,QAAI,OAAO,GAAG,EAAE,KAAK;AAAA,MACnB,IAAI,KAAK;AAAA,MACT,MAAM,KAAK;AAAA,MACX,OAAO,KAAK;AAAA,MACZ,MAAM,KAAK;AAAA,MACX,YAAY,KAAK;AAAA,MACjB,UAAU,KAAK;AAAA,MACf,UAAU,CAAC,CAAC,KAAK;AAAA,IACnB,CAAC;AAAA,EACH,SAAS,GAAQ;AACf,QAAI,GAAG,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AACtF,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,0BAA0B,CAAC;AAAA,EACzE;AACF,CAAC;AAGDC,SAAO,IAAI,YAAY,OAAO,MAAM,QAAQ;AAC1C,QAAM,CAAC,OAAO,KAAK,IAAI,MAAM,QAAQ,IAAI;AAAA,IACvCD,SAAO,QAAQ,SAAS,EAAE,SAAS,EAAE,MAAM,MAAM,EAAE,CAAC;AAAA,IACpDA,SAAO,WAAW,SAAS,EAAE,SAAS,EAAE,MAAM,MAAM,EAAE,CAAC;AAAA,EACzD,CAAC;AACD,MAAI,KAAK,EAAE,OAAO,MAAM,IAAI,OAAK,EAAE,IAAI,GAAG,aAAa,MAAM,IAAI,OAAK,EAAE,IAAI,EAAE,CAAC;AACjF,CAAC;AAED,IAAO,gBAAQC;AAGfA,SAAO,KAAK,gBAAgB,OAAO,KAAK,QAAQ;AAC9C,QAAM,OAAO,eAAE,OAAO;AAAA,IACpB,MAAM,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,IACtB,OAAO,eAAE,OAAO,EAAE,MAAM;AAAA,IACxB,UAAU,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,SAAS;AAAA,IACrC,gBAAgB,eAAE,OAAO,EAAE,IAAI,CAAC;AAAA,EAClC,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACvB,MAAI;AAEF,UAAM,OAAO,KAAK,WACd,MAAM,WAAW,KAAK,QAAQ,IAC7B,MAAMD,SAAO,QAAQ,UAAU,EAAE,OAAO,EAAE,MAAM,EAAE,QAAQ,UAAU,MAAM,cAAc,EAAE,EAAE,CAAC,KAAM,MAAM,WAAW,QAAQ;AACjI,UAAM,OAAO,MAAM,iBAAiB,KAAK,cAAc;AACvD,UAAM,QAAQ,KAAK,MAAM,YAAY;AACrC,QAAI,OAAO,MAAMA,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,MAAM,EAAE,CAAC;AAC5D,QAAI,CAAC,MAAM;AACT,aAAO,MAAMA,SAAO,KAAK,OAAO,EAAE,MAAO;AAAA,QACvC,MAAM,KAAK;AAAA,QACX;AAAA,QACA,QAAS,KAAa;AAAA,QACtB,cAAc,KAAK;AAAA,QACnB,UAAU;AAAA,QACV,iBAAiB;AAAA,MACnB,EAAU,CAAC;AAAA,IACb;AAEA,UAAMA,SAAO,gBAAgB,OAAO;AAAA,MAClC,OAAO,EAAE,QAAQ,KAAK,GAAG;AAAA,MACzB,QAAQ,EAAE,QAAQ,YAAY,aAAc,IAAY,QAAQ,WAAW,oBAAI,KAAK,EAAE;AAAA,MACtF,QAAQ,EAAE,QAAQ,KAAK,IAAI,QAAQ,YAAY,aAAc,IAAY,QAAQ,WAAW,oBAAI,KAAK,GAAG,uBAAuB,KAAK,IAAI,iBAAkB,KAAa,GAAG;AAAA,IAC5K,CAAC;AAED,UAAM,MAAM,MAAM,kBAAkB,KAAK,IAAI,KAAK,IAAI;AAEtD,UAAM,aAAa,QAAQ,IAAI,qBAAqB;AACpD,UAAM,YAAY,GAAG,UAAU,wBAAwB,mBAAmB,GAAG,CAAC;AAC9E,QAAI,aAAa,GAAG;AAClB,YAAM,EAAE,SAAS,KAAK,IAAI,kBAAkB,WAAW,KAAK,MAAO,MAAc,MAAM,KAAK,IAAI;AAChG,YAAM,SAAS,KAAK,OAAO,SAAS,IAAI;AAAA,IAC1C;AACA,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,MAAM,IAAI,KAAK,IAAI,OAAO,KAAK,OAAO,GAAI,aAAa,IAAI,CAAC,IAAI,EAAE,UAAU,EAAG,CAAC;AAAA,EAC7G,SAAS,GAAQ;AACf,QAAI,GAAG,SAAS,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,uBAAuB,CAAC;AACtF,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAIDC,SAAO,KAAK,wBAAwB,OAAO,KAAK,QAAQ;AACtD,QAAM,OAAO,eAAE,OAAO,EAAE,QAAQ,eAAE,OAAO,EAAE,IAAI,CAAC,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACzE,QAAM,UAAW,IAAY;AAC7B,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC9E,MAAI;AACF,UAAM,SAAS,MAAMD,SAAO,KAAK,WAAW,EAAE,OAAO,EAAE,IAAI,KAAK,OAAO,EAAE,CAAC;AAC1E,QAAI,CAAC,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,iBAAiB,CAAC;AACpE,UAAMG,MAAUH;AAChB,UAAM,UAAU,MAAMG,IAAG,qBAAqB,OAAO,EAAE,MAAM,EAAE,SAAS,QAAQ,OAAO,GAAG,EAAE,CAAC;AAC7F,UAAMA,IAAG,WAAW,OAAO,EAAE,MAAM,EAAE,SAAS,cAAc,OAAO,IAAI,QAAQ,uBAAuB,SAAS,sCAAsC,EAAE,CAAC;AACxJ,UAAM,UAAU,QAAQ,IAAI,YAAY,IAAI,YAAY,MAAM;AAC9D,QAAI,OAAO,UAAU,QAAQ,IAAI,EAAE,UAAU,MAAM,UAAU,OAAO,QAAQ,OAAO,CAAC;AACpF,QAAI,KAAK,EAAE,IAAI,MAAM,WAAW,QAAQ,IAAI,MAAM,EAAE,IAAI,OAAO,IAAI,MAAM,OAAO,MAAM,OAAO,OAAO,MAAM,EAAE,CAAC;AAAA,EAC/G,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,gCAAgC,CAAC;AAAA,EAC/E;AACF,CAAC;AAEDF,SAAO,KAAK,uBAAuB,OAAO,KAAK,QAAQ;AACrD,QAAM,UAAW,IAAY;AAC7B,QAAM,SAAU,IAAY,SAAS,UAAU;AAC/C,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC9E,MAAI;AACF,QAAI,QAAQ;AACV,YAAME,MAAUH;AAChB,YAAMG,IAAG,qBAAqB,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,MAAM,GAAG,SAAS,SAAS,KAAK,GAAG,MAAM,EAAE,SAAS,oBAAI,KAAK,EAAE,EAAE,CAAC;AAAA,IACnI;AACA,UAAMA,MAAUH;AAChB,UAAMG,IAAG,WAAW,OAAO,EAAE,MAAM,EAAE,SAAS,QAAQ,sBAAsB,SAAS,qCAAqC,EAAE,CAAC;AAC7H,QAAI,YAAY,QAAQ;AACxB,QAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AAAA,EACvB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,+BAA+B,CAAC;AAAA,EAC9E;AACF,CAAC;AAEDF,SAAO,IAAI,yBAAyB,OAAO,KAAK,QAAQ;AACtD,QAAM,UAAW,IAAY;AAC7B,QAAM,SAAU,IAAY,SAAS,UAAU;AAC/C,MAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,0BAA0B,CAAC;AAC9E,MAAI,CAAC,OAAQ,QAAO,IAAI,KAAK,EAAE,QAAQ,MAAM,CAAC;AAC9C,MAAI;AACF,UAAME,MAAUH;AAChB,UAAM,UAAU,MAAMG,IAAG,qBAAqB,UAAU,EAAE,OAAO,EAAE,IAAI,OAAO,MAAM,GAAG,SAAS,SAAS,KAAK,GAAG,SAAS,EAAE,MAAM,KAAK,EAAE,CAAC;AAC1I,QAAI,CAAC,QAAS,QAAO,IAAI,KAAK,EAAE,QAAQ,MAAM,CAAC;AAC/C,QAAI,KAAK,EAAE,QAAQ,MAAM,SAAS,EAAE,IAAI,QAAQ,IAAI,MAAM,EAAE,IAAI,QAAQ,QAAQ,MAAM,QAAQ,KAAK,MAAM,OAAO,QAAQ,KAAK,MAAM,GAAG,WAAW,QAAQ,UAAU,EAAE,CAAC;AAAA,EACxK,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AAGDF,SAAO,KAAK,0BAA0B,OAAO,MAAM,QAAQ;AACzD,QAAM,aAAa,OAAO,QAAQ,IAAI,oBAAoB,EAAE,EAAE,KAAK,EAAE,YAAY;AACjF,MAAI,CAAC,WAAY,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kCAAkC,CAAC;AACzF,MAAI;AACF,UAAM,WAAW,MAAMD,SAAO,KAAK,UAAU,EAAE,OAAO,EAAE,OAAO,WAAW,EAAE,CAAC;AAC7E,QAAI,UAAU;AACd,QAAI,WAAW;AACf,UAAM,SAAS,MAAMA,SAAO,KAAK,SAAS,EAAE,OAAO,EAAE,KAAK,EAAE,OAAO,WAAW,EAAE,EAAE,CAAC;AACnF,eAAW,KAAK,QAAQ;AACtB,UAAI;AACF,cAAMA,SAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,EAAE,CAAC;AAChD;AAAA,MACF,QAAQ;AAEN,cAAM,WAAW,YAAY,EAAE,EAAE;AACjC,cAAMA,SAAO,KAAK,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,GAAG,GAAG,MAAM,EAAE,UAAU,OAAO,OAAO,UAAU,MAAM,iBAAiB,cAAc,KAAK,EAAS,CAAC;AAC9I;AAAA,MACF;AAAA,IACF;AACA,QAAI,KAAK,EAAE,IAAI,MAAM,MAAM,WAAW,IAAI,GAAG,SAAS,SAAS,CAAC;AAAA,EAClE,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,wBAAwB,CAAC;AAAA,EACvE;AACF,CAAC;AACD,SAASI,WAAU,KAAa;AAC9B,SAAO,eAAAC,QAAO,WAAW,QAAQ,EAAE,OAAO,GAAG,EAAE,OAAO,KAAK;AAC7D;AACA,eAAe,kBAAkB,QAAgB,YAAoB;AACnE,QAAM,MAAM,eAAAA,QAAO,YAAY,EAAE,EAAE,SAAS,KAAK;AACjD,QAAM,YAAYD,WAAU,GAAG;AAC/B,QAAM,YAAY,IAAI,KAAK,KAAK,IAAI,IAAI,aAAa,GAAI;AACzD,QAAMJ,SAAO,UAAU,OAAO,EAAE,MAAM,EAAE,QAAQ,MAAM,gBAAuB,WAAW,UAAU,EAAE,CAAC;AACrG,SAAO;AACT;;;AC7NA,IAAAM,mBAAuB;AACvB,IAAAC,eAAkB;AAIlB,IAAMC,eAAS,yBAAO;AAEtBA,SAAO,IAAI,qBAAqB,mBAAmB,OAAO,MAAM,QAAQ;AACtE,QAAM,QAAQ,MAAM,mBAAmB;AACvC,QAAM,UAAU,CAAC,CAAC,QAAQ,IAAI;AAC9B,MAAI,KAAK,EAAE,OAAO,QAAQ,UAAU,QAAQ,KAAK,CAAC;AACpD,CAAC;AAEDA,SAAO,IAAI,qBAAqB,mBAAmB,OAAO,KAAK,QAAQ;AACrE,QAAM,OAAO,eAAE,OAAO,EAAE,OAAO,eAAE,OAAO,EAAE,MAAM,EAAE,CAAC,EAAE,MAAM,IAAI,QAAQ,CAAC,CAAC;AACzE,QAAM,QAAQ,MAAM,mBAAmB,KAAK,KAAK;AACjD,MAAI,KAAK,EAAE,IAAI,MAAM,OAAO,MAAM,CAAC;AACrC,CAAC;AAED,IAAO,mBAAQA;;;ACnBf,IAAAC,mBAA0C;AAC1C,IAAAC,iBAAmB;AACnB,IAAAC,gBAAkB;AAGlB,IAAMC,eAAS,yBAAO;AAGtB,IAAMC,cAAS,eAAAC,SAAO,EAAE,SAAS,eAAAA,QAAO,cAAc,EAAE,CAAC;AAEzD,eAAe,MAAM,IAAY;AAC/B,SAAO,IAAI,QAAQ,aAAW,WAAW,SAAS,EAAE,CAAC;AACvD;AAEAF,SAAO,KAAK,eAAeC,QAAO,OAAO,OAAO,GAAG,OAAO,KAAc,QAAkB;AACxF,MAAI;AACF,UAAM,MAAM,QAAQ,IAAI,sBAAsB;AAC9C,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6BAA6B,CAAC;AAC7E,UAAM,OAAQ,IAAY;AAC1B,QAAI,CAAC,QAAQ,CAAC,KAAK,OAAQ,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yCAAyC,CAAC;AAG1G,UAAM,aAAa,MAAM,cAAAE,QAAM,KAAK,wCAAwC,KAAK,QAAQ;AAAA,MACvF,SAAS;AAAA,QACP,eAAe;AAAA,QACf,gBAAgB;AAAA,MAClB;AAAA,MACA,eAAe;AAAA,IACjB,CAAC;AACD,UAAM,YAAY,YAAY,MAAM;AACpC,QAAI,CAAC,UAAW,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yBAAyB,CAAC;AAG/E,UAAM,SAAS,MAAM,cAAAA,QAAM,KAAK,4CAA4C;AAAA,MAC1E,WAAW;AAAA,MACX,WAAW;AAAA,MACX,aAAa;AAAA,IACf,GAAG;AAAA,MACD,SAAS,EAAE,eAAe,KAAK,gBAAgB,mBAAmB;AAAA,IACpE,CAAC;AACD,UAAM,OAAO,QAAQ,MAAM;AAC3B,QAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,8BAA8B,CAAC;AAG/E,QAAI,OAAO;AACX,aAAS,IAAI,GAAG,IAAI,IAAI,KAAK;AAC3B,YAAM,MAAM,GAAI;AAChB,YAAM,OAAO,MAAM,cAAAA,QAAM,IAAI,4CAA4C,IAAI,IAAI;AAAA,QAC/E,SAAS,EAAE,eAAe,IAAI;AAAA,MAChC,CAAC;AACD,YAAM,SAAS,OAAO,MAAM,MAAM,UAAU,EAAE;AAC9C,UAAI,WAAW,aAAa;AAAE,eAAO,OAAO,MAAM,MAAM,QAAQ,EAAE;AAAI;AAAA,MAAM;AAC5E,UAAI,WAAW,SAAS;AACtB,eAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,MAAM,MAAM,SAAS,uBAAuB,CAAC;AAAA,MACpF;AAAA,IACF;AACA,QAAI,CAAC,KAAM,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,wBAAwB,CAAC;AACzE,QAAI,KAAK,EAAE,KAAK,CAAC;AAAA,EACnB,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,6BAA6B,CAAC;AAAA,EAC5E;AACF,CAAC;AAGDH,SAAO,IAAI,mBAAmB,OAAO,MAAe,QAAkB;AACpE,MAAI;AACF,UAAM,MAAM,QAAQ,IAAI,sBAAsB;AAC9C,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6BAA6B,CAAC;AAG7E,UAAM,UAAU,EAAE,eAAe,KAAK,gBAAgB,mBAAmB;AACzE,UAAM,OAAO,EAAE,YAAY,KAAK;AAChC,UAAM,IAAI,MAAM,cAAAG,QAAM,KAAK,gDAAgD,MAAM,EAAE,QAAQ,CAAC;AAC5F,UAAM,QAAQ,GAAG,MAAM;AACvB,QAAI,CAAC,MAAO,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,kCAAkC,CAAC;AACpF,QAAI,KAAK,EAAE,OAAO,OAAO,YAAY,CAAC;AAAA,EACxC,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,UAAU,QAAQ,GAAG,WAAW,kCAAkC,CAAC;AAAA,EACtG;AACF,CAAC;AAED,IAAO,iBAAQH;;;ACjFf,IAAAI,mBAA0C;AAC1C,IAAAC,gBAAkB;AAElB,IAAMC,eAAS,yBAAO;AAGtBA,SAAO,KAAK,SAAS,OAAO,KAAc,QAAkB;AAC1D,MAAI;AACF,UAAM,UAAU,OAAO,IAAI,MAAM,WAAW,EAAE,EAAE,KAAK;AACrD,QAAI,CAAC,QAAS,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,sBAAsB,CAAC;AAG1E,UAAM,QAAQ,QAAQ,IAAI,sBAAsB;AAChD,UAAM,QAAQ,QAAQ,IAAI,qBAAqB;AAC/C,QAAI,OAAO;AACT,YAAMC,WAAU,CAAC,MAAmB;AAClC,YAAI,CAAC,EAAG,QAAO;AACf,cAAM,SAAS,CAAC,SAAQ,YAAW,UAAS,WAAU,UAAS,MAAM;AACrE,mBAAW,KAAK,QAAQ;AACtB,cAAI,OAAO,IAAI,CAAC,MAAM,YAAY,EAAE,CAAC,EAAE,KAAK,EAAG,QAAO,EAAE,CAAC,EAAE,KAAK;AAAA,QAClE;AAEA,YAAI,OAAO,GAAG,SAAS,YAAY,EAAE,KAAK,KAAK,EAAG,QAAO,EAAE,KAAK,KAAK;AACrE,YAAI,OAAO,GAAG,SAAS,YAAY,EAAE,MAAM;AACzC,qBAAW,KAAK,QAAQ;AACtB,kBAAM,IAAI,EAAE,KAAK,CAAC;AAClB,gBAAI,OAAO,MAAM,YAAY,EAAE,KAAK,EAAG,QAAO,EAAE,KAAK;AAAA,UACvD;AAAA,QACF;AACA,YAAI,MAAM,QAAQ,GAAG,OAAO,KAAK,OAAO,EAAE,QAAQ,CAAC,GAAG,SAAS,SAAU,QAAO,EAAE,QAAQ,CAAC,EAAE,KAAK,KAAK;AACvG,YAAI,OAAO,GAAG,MAAM,SAAS,SAAU,QAAO,EAAE,KAAK,KAAK,KAAK;AAC/D,eAAO;AAAA,MACT;AACA,YAAM,cAAsC,EAAE,gBAAgB,mBAAmB;AACjF,UAAI,OAAO;AAAE,oBAAY,eAAe,IAAI,UAAU,KAAK;AAAI,oBAAY,WAAW,IAAI;AAAA,MAAM;AAChG,YAAM,cAAsC,EAAE,gBAAgB,oCAAoC;AAClG,UAAI,OAAO;AAAE,oBAAY,eAAe,IAAI,UAAU,KAAK;AAAI,oBAAY,WAAW,IAAI;AAAA,MAAM;AAChG,YAAMC,YAA6E;AAAA,QACjF,aAAa,EAAE,IAAI,MAAM,QAAQ,GAAG,MAAM,OAAO,MAAM,cAAAC,QAAM,KAAK,OAAO,EAAE,SAAS,QAAS,IAAY,UAAU,MAAM,KAAI,oBAAI,KAAK,GAAE,YAAY,EAAE,GAAG,EAAE,SAAS,aAAa,SAAS,KAAO,gBAAgB,MAAM,KAAK,CAAC,GAAG,KAAM;AAAA,QACtO,aAAa,EAAE,IAAI,MAAM,QAAQ,GAAG,MAAM,OAAO,MAAM,cAAAA,QAAM,KAAK,OAAO,EAAE,MAAM,QAAQ,GAAG,EAAE,SAAS,aAAa,SAAS,KAAO,gBAAgB,MAAM,KAAK,CAAC,GAAG,KAAM;AAAA,QACzK,aAAa,EAAE,IAAI,MAAM,QAAQ,GAAG,MAAM,OAAO,MAAM,cAAAA,QAAM,KAAK,OAAO,EAAE,QAAQ,QAAQ,GAAG,EAAE,SAAS,aAAa,SAAS,KAAO,gBAAgB,MAAM,KAAK,CAAC,GAAG,KAAM;AAAA,QAC3K,aAAa,EAAE,IAAI,MAAM,QAAQ,GAAG,MAAM,OAAO,MAAM,cAAAA,QAAM,KAAK,OAAO,EAAE,OAAO,QAAQ,GAAG,EAAE,SAAS,aAAa,SAAS,KAAO,gBAAgB,MAAM,KAAK,CAAC,GAAG,KAAM;AAAA,QAC1K,aAAa,EAAE,IAAI,MAAM,QAAQ,GAAG,MAAM,OAAO,MAAM,cAAAA,QAAM,KAAK,OAAO,IAAI,gBAAgB,EAAE,QAAQ,CAAC,GAAG,EAAE,SAAS,aAAa,SAAS,KAAO,gBAAgB,MAAM,KAAK,CAAC,GAAG,KAAM;AAAA,QACxL,aAAa,EAAE,IAAI,MAAM,QAAQ,GAAG,MAAM,OAAO,MAAM,cAAAA,QAAM,IAAI,GAAG,KAAK,YAAY,mBAAmB,OAAO,CAAC,IAAI,EAAE,SAAS,aAAa,SAAS,KAAO,gBAAgB,MAAM,KAAK,CAAC,GAAG,KAAM;AAAA,MACnM;AACA,iBAAW,MAAMD,WAAU;AACzB,YAAI;AACF,gBAAM,OAAO,MAAM,GAAG;AACtB,gBAAM,QAAQD,SAAQ,KAAK,IAAI;AAC/B,cAAI,MAAO,QAAO,IAAI,KAAK,EAAE,MAAM,CAAC;AAAA,QACtC,SAAS,KAAU;AACjB,gBAAM,OAAO,KAAK,UAAU;AAC5B,gBAAM,OAAO,KAAK,UAAU;AAC5B,kBAAQ,KAAK,4BAA4B,EAAE,MAAM,MAAM,OAAO,SAAS,WAAW,OAAO,KAAK,UAAU,IAAI,EAAE,CAAC;AAC/G,cAAI,SAAS,OAAO,SAAS,IAAK,QAAO,IAAI,OAAO,IAAI,EAAE,KAAK,EAAE,OAAO,6EAA6E,CAAC;AAAA,QACxJ;AAAA,MACF;AAEA,UAAI;AACF,cAAM,QAAQ,MAAM,cAAAE,QAAM,IAAI,OAAO,EAAE,SAAS,KAAM,gBAAgB,MAAM,KAAK,CAAC;AAClF,cAAM,OAAO,OAAO;AACpB,YAAI,OAAO,SAAS,YAAY,KAAK,KAAK,EAAG,QAAO,IAAI,KAAK,EAAE,OAAO,KAAK,UAAU,GAAG,GAAI,EAAE,CAAC;AAAA,MACjG,QAAQ;AAAA,MAAC;AACT,aAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2GAA2G,CAAC;AAAA,IACnJ;AAGA,UAAM,MAAM,QAAQ,IAAI,qBAAqB,QAAQ,IAAI,gBAAgB;AACzE,UAAM,OAAO,QAAQ,IAAI,sBAAsB;AAC/C,QAAI,CAAC,IAAK,QAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,yCAAyC,CAAC;AAEzF,UAAM,UAAU,EAAE,kBAAkB,KAAK,mBAAmB,KAAK;AACjE,UAAM,UAAU;AAEhB,UAAM,UAAU,CAAC,SAAsB;AACrC,UAAI,CAAC,KAAM,QAAO;AAClB,YAAM,SAAS,CAAC,YAAY,UAAU,WAAW,UAAU,SAAS,SAAS;AAC7E,iBAAW,KAAK,QAAQ;AACtB,YAAI,OAAO,KAAK,CAAC,MAAM,YAAY,KAAK,CAAC,EAAE,KAAK,EAAG,QAAO,KAAK,CAAC,EAAE,KAAK;AAAA,MACzE;AAEA,UAAI,OAAO,MAAM,MAAM,SAAS,SAAU,QAAO,KAAK,KAAK,KAAK,KAAK;AACrE,UAAI,MAAM,QAAQ,MAAM,OAAO,KAAK,KAAK,QAAQ,CAAC,GAAG,KAAM,QAAO,OAAO,KAAK,QAAQ,CAAC,EAAE,IAAI,EAAE,KAAK;AACpG,aAAO;AAAA,IACT;AAGA,UAAM,WAAyC;AAAA,MAC7C,YAAY;AACV,cAAM,MAAM,IAAI,IAAI,WAAW,IAAI,MAAM;AACzC,YAAI,aAAa,IAAI,SAAS,OAAO;AACrC,cAAM,IAAI,MAAM,cAAAA,QAAM,IAAI,IAAI,SAAS,GAAG,EAAE,SAAS,QAAQ,CAAC;AAC9D,eAAO,QAAQ,EAAE,IAAI;AAAA,MACvB;AAAA,MACA,YAAY;AACV,cAAM,MAAM,WAAW,IAAI;AAC3B,cAAM,IAAI,MAAM,cAAAA,QAAM,KAAK,KAAK,EAAE,QAAQ,GAAG,EAAE,SAAS,EAAE,GAAG,SAAS,gBAAgB,mBAAmB,GAAG,QAAQ,CAAC;AACrH,eAAO,QAAQ,EAAE,IAAI;AAAA,MACvB;AAAA,IACF;AAEA,eAAW,WAAW,UAAU;AAC9B,UAAI;AACF,cAAM,MAAM,MAAM,QAAQ;AAC1B,YAAI,IAAK,QAAO,IAAI,KAAK,EAAE,OAAO,IAAI,CAAC;AAAA,MACzC,SAAS,KAAU;AAEjB,cAAM,OAAO,KAAK,UAAU;AAC5B,cAAM,OAAO,KAAK,UAAU;AAC5B,gBAAQ,KAAK,0BAA0B,EAAE,MAAM,MAAM,OAAO,SAAS,WAAW,OAAO,KAAK,UAAU,IAAI,EAAE,CAAC;AAC7G,YAAI,SAAS,KAAK;AAChB,iBAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,qIAAqI,CAAC;AAAA,QAC7K;AACA,YAAI,SAAS,KAAK;AAChB,gBAAM,aAAa,KAAK,UAAU,UAAU,aAAa,KAAK;AAC9D,iBAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,2DAA2D,WAAW,CAAC;AAAA,QAC9G;AAAA,MACF;AAAA,IACF;AAEA,WAAO,IAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,6CAA6C,CAAC;AAAA,EACrF,SAAS,GAAQ;AACf,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,OAAO,GAAG,WAAW,iBAAiB,CAAC;AAAA,EAChE;AACF,CAAC;AAED,IAAO,kBAAQH;;;AtBjFf,2BAAyB;AAAA,CAzCxB,MAAM;AACL,QAAM,aAAa;AAAA,IACjB,aAAAI,QAAK,QAAQ,QAAQ,IAAI,GAAG,aAAa;AAAA,IACzC,aAAAA,QAAK,QAAQ,QAAQ,IAAI,GAAG,MAAM;AAAA,IAClC,aAAAA,QAAK,QAAQ,WAAW,SAAS;AAAA,EACnC;AACA,aAAW,KAAK,YAAY;AAC1B,QAAI;AACF,UAAI,WAAAC,QAAG,WAAW,CAAC,GAAG;AAAE,sBAAAC,QAAO,OAAO,EAAE,MAAM,EAAE,CAAC;AAAG;AAAA,MAAM;AAAA,IAC5D,QAAQ;AAAA,IAAC;AAAA,EACX;AACF,GAAG;AAyBH,IAAM,UAAM,iBAAAC,SAAQ;AACpB,IAAI,QAAQ,cAAc;AAC1B,IAAI,IAAI,eAAe,CAAC;AACxB,IAAI,IAAI,iBAAiB,CAAC;AAC1B,IAAI,QAAI,YAAAC,SAAK,iBAAiB,CAAC,CAAC;AAEhC,IAAI,QAAI,qBAAAC,SAAa,CAAC;AACtB,IAAI,IAAI,iBAAAF,QAAQ,KAAK,CAAC;AACtB,IAAI,QAAI,cAAAG,SAAO,KAAK,CAAC;AAErB,IAAI,IAAI,YAAY,iBAAAH,QAAQ,OAAO,aAAAH,QAAK,QAAQ,QAAQ,IAAI,GAAG,SAAS,CAAC,CAAC;AAE1E,IAAMO,WAAS,IAAI,6BAAa;AAEhC,IAAI,IAAI,WAAW,OAAO,MAAM,QAAQ;AACtC,MAAI;AACF,UAAMA,SAAO;AACb,QAAI,KAAK,EAAE,IAAI,KAAK,CAAC;AAAA,EACvB,SAAS,GAAG;AACV,QAAI,OAAO,GAAG,EAAE,KAAK,EAAE,IAAI,OAAO,OAAO,OAAO,CAAC,EAAE,CAAC;AAAA,EACtD;AACF,CAAC;AAGD,IAAI,IAAI,OAAO,KAAK,MAAM,SAAS;AACjC,QAAM,OAAO,IAAI,OAAO,eAAe,KAAK;AAC5C,MAAI,SAAwB;AAC5B,MAAI,UAAyB;AAC7B,MAAI,KAAK,YAAY,EAAE,WAAW,SAAS,GAAG;AAC5C,UAAM,QAAQ,KAAK,MAAM,CAAC;AAC1B,QAAI;AACF,YAAM,SAAS,QAAQ,IAAI,cAAc;AAEzC,YAAMC,OAAM,QAAQ,cAAc;AAClC,YAAM,UAAUA,KAAI,OAAO,OAAO,MAAM;AACxC,eAAS,SAAS,OAAO;AACzB,gBAAU;AAAA,IACZ,QAAQ;AAAA,IAAC;AAAA,EACX;AAEA,QAAM,mBAAmB,QAAQ,IAAI,qBAAqB,IAAI,YAAY,MAAM;AAChF,MAAI,CAAC,UAAU,iBAAiB;AAC9B,UAAM,aAAa,IAAI,OAAO,WAAW,KAAK;AAC9C,UAAM,aAAc,IAAY,SAAS,QAAQ;AACjD,aAAS,cAAc,cAAc;AAAA,EACvC;AAGA,MAAI;AACF,UAAM,SAAU,IAAY,SAAS,UAAU;AAC/C,QAAI,UAAU,SAAS;AACrB,YAAM,EAAE,cAAAC,eAAa,IAAI,MAAM,OAAO,gBAAgB;AACtD,YAAMF,WAAS,IAAIE,eAAa;AAChC,YAAMC,MAAUH;AAChB,YAAM,UAAU,MAAMG,IAAG,qBAAqB,WAAW,EAAE,OAAO,EAAE,IAAI,OAAO,MAAM,EAAE,EAAE,CAAC;AAC1F,UAAI,WAAW,CAAC,QAAQ,WAAW,QAAQ,YAAY,SAAS;AAC9D,iBAAS,QAAQ;AAChB,QAAC,IAAY,UAAU;AACvB,QAAC,IAAY,yBAAyB,QAAQ;AAAA,MACjD;AAAA,IACF;AAAA,EACF,QAAQ;AAAA,EAAC;AAET;AAAC,EAAC,IAAY,SAAS;AAGvB,OAAK;AACP,CAAC;AAED,IAAI,IAAI,aAAa,gBAAc;AACnC,IAAI,IAAI,UAAU,aAAW;AAC7B,IAAI,IAAI,aAAa,gBAAc;AAEnC,IAAI,IAAI,cAAc,aAAW;AACjC,IAAI,IAAI,oBAAoB,mBAAiB;AAC7C,IAAI,IAAI,cAAc,aAAW;AACjC,IAAI,IAAI,SAAS,YAAU;AAE3B,IAAI,IAAI,aAAa,YAAU;AAE/B,IAAI,IAAI,kBAAkB,iBAAe;AAEzC,IAAI,IAAI,iBAAiB,gBAAc;AAEvC,IAAI,IAAI,cAAc,aAAW;AACjC,IAAI,IAAI,iBAAiB,gBAAc;AACvC,IAAI,IAAI,qBAAqB,oBAAiB;AAE9C,IAAI,IAAI,aAAa,gBAAc;AAEnC,IAAI,IAAI,kBAAkB,iBAAe;AAEzC,IAAI,IAAI,cAAc,aAAW;AAEjC,IAAI,IAAI,iBAAiB,gBAAc;AAEvC,IAAI,IAAI,eAAe,cAAY;AAEnC,IAAI,IAAI,gBAAgB,iBAAiB,GAAG,eAAa;AAEzD,IAAM,OAAO,QAAQ,IAAI,QAAQ;AACjC,IAAI,OAAO,MAAM,MAAM;AACrB,UAAQ,IAAI,qBAAqB,IAAI,EAAE;AACzC,CAAC;","names":["pdfParse","Tesseract","import_fs","import_path","import_express","import_client","helmet","rateLimit","prisma","import_express","import_client","import_zod","prisma","router","import_express","import_client","import_zod","prisma","router","path","fs","multer","import_express","import_client","import_zod","import_client","import_client","prisma","prisma","isSuperAdmin","prisma","router","db","import_express","import_client","import_zod","prisma","router","import_express","import_client","import_zod","prisma","router","bodySchema","import_express","import_client","import_zod","port","nodemailer","baseUrl","prisma","router","jwt","crypto","bcrypt","db","u","import_express","import_client","import_zod","prisma","router","db","import_express","import_client","import_crypto","prisma","router","crypto","axios","url","r","items","events","import_express","import_client","import_axios","prisma","db","router","baseUrl","clientBaseUrl","resolveUserId","ensureGoogleToken","axios","invoiceHtml","looksLikeSlip","walkParts","walk","import_express","import_client","import_zod","prisma","db","router","createSchema","import_express","import_client","import_zod","import_path","prisma","db","router","axios","uploadDir","path","fs","extractAmount","import_express","import_client","import_zod","prisma","db","router","hasModel","import_express","import_client","import_multer","import_path","import_promises","import_zod","prisma","db","router","path","storage","multer","fs","upload","import_express","import_client","import_zod","import_bcryptjs","import_crypto","prisma","router","bcrypt","db","hashToken","crypto","import_express","import_zod","router","import_express","import_multer","import_axios","router","upload","multer","axios","import_express","import_axios","router","extract","attempts","axios","path","fs","dotenv","express","cors","cookieParser","morgan","prisma","jwt","PrismaClient","db"]}